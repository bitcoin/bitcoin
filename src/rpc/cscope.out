cscope 15 $HOME/syscoin2/src/rpc               0000436299
	@auxpow_miner.cpp

5 
	~<½c/auxpow_mš”.h
>

7 
	~<¬™h_ušt256.h
>

8 
	~<auxpow.h
>

9 
	~<chaš·¿ms.h
>

10 
	~<Ãt.h
>

11 
	~<node/cÚ‹xt.h
>

12 
	~<½c/blockchaš.h
>

13 
	~<½c/´ÙocŞ.h
>

14 
	~<½c/»que¡.h
>

15 
	~<ut/¡»ncodšgs.h
>

16 
	~<ut/time.h
>

17 
	~<v®id©iÚ.h
>

19 
	~<ÿs£¹
>

20 
	~<ut/check.h
>

21 
	gÇme¥aû


24 
auxMššgCheck
(
CCÚnmª
 &
cÚnmª
)

27 ià(
	gcÚnmª
.
G‘NodeCouÁ
 (
CCÚnmª
::
CONNECTIONS_ALL
) == 0

28 && !
P¬ams
 ().
MšeBlocksOnDemªd
 ())

29 
throw
 
JSONRPCE¼Ü
 (
RPC_CLIENT_NOT_CONNECTED
,

32 ià(::
Chaš¡©eAùive
 ().
IsIn™ŸlBlockDowÆßd
 ()

33 && !
P¬ams
 ().
MšeBlocksOnDemªd
 ())

34 
throw
 
JSONRPCE¼Ü
 (
RPC_CLIENT_IN_INITIAL_DOWNLOAD
,

40 
LOCK
 (
cs_maš
);

41 cÚ¡‡utØ
	gauxpowS¹
 = 
P¬ams
 ().
G‘CÚ£nsus
 ().
nAuxpowS¹Height
;

42 ià(::
ChašAùive
 ().
Height
 (è+ 1 < 
auxpowS¹
)

43 
throw
 
¡d
::
ruÁime_”rÜ
 ("mining‡uxblock method is‚ot yet‡vailable");

49 cÚ¡ 
CBlock
*

50 
	gAuxpowMš”
::
	$g‘Cu¼’tBlock
 (cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
,

51 cÚ¡ 
CSüt
& 
sütPubKey
, 
ušt256
& 
rg‘
)

53 
	`As£¹LockH–d
 (
cs
);

54 cÚ¡ 
CBlock
* 
pblockCur
 = 
nuÎ±r
;

57 
	`LOCK
 (
cs_maš
);

58 
CSütID
 
	`sütID
 (
sütPubKey
);

59 autØ
™”
 = 
curBlocks
.
	`fšd
(
sütID
);

60 ià(
™”
 !ğ
curBlocks
.
	`’d
())

61 
pblockCur
 = 
™”
->
£cÚd
;

63 ià(
pblockCur
 =ğ
nuÎ±r


64 || 
pšdexP»v
 !ğ::
	`ChašAùive
 ().
	`T
 ()

65 || (
mempoŞ
.
	`G‘T¿n§ùiÚsUpd©ed
 (è!ğ
txUpd©edLa¡


66 && 
	`G‘Time
 (è- 
¡¬tTime
 > 60))

68 ià(
pšdexP»v
 !ğ::
	`ChašAùive
 ().
	`T
 ())

71 
blocks
.
	`ş—r
 ();

72 
‹m¶©es
.
	`ş—r
 ();

73 
curBlocks
.
	`ş—r
 ();

77 
¡d
::
unique_±r
<
CBlockTem¶©e
> 
ÃwBlock


78 ğ
	`BlockAs£mbËr
 (
mempoŞ
, 
	`P¬ams
 ()).
	`C»©eNewBlock
 (
sütPubKey
);

79 ià(
ÃwBlock
 =ğ
nuÎ±r
)

80 
throw
 
	`JSONRPCE¼Ü
 (
RPC_OUT_OF_MEMORY
, "out of memory");

83 
txUpd©edLa¡
 = 
mempoŞ
.
	`G‘T¿n§ùiÚsUpd©ed
 ();

84 
pšdexP»v
 = ::
	`ChašAùive
 ().
	`T
 ();

85 
¡¬tTime
 = 
	`G‘Time
 ();

88 
	`Inüem’tExŒaNÚû
 (&
ÃwBlock
->
block
, 
pšdexP»v
, 
exŒaNÚû
);

89 
ÃwBlock
->
block
.
	`S‘AuxpowV”siÚ
 (
Œue
);

92 
pblockCur
 = &
ÃwBlock
->
block
;

93 
curBlocks
.
	`em¶aû
(
sütID
, 
pblockCur
);

94 
blocks
[
pblockCur
->
	`G‘Hash
 ()] =…blockCur;

95 
‹m¶©es
.
	`push_back
 (
¡d
::
	`move
 (
ÃwBlock
));

104 
	`CHECK_NONFATAL
(
pblockCur
);

106 
¬™h_ušt256
 
¬™hT¬g‘
;

107 
boŞ
 
fNeg©ive
, 
fOv”æow
;

108 
¬™hT¬g‘
.
	`S‘Com·ù
 (
pblockCur
->
nB™s
, &
fNeg©ive
, &
fOv”æow
);

109 ià(
fNeg©ive
 || 
fOv”æow
 || 
¬™hT¬g‘
 == 0)

110 
throw
 
¡d
::
	`ruÁime_”rÜ
 ("invalid difficulty bits in block");

111 
rg‘
 = 
	`Ar™hToUšt256
 (
¬™hT¬g‘
);

113  
pblockCur
;

114 
	}
}

116 cÚ¡ 
CBlock
*

117 
	gAuxpowMš”
::
	$lookupSavedBlock
 (cÚ¡ 
¡d
::
¡ršg
& 
hashHex
) const

119 
	`As£¹LockH–d
 (
cs
);

121 
ušt256
 
hash
;

122 
hash
.
	`S‘Hex
 (
hashHex
);

124 cÚ¡‡utØ
™”
 = 
blocks
.
	`fšd
 (
hash
);

125 ià(
™”
 =ğ
blocks
.
	`’d
 ())

126 
throw
 
	`JSONRPCE¼Ü
 (
RPC_INVALID_PARAMETER
, "block hash unknown");

128  
™”
->
£cÚd
;

129 
	}
}

131 
UniV®ue


132 
	gAuxpowMš”
::
	$ü—‹AuxBlock
 (cÚ¡ 
CSüt
& 
sütPubKey
, cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
)

134 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
cÚ‹xt
);

135 if(!
node
.
cÚnmª
)

136 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

137 
	`auxMššgCheck
 (*
node
.
cÚnmª
);

138 
	`LOCK
 (
cs
);

140 cÚ¡‡uto& 
mempoŞ
 = 
	`Ensu»MemPoŞ
 (
cÚ‹xt
);

142 
ušt256
 
rg‘
;

143 cÚ¡ 
CBlock
* 
pblock
 = 
	`g‘Cu¼’tBlock
 (
mempoŞ
, 
sütPubKey
, 
rg‘
);

145 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

146 
»suÉ
.
	`pushKV
 ("hash", 
pblock
->
	`G‘Hash
 ().
	`G‘Hex
 ());

147 
»suÉ
.
	`pushKV
 ("chašid", 
pblock
->
	`G‘ChašId
 ());

148 
»suÉ
.
	`pushKV
 ("´eviousblockhash", 
pblock
->
hashP»vBlock
.
	`G‘Hex
 ());

149 
»suÉ
.
	`pushKV
 ("coinbasevalue",

150 
¡©ic_ÿ¡
<
št64_t
> (
pblock
->
vtx
[0]->
vout
[0].
nV®ue
));

151 
»suÉ
.
	`pushKV
 ("b™s", 
	`¡½rštf
 ("%08x", 
pblock
->
nB™s
));

152 
»suÉ
.
	`pushKV
 ("height", 
¡©ic_ÿ¡
<
št64_t
> (
pšdexP»v
->
nHeight
 + 1));

153 
»suÉ
.
	`pushKV
 ("_rg‘", 
	`HexSŒ
 (
rg‘
.
	`begš
 (),¬g‘.
	`’d
 ()));

155  
»suÉ
;

156 
	}
}

158 
boŞ


159 
	gAuxpowMš”
::
	$subm™AuxBlock
 (cÚ¡ 
¡d
::
¡ršg
& 
hashHex
,

160 cÚ¡ 
¡d
::
¡ršg
& 
auxpowHex
, cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
) const

162 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
cÚ‹xt
);

163 if(!
node
.
cÚnmª
)

164 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

165 
	`auxMššgCheck
 (*
node
.
cÚnmª
);

167 
¡d
::
sh¬ed_±r
<
CBlock
> 
sh¬ed_block
;

169 
	`LOCK
 (
cs
);

170 cÚ¡ 
CBlock
* 
pblock
 = 
	`lookupSavedBlock
 (
hashHex
);

171 
sh¬ed_block
 = 
¡d
::
make_sh¬ed
<
CBlock
> (*
pblock
);

174 cÚ¡ 
¡d
::
veùÜ
<> 
vchAuxPow
 = 
	`P¬£Hex
 (
auxpowHex
);

175 
CD©aSŒ—m
 
	`ss
(
vchAuxPow
, 
SER_GETHASH
, 
PROTOCOL_VERSION
);

176 
¡d
::
unique_±r
<
CAuxPow
> 
	`pow
(
Ãw
 
	`CAuxPow
 ());

177 
ss
 >> *
pow
;

178 
sh¬ed_block
->
	`S‘Auxpow
 (
¡d
::
	`move
 (
pow
));

179 
	`CHECK_NONFATAL
(
sh¬ed_block
->
	`G‘Hash
 ().
	`G‘Hex
 (è=ğ
hashHex
);

181  
	`Ensu»Chašmª
(
node
).
	`ProûssNewBlock
 (
	`P¬ams
 (), 
sh¬ed_block
, 
Œue
, 
nuÎ±r
);

182 
	}
}

184 
	gAuxpowMš”
&

185 
	gAuxpowMš”
::
	$g‘
 ()

187 
AuxpowMš”
* 
š¡ªû
 = 
nuÎ±r
;

188 
RecursiveMu‹x
 
lock
;

190 
	`LOCK
 (
lock
);

191 ià(
š¡ªû
 =ğ
nuÎ±r
)

192 
š¡ªû
 = 
Ãw
 
	`AuxpowMš”
 ();

194  *
š¡ªû
;

195 
	}
}

	@auxpow_miner.h

5 #iâdeà
SYSCOIN_RPC_AUXPOW_MINER_H


6 
	#SYSCOIN_RPC_AUXPOW_MINER_H


	)

8 
	~<mš”.h
>

9 
	~<süt/süt.h
>

10 
	~<süt/¡ªd¬d.h
>

11 
	~<sync.h
>

12 
	~<txmempoŞ.h
>

13 
	~<ušt256.h
>

14 
	~<univ®ue.h
>

16 
	~<m­
>

17 
	~<memÜy
>

18 
	~<¡ršg
>

19 
	~<veùÜ
>

20 
	~<ut/»f.h
>

22 
Çme¥aû
 
	gauxpow_‹¡s


24 
şass
 
	gAuxpowMš”FÜTe¡
;

35 şas 
	cAuxpowMš”


38 
	m´iv©e
:

41 
mubË
 
RecursiveMu‹x
 
cs
;

43 
	m¡d
::
veùÜ
<
¡d
::
unique_±r
<
CBlockTem¶©e
>> 
‹m¶©es
;

45 
	m¡d
::
m­
<
ušt256
, cÚ¡ 
	mCBlock
*> 
	mblocks
;

47 
	m¡d
::
m­
<
CSütID
, cÚ¡ 
	mCBlock
*> 
	mcurBlocks
;

50 
	mexŒaNÚû
 = 0;

53 
	mtxUpd©edLa¡
;

54 cÚ¡ 
CBlockIndex
* 
	mpšdexP»v
 = 
nuÎ±r
;

55 
ušt64_t
 
	m¡¬tTime
;

63 cÚ¡ 
CBlock
* 
g‘Cu¼’tBlock
 (cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
,

64 cÚ¡ 
CSüt
& 
sütPubKey
, 
ušt256
& 
rg‘
);

70 cÚ¡ 
CBlock
* 
	$lookupSavedBlock
 (cÚ¡ 
¡d
::
¡ršg
& 
hashHex
) const;

72 
ä›nd
 
şass
 
auxpow_‹¡s
::
AuxpowMš”FÜTe¡
;

74 
public
:

76 
	`AuxpowMš”
 () = ;

83 
UniV®ue
 
	`ü—‹AuxBlock
 (cÚ¡ 
CSüt
& 
sütPubKey
, cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
);

91 
boŞ
 
	$subm™AuxBlock
 (cÚ¡ 
¡d
::
¡ršg
& 
hashHex
,

92 cÚ¡ 
¡d
::
¡ršg
& 
auxpowHex
, cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
) const;

97 
AuxpowMš”
& 
	`g‘
 ();

	@blockchain.cpp

6 
	~<½c/blockchaš.h
>

8 
	~<amouÁ.h
>

9 
	~<blockf‹r.h
>

10 
	~<chaš.h
>

11 
	~<chaš·¿ms.h
>

12 
	~<cošs.h
>

13 
	~<cÚ£nsus/v®id©iÚ.h
>

14 
	~<cÜe_io.h
>

15 
	~<hash.h
>

16 
	~<šdex/blockf‹ršdex.h
>

17 
	~<node/coš¡©s.h
>

18 
	~<node/cÚ‹xt.h
>

19 
	~<node/utxo_¢­shÙ.h
>

20 
	~<pŞicy/ã”©e.h
>

21 
	~<pŞicy/pŞicy.h
>

22 
	~<pŞicy/rbf.h
>

23 
	~<´im™ives/Œª§ùiÚ.h
>

24 
	~<½c/¿wŒª§ùiÚ_ut.h
>

25 
	~<½c/£rv”.h
>

26 
	~<½c/ut.h
>

27 
	~<süt/desütÜ.h
>

28 
	~<¡»ams.h
>

29 
	~<sync.h
>

30 
	~<txdb.h
>

31 
	~<txmempoŞ.h
>

32 
	~<undo.h
>

33 
	~<ut/»f.h
>

34 
	~<ut/¡»ncodšgs.h
>

35 
	~<ut/sy¡em.h
>

36 
	~<ut/Œª¦©iÚ.h
>

37 
	~<v®id©iÚ.h
>

38 
	~<v®id©iÚš‹rçû.h
>

39 
	~<w¬nšgs.h
>

41 
	~<¡dšt.h
>

43 
	~<univ®ue.h
>

45 
	~<cÚd™iÚ_v¬ŸbË
>

46 
	~<memÜy
>

47 
	~<mu‹x
>

49 
	~<w®Ët/cÚ‹xt.h
>

50 
	~<£rviûs/as£t.h
>

51 
	sCUpd©edBlock


53 
ušt256
 
	mhash
;

54 
	mheight
;

57 
Mu‹x
 
	gcs_blockchªge
;

58 
	g¡d
::
cÚd™iÚ_v¬ŸbË
 
cÚd_blockchªge
;

59 
CUpd©edBlock
 
Ï‹¡block
 
GUARDED_BY
(
cs_blockchªge
);

61 
	gNodeCÚ‹xt
& 
	$Ensu»NodeCÚ‹xt
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
)

64 ià(
cÚ‹xt
.
Has
<
W®ËtCÚ‹xt
>()) {

65 cÚ¡‡uto& 
wùx
 = 
cÚ‹xt
.
G‘
<
W®ËtCÚ‹xt
>();

66 ià(
wùx
.
nodeCÚ‹xt
 !ğ
nuÎ±r
)

67  *
wùx
.
nodeCÚ‹xt
;

69 ià(!
cÚ‹xt
.
Has
<
NodeCÚ‹xt
>()) {

70 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Node context‚ot found");

72  
cÚ‹xt
.
G‘
<
NodeCÚ‹xt
>();

73 
	}
}

75 
	gCTxMemPoŞ
& 
	$Ensu»MemPoŞ
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
)

77 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
cÚ‹xt
);

78 ià(!
node
.
mempoŞ
) {

79 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_MEMPOOL_DISABLED
, "Mempool disabled or instance‚ot found");

81  *
node
.
mempoŞ
;

82 
	}
}

84 
	gChaš¡©eMªag”
& 
	$Ensu»Chašmª
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
)

86 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
cÚ‹xt
);

87  
	`Ensu»Chašmª
(
node
);

88 
	}
}

92 
	$G‘DifficuÉy
(cÚ¡ 
CBlockIndex
* 
blockšdex
)

94 
	`CHECK_NONFATAL
(
blockšdex
);

96 
nShiá
 = (
blockšdex
->
nB™s
 >> 24) & 0xff;

97 
dDiff
 =

98 ()0x0000fffà/ ()(
blockšdex
->
nB™s
 & 0x00ffffff);

100 
nShiá
 < 29)

102 
dDiff
 *= 256.0;

103 
nShiá
++;

105 
nShiá
 > 29)

107 
dDiff
 /= 256.0;

108 
nShiá
--;

111  
dDiff
;

112 
	}
}

114 
	$Compu‹NextBlockAndD•th
(cÚ¡ 
CBlockIndex
* 
t
, cÚ¡ CBlockIndex* 
blockšdex
, cÚ¡ CBlockIndex*& 
Ãxt
)

116 
Ãxt
 = 
t
->
	`G‘Anû¡Ü
(
blockšdex
->
nHeight
 + 1);

117 ià(
Ãxt
 &&‚ext->
µ»v
 =ğ
blockšdex
) {

118  
t
->
nHeight
 - 
blockšdex
->nHeight + 1;

120 
Ãxt
 = 
nuÎ±r
;

121  
blockšdex
 =ğ
t
 ? 1 : -1;

122 
	}
}

123 
UniV®ue
 
	$AuxpowToJSON
(cÚ¡ 
CAuxPow
& 
auxpow
)

125 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

128 
UniV®ue
 
	`tx
(UniV®ue::
VOBJ
);

129 
tx
.
	`pushKV
("hex", 
	`EncodeHexTx
(*
auxpow
.
cošba£Tx
));

130 
	`TxToJSON
(*
auxpow
.
cošba£Tx
,‡uxpow.
·»ÁBlock
.
	`G‘Hash
(), 
tx
);

131 
»suÉ
.
	`pushKV
("tx", 
tx
);

134 
»suÉ
.
	`pushKV
("chaššdex", 
auxpow
.
nChašIndex
);

137 
UniV®ue
 
	`b¿nch
(UniV®ue::
VARR
);

138 cÚ¡‡uto& 
node
 : 
auxpow
.
vM”kËB¿nch
)

139 
b¿nch
.
	`push_back
(
node
.
	`G‘Hex
());

140 
»suÉ
.
	`pushKV
("m”kËb¿nch", 
b¿nch
);

144 
UniV®ue
 
	`b¿nch
(UniV®ue::
VARR
);

145 cÚ¡‡uto& 
node
 : 
auxpow
.
vChašM”kËB¿nch
)

146 
b¿nch
.
	`push_back
(
node
.
	`G‘Hex
());

147 
»suÉ
.
	`pushKV
("chašm”kËb¿nch", 
b¿nch
);

150 
CD©aSŒ—m
 
	`ssP¬’t
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

151 
ssP¬’t
 << 
auxpow
.
·»ÁBlock
;

152 cÚ¡ 
¡d
::
¡ršg
 
¡rHex
 = 
	`HexSŒ
(
ssP¬’t
.
	`begš
(), ssP¬’t.
	`’d
());

153 
»suÉ
.
	`pushKV
("·»Áblock", 
¡rHex
);

155  
»suÉ
;

156 
	}
}

157 
UniV®ue
 
	$blockh—d”ToJSON
(cÚ¡ 
CBlockIndex
* 
t
, cÚ¡ CBlockIndex* 
blockšdex
)

160 
	`As£¹LockNÙH–d
(
cs_maš
);

162 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

163 
»suÉ
.
	`pushKV
("hash", 
blockšdex
->
	`G‘BlockHash
().
	`G‘Hex
());

164 cÚ¡ 
CBlockIndex
* 
²ext
;

165 
cÚfœm©iÚs
 = 
	`Compu‹NextBlockAndD•th
(
t
, 
blockšdex
, 
²ext
);

166 
»suÉ
.
	`pushKV
("cÚfœm©iÚs", 
cÚfœm©iÚs
);

167 
»suÉ
.
	`pushKV
("height", 
blockšdex
->
nHeight
);

168 
»suÉ
.
	`pushKV
("v”siÚ", 
blockšdex
->
nV”siÚ
);

169 
»suÉ
.
	`pushKV
("v”siÚHex", 
	`¡½rštf
("%08x", 
blockšdex
->
nV”siÚ
));

170 
»suÉ
.
	`pushKV
("m”kËroÙ", 
blockšdex
->
hashM”kËRoÙ
.
	`G‘Hex
());

171 
»suÉ
.
	`pushKV
("time", (
št64_t
)
blockšdex
->
nTime
);

172 
»suÉ
.
	`pushKV
("medŸÁime", (
št64_t
)
blockšdex
->
	`G‘MedŸnTimePa¡
());

173 
»suÉ
.
	`pushKV
("nÚû", (
ušt64_t
)
blockšdex
->
nNÚû
);

174 
»suÉ
.
	`pushKV
("b™s", 
	`¡½rštf
("%08x", 
blockšdex
->
nB™s
));

175 
»suÉ
.
	`pushKV
("difficuÉy", 
	`G‘DifficuÉy
(
blockšdex
));

176 
»suÉ
.
	`pushKV
("chašwÜk", 
blockšdex
->
nChašWÜk
.
	`G‘Hex
());

177 
»suÉ
.
	`pushKV
("nTx", (
ušt64_t
)
blockšdex
->
nTx
);

179 ià(
blockšdex
->
µ»v
)

180 
»suÉ
.
	`pushKV
("´eviousblockhash", 
blockšdex
->
µ»v
->
	`G‘BlockHash
().
	`G‘Hex
());

181 ià(
²ext
)

182 
»suÉ
.
	`pushKV
("Ãxtblockhash", 
²ext
->
	`G‘BlockHash
().
	`G‘Hex
());

183  
»suÉ
;

184 
	}
}

186 
UniV®ue
 
	$blockToJSON
(cÚ¡ 
CBlock
& 
block
, cÚ¡ 
CBlockIndex
* 
t
, cÚ¡ CBlockIndex* 
blockšdex
, 
boŞ
 
txD‘as
)

189 
	`As£¹LockNÙH–d
(
cs_maš
);

191 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

192 
»suÉ
.
	`pushKV
("hash", 
blockšdex
->
	`G‘BlockHash
().
	`G‘Hex
());

193 cÚ¡ 
CBlockIndex
* 
²ext
;

194 
cÚfœm©iÚs
 = 
	`Compu‹NextBlockAndD•th
(
t
, 
blockšdex
, 
²ext
);

195 
»suÉ
.
	`pushKV
("cÚfœm©iÚs", 
cÚfœm©iÚs
);

196 
»suÉ
.
	`pushKV
("¡r³dsize", ()::
	`G‘S”ŸlizeSize
(
block
, 
PROTOCOL_VERSION
 | 
SERIALIZE_TRANSACTION_NO_WITNESS
));

197 
»suÉ
.
	`pushKV
("size", ()::
	`G‘S”ŸlizeSize
(
block
, 
PROTOCOL_VERSION
));

198 
»suÉ
.
	`pushKV
("weight", ()::
	`G‘BlockWeight
(
block
));

199 
»suÉ
.
	`pushKV
("height", 
blockšdex
->
nHeight
);

200 
»suÉ
.
	`pushKV
("v”siÚ", 
block
.
nV”siÚ
);

201 
»suÉ
.
	`pushKV
("v”siÚHex", 
	`¡½rštf
("%08x", 
block
.
nV”siÚ
));

202 
»suÉ
.
	`pushKV
("m”kËroÙ", 
block
.
hashM”kËRoÙ
.
	`G‘Hex
());

203 
UniV®ue
 
	`txs
(UniV®ue::
VARR
);

204 cÚ¡‡uto& 
tx
 : 
block
.
vtx
)

206 if(
txD‘as
)

208 
UniV®ue
 
	`objTx
(UniV®ue::
VOBJ
);

209 
	`TxToUniv
(*
tx
, 
	`ušt256
(), 
objTx
, 
Œue
, 
	`RPCS”Ÿliz©iÚFÏgs
());

210 
txs
.
	`push_back
(
objTx
);

213 
txs
.
	`push_back
(
tx
->
	`G‘Hash
().
	`G‘Hex
());

215 
»suÉ
.
	`pushKV
("tx", 
txs
);

216 
»suÉ
.
	`pushKV
("time", 
block
.
	`G‘BlockTime
());

217 
»suÉ
.
	`pushKV
("medŸÁime", (
št64_t
)
blockšdex
->
	`G‘MedŸnTimePa¡
());

218 
»suÉ
.
	`pushKV
("nÚû", (
ušt64_t
)
block
.
nNÚû
);

219 
»suÉ
.
	`pushKV
("b™s", 
	`¡½rštf
("%08x", 
block
.
nB™s
));

220 
»suÉ
.
	`pushKV
("difficuÉy", 
	`G‘DifficuÉy
(
blockšdex
));

221 
»suÉ
.
	`pushKV
("chašwÜk", 
blockšdex
->
nChašWÜk
.
	`G‘Hex
());

222 
»suÉ
.
	`pushKV
("nTx", (
ušt64_t
)
blockšdex
->
nTx
);

224 ià(
block
.
auxpow
)

225 
»suÉ
.
	`pushKV
("auxpow", 
	`AuxpowToJSON
(*
block
.
auxpow
));

226 ià(
blockšdex
->
µ»v
)

227 
»suÉ
.
	`pushKV
("´eviousblockhash", 
blockšdex
->
µ»v
->
	`G‘BlockHash
().
	`G‘Hex
());

228 ià(
²ext
)

229 
»suÉ
.
	`pushKV
("Ãxtblockhash", 
²ext
->
	`G‘BlockHash
().
	`G‘Hex
());

230  
»suÉ
;

231 
	}
}

233 
UniV®ue
 
	$g‘blockcouÁ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

235 
RPCH–pMª
{"getblockcount",

239 
RPCResuÉ
{

240 
RPCResuÉ
::
Ty³
::
NUM
, "", "The current block count"},

241 
RPCExam¶es
{

242 
	`H–pExam¶eCli
("getblockcount", "")

243 + 
	`H–pExam¶eRpc
("getblockcount", "")

245 }.
	`Check
(
»que¡
);

247 
	`LOCK
(
cs_maš
);

248  ::
	`ChašAùive
().
	`Height
();

249 
	}
}

251 
UniV®ue
 
	$g‘be¡blockhash
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

253 
RPCH–pMª
{"getbestblockhash",

256 
RPCResuÉ
{

257 
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "the block hash, hex-encoded"},

258 
RPCExam¶es
{

259 
	`H–pExam¶eCli
("getbestblockhash", "")

260 + 
	`H–pExam¶eRpc
("getbestblockhash", "")

262 }.
	`Check
(
»que¡
);

264 
	`LOCK
(
cs_maš
);

265  ::
	`ChašAùive
().
	`T
()->
	`G‘BlockHash
().
	`G‘Hex
();

266 
	}
}

268 
	$RPCNÙifyBlockChªge
(cÚ¡ 
CBlockIndex
* 
pšdex
)

270 if(
pšdex
) {

271 
	`LOCK
(
cs_blockchªge
);

272 
Ï‹¡block
.
hash
 = 
pšdex
->
	`G‘BlockHash
();

273 
Ï‹¡block
.
height
 = 
pšdex
->
nHeight
;

275 
cÚd_blockchªge
.
	`nÙify_®l
();

276 
	}
}

278 
UniV®ue
 
	$wa™fÜÃwblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

280 
RPCH–pMª
{"waitfornewblock",

284 {"timeout", 
RPCArg
::
Ty³
::
NUM
, "0", "Time in millisecondso wait for‡„esponse. 0 indicates‚oimeout."},

286 
RPCResuÉ
{

287 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

289 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "The blockhash"},

290 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "Block height"},

292 
RPCExam¶es
{

293 
	`H–pExam¶eCli
("waitfornewblock", "1000")

294 + 
	`H–pExam¶eRpc
("waitfornewblock", "1000")

296 }.
	`Check
(
»que¡
);

297 
timeout
 = 0;

298 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
())

299 
timeout
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

301 
CUpd©edBlock
 
block
;

303 
	`WAIT_LOCK
(
cs_blockchªge
, 
lock
);

304 
block
 = 
Ï‹¡block
;

305 if(
timeout
)

306 
cÚd_blockchªge
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`mli£cÚds
(
timeout
), [&
block
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.
height
 !ğblock.heighˆ||†©e¡block.
hash
 !ğblock.hash || !
	`IsRPCRuÂšg
(); });

308 
cÚd_blockchªge
.
	`wa™
(
lock
, [&
block
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.
height
 !ğblock.heighˆ||†©e¡block.
hash
 !ğblock.hash || !
	`IsRPCRuÂšg
(); });

309 
block
 = 
Ï‹¡block
;

311 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

312 
»t
.
	`pushKV
("hash", 
block
.
hash
.
	`G‘Hex
());

313 
»t
.
	`pushKV
("height", 
block
.
height
);

314  
»t
;

315 
	}
}

317 
UniV®ue
 
	$wa™fÜblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

319 
RPCH–pMª
{"waitforblock",

323 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Block hasho wait for."},

324 {"timeout", 
RPCArg
::
Ty³
::
NUM
, "0", "Time in millisecondso wait for‡„esponse. 0 indicates‚oimeout."},

326 
RPCResuÉ
{

327 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

329 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "The blockhash"},

330 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "Block height"},

332 
RPCExam¶es
{

333 
	`H–pExam¶eCli
("waitforblock", "\"0000000000079f8ef3d2c688c244eb7a4570b24c9ed7b4a8c619eb02596f8862\" 1000")

334 + 
	`H–pExam¶eRpc
("waitforblock", "\"0000000000079f8ef3d2c688c244eb7a4570b24c9ed7b4a8c619eb02596f8862\", 1000")

336 }.
	`Check
(
»que¡
);

337 
timeout
 = 0;

339 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash"));

341 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

342 
timeout
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

344 
CUpd©edBlock
 
block
;

346 
	`WAIT_LOCK
(
cs_blockchªge
, 
lock
);

347 if(
timeout
)

348 
cÚd_blockchªge
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`mli£cÚds
(
timeout
), [&
hash
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.hash =ğhash || !
	`IsRPCRuÂšg
();});

350 
cÚd_blockchªge
.
	`wa™
(
lock
, [&
hash
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.hash =ğhash || !
	`IsRPCRuÂšg
(); });

351 
block
 = 
Ï‹¡block
;

354 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

355 
»t
.
	`pushKV
("hash", 
block
.
hash
.
	`G‘Hex
());

356 
»t
.
	`pushKV
("height", 
block
.
height
);

357  
»t
;

358 
	}
}

360 
UniV®ue
 
	$wa™fÜblockheight
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

362 
RPCH–pMª
{"waitforblockheight",

367 {"height", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "Block heighto wait for."},

368 {"timeout", 
RPCArg
::
Ty³
::
NUM
, "0", "Time in millisecondso wait for‡„esponse. 0 indicates‚oimeout."},

370 
RPCResuÉ
{

371 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

373 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "The blockhash"},

374 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "Block height"},

376 
RPCExam¶es
{

377 
	`H–pExam¶eCli
("waitforblockheight", "100 1000")

378 + 
	`H–pExam¶eRpc
("waitforblockheight", "100, 1000")

380 }.
	`Check
(
»que¡
);

381 
timeout
 = 0;

383 
height
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

385 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

386 
timeout
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

388 
CUpd©edBlock
 
block
;

390 
	`WAIT_LOCK
(
cs_blockchªge
, 
lock
);

391 if(
timeout
)

392 
cÚd_blockchªge
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`mli£cÚds
(
timeout
), [&
height
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.heighˆ>ğheighˆ|| !
	`IsRPCRuÂšg
();});

394 
cÚd_blockchªge
.
	`wa™
(
lock
, [&
height
](è
	`EXCLUSIVE_LOCKS_REQUIRED
(
cs_blockchªge
è{ 
Ï‹¡block
.heighˆ>ğheighˆ|| !
	`IsRPCRuÂšg
(); });

395 
block
 = 
Ï‹¡block
;

397 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

398 
»t
.
	`pushKV
("hash", 
block
.
hash
.
	`G‘Hex
());

399 
»t
.
	`pushKV
("height", 
block
.
height
);

400  
»t
;

401 
	}
}

403 
UniV®ue
 
	$syncw™hv®id©iÚš‹rçûqueue
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

405 
RPCH–pMª
{"syncwithvalidationinterfacequeue",

408 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

409 
RPCExam¶es
{

410 
	`H–pExam¶eCli
("syncwithvalidationinterfacequeue","")

411 + 
	`H–pExam¶eRpc
("syncwithvalidationinterfacequeue","")

413 }.
	`Check
(
»que¡
);

415 
	`SyncW™hV®id©iÚIÁ”çûQueue
();

416  
NuÎUniV®ue
;

417 
	}
}

419 
UniV®ue
 
	$g‘difficuÉy
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

421 
RPCH–pMª
{"getdifficulty",

424 
RPCResuÉ
{

425 
RPCResuÉ
::
Ty³
::
NUM
, "", "the…roof-of-work difficulty‡s‡ multiple ofhe minimum difficulty."},

426 
RPCExam¶es
{

427 
	`H–pExam¶eCli
("getdifficulty", "")

428 + 
	`H–pExam¶eRpc
("getdifficulty", "")

430 }.
	`Check
(
»que¡
);

432 
	`LOCK
(
cs_maš
);

433  
	`G‘DifficuÉy
(::
	`ChašAùive
().
	`T
());

434 
	}
}

436 
	g¡d
::
veùÜ
<
RPCResuÉ
> 
	$MempoŞEÁryDesütiÚ
() {  {

437 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "vsize", "virtualransaction size‡s defined in BIP 141. This is different from‡ctual serialized size for witnessransactions‡s witness data is discounted."},

438 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "weight", "transaction weight‡s defined in BIP 141."},

439 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "ãe", "Œª§ùiÚ f“ iÀ" + 
CURRENCY_UNIT
 + " (DEPRECATED)"},

440 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "modifiedfee", "transaction fee with fee deltas used for mining…riority (DEPRECATED)"},

441 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM_TIME
, "time", "localimeransactionƒntered…ool in seconds since 1 Jan 1970 GMT"},

442 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "height", "block height whenransactionƒntered…ool"},

443 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "descendantcount", "number of in-mempool descendantransactions (includinghis one)"},

444 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "descendantsize", "virtualransaction size of in-mempool descendants (includinghis one)"},

445 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "descendantfees", "modified fees (see‡bove) of in-mempool descendants (includinghis one) (DEPRECATED)"},

446 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "ancestorcount", "number of in-mempool‡ncestorransactions (includinghis one)"},

447 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NUM
, "ancestorsize", "virtualransaction size of in-mempool‡ncestors (includinghis one)"},

448 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "ancestorfees", "modified fees (see‡bove) of in-mempool‡ncestors (includinghis one) (DEPRECATED)"},

449 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_HEX
, "wtxid", "hash of serializedransaction, including witness data"},

450 
RPCResuÉ
{RPCResuÉ::
Ty³
::
OBJ
, "fees", "",

452 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "ba£", "Œª§ùiÚ f“ iÀ" + 
CURRENCY_UNIT
},

453 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "modif›d", "Œª§ùiÚ f“ w™h f“ d– u£d fÜ mššg…riÜ™y iÀ" + 
CURRENCY_UNIT
},

454 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "ªû¡Ü", "modif›d f“ (£aboveèoàš-mempoŞ‡nû¡Ü (šşudšghi Úeèš " + 
CURRENCY_UNIT
},

455 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_AMOUNT
, "desûndªt", "modif›d f“ (£aboveèoàš-mempoŞ desûndªt (šşudšghi Úeèš " + 
CURRENCY_UNIT
},

457 
RPCResuÉ
{RPCResuÉ::
Ty³
::
ARR
, "depends", "unconfirmedransactions used‡s inputs forhisransaction",

458 {
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_HEX
, "transactionid", "parentransaction id"}}},

459 
RPCResuÉ
{RPCResuÉ::
Ty³
::
ARR
, "spentby", "unconfirmedransactions spending outputs fromhisransaction",

460 {
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR_HEX
, "transactionid", "childransaction id"}}},

461 
RPCResuÉ
{RPCResuÉ::
Ty³
::
BOOL
, "bip125-replaceable", "Whetherhisransaction could be„eplaced dueo BIP125 (replace-by-fee)"},

462 
RPCResuÉ
{RPCResuÉ::
Ty³
::
BOOL
, "unbroadcast", "Whetherhisransaction is currently unbroadcast (initial broadcast‚ot yet‡cknowledged by‡ny…eers)"},

463 };
	}
}

465 
	$’ŒyToJSON
(cÚ¡ 
CTxMemPoŞ
& 
poŞ
, 
UniV®ue
& 
šfo
, cÚ¡ 
CTxMemPoŞEÁry
& 
e
è
	$EXCLUSIVE_LOCKS_REQUIRED
(
poŞ
.
cs
)

467 
	`As£¹LockH–d
(
poŞ
.
cs
);

469 
UniV®ue
 
	`ães
(UniV®ue::
VOBJ
);

470 
ães
.
	`pushKV
("ba£", 
	`V®ueFromAmouÁ
(
e
.
	`G‘F“
()));

471 
ães
.
	`pushKV
("modif›d", 
	`V®ueFromAmouÁ
(
e
.
	`G‘Modif›dF“
()));

472 
ães
.
	`pushKV
("ªû¡Ü", 
	`V®ueFromAmouÁ
(
e
.
	`G‘ModF“sW™hAnû¡Üs
()));

473 
ães
.
	`pushKV
("desûndªt", 
	`V®ueFromAmouÁ
(
e
.
	`G‘ModF“sW™hDesûndªts
()));

474 
šfo
.
	`pushKV
("ães", 
ães
);

476 
šfo
.
	`pushKV
("vsize", ()
e
.
	`G‘TxSize
());

477 
šfo
.
	`pushKV
("weight", ()
e
.
	`G‘TxWeight
());

478 
šfo
.
	`pushKV
("ãe", 
	`V®ueFromAmouÁ
(
e
.
	`G‘F“
()));

479 
šfo
.
	`pushKV
("modif›dãe", 
	`V®ueFromAmouÁ
(
e
.
	`G‘Modif›dF“
()));

480 
šfo
.
	`pushKV
("time", 
	`couÁ_£cÚds
(
e
.
	`G‘Time
()));

481 
šfo
.
	`pushKV
("height", ()
e
.
	`G‘Height
());

482 
šfo
.
	`pushKV
("desûndªtcouÁ", 
e
.
	`G‘CouÁW™hDesûndªts
());

483 
šfo
.
	`pushKV
("desûndªtsize", 
e
.
	`G‘SizeW™hDesûndªts
());

484 
šfo
.
	`pushKV
("desûndªtães", 
e
.
	`G‘ModF“sW™hDesûndªts
());

485 
šfo
.
	`pushKV
("ªû¡ÜcouÁ", 
e
.
	`G‘CouÁW™hAnû¡Üs
());

486 
šfo
.
	`pushKV
("ªû¡Üsize", 
e
.
	`G‘SizeW™hAnû¡Üs
());

487 
šfo
.
	`pushKV
("ªû¡Üães", 
e
.
	`G‘ModF“sW™hAnû¡Üs
());

488 
šfo
.
	`pushKV
("wtxid", 
poŞ
.
vTxHashes
[
e
.
vTxHashesIdx
].
fœ¡
.
	`ToSŒšg
());

489 cÚ¡ 
CT¿n§ùiÚ
& 
tx
 = 
e
.
	`G‘Tx
();

490 
¡d
::
£t
<¡d::
¡ršg
> 
£tD•’ds
;

491 cÚ¡ 
CTxIn
& 
txš
 : 
tx
.
vš
)

493 ià(
poŞ
.
	`exi¡s
(
txš
.
´evout
.
hash
))

494 
£tD•’ds
.
	`š£¹
(
txš
.
´evout
.
hash
.
	`ToSŒšg
());

497 
UniV®ue
 
	`d•’ds
(UniV®ue::
VARR
);

498 cÚ¡ 
¡d
::
¡ršg
& 
d•
 : 
£tD•’ds
)

500 
d•’ds
.
	`push_back
(
d•
);

503 
šfo
.
	`pushKV
("d•’ds", 
d•’ds
);

505 
UniV®ue
 
	`¥’t
(UniV®ue::
VARR
);

506 cÚ¡ 
CTxMemPoŞ
::
tx™”
& 
™
 = 
poŞ
.
m­Tx
.
	`fšd
(
tx
.
	`G‘Hash
());

507 cÚ¡ 
CTxMemPoŞ
::
£tEÁr›s
& 
£tChd»n
 = 
poŞ
.
	`G‘MemPoŞChd»n
(
™
);

508 
CTxMemPoŞ
::
tx™”
 
chd™”
 : 
£tChd»n
) {

509 
¥’t
.
	`push_back
(
chd™”
->
	`G‘Tx
().
	`G‘Hash
().
	`ToSŒšg
());

512 
šfo
.
	`pushKV
("¥’tby", 
¥’t
);

515 
boŞ
 
rbfStus
 = 
çl£
;

516 
RBFT¿n§ùiÚS‹
 
rbfS‹
 = 
	`IsRBFO±In
(
tx
, 
poŞ
);

517 ià(
rbfS‹
 =ğ
RBFT¿n§ùiÚS‹
::
UNKNOWN
) {

518 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Transaction is‚ot in mempool");

519 } ià(
rbfS‹
 =ğ
RBFT¿n§ùiÚS‹
::
REPLACEABLE_BIP125
) {

520 
rbfStus
 = 
Œue
;

523 
šfo
.
	`pushKV
("b125-»¶aûabË", 
rbfStus
);

524 
šfo
.
	`pushKV
("unbrßdÿ¡", 
poŞ
.
	`IsUnbrßdÿ¡Tx
(
tx
.
	`G‘Hash
()));

525 
	}
}

527 
UniV®ue
 
	$MempoŞToJSON
(cÚ¡ 
CTxMemPoŞ
& 
poŞ
, 
boŞ
 
v”bo£
)

529 ià(
v”bo£
) {

530 
	`LOCK
(
poŞ
.
cs
);

531 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

532 cÚ¡ 
CTxMemPoŞEÁry
& 
e
 : 
poŞ
.
m­Tx
) {

533 cÚ¡ 
ušt256
& 
hash
 = 
e
.
	`G‘Tx
().
	`G‘Hash
();

534 
UniV®ue
 
	`šfo
(UniV®ue::
VOBJ
);

535 
	`’ŒyToJSON
(
poŞ
, 
šfo
, 
e
);

539 
o
.
	`__pushKV
(
hash
.
	`ToSŒšg
(), 
šfo
);

541  
o
;

543 
¡d
::
veùÜ
<
ušt256
> 
vtxid
;

544 
poŞ
.
	`qu”yHashes
(
vtxid
);

546 
UniV®ue
 
	`a
(UniV®ue::
VARR
);

547 cÚ¡ 
ušt256
& 
hash
 : 
vtxid
)

548 
a
.
	`push_back
(
hash
.
	`ToSŒšg
());

550  
a
;

552 
	}
}

554 
UniV®ue
 
	$g‘¿wmempoŞ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

556 
RPCH–pMª
{"getrawmempool",

560 {"v”bo£", 
RPCArg
::
Ty³
::
BOOL
, "false", "True for‡ json object, false for‡rray ofransaction ids"},

563 
RPCResuÉ
{"for verbose = false",

564 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

566 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Theransaction id"},

568 
RPCResuÉ
{"for verbose =rue",

569 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

571 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "Œª§ùiÚid", "", 
	`MempoŞEÁryDesütiÚ
()},

574 
RPCExam¶es
{

575 
	`H–pExam¶eCli
("getrawmempool", "true")

576 + 
	`H–pExam¶eRpc
("getrawmempool", "true")

578 }.
	`Check
(
»que¡
);

580 
boŞ
 
fV”bo£
 = 
çl£
;

581 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
())

582 
fV”bo£
 = 
»que¡
.
·¿ms
[0].
	`g‘_boŞ
();

584  
	`MempoŞToJSON
(
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
), 
fV”bo£
);

585 
	}
}

587 
UniV®ue
 
	$g‘mempoŞªû¡Üs
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

589 
RPCH–pMª
{"getmempoolancestors",

592 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id (must be in mempool)"},

593 {"v”bo£", 
RPCArg
::
Ty³
::
BOOL
, "false", "True for‡ json object, false for‡rray ofransaction ids"},

596 
RPCResuÉ
{"for verbose = false",

597 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

598 {{
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Theransaction id of‡n in-mempool‡ncestorransaction"}}},

599 
RPCResuÉ
{"for verbose =rue",

600 
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "Œª§ùiÚid", "", 
	`MempoŞEÁryDesütiÚ
()},

602 
RPCExam¶es
{

603 
	`H–pExam¶eCli
("getmempoolancestors", "\"mytxid\"")

604 + 
	`H–pExam¶eRpc
("getmempoolancestors", "\"mytxid\"")

606 }.
	`Check
(
»que¡
);

608 
boŞ
 
fV”bo£
 = 
çl£
;

609 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

610 
fV”bo£
 = 
»que¡
.
·¿ms
[1].
	`g‘_boŞ
();

612 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "parameter 1");

614 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

615 
	`LOCK
(
mempoŞ
.
cs
);

617 
CTxMemPoŞ
::
tx™”
 
™
 = 
mempoŞ
.
m­Tx
.
	`fšd
(
hash
);

618 ià(
™
 =ğ
mempoŞ
.
m­Tx
.
	`’d
()) {

619 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Transaction‚ot in mempool");

622 
CTxMemPoŞ
::
£tEÁr›s
 
£tAnû¡Üs
;

623 
ušt64_t
 
noLim™
 = 
¡d
::
num”ic_lim™s
<ušt64_t>::
	`max
();

624 
¡d
::
¡ršg
 
dummy
;

625 
mempoŞ
.
	`C®cuÏ‹MemPoŞAnû¡Üs
(*
™
, 
£tAnû¡Üs
, 
noLim™
,‚oLim™,‚oLim™,‚oLim™, 
dummy
, 
çl£
);

627 ià(!
fV”bo£
) {

628 
UniV®ue
 
	`o
(UniV®ue::
VARR
);

629 
CTxMemPoŞ
::
tx™”
 
ªû¡ÜIt
 : 
£tAnû¡Üs
) {

630 
o
.
	`push_back
(
ªû¡ÜIt
->
	`G‘Tx
().
	`G‘Hash
().
	`ToSŒšg
());

633  
o
;

635 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

636 
CTxMemPoŞ
::
tx™”
 
ªû¡ÜIt
 : 
£tAnû¡Üs
) {

637 cÚ¡ 
CTxMemPoŞEÁry
 &
e
 = *
ªû¡ÜIt
;

638 cÚ¡ 
ušt256
& 
_hash
 = 
e
.
	`G‘Tx
().
	`G‘Hash
();

639 
UniV®ue
 
	`šfo
(UniV®ue::
VOBJ
);

640 
	`’ŒyToJSON
(
mempoŞ
, 
šfo
, 
e
);

641 
o
.
	`pushKV
(
_hash
.
	`ToSŒšg
(), 
šfo
);

643  
o
;

645 
	}
}

647 
UniV®ue
 
	$g‘mempoŞdesûndªts
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

649 
RPCH–pMª
{"getmempooldescendants",

652 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id (must be in mempool)"},

653 {"v”bo£", 
RPCArg
::
Ty³
::
BOOL
, "false", "True for‡ json object, false for‡rray ofransaction ids"},

656 
RPCResuÉ
{"for verbose = false",

657 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

658 {{
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Theransaction id of‡n in-mempool descendantransaction"}}},

659 
RPCResuÉ
{"for verbose =rue",

660 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

662 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "Œª§ùiÚid", "", 
	`MempoŞEÁryDesütiÚ
()},

665 
RPCExam¶es
{

666 
	`H–pExam¶eCli
("getmempooldescendants", "\"mytxid\"")

667 + 
	`H–pExam¶eRpc
("getmempooldescendants", "\"mytxid\"")

669 }.
	`Check
(
»que¡
);

671 
boŞ
 
fV”bo£
 = 
çl£
;

672 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

673 
fV”bo£
 = 
»que¡
.
·¿ms
[1].
	`g‘_boŞ
();

675 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "parameter 1");

677 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

678 
	`LOCK
(
mempoŞ
.
cs
);

680 
CTxMemPoŞ
::
tx™”
 
™
 = 
mempoŞ
.
m­Tx
.
	`fšd
(
hash
);

681 ià(
™
 =ğ
mempoŞ
.
m­Tx
.
	`’d
()) {

682 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Transaction‚ot in mempool");

685 
CTxMemPoŞ
::
£tEÁr›s
 
£tDesûndªts
;

686 
mempoŞ
.
	`C®cuÏ‹Desûndªts
(
™
, 
£tDesûndªts
);

688 
£tDesûndªts
.
	`”a£
(
™
);

690 ià(!
fV”bo£
) {

691 
UniV®ue
 
	`o
(UniV®ue::
VARR
);

692 
CTxMemPoŞ
::
tx™”
 
desûndªtIt
 : 
£tDesûndªts
) {

693 
o
.
	`push_back
(
desûndªtIt
->
	`G‘Tx
().
	`G‘Hash
().
	`ToSŒšg
());

696  
o
;

698 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

699 
CTxMemPoŞ
::
tx™”
 
desûndªtIt
 : 
£tDesûndªts
) {

700 cÚ¡ 
CTxMemPoŞEÁry
 &
e
 = *
desûndªtIt
;

701 cÚ¡ 
ušt256
& 
_hash
 = 
e
.
	`G‘Tx
().
	`G‘Hash
();

702 
UniV®ue
 
	`šfo
(UniV®ue::
VOBJ
);

703 
	`’ŒyToJSON
(
mempoŞ
, 
šfo
, 
e
);

704 
o
.
	`pushKV
(
_hash
.
	`ToSŒšg
(), 
šfo
);

706  
o
;

708 
	}
}

710 
UniV®ue
 
	$g‘mempoŞ’Œy
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

712 
RPCH–pMª
{"getmempoolentry",

715 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id (must be in mempool)"},

717 
RPCResuÉ
{

718 
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "", "", 
	`MempoŞEÁryDesütiÚ
()},

719 
RPCExam¶es
{

720 
	`H–pExam¶eCli
("getmempoolentry", "\"mytxid\"")

721 + 
	`H–pExam¶eRpc
("getmempoolentry", "\"mytxid\"")

723 }.
	`Check
(
»que¡
);

725 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "parameter 1");

727 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

728 
	`LOCK
(
mempoŞ
.
cs
);

730 
CTxMemPoŞ
::
tx™”
 
™
 = 
mempoŞ
.
m­Tx
.
	`fšd
(
hash
);

731 ià(
™
 =ğ
mempoŞ
.
m­Tx
.
	`’d
()) {

732 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Transaction‚ot in mempool");

735 cÚ¡ 
CTxMemPoŞEÁry
 &
e
 = *
™
;

736 
UniV®ue
 
	`šfo
(UniV®ue::
VOBJ
);

737 
	`’ŒyToJSON
(
mempoŞ
, 
šfo
, 
e
);

738  
šfo
;

739 
	}
}

741 
UniV®ue
 
	$g‘blockhash
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

743 
RPCH–pMª
{"getblockhash",

746 {"height", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The height index"},

748 
RPCResuÉ
{

749 
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "The block hash"},

750 
RPCExam¶es
{

751 
	`H–pExam¶eCli
("getblockhash", "1000")

752 + 
	`H–pExam¶eRpc
("getblockhash", "1000")

754 }.
	`Check
(
»que¡
);

756 
	`LOCK
(
cs_maš
);

758 
nHeight
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

759 ià(
nHeight
 < 0 ||‚Heighˆ> ::
	`ChašAùive
().
	`Height
())

760 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Block height out of„ange");

762 
CBlockIndex
* 
pblockšdex
 = ::
	`ChašAùive
()[
nHeight
];

763  
pblockšdex
->
	`G‘BlockHash
().
	`G‘Hex
();

764 
	}
}

766 
UniV®ue
 
	$g‘blockh—d”
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

768 
RPCH–pMª
{"getblockheader",

772 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The block hash"},

773 {"v”bo£", 
RPCArg
::
Ty³
::
BOOL
, "true", "true for‡ json object, false forhe hex-encoded data"},

776 
RPCResuÉ
{"for verbose =rue",

777 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

779 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "the block hash (same‡s…rovided)"},

780 {
RPCResuÉ
::
Ty³
::
NUM
, "confirmations", "The‚umber of confirmations, or -1 ifhe block is‚ot onhe main chain"},

781 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The block height or index"},

782 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The block version"},

783 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "versionHex", "The block version formatted in hexadecimal"},

784 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "merkleroot", "The merkle„oot"},

785 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "time", "Thblockimex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

786 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "medŸÁime", "ThmedŸÀblockimex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

787 {
RPCResuÉ
::
Ty³
::
NUM
, "nonce", "The‚once"},

788 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "bits", "The bits"},

789 {
RPCResuÉ
::
Ty³
::
NUM
, "difficulty", "The difficulty"},

790 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "chainwork", "Expected‚umber of hashes„equiredo…roducehe current chain"},

791 {
RPCResuÉ
::
Ty³
::
NUM
, "nTx", "The‚umber ofransactions inhe block"},

792 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "previousblockhash", "The hash ofhe…revious block"},

793 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "nextblockhash", "The hash ofhe‚ext block"},

795 
RPCResuÉ
{"for verbose=false",

796 
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "A stringhat is serialized, hex-encoded data for block 'hash'"},

798 
RPCExam¶es
{

799 
	`H–pExam¶eCli
("getblockheader", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"")

800 + 
	`H–pExam¶eRpc
("getblockheader", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"")

802 }.
	`Check
(
»que¡
);

804 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "hash"));

806 
boŞ
 
fV”bo£
 = 
Œue
;

807 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

808 
fV”bo£
 = 
»que¡
.
·¿ms
[1].
	`g‘_boŞ
();

810 cÚ¡ 
CBlockIndex
* 
pblockšdex
;

811 cÚ¡ 
CBlockIndex
* 
t
;

813 
	`LOCK
(
cs_maš
);

814 
pblockšdex
 = 
	`LookupBlockIndex
(
hash
);

815 
t
 = ::
	`ChašAùive
().
	`T
();

818 ià(!
pblockšdex
) {

819 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

822 ià(!
fV”bo£
)

824 
CD©aSŒ—m
 
	`ssBlock
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

825 
ssBlock
 << 
pblockšdex
->
	`G‘BlockH—d”
(
	`P¬ams
().
	`G‘CÚ£nsus
());

826 
¡d
::
¡ršg
 
¡rHex
 = 
	`HexSŒ
(
ssBlock
.
	`begš
(), ssBlock.
	`’d
());

827  
¡rHex
;

830  
	`blockh—d”ToJSON
(
t
, 
pblockšdex
);

831 
	}
}

833 
CBlock
 
	$G‘BlockChecked
(cÚ¡ 
CBlockIndex
* 
pblockšdex
)

835 
CBlock
 
block
;

836 ià(
	`IsBlockPruÃd
(
pblockšdex
)) {

837 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Block‚ot‡vailable (pruned data)");

840 ià(!
	`R—dBlockFromDisk
(
block
, 
pblockšdex
, 
	`P¬ams
().
	`G‘CÚ£nsus
())) {

846 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Block‚ot found on disk");

849  
block
;

850 
	}
}

852 
CBlockUndo
 
	$G‘UndoChecked
(cÚ¡ 
CBlockIndex
* 
pblockšdex
)

854 
CBlockUndo
 
blockUndo
;

855 ià(
	`IsBlockPruÃd
(
pblockšdex
)) {

856 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Undo data‚ot‡vailable (pruned data)");

859 ià(!
	`UndoR—dFromDisk
(
blockUndo
, 
pblockšdex
)) {

860 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Can't„ead undo data from disk");

863  
blockUndo
;

864 
	}
}

866 
UniV®ue
 
	$g‘block
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

868 
RPCH–pMª
{"getblock",

873 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The block hash"},

874 {"v”bos™y|v”bo£", 
RPCArg
::
Ty³
::
NUM
, "1", "0 for hex-encoded data, 1 for‡ json object,‡nd 2 for json object withransaction data"},

877 
RPCResuÉ
{"for verbosity = 0",

878 
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "A stringhat is serialized, hex-encoded data for block 'hash'"},

879 
RPCResuÉ
{"for verbosity = 1",

880 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

882 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "the block hash (same‡s…rovided)"},

883 {
RPCResuÉ
::
Ty³
::
NUM
, "confirmations", "The‚umber of confirmations, or -1 ifhe block is‚ot onhe main chain"},

884 {
RPCResuÉ
::
Ty³
::
NUM
, "size", "The block size"},

885 {
RPCResuÉ
::
Ty³
::
NUM
, "strippedsize", "The block sizeƒxcluding witness data"},

886 {
RPCResuÉ
::
Ty³
::
NUM
, "weight", "The block weight‡s defined in BIP 141"},

887 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The block height or index"},

888 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The block version"},

889 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "versionHex", "The block version formatted in hexadecimal"},

890 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "merkleroot", "The merkle„oot"},

891 {
RPCResuÉ
::
Ty³
::
ARR
, "tx", "Theransaction ids",

892 {{
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Theransaction id"}}},

893 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "time", "Thblockimex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

894 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "medŸÁime", "ThmedŸÀblockimex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

895 {
RPCResuÉ
::
Ty³
::
NUM
, "nonce", "The‚once"},

896 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "bits", "The bits"},

897 {
RPCResuÉ
::
Ty³
::
NUM
, "difficulty", "The difficulty"},

898 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "chainwork", "Expected‚umber of hashes„equiredo…roducehe chain upohis block (in hex)"},

899 {
RPCResuÉ
::
Ty³
::
NUM
, "nTx", "The‚umber ofransactions inhe block"},

900 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "previousblockhash", "The hash ofhe…revious block"},

901 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "nextblockhash", "The hash ofhe‚ext block"},

902 {
RPCResuÉ
::
Ty³
::
OBJ
, "auxpow", "The‡uxpow object‡ttachedohis block",

904 {
RPCResuÉ
::
Ty³
::
OBJ
, "tx", "The…arent chain coinbasex ofhis‡uxpow",

906 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

908 {
RPCResuÉ
::
Ty³
::
NUM
, "index", "Merkle index ofhe…arent coinbase"},

909 {
RPCResuÉ
::
Ty³
::
ARR
, "merklebranch", "Merkle branch's ofhe…arent coinbase",

910 {{
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Merkle branch"}}},

911 {
RPCResuÉ
::
Ty³
::
NUM
, "chainindex", "Index inhe‡uxpow Merkleree"},

912 {
RPCResuÉ
::
Ty³
::
ARR
, "chainmerklebranch", "Branch's inhe‡uxpow Merkleree",

913 {{
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "auxpow branch"}}},

914 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "parentblock", "The…arent block serialised‡s hex string"},

917 
RPCResuÉ
{"for verbosity = 2",

918 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

920 {
RPCResuÉ
::
Ty³
::
ELISION
, "", "Same output‡s verbosity = 1"},

921 {
RPCResuÉ
::
Ty³
::
ARR
, "tx", "",

923 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

925 {
RPCResuÉ
::
Ty³
::
ELISION
, "", "Theransactions inhe format ofhe getrawtransaction RPC. Different from verbosity = 1 \"tx\"„esult"},

928 {
RPCResuÉ
::
Ty³
::
ELISION
, "", "Same output‡s verbosity = 1"},

931 
RPCExam¶es
{

932 
	`H–pExam¶eCli
("getblock", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"")

933 + 
	`H–pExam¶eRpc
("getblock", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\"")

935 }.
	`Check
(
»que¡
);

937 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash"));

939 
v”bos™y
 = 1;

940 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

941 if(
»que¡
.
·¿ms
[1].
	`isNum
())

942 
v”bos™y
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

944 
v”bos™y
 = 
»que¡
.
·¿ms
[1].
	`g‘_boŞ
() ? 1 : 0;

947 
CBlock
 
block
;

948 cÚ¡ 
CBlockIndex
* 
pblockšdex
;

949 cÚ¡ 
CBlockIndex
* 
t
;

951 
	`LOCK
(
cs_maš
);

952 
pblockšdex
 = 
	`LookupBlockIndex
(
hash
);

953 
t
 = ::
	`ChašAùive
().
	`T
();

955 ià(!
pblockšdex
) {

956 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

959 
block
 = 
	`G‘BlockChecked
(
pblockšdex
);

962 ià(
v”bos™y
 <= 0)

964 
CD©aSŒ—m
 
	`ssBlock
(
SER_NETWORK
, 
PROTOCOL_VERSION
 | 
	`RPCS”Ÿliz©iÚFÏgs
());

965 
ssBlock
 << 
block
;

966 
¡d
::
¡ršg
 
¡rHex
 = 
	`HexSŒ
(
ssBlock
.
	`begš
(), ssBlock.
	`’d
());

967  
¡rHex
;

970  
	`blockToJSON
(
block
, 
t
, 
pblockšdex
, 
v”bos™y
 >= 2);

971 
	}
}

973 
UniV®ue
 
	$´uÃblockchaš
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

975 
RPCH–pMª
{"pruneblockchain", "",

977 {"height", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "Thblock heighˆtØ´uÃ u°to. May b£ˆtØ¨disü‘height, o¸tØ¨" + 
UNIX_EPOCH_TIME
 + "\n"

980 
RPCResuÉ
{

981 
RPCResuÉ
::
Ty³
::
NUM
, "", "Height ofhe†ast block…runed"},

982 
RPCExam¶es
{

983 
	`H–pExam¶eCli
("pruneblockchain", "1000")

984 + 
	`H–pExam¶eRpc
("pruneblockchain", "1000")

986 }.
	`Check
(
»que¡
);

988 ià(!
fPruÃMode
)

989 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Cannot…rune blocks because‚ode is‚ot in…rune mode.");

991 
	`LOCK
(
cs_maš
);

993 
heightP¬am
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

994 ià(
heightP¬am
 < 0)

995 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Negative block height.");

999 ià(
heightP¬am
 > 1000000000) {

1001 
CBlockIndex
* 
pšdex
 = ::
	`ChašAùive
().
	`FšdE¬l›¡AtL—¡
(
heightP¬am
 - 
TIMESTAMP_WINDOW
, 0);

1002 ià(!
pšdex
) {

1003 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Could‚ot find block with‡t†easthe specifiedimestamp.");

1005 
heightP¬am
 = 
pšdex
->
nHeight
;

1008 
height
 = (è
heightP¬am
;

1009 
chašHeight
 = (è::
	`ChašAùive
().
	`Height
();

1010 ià(
chašHeight
 < 
	`P¬ams
().
	`PruÃAá”Height
())

1011 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Blockchain isoo short for…runing.");

1012 ià(
height
 > 
chašHeight
)

1013 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Blockchain is shorterhanhe‡ttempted…rune height.");

1014 ià(
height
 > 
chašHeight
 - 
MIN_BLOCKS_TO_KEEP
) {

1015 
	`LogPršt
(
BCLog
::
RPC
, "Attempto…rune blocks closeoheip. Retaininghe minimum‚umber of blocks.\n");

1016 
height
 = 
chašHeight
 - 
MIN_BLOCKS_TO_KEEP
;

1019 
	`PruÃBlockFesMªu®
(
height
);

1020 cÚ¡ 
CBlockIndex
* 
block
 = ::
	`ChašAùive
().
	`T
();

1021 
	`CHECK_NONFATAL
(
block
);

1022 
block
->
µ»v
 && (block->µ»v->
nStus
 & 
BLOCK_HAVE_DATA
)) {

1023 
block
 = block->
µ»v
;

1025  
	`ušt64_t
(
block
->
nHeight
);

1026 
	}
}

1028 
UniV®ue
 
	$g‘txout£tšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1030 
RPCH–pMª
{"gettxoutsetinfo",

1034 
RPCResuÉ
{

1035 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1037 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The current block height (index)"},

1038 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "bestblock", "The hash ofhe block‡theip ofhe chain"},

1039 {
RPCResuÉ
::
Ty³
::
NUM
, "transactions", "The‚umber ofransactions with unspent outputs"},

1040 {
RPCResuÉ
::
Ty³
::
NUM
, "txouts", "The‚umber of unspentransaction outputs"},

1041 {
RPCResuÉ
::
Ty³
::
NUM
, "bogosize", "A meaningless metric for UTXO set size"},

1042 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash_serialized_2", "The serialized hash"},

1043 {
RPCResuÉ
::
Ty³
::
NUM
, "disk_size", "Theƒstimated size ofhe chainstate on disk"},

1044 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "total_amount", "Theotal‡mount"},

1046 
RPCExam¶es
{

1047 
	`H–pExam¶eCli
("gettxoutsetinfo", "")

1048 + 
	`H–pExam¶eRpc
("gettxoutsetinfo", "")

1050 }.
	`Check
(
»que¡
);

1052 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1054 
CCošsSts
 
¡©s
;

1055 ::
	`Chaš¡©eAùive
().
	`FÜûFlushS‹ToDisk
();

1057 
CCošsV›w
* 
cošs_v›w
 = 
	`WITH_LOCK
(
cs_maš
,  &
	`Chaš¡©eAùive
().
	`CošsDB
());

1058 ià(
	`G‘UTXOSts
(
cošs_v›w
, 
¡©s
, 
RpcIÁ”ru±iÚPošt
)) {

1059 
»t
.
	`pushKV
("height", (
št64_t
)
¡©s
.
nHeight
);

1060 
»t
.
	`pushKV
("be¡block", 
¡©s
.
hashBlock
.
	`G‘Hex
());

1061 
»t
.
	`pushKV
("Œª§ùiÚs", (
št64_t
)
¡©s
.
nT¿n§ùiÚs
);

1062 
»t
.
	`pushKV
("txouts", (
št64_t
)
¡©s
.
nT¿n§ùiÚOuuts
);

1063 
»t
.
	`pushKV
("bogosize", (
št64_t
)
¡©s
.
nBogoSize
);

1064 
»t
.
	`pushKV
("hash_£rŸlized_2", 
¡©s
.
hashS”Ÿlized
.
	`G‘Hex
());

1065 
»t
.
	`pushKV
("disk_size", 
¡©s
.
nDiskSize
);

1066 
»t
.
	`pushKV
("tÙ®_amouÁ", 
	`V®ueFromAmouÁ
(
¡©s
.
nTÙ®AmouÁ
));

1068 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Unableo„ead UTXO set");

1070  
»t
;

1071 
	}
}

1073 
UniV®ue
 
	$g‘txout
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1075 
RPCH–pMª
{"gettxout",

1078 {"txid", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id"},

1079 {"n", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "vout‚umber"},

1080 {"šşude_mempoŞ", 
RPCArg
::
Ty³
::
BOOL
, "true", "Whethero includehe mempool. Notehat‡n unspent outputhat is spent inhe mempool won't‡ppear."},

1082 
RPCResuÉ
{

1083 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1085 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "bestblock", "The hash ofhe block‡theip ofhe chain"},

1086 {
RPCResuÉ
::
Ty³
::
NUM
, "confirmations", "The‚umber of confirmations"},

1087 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "v®ue", "ThŒª§ùiÚ v®uš " + 
CURRENCY_UNIT
},

1088 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptPubKey", "",

1090 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "asm", ""},

1091 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", ""},

1092 {
RPCResuÉ
::
Ty³
::
NUM
, "reqSigs", "Number of„equired signatures"},

1093 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "type", "Theype,ƒg…ubkeyhash"},

1094 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "array of syscoin‡ddresses",

1095 {{
RPCResuÉ
::
Ty³
::
STR
, "address", "syscoin‡ddress"}}},

1097 {
RPCResuÉ
::
Ty³
::
BOOL
, "coinbase", "Coinbase or‚ot"},

1099 
RPCExam¶es
{

1101 + 
	`H–pExam¶eCli
("listunspent", "") +

1103 + 
	`H–pExam¶eCli
("gettxout", "\"txid\" 1") +

1105 + 
	`H–pExam¶eRpc
("gettxout", "\"txid\", 1")

1107 }.
	`Check
(
»que¡
);

1109 
	`LOCK
(
cs_maš
);

1111 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1113 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "txid"));

1114 
n
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

1115 
COutPošt
 
	`out
(
hash
, 
n
);

1116 
boŞ
 
fMempoŞ
 = 
Œue
;

1117 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
())

1118 
fMempoŞ
 = 
»que¡
.
·¿ms
[2].
	`g‘_boŞ
();

1120 
Coš
 
coš
;

1121 
CCošsV›wCache
* 
cošs_v›w
 = &::
	`Chaš¡©eAùive
().
	`CošsT
();

1123 ià(
fMempoŞ
) {

1124 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

1125 
	`LOCK
(
mempoŞ
.
cs
);

1126 
CCošsV›wMemPoŞ
 
	`v›w
(
cošs_v›w
, 
mempoŞ
);

1127 ià(!
v›w
.
	`G‘Coš
(
out
, 
coš
è|| 
mempoŞ
.
	`isS³Á
(out)) {

1128  
NuÎUniV®ue
;

1131 ià(!
cošs_v›w
->
	`G‘Coš
(
out
, 
coš
)) {

1132  
NuÎUniV®ue
;

1136 cÚ¡ 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
cošs_v›w
->
	`G‘Be¡Block
());

1137 
»t
.
	`pushKV
("be¡block", 
pšdex
->
	`G‘BlockHash
().
	`G‘Hex
());

1138 ià(
coš
.
nHeight
 =ğ
MEMPOOL_HEIGHT
) {

1139 
»t
.
	`pushKV
("confirmations", 0);

1141 
»t
.
	`pushKV
("cÚfœm©iÚs", (
št64_t
)(
pšdex
->
nHeight
 - 
coš
.nHeight + 1));

1143 
»t
.
	`pushKV
("v®ue", 
	`V®ueFromAmouÁ
(
coš
.
out
.
nV®ue
));

1144 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

1145 
	`SütPubKeyToUniv
(
coš
.
out
.
sütPubKey
, 
o
, 
Œue
);

1146 
»t
.
	`pushKV
("sütPubKey", 
o
);

1147 
»t
.
	`pushKV
("cošba£", (
boŞ
)
coš
.
fCošBa£
);

1149  
»t
;

1150 
	}
}

1152 
UniV®ue
 
	$v”ifychaš
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1154 
RPCH–pMª
{"verifychain",

1157 {"checkËv–", 
RPCArg
::
Ty³
::
NUM
, 
	`¡½rštf
("%d,„ªge=0-4", 
DEFAULT_CHECKLEVEL
),

1158 
	`¡½rštf
("HowhÜoughhblock v”ifiÿtiÚ is:\À- %s", 
	`Još
(
CHECKLEVEL_DOC
, "\n- "))},

1159 {"nblocks", 
RPCArg
::
Ty³
::
NUM
, 
	`¡½rštf
("%d, 0÷Î", 
DEFAULT_CHECKBLOCKS
), "The‚umber of blockso check."},

1161 
RPCResuÉ
{

1162 
RPCResuÉ
::
Ty³
::
BOOL
, "", "Verified or‚ot"},

1163 
RPCExam¶es
{

1164 
	`H–pExam¶eCli
("verifychain", "")

1165 + 
	`H–pExam¶eRpc
("verifychain", "")

1167 }.
	`Check
(
»que¡
);

1169 cÚ¡ 
	`check_Ëv–
(
»que¡
.
·¿ms
[0].
	`isNuÎ
(è? 
DEFAULT_CHECKLEVEL
 :„eque¡.·¿ms[0].
	`g‘_št
());

1170 cÚ¡ 
check_d•th
{
»que¡
.
·¿ms
[1].
	`isNuÎ
(è? 
DEFAULT_CHECKBLOCKS
 :„eque¡.·¿ms[1].
	`g‘_št
()};

1172 
	`LOCK
(
cs_maš
);

1174  
	`CV”ifyDB
().
	`V”ifyDB
(
	`P¬ams
(), &::
	`Chaš¡©eAùive
().
	`CošsT
(), 
check_Ëv–
, 
check_d•th
);

1175 
	}
}

1177 
	$Bur›dFÜkDescPushBack
(
UniV®ue
& 
soáfÜks
, cÚ¡ 
¡d
::
¡ršg
 &
Çme
, 
height
è
	$EXCLUSIVE_LOCKS_REQUIRED
(
cs_maš
)

1184 ià(
height
 =ğ
¡d
::
num”ic_lim™s
<>::
	`max
()) ;

1186 
UniV®ue
 
	`rv
(UniV®ue::
VOBJ
);

1187 
rv
.
	`pushKV
("type", "buried");

1190 
rv
.
	`pushKV
("aùive", ::
	`ChašAùive
().
	`T
()->
nHeight
 + 1 >ğ
height
);

1191 
rv
.
	`pushKV
("height", 
height
);

1192 
soáfÜks
.
	`pushKV
(
Çme
, 
rv
);

1193 
	}
}

1195 
	$BIP9SoáFÜkDescPushBack
(
UniV®ue
& 
soáfÜks
, cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ 
CÚ£nsus
::
P¬ams
& 
cÚ£nsusP¬ams
, CÚ£nsus::
D•loym’tPos
 
id
è
	$EXCLUSIVE_LOCKS_REQUIRED
(
cs_maš
)

1201 ià(
cÚ£nsusP¬ams
.
vD•loym’ts
[
id
].
nTimeout
 <= 1230768000) ;

1203 
UniV®ue
 
	`b9
(UniV®ue::
VOBJ
);

1204 cÚ¡ 
Th»shŞdS‹
 
th»shŞdS‹
 = 
	`V”siÚB™sTS‹
(
cÚ£nsusP¬ams
, 
id
);

1205 
th»shŞdS‹
) {

1206 
Th»shŞdS‹
::
DEFINED
: 
b9
.
	`pushKV
("status", "defined"); ;

1207 
Th»shŞdS‹
::
STARTED
: 
b9
.
	`pushKV
("status", "started"); ;

1208 
Th»shŞdS‹
::
LOCKED_IN
: 
b9
.
	`pushKV
("status", "locked_in"); ;

1209 
Th»shŞdS‹
::
ACTIVE
: 
b9
.
	`pushKV
("status", "active"); ;

1210 
Th»shŞdS‹
::
FAILED
: 
b9
.
	`pushKV
("status", "failed"); ;

1212 ià(
Th»shŞdS‹
::
STARTED
 =ğ
th»shŞdS‹
)

1214 
b9
.
	`pushKV
("b™", 
cÚ£nsusP¬ams
.
vD•loym’ts
[
id
].
b™
);

1216 
b9
.
	`pushKV
("¡¬t_time", 
cÚ£nsusP¬ams
.
vD•loym’ts
[
id
].
nS¹Time
);

1217 
b9
.
	`pushKV
("timeout", 
cÚ£nsusP¬ams
.
vD•loym’ts
[
id
].
nTimeout
);

1218 
št64_t
 
sšû_height
 = 
	`V”siÚB™sTS‹SšûHeight
(
cÚ£nsusP¬ams
, 
id
);

1219 
b9
.
	`pushKV
("sšû", 
sšû_height
);

1220 ià(
Th»shŞdS‹
::
STARTED
 =ğ
th»shŞdS‹
)

1222 
UniV®ue
 
	`¡©sUV
(UniV®ue::
VOBJ
);

1223 
BIP9Sts
 
¡©sSŒuù
 = 
	`V”siÚB™sTSti¡ics
(
cÚ£nsusP¬ams
, 
id
);

1224 
¡©sUV
.
	`pushKV
("³riod", 
¡©sSŒuù
.
³riod
);

1225 
¡©sUV
.
	`pushKV
("th»shŞd", 
¡©sSŒuù
.
th»shŞd
);

1226 
¡©sUV
.
	`pushKV
("–­£d", 
¡©sSŒuù
.
–­£d
);

1227 
¡©sUV
.
	`pushKV
("couÁ", 
¡©sSŒuù
.
couÁ
);

1228 
¡©sUV
.
	`pushKV
("possibË", 
¡©sSŒuù
.
possibË
);

1229 
b9
.
	`pushKV
("¡©i¡ics", 
¡©sUV
);

1232 
UniV®ue
 
	`rv
(UniV®ue::
VOBJ
);

1233 
rv
.
	`pushKV
("type", "bip9");

1234 
rv
.
	`pushKV
("b9", 
b9
);

1235 ià(
Th»shŞdS‹
::
ACTIVE
 =ğ
th»shŞdS‹
) {

1236 
rv
.
	`pushKV
("height", 
sšû_height
);

1238 
rv
.
	`pushKV
("aùive", 
Th»shŞdS‹
::
ACTIVE
 =ğ
th»shŞdS‹
);

1240 
soáfÜks
.
	`pushKV
(
Çme
, 
rv
);

1241 
	}
}

1243 
UniV®ue
 
	$g‘blockchaššfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1245 
RPCH–pMª
{"getblockchaininfo",

1248 
RPCResuÉ
{

1249 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1251 {
RPCResuÉ
::
Ty³
::
STR
, "chain", "current‚etwork‚ame (main,est,„egtest)"},

1252 {
RPCResuÉ
::
Ty³
::
NUM
, "blocks", "the height ofhe most-work fully-validated chain. The genesis block has height 0"},

1253 {
RPCResuÉ
::
Ty³
::
NUM
, "headers", "the current‚umber of headers we have validated"},

1254 {
RPCResuÉ
::
Ty³
::
STR
, "bestblockhash", "the hash ofhe currently best block"},

1255 {
RPCResuÉ
::
Ty³
::
NUM
, "difficulty", "the current difficulty"},

1256 {
RPCResuÉ
::
Ty³
::
NUM
, "mediantime", "medianime forhe current best block"},

1257 {
RPCResuÉ
::
Ty³
::
NUM
, "verificationprogress", "estimate of verification…rogress [0..1]"},

1258 {
RPCResuÉ
::
Ty³
::
BOOL
, "initialblockdownload", "(debug information)ƒstimate of whetherhis‚ode is in Initial Block Download mode"},

1259 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "chainwork", "total‡mount of work in‡ctive chain, in hexadecimal"},

1260 {
RPCResuÉ
::
Ty³
::
NUM
, "size_on_disk", "theƒstimated size ofhe block‡nd undo files on disk"},

1261 {
RPCResuÉ
::
Ty³
::
BOOL
, "pruned", "ifhe blocks‡re subjecto…runing"},

1262 {
RPCResuÉ
::
Ty³
::
NUM
, "pruneheight", "lowest-height complete block stored (only…resent if…runing isƒnabled)"},

1263 {
RPCResuÉ
::
Ty³
::
BOOL
, "automatic_pruning", "whether‡utomatic…runing isƒnabled (only…resent if…runing isƒnabled)"},

1264 {
RPCResuÉ
::
Ty³
::
NUM
, "prune_target_size", "thearget size used by…runing (only…resent if‡utomatic…runing isƒnabled)"},

1265 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "softforks", "status of softforks",

1267 {
RPCResuÉ
::
Ty³
::
OBJ
, "xxxx", "name ofhe softfork",

1269 {
RPCResuÉ
::
Ty³
::
STR
, "type", "one of \"buried\", \"bip9\""},

1270 {
RPCResuÉ
::
Ty³
::
OBJ
, "bip9", "status of bip9 softforks (only for \"bip9\"ype)",

1272 {
RPCResuÉ
::
Ty³
::
STR
, "status", "one of \"defined\", \"started\", \"locked_in\", \"active\", \"failed\""},

1273 {
RPCResuÉ
::
Ty³
::
NUM
, "bit", "the bit (0-28) inhe block version field usedo signalhis softfork (only for \"started\" status)"},

1274 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "start_time", "the minimum medianime…ast of‡ block‡t whichhe bit gains its meaning"},

1275 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "timeout", "the medianime…ast of‡ block‡t whichhe deployment is considered failed if‚ot yet†ocked in"},

1276 {
RPCResuÉ
::
Ty³
::
NUM
, "since", "height ofhe first blocko whichhe status‡pplies"},

1277 {
RPCResuÉ
::
Ty³
::
OBJ
, "statistics", "numeric statistics‡bout BIP9 signalling for‡ softfork (only for \"started\" status)",

1279 {
RPCResuÉ
::
Ty³
::
NUM
, "period", "the†ength in blocks ofhe BIP9 signalling…eriod"},

1280 {
RPCResuÉ
::
Ty³
::
NUM
, "threshold", "the‚umber of blocks withhe version bit set„equiredo‡ctivatehe feature"},

1281 {
RPCResuÉ
::
Ty³
::
NUM
, "elapsed", "the‚umber of blocksƒlapsed sincehe beginning ofhe current…eriod"},

1282 {
RPCResuÉ
::
Ty³
::
NUM
, "count", "the‚umber of blocks withhe version bit set inhe current…eriod"},

1283 {
RPCResuÉ
::
Ty³
::
BOOL
, "possible", "returns false ifhere‡re‚otƒnough blocks†eft inhis…eriodo…ass‡ctivationhreshold"},

1286 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "height ofhe first block whichhe„ules‡re or will beƒnforced (only for \"buried\"ype, or \"bip9\"ype with \"active\" status)"},

1287 {
RPCResuÉ
::
Ty³
::
BOOL
, "active", "true ifhe„ules‡reƒnforced forhe mempool‡ndhe‚ext block"},

1290 {
RPCResuÉ
::
Ty³
::
STR
, "warnings", "any‚etwork‡nd blockchain warnings"},

1292 
RPCExam¶es
{

1293 
	`H–pExam¶eCli
("getblockchaininfo", "")

1294 + 
	`H–pExam¶eRpc
("getblockchaininfo", "")

1296 }.
	`Check
(
»que¡
);

1298 
	`LOCK
(
cs_maš
);

1300 cÚ¡ 
CBlockIndex
* 
t
 = ::
	`ChašAùive
().
	`T
();

1301 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

1302 
obj
.
	`pushKV
("chaš", 
	`P¬ams
().
	`N‘wÜkIDSŒšg
());

1303 
obj
.
	`pushKV
("blocks", ()::
	`ChašAùive
().
	`Height
());

1304 
obj
.
	`pushKV
("h—d”s", 
pšdexBe¡H—d”
 ?…šdexBe¡H—d”->
nHeight
 : -1);

1305 
obj
.
	`pushKV
("be¡blockhash", 
t
->
	`G‘BlockHash
().
	`G‘Hex
());

1306 
obj
.
	`pushKV
("difficuÉy", ()
	`G‘DifficuÉy
(
t
));

1307 
obj
.
	`pushKV
("medŸÁime", (
št64_t
)
t
->
	`G‘MedŸnTimePa¡
());

1308 
obj
.
	`pushKV
("v”ifiÿtiÚ´og»ss", 
	`GuessV”ifiÿtiÚProg»ss
(
	`P¬ams
().
	`TxD©a
(), 
t
));

1309 
obj
.
	`pushKV
("š™ŸlblockdowÆßd", ::
	`Chaš¡©eAùive
().
	`IsIn™ŸlBlockDowÆßd
());

1310 
obj
.
	`pushKV
("chašwÜk", 
t
->
nChašWÜk
.
	`G‘Hex
());

1311 
obj
.
	`pushKV
("size_Ú_disk", 
	`C®cuÏ‹Cu¼’tU§ge
());

1312 
obj
.
	`pushKV
("´uÃd", 
fPruÃMode
);

1313 ià(
fPruÃMode
) {

1314 cÚ¡ 
CBlockIndex
* 
block
 = 
t
;

1315 
	`CHECK_NONFATAL
(
block
);

1316 
block
->
µ»v
 && (block->µ»v->
nStus
 & 
BLOCK_HAVE_DATA
)) {

1317 
block
 = block->
µ»v
;

1320 
obj
.
	`pushKV
("´uÃheight", 
block
->
nHeight
);

1323 
boŞ
 
autom©ic_´unšg
 = (
gArgs
.
	`G‘Arg
("-prune", 0) != 1);

1324 
obj
.
	`pushKV
("autom©ic_´unšg", 
autom©ic_´unšg
);

1325 ià(
autom©ic_´unšg
) {

1326 
obj
.
	`pushKV
("´uÃ_rg‘_size", 
nPruÃT¬g‘
);

1330 
obj
.
	`pushKV
("g‘h_sync_¡©us", 
fG‘hSyncStus
);

1331 
obj
.
	`pushKV
("g‘h_tÙ®_blocks", 
fG‘hSyncHeight
);

1332 
obj
.
	`pushKV
("g‘h_cu¼’t_block", 
fG‘hCu¼’tHeight
);

1333 cÚ¡ 
CÚ£nsus
::
P¬ams
& 
cÚ£nsusP¬ams
 = 
	`P¬ams
().
	`G‘CÚ£nsus
();

1334 
UniV®ue
 
	`soáfÜks
(UniV®ue::
VOBJ
);

1335 
	`Bur›dFÜkDescPushBack
(
soáfÜks
, "b34", 
cÚ£nsusP¬ams
.
BIP34Height
);

1336 
	`Bur›dFÜkDescPushBack
(
soáfÜks
, "b66", 
cÚ£nsusP¬ams
.
BIP66Height
);

1337 
	`Bur›dFÜkDescPushBack
(
soáfÜks
, "b65", 
cÚ£nsusP¬ams
.
BIP65Height
);

1338 
	`Bur›dFÜkDescPushBack
(
soáfÜks
, "csv", 
cÚ£nsusP¬ams
.
CSVHeight
);

1339 
	`Bur›dFÜkDescPushBack
(
soáfÜks
, "£gw™", 
cÚ£nsusP¬ams
.
Segw™Height
);

1340 
	`BIP9SoáFÜkDescPushBack
(
soáfÜks
, "‹¡dummy", 
cÚ£nsusP¬ams
, 
CÚ£nsus
::
DEPLOYMENT_TESTDUMMY
);

1341 
obj
.
	`pushKV
("soáfÜks", 
soáfÜks
);

1343 
obj
.
	`pushKV
("w¬nšgs", 
	`G‘W¬nšgs
(
çl£
).
Üigš®
);

1344  
obj
;

1345 
	}
}

1348 
	sCom·»BlocksByHeight


1350 
boŞ
 
İ”©Ü
()(cÚ¡ 
CBlockIndex
* 
	ma
, cÚ¡ CBlockIndex* 
	mb
) const

1355 ià(
	ma
->
	mnHeight
 !ğ
b
->
nHeight
)

1356  (
a
->
nHeight
 > 
b
->nHeight);

1358  
	ma
 < 
	mb
;

1362 
UniV®ue
 
	$g‘chašts
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1364 
RPCH–pMª
{"getchaintips",

1368 
RPCResuÉ
{

1369 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

1370 {{
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1372 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "height ofhe chainip"},

1373 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "block hash ofheip"},

1374 {
RPCResuÉ
::
Ty³
::
NUM
, "branchlen", "zero for main chain, otherwise†ength of branch connectingheipohe main chain"},

1375 {
RPCResuÉ
::
Ty³
::
STR
, "status", "status ofhe chain, \"active\" forhe main chain\n"

1383 
RPCExam¶es
{

1384 
	`H–pExam¶eCli
("getchaintips", "")

1385 + 
	`H–pExam¶eRpc
("getchaintips", "")

1387 }.
	`Check
(
»que¡
);

1389 
	`LOCK
(
cs_maš
);

1398 
¡d
::
£t
<cÚ¡ 
CBlockIndex
*, 
Com·»BlocksByHeight
> 
£tTs
;

1399 
¡d
::
£t
<cÚ¡ 
CBlockIndex
*> 
£tO½hªs
;

1400 
¡d
::
£t
<cÚ¡ 
CBlockIndex
*> 
£tP»vs
;

1402 cÚ¡ 
¡d
::
·œ
<cÚ¡ 
ušt256
, 
CBlockIndex
*>& 
™em
 : ::
	`BlockIndex
())

1404 ià(!::
	`ChašAùive
().
	`CÚšs
(
™em
.
£cÚd
)) {

1405 
£tO½hªs
.
	`š£¹
(
™em
.
£cÚd
);

1406 
£tP»vs
.
	`š£¹
(
™em
.
£cÚd
->
µ»v
);

1410 
¡d
::
£t
<cÚ¡ 
CBlockIndex
*>::
™”©Ü
 
™
 = 
£tO½hªs
.
	`begš
(); iˆ!ğ£tO½hªs.
	`’d
(); ++it)

1412 ià(
£tP»vs
.
	`”a£
(*
™
) == 0) {

1413 
£tTs
.
	`š£¹
(*
™
);

1418 
£tTs
.
	`š£¹
(::
	`ChašAùive
().
	`T
());

1421 
UniV®ue
 
	`»s
(UniV®ue::
VARR
);

1422 cÚ¡ 
CBlockIndex
* 
block
 : 
£tTs
)

1424 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

1425 
obj
.
	`pushKV
("height", 
block
->
nHeight
);

1426 
obj
.
	`pushKV
("hash", 
block
->
phashBlock
->
	`G‘Hex
());

1428 cÚ¡ 
b¿nchL’
 = 
block
->
nHeight
 - ::
	`ChašAùive
().
	`FšdFÜk
(block)->nHeight;

1429 
obj
.
	`pushKV
("b¿nchËn", 
b¿nchL’
);

1431 
¡d
::
¡ršg
 
¡©us
;

1432 ià(::
	`ChašAùive
().
	`CÚšs
(
block
)) {

1434 
¡©us
 = "active";

1435 } ià(
block
->
nStus
 & 
BLOCK_FAILED_MASK
) {

1437 
¡©us
 = "invalid";

1438 } ià(!
block
->
	`HaveTxsDowÆßded
()) {

1440 
¡©us
 = "headers-only";

1441 } ià(
block
->
	`IsV®id
(
BLOCK_VALID_SCRIPTS
)) {

1443 
¡©us
 = "valid-fork";

1444 } ià(
block
->
	`IsV®id
(
BLOCK_VALID_TREE
)) {

1446 
¡©us
 = "valid-headers";

1449 
¡©us
 = "unknown";

1451 
obj
.
	`pushKV
("¡©us", 
¡©us
);

1453 
»s
.
	`push_back
(
obj
);

1456  
»s
;

1457 
	}
}

1459 
UniV®ue
 
	$MempoŞInfoToJSON
(cÚ¡ 
CTxMemPoŞ
& 
poŞ
)

1462 
	`LOCK
(
poŞ
.
cs
);

1463 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1464 
»t
.
	`pushKV
("lßded", 
poŞ
.
	`IsLßded
());

1465 
»t
.
	`pushKV
("size", (
št64_t
)
poŞ
.
	`size
());

1466 
»t
.
	`pushKV
("by‹s", (
št64_t
)
poŞ
.
	`G‘TÙ®TxSize
());

1467 
»t
.
	`pushKV
("u§ge", (
št64_t
)
poŞ
.
	`DyÇmicMemÜyU§ge
());

1468 
size_t
 
maxmempoŞ
 = 
gArgs
.
	`G‘Arg
("-maxmempoŞ", 
DEFAULT_MAX_MEMPOOL_SIZE
) * 1000000;

1469 
»t
.
	`pushKV
("maxmempoŞ", (
št64_t
è
maxmempoŞ
);

1470 
»t
.
	`pushKV
("mempoŞmšãe", 
	`V®ueFromAmouÁ
(
¡d
::
	`max
(
poŞ
.
	`G‘MšF“
(
maxmempoŞ
), ::
mšR–ayTxF“
).
	`G‘F“P”K
()));

1471 
»t
.
	`pushKV
("mš»Ïytxãe", 
	`V®ueFromAmouÁ
(::
mšR–ayTxF“
.
	`G‘F“P”K
()));

1472 
»t
.
	`pushKV
("unbrßdÿ¡couÁ", 
ušt64_t
{
poŞ
.
	`G‘Unbrßdÿ¡Txs
().
	`size
()});

1473  
»t
;

1474 
	}
}

1476 
UniV®ue
 
	$g‘mempoŞšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1478 
RPCH–pMª
{"getmempoolinfo",

1481 
RPCResuÉ
{

1482 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1484 {
RPCResuÉ
::
Ty³
::
BOOL
, "loaded", "True ifhe mempool is fully†oaded"},

1485 {
RPCResuÉ
::
Ty³
::
NUM
, "size", "Currentx count"},

1486 {
RPCResuÉ
::
Ty³
::
NUM
, "bytes", "Sum of‡ll virtualransaction sizes‡s defined in BIP 141. Differs from‡ctual serialized size because witness data is discounted"},

1487 {
RPCResuÉ
::
Ty³
::
NUM
, "usage", "Total memory usage forhe mempool"},

1488 {
RPCResuÉ
::
Ty³
::
NUM
, "maxmempool", "Maximum memory usage forhe mempool"},

1489 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "mempoŞmšãe", "Mšimum f“„©š " + 
CURRENCY_UNIT
 + "/kB forxo be‡ccepted. Ishe maximum of minrelaytxfee‡nd minimum mempool fee"},

1490 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "minrelaytxfee", "Current minimum„elay fee forransactions"},

1491 {
RPCResuÉ
::
Ty³
::
NUM
, "unbroadcastcount", "Current‚umber ofransactionshat haven't…assed initial broadcast yet"}

1493 
RPCExam¶es
{

1494 
	`H–pExam¶eCli
("getmempoolinfo", "")

1495 + 
	`H–pExam¶eRpc
("getmempoolinfo", "")

1497 }.
	`Check
(
»que¡
);

1499  
	`MempoŞInfoToJSON
(
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
));

1500 
	}
}

1502 
UniV®ue
 
	$´eciousblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1504 
RPCH–pMª
{"preciousblock",

1509 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hash ofhe blocko mark‡s…recious"},

1511 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1512 
RPCExam¶es
{

1513 
	`H–pExam¶eCli
("preciousblock", "\"blockhash\"")

1514 + 
	`H–pExam¶eRpc
("preciousblock", "\"blockhash\"")

1516 }.
	`Check
(
»que¡
);

1518 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash"));

1519 
CBlockIndex
* 
pblockšdex
;

1522 
	`LOCK
(
cs_maš
);

1523 
pblockšdex
 = 
	`LookupBlockIndex
(
hash
);

1524 ià(!
pblockšdex
) {

1525 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

1529 
BlockV®id©iÚS‹
 
¡©e
;

1530 
	`P»ciousBlock
(
¡©e
, 
	`P¬ams
(), 
pblockšdex
);

1532 ià(!
¡©e
.
	`IsV®id
()) {

1533 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, 
¡©e
.
	`ToSŒšg
());

1536  
NuÎUniV®ue
;

1537 
	}
}

1539 
UniV®ue
 
	$šv®id©eblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1541 
RPCH–pMª
{"invalidateblock",

1544 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hash ofhe blocko mark‡s invalid"},

1546 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1547 
RPCExam¶es
{

1548 
	`H–pExam¶eCli
("invalidateblock", "\"blockhash\"")

1549 + 
	`H–pExam¶eRpc
("invalidateblock", "\"blockhash\"")

1551 }.
	`Check
(
»que¡
);

1553 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash"));

1554 
BlockV®id©iÚS‹
 
¡©e
;

1556 
CBlockIndex
* 
pblockšdex
;

1558 
	`LOCK
(
cs_maš
);

1559 
pblockšdex
 = 
	`LookupBlockIndex
(
hash
);

1560 ià(!
pblockšdex
) {

1561 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

1564 
	`Inv®id©eBlock
(
¡©e
, 
	`P¬ams
(), 
pblockšdex
);

1566 ià(
¡©e
.
	`IsV®id
()) {

1567 
	`Aùiv©eBe¡Chaš
(
¡©e
, 
	`P¬ams
());

1570 ià(!
¡©e
.
	`IsV®id
()) {

1571 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, 
¡©e
.
	`ToSŒšg
());

1574  
NuÎUniV®ue
;

1575 
	}
}

1577 
UniV®ue
 
	$»cÚsid”block
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1579 
RPCH–pMª
{"reconsiderblock",

1583 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hash ofhe blocko„econsider"},

1585 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1586 
RPCExam¶es
{

1587 
	`H–pExam¶eCli
("reconsiderblock", "\"blockhash\"")

1588 + 
	`H–pExam¶eRpc
("reconsiderblock", "\"blockhash\"")

1590 }.
	`Check
(
»que¡
);

1592 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash"));

1595 
	`LOCK
(
cs_maš
);

1596 
CBlockIndex
* 
pblockšdex
 = 
	`LookupBlockIndex
(
hash
);

1597 ià(!
pblockšdex
) {

1598 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

1601 
	`Re£tBlockFau»FÏgs
(
pblockšdex
);

1604 
fLßded
 = 
çl£
;

1605 
BlockV®id©iÚS‹
 
¡©e
;

1606 
	`Aùiv©eBe¡Chaš
(
¡©e
, 
	`P¬ams
());

1607 
fLßded
 = 
Œue
;

1608 ià(!
¡©e
.
	`IsV®id
()) {

1609 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, 
¡©e
.
	`ToSŒšg
());

1612  
NuÎUniV®ue
;

1613 
	}
}

1615 
UniV®ue
 
	$g‘chaštx¡©s
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1617 
RPCH–pMª
{"getchaintxstats",

1620 {"nblocks", 
RPCArg
::
Ty³
::
NUM
, "one month", "Size ofhe window in‚umber of blocks"},

1621 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, "chainip", "The hash ofhe blockhatƒndshe window."},

1623 
RPCResuÉ
{

1624 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1626 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "time", "Thtime¡am°fÜhfš® block iÀthwšdow,ƒx´es£d iÀ" + 
UNIX_EPOCH_TIME
},

1627 {
RPCResuÉ
::
Ty³
::
NUM
, "txcount", "Theotal‚umber ofransactions inhe chain upohat…oint"},

1628 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "window_final_block_hash", "The hash ofhe final block inhe window"},

1629 {
RPCResuÉ
::
Ty³
::
NUM
, "window_final_block_height", "The height ofhe final block inhe window."},

1630 {
RPCResuÉ
::
Ty³
::
NUM
, "window_block_count", "Size ofhe window in‚umber of blocks"},

1631 {
RPCResuÉ
::
Ty³
::
NUM
, "window_tx_count", "The‚umber ofransactions inhe window. Only„eturned if \"window_block_count\" is > 0"},

1632 {
RPCResuÉ
::
Ty³
::
NUM
, "window_interval", "Theƒlapsedime inhe window in seconds. Only„eturned if \"window_block_count\" is > 0"},

1633 {
RPCResuÉ
::
Ty³
::
NUM
, "txrate", "The‡verage„ate ofransactions…er second inhe window. Only„eturned if \"window_interval\" is > 0"},

1635 
RPCExam¶es
{

1636 
	`H–pExam¶eCli
("getchaintxstats", "")

1637 + 
	`H–pExam¶eRpc
("getchaintxstats", "2016")

1639 }.
	`Check
(
»que¡
);

1641 cÚ¡ 
CBlockIndex
* 
pšdex
;

1642 
blockcouÁ
 = 30 * 24 * 60 * 60 / 
	`P¬ams
().
	`G‘CÚ£nsus
().
nPowT¬g‘S·cšg
;

1644 ià(
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

1645 
	`LOCK
(
cs_maš
);

1646 
pšdex
 = ::
	`ChašAùive
().
	`T
();

1648 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "blockhash"));

1649 
	`LOCK
(
cs_maš
);

1650 
pšdex
 = 
	`LookupBlockIndex
(
hash
);

1651 ià(!
pšdex
) {

1652 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

1654 ià(!::
	`ChašAùive
().
	`CÚšs
(
pšdex
)) {

1655 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Block is‚ot in main chain");

1659 
	`CHECK_NONFATAL
(
pšdex
 !ğ
nuÎ±r
);

1661 ià(
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

1662 
blockcouÁ
 = 
¡d
::
	`max
(0, std::
	`mš
(blockcouÁ, 
pšdex
->
nHeight
 - 1));

1664 
blockcouÁ
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

1666 ià(
blockcouÁ
 < 0 || (blockcouÁ > 0 && blockcouÁ >ğ
pšdex
->
nHeight
)) {

1667 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid block count: should be between 0‡ndhe block's height - 1");

1671 cÚ¡ 
CBlockIndex
* 
pšdexPa¡
 = 
pšdex
->
	`G‘Anû¡Ü
Õšdex->
nHeight
 - 
blockcouÁ
);

1672 
nTimeDiff
 = 
pšdex
->
	`G‘MedŸnTimePa¡
(è- 
pšdexPa¡
->GetMedianTimePast();

1673 
nTxDiff
 = 
pšdex
->
nChašTx
 - 
pšdexPa¡
->nChainTx;

1675 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1676 
»t
.
	`pushKV
("time", (
št64_t
)
pšdex
->
nTime
);

1677 
»t
.
	`pushKV
("txcouÁ", (
št64_t
)
pšdex
->
nChašTx
);

1678 
»t
.
	`pushKV
("wšdow_fš®_block_hash", 
pšdex
->
	`G‘BlockHash
().
	`G‘Hex
());

1679 
»t
.
	`pushKV
("wšdow_fš®_block_height", 
pšdex
->
nHeight
);

1680 
»t
.
	`pushKV
("wšdow_block_couÁ", 
blockcouÁ
);

1681 ià(
blockcouÁ
 > 0) {

1682 
»t
.
	`pushKV
("wšdow_tx_couÁ", 
nTxDiff
);

1683 
»t
.
	`pushKV
("wšdow_š‹rv®", 
nTimeDiff
);

1684 ià(
nTimeDiff
 > 0) {

1685 
»t
.
	`pushKV
("tx¿‹", (()
nTxDiff
è/ 
nTimeDiff
);

1689  
»t
;

1690 
	}
}

1692 
	g‹m¶©e
<
ty³Çme
 
	gT
>

1693 
T
 
C®cuÏ‹Trunÿ‹dMedŸn
(
¡d
::
veùÜ
<T>& 
scÜes
)

1695 
size_t
 
size
 = 
scÜes
.size();

1696 ià(
	gsize
 == 0) {

1700 
	g¡d
::
sÜt
(
scÜes
.
begš
(), scÜes.
’d
());

1701 ià(
	gsize
 % 2 == 0) {

1702  (
scÜes
[
size
 / 2 - 1] + scores[size / 2]) / 2;

1704  
	gscÜes
[
size
 / 2];

1708 
C®cuÏ‹P”ûÁesByWeight
(
CAmouÁ
 
»suÉ
[
NUM_GETBLOCKSTATS_PERCENTILES
], 
¡d
::
veùÜ
<¡d::
·œ
<CAmouÁ, 
št64_t
>>& 
scÜes
, iÁ64_ˆ
tÙ®_weight
)

1710 ià(
	gscÜes
.
em±y
()) {

1714 
	g¡d
::
sÜt
(
scÜes
.
begš
(), scÜes.
’d
());

1717 cÚ¡ 
	gweights
[
NUM_GETBLOCKSTATS_PERCENTILES
] = {

1718 
tÙ®_weight
 / 10.0,otal_weight / 4.0,otal_weight / 2.0, (total_weight * 3.0) / 4.0, (total_weight * 9.0) / 10.0

1721 
št64_t
 
	gÃxt_³rûÁe_šdex
 = 0;

1722 
št64_t
 
	gcumuÏtive_weight
 = 0;

1723 cÚ¡‡uto& 
	g–em’t
 : 
scÜes
) {

1724 
cumuÏtive_weight
 +ğ
–em’t
.
£cÚd
;

1725 
	gÃxt_³rûÁe_šdex
 < 
	gNUM_GETBLOCKSTATS_PERCENTILES
 && 
	gcumuÏtive_weight
 >ğ
weights
[
Ãxt_³rûÁe_šdex
]) {

1726 
»suÉ
[
Ãxt_³rûÁe_šdex
] = 
–em’t
.
fœ¡
;

1727 ++
	gÃxt_³rûÁe_šdex
;

1732 
št64_t
 
	gi
 = 
Ãxt_³rûÁe_šdex
; i < 
	gNUM_GETBLOCKSTATS_PERCENTILES
; i++) {

1733 
	g»suÉ
[
i
] = 
scÜes
.
back
().
fœ¡
;

1737 
	g‹m¶©e
<
ty³Çme
 
	gT
>

1738 
šlše
 
boŞ
 
S‘HasKeys
(cÚ¡ 
¡d
::
£t
<
T
>& s‘è{ 
çl£
;}

1739 
	g‹m¶©e
<
ty³Çme
 
	gT
,y³Çm
	gTk
, 
	gty³Çme
... 
	gArgs
>

1740 
šlše
 
boŞ
 
S‘HasKeys
(cÚ¡ 
¡d
::
£t
<
T
>& s‘, cÚ¡ 
Tk
& 
key
, cÚ¡ 
Args
&... 
¬gs
)

1742  (
	g£t
.
couÁ
(
key
è!ğ0è|| 
S‘HasKeys
(
£t
, 
¬gs
...);

1746 
cÚ¡ex´
 
size_t
 
	gPER_UTXO_OVERHEAD
 = (
COutPošt
è+ (
ušt32_t
è+ (
boŞ
);

1748 
UniV®ue
 
	$g‘block¡©s
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1750 
RPCH–pMª
{"getblockstats",

1754 {"hash_Ü_height", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The block hash or height ofhearget block", "", {"", "string or‚umeric"}},

1755 {"¡©s", 
RPCArg
::
Ty³
::
ARR
, "all values", "Valueso…lot (see„esult below)",

1757 {"height", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "Selected statistic"},

1758 {"time", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "Selected statistic"},

1762 
RPCResuÉ
{

1763 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1765 {
RPCResuÉ
::
Ty³
::
NUM
, "avgfee", "Average fee inhe block"},

1766 {
RPCResuÉ
::
Ty³
::
NUM
, "avgfeerate", "Average feerate (in satoshis…er virtual byte)"},

1767 {
RPCResuÉ
::
Ty³
::
NUM
, "avgtxsize", "Averageransaction size"},

1768 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "blockhash", "The block hash (to check for…otential„eorgs)"},

1769 {
RPCResuÉ
::
Ty³
::
ARR_FIXED
, "feerate_percentiles", "Feerates‡the 10th, 25th, 50th, 75th,‡nd 90th…ercentile weight unit (in satoshis…er virtual byte)",

1771 {
RPCResuÉ
::
Ty³
::
NUM
, "10th_percentile_feerate", "The 10th…ercentile feerate"},

1772 {
RPCResuÉ
::
Ty³
::
NUM
, "25th_percentile_feerate", "The 25th…ercentile feerate"},

1773 {
RPCResuÉ
::
Ty³
::
NUM
, "50th_percentile_feerate", "The 50th…ercentile feerate"},

1774 {
RPCResuÉ
::
Ty³
::
NUM
, "75th_percentile_feerate", "The 75th…ercentile feerate"},

1775 {
RPCResuÉ
::
Ty³
::
NUM
, "90th_percentile_feerate", "The 90th…ercentile feerate"},

1777 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The height ofhe block"},

1778 {
RPCResuÉ
::
Ty³
::
NUM
, "ins", "The‚umber of inputs (excluding coinbase)"},

1779 {
RPCResuÉ
::
Ty³
::
NUM
, "maxfee", "Maximum fee inhe block"},

1780 {
RPCResuÉ
::
Ty³
::
NUM
, "maxfeerate", "Maximum feerate (in satoshis…er virtual byte)"},

1781 {
RPCResuÉ
::
Ty³
::
NUM
, "maxtxsize", "Maximumransaction size"},

1782 {
RPCResuÉ
::
Ty³
::
NUM
, "medianfee", "Truncated median fee inhe block"},

1783 {
RPCResuÉ
::
Ty³
::
NUM
, "mediantime", "The block medianime…ast"},

1784 {
RPCResuÉ
::
Ty³
::
NUM
, "mediantxsize", "Truncated medianransaction size"},

1785 {
RPCResuÉ
::
Ty³
::
NUM
, "minfee", "Minimum fee inhe block"},

1786 {
RPCResuÉ
::
Ty³
::
NUM
, "minfeerate", "Minimum feerate (in satoshis…er virtual byte)"},

1787 {
RPCResuÉ
::
Ty³
::
NUM
, "mintxsize", "Minimumransaction size"},

1788 {
RPCResuÉ
::
Ty³
::
NUM
, "outs", "The‚umber of outputs"},

1789 {
RPCResuÉ
::
Ty³
::
NUM
, "subsidy", "The block subsidy"},

1790 {
RPCResuÉ
::
Ty³
::
NUM
, "swtotal_size", "Total size of‡ll segwitransactions"},

1791 {
RPCResuÉ
::
Ty³
::
NUM
, "swtotal_weight", "Total weight of‡ll segwitransactions divided by segwit scale factor (4)"},

1792 {
RPCResuÉ
::
Ty³
::
NUM
, "swtxs", "The‚umber of segwitransactions"},

1793 {
RPCResuÉ
::
Ty³
::
NUM
, "time", "The blockime"},

1794 {
RPCResuÉ
::
Ty³
::
NUM
, "total_out", "Total‡mount in‡ll outputs (excluding coinbase‡ndhus„eward [ie subsidy +otalfee])"},

1795 {
RPCResuÉ
::
Ty³
::
NUM
, "total_size", "Total size of‡ll‚on-coinbaseransactions"},

1796 {
RPCResuÉ
::
Ty³
::
NUM
, "total_weight", "Total weight of‡ll‚on-coinbaseransactions divided by segwit scale factor (4)"},

1797 {
RPCResuÉ
::
Ty³
::
NUM
, "totalfee", "The feeotal"},

1798 {
RPCResuÉ
::
Ty³
::
NUM
, "txs", "The‚umber ofransactions (excluding coinbase)"},

1799 {
RPCResuÉ
::
Ty³
::
NUM
, "utxo_increase", "The increase/decrease inhe‚umber of unspent outputs"},

1800 {
RPCResuÉ
::
Ty³
::
NUM
, "utxo_size_inc", "The increase/decrease in size forhe utxo index (not discounting op_return‡nd similar)"},

1802 
RPCExam¶es
{

1803 
	`H–pExam¶eCli
("g‘block¡©s", 
R
"('"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09"' '["
mšã”©e
","
avgã”©e
"]')") +

1804 
	`H–pExam¶eCli
("g‘block¡©s", 
R
"(1000 '["
mšã”©e
","
avgã”©e
"]')") +

1805 
	`H–pExam¶eRpc
("g‘block¡©s", 
R
"("00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09", ["
mšã”©e
","
avgã”©e
"])") +

1806 
	`H–pExam¶eRpc
("g‘block¡©s", 
R
"(1000, ["
mšã”©e
","
avgã”©e
"])")

1808 }.
	`Check
(
»que¡
);

1810 
	`LOCK
(
cs_maš
);

1812 
CBlockIndex
* 
pšdex
;

1813 ià(
»que¡
.
·¿ms
[0].
	`isNum
()) {

1814 cÚ¡ 
height
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

1815 cÚ¡ 
cu¼’t_t
 = ::
	`ChašAùive
().
	`Height
();

1816 ià(
height
 < 0) {

1817 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("T¬g‘ block heighˆ%d i Ãg©ive", 
height
));

1819 ià(
height
 > 
cu¼’t_t
) {

1820 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("T¬g‘ block heighˆ%d‡á” cu¼’ˆt %d", 
height
, 
cu¼’t_t
));

1823 
pšdex
 = ::
	`ChašAùive
()[
height
];

1825 cÚ¡ 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "hash_or_height"));

1826 
pšdex
 = 
	`LookupBlockIndex
(
hash
);

1827 ià(!
pšdex
) {

1828 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

1830 ià(!::
	`ChašAùive
().
	`CÚšs
(
pšdex
)) {

1831 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("Block i nÙ iÀchaš %s", 
	`P¬ams
().
	`N‘wÜkIDSŒšg
()));

1835 
	`CHECK_NONFATAL
(
pšdex
 !ğ
nuÎ±r
);

1837 
¡d
::
£t
<¡d::
¡ršg
> 
¡©s
;

1838 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

1839 cÚ¡ 
UniV®ue
 
¡©s_univ®ue
 = 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
();

1840 
i
 = 0; i < 
¡©s_univ®ue
.
	`size
(); i++) {

1841 cÚ¡ 
¡d
::
¡ršg
 
¡©
 = 
¡©s_univ®ue
[
i
].
	`g‘_¡r
();

1842 
¡©s
.
	`š£¹
(
¡©
);

1846 cÚ¡ 
CBlock
 
block
 = 
	`G‘BlockChecked
(
pšdex
);

1847 cÚ¡ 
CBlockUndo
 
blockUndo
 = 
	`G‘UndoChecked
(
pšdex
);

1849 cÚ¡ 
boŞ
 
do_®l
 = 
¡©s
.
	`size
() == 0;

1850 cÚ¡ 
boŞ
 
do_medŸÁxsize
 = 
do_®l
 || 
¡©s
.
	`couÁ
("mediantxsize") != 0;

1851 cÚ¡ 
boŞ
 
do_medŸnãe
 = 
do_®l
 || 
¡©s
.
	`couÁ
("medianfee") != 0;

1852 cÚ¡ 
boŞ
 
do_ã”©e_³rûÁes
 = 
do_®l
 || 
¡©s
.
	`couÁ
("feerate_percentiles") != 0;

1853 cÚ¡ 
boŞ
 
loİ_šputs
 = 
do_®l
 || 
do_medŸnãe
 || 
do_ã”©e_³rûÁes
 ||

1854 
	`S‘HasKeys
(
¡©s
, "utxo_size_inc", "totalfee", "avgfee", "avgfeerate", "minfee", "maxfee", "minfeerate", "maxfeerate");

1855 cÚ¡ 
boŞ
 
loİ_ouuts
 = 
do_®l
 || 
loİ_šputs
 || 
¡©s
.
	`couÁ
("total_out");

1856 cÚ¡ 
boŞ
 
do_ÿlcuÏ‹_size
 = 
do_medŸÁxsize
 ||

1857 
	`S‘HasKeys
(
¡©s
, "total_size", "avgtxsize", "mintxsize", "maxtxsize", "swtotal_size");

1858 cÚ¡ 
boŞ
 
do_ÿlcuÏ‹_weight
 = 
do_®l
 || 
	`S‘HasKeys
(
¡©s
, "total_weight", "avgfeerate", "swtotal_weight", "avgfeerate", "feerate_percentiles", "minfeerate", "maxfeerate");

1859 cÚ¡ 
boŞ
 
do_ÿlcuÏ‹_sw
 = 
do_®l
 || 
	`S‘HasKeys
(
¡©s
, "swtxs", "swtotal_size", "swtotal_weight");

1861 
CAmouÁ
 
maxãe
 = 0;

1862 
CAmouÁ
 
maxã”©e
 = 0;

1863 
CAmouÁ
 
mšãe
 = 
MAX_MONEY
;

1864 
CAmouÁ
 
mšã”©e
 = 
MAX_MONEY
;

1865 
CAmouÁ
 
tÙ®_out
 = 0;

1866 
CAmouÁ
 
tÙ®ãe
 = 0;

1867 
št64_t
 
šputs
 = 0;

1868 
št64_t
 
maxtxsize
 = 0;

1869 
št64_t
 
mštxsize
 = 
MAX_BLOCK_SERIALIZED_SIZE
;

1870 
št64_t
 
ouuts
 = 0;

1871 
št64_t
 
swtÙ®_size
 = 0;

1872 
št64_t
 
swtÙ®_weight
 = 0;

1873 
št64_t
 
swtxs
 = 0;

1874 
št64_t
 
tÙ®_size
 = 0;

1875 
št64_t
 
tÙ®_weight
 = 0;

1876 
št64_t
 
utxo_size_šc
 = 0;

1877 
¡d
::
veùÜ
<
CAmouÁ
> 
ãe_¬¿y
;

1878 
¡d
::
veùÜ
<¡d::
·œ
<
CAmouÁ
, 
št64_t
>> 
ã”©e_¬¿y
;

1879 
¡d
::
veùÜ
<
št64_t
> 
txsize_¬¿y
;

1881 
size_t
 
i
 = 0; i < 
block
.
vtx
.
	`size
(); ++i) {

1882 cÚ¡‡uto& 
tx
 = 
block
.
vtx
.
	`©
(
i
);

1883 
ouuts
 +ğ
tx
->
vout
.
	`size
();

1885 
CAmouÁ
 
tx_tÙ®_out
 = 0;

1886 ià(
loİ_ouuts
) {

1887 cÚ¡ 
CTxOut
& 
out
 : 
tx
->
vout
) {

1888 
tx_tÙ®_out
 +ğ
out
.
nV®ue
;

1889 
utxo_size_šc
 +ğ
	`G‘S”ŸlizeSize
(
out
, 
PROTOCOL_VERSION
è+ 
PER_UTXO_OVERHEAD
;

1893 ià(
tx
->
	`IsCošBa£
()) {

1897 
šputs
 +ğ
tx
->
vš
.
	`size
();

1898 
tÙ®_out
 +ğ
tx_tÙ®_out
;

1900 
št64_t
 
tx_size
 = 0;

1901 ià(
do_ÿlcuÏ‹_size
) {

1903 
tx_size
 = 
tx
->
	`G‘TÙ®Size
();

1904 ià(
do_medŸÁxsize
) {

1905 
txsize_¬¿y
.
	`push_back
(
tx_size
);

1907 
maxtxsize
 = 
¡d
::
	`max
(maxtxsize, 
tx_size
);

1908 
mštxsize
 = 
¡d
::
	`mš
(mštxsize, 
tx_size
);

1909 
tÙ®_size
 +ğ
tx_size
;

1912 
št64_t
 
weight
 = 0;

1913 ià(
do_ÿlcuÏ‹_weight
) {

1914 
weight
 = 
	`G‘T¿n§ùiÚWeight
(*
tx
);

1915 
tÙ®_weight
 +ğ
weight
;

1918 ià(
do_ÿlcuÏ‹_sw
 && 
tx
->
	`HasW™Ãss
()) {

1919 ++
swtxs
;

1920 
swtÙ®_size
 +ğ
tx_size
;

1921 
swtÙ®_weight
 +ğ
weight
;

1924 ià(
loİ_šputs
) {

1925 
CAmouÁ
 
tx_tÙ®_š
 = 0;

1926 cÚ¡‡uto& 
txundo
 = 
blockUndo
.
vtxundo
.
	`©
(
i
 - 1);

1927 cÚ¡ 
Coš
& 
coš
: 
txundo
.
v´evout
) {

1928 cÚ¡ 
CTxOut
& 
´evouut
 = 
coš
.
out
;

1930 
tx_tÙ®_š
 +ğ
´evouut
.
nV®ue
;

1931 
utxo_size_šc
 -ğ
	`G‘S”ŸlizeSize
(
´evouut
, 
PROTOCOL_VERSION
è+ 
PER_UTXO_OVERHEAD
;

1934 
CAmouÁ
 
txãe
 = 
tx_tÙ®_š
 - 
tx_tÙ®_out
;

1935 
	`CHECK_NONFATAL
(
	`MÚeyRªge
(
txãe
));

1936 ià(
do_medŸnãe
) {

1937 
ãe_¬¿y
.
	`push_back
(
txãe
);

1939 
maxãe
 = 
¡d
::
	`max
(maxãe, 
txãe
);

1940 
mšãe
 = 
¡d
::
	`mš
(mšãe, 
txãe
);

1941 
tÙ®ãe
 +ğ
txãe
;

1944 
CAmouÁ
 
ã”©e
 = 
weight
 ? (
txãe
 * 
WITNESS_SCALE_FACTOR
) / weight : 0;

1945 ià(
do_ã”©e_³rûÁes
) {

1946 
ã”©e_¬¿y
.
	`em¶aû_back
(
¡d
::
	`make_·œ
(
ã”©e
, 
weight
));

1948 
maxã”©e
 = 
¡d
::
	`max
(maxã”©e, 
ã”©e
);

1949 
mšã”©e
 = 
¡d
::
	`mš
(mšã”©e, 
ã”©e
);

1953 
CAmouÁ
 
ã”©e_³rûÁes
[
NUM_GETBLOCKSTATS_PERCENTILES
] = { 0 };

1954 
	`C®cuÏ‹P”ûÁesByWeight
(
ã”©e_³rûÁes
, 
ã”©e_¬¿y
, 
tÙ®_weight
);

1956 
UniV®ue
 
	`ã”©es_»s
(UniV®ue::
VARR
);

1957 
št64_t
 
i
 = 0; i < 
NUM_GETBLOCKSTATS_PERCENTILES
; i++) {

1958 
ã”©es_»s
.
	`push_back
(
ã”©e_³rûÁes
[
i
]);

1961 
UniV®ue
 
	`»t_®l
(UniV®ue::
VOBJ
);

1962 
»t_®l
.
	`pushKV
("avgãe", (
block
.
vtx
.
	`size
(è> 1è? 
tÙ®ãe
 / (block.vtx.size() - 1) : 0);

1963 
»t_®l
.
	`pushKV
("avgã”©e", 
tÙ®_weight
 ? (
tÙ®ãe
 * 
WITNESS_SCALE_FACTOR
) /otal_weight : 0);

1964 
»t_®l
.
	`pushKV
("avgtxsize", (
block
.
vtx
.
	`size
(è> 1è? 
tÙ®_size
 / (block.vtx.size() - 1) : 0);

1965 
»t_®l
.
	`pushKV
("blockhash", 
pšdex
->
	`G‘BlockHash
().
	`G‘Hex
());

1966 
»t_®l
.
	`pushKV
("ã”©e_³rûÁes", 
ã”©es_»s
);

1967 
»t_®l
.
	`pushKV
("height", (
št64_t
)
pšdex
->
nHeight
);

1968 
»t_®l
.
	`pushKV
("šs", 
šputs
);

1969 
»t_®l
.
	`pushKV
("maxãe", 
maxãe
);

1970 
»t_®l
.
	`pushKV
("maxã”©e", 
maxã”©e
);

1971 
»t_®l
.
	`pushKV
("maxtxsize", 
maxtxsize
);

1972 
»t_®l
.
	`pushKV
("medŸnãe", 
	`C®cuÏ‹Trunÿ‹dMedŸn
(
ãe_¬¿y
));

1973 
»t_®l
.
	`pushKV
("medŸÁime", 
pšdex
->
	`G‘MedŸnTimePa¡
());

1974 
»t_®l
.
	`pushKV
("medŸÁxsize", 
	`C®cuÏ‹Trunÿ‹dMedŸn
(
txsize_¬¿y
));

1975 
»t_®l
.
	`pushKV
("mšãe", (
mšãe
 =ğ
MAX_MONEY
) ? 0 : minfee);

1976 
»t_®l
.
	`pushKV
("mšã”©e", (
mšã”©e
 =ğ
MAX_MONEY
) ? 0 : minfeerate);

1977 
»t_®l
.
	`pushKV
("mštxsize", 
mštxsize
 =ğ
MAX_BLOCK_SERIALIZED_SIZE
 ? 0 : mintxsize);

1978 
»t_®l
.
	`pushKV
("outs", 
ouuts
);

1980 
»t_®l
.
	`pushKV
("subsidy", 
	`G‘BlockSubsidy
(
pšdex
->
nHeight
, 
	`P¬ams
()));

1981 
»t_®l
.
	`pushKV
("swtÙ®_size", 
swtÙ®_size
);

1982 
»t_®l
.
	`pushKV
("swtÙ®_weight", 
swtÙ®_weight
);

1983 
»t_®l
.
	`pushKV
("swtxs", 
swtxs
);

1984 
»t_®l
.
	`pushKV
("time", 
pšdex
->
	`G‘BlockTime
());

1985 
»t_®l
.
	`pushKV
("tÙ®_out", 
tÙ®_out
);

1986 
»t_®l
.
	`pushKV
("tÙ®_size", 
tÙ®_size
);

1987 
»t_®l
.
	`pushKV
("tÙ®_weight", 
tÙ®_weight
);

1988 
»t_®l
.
	`pushKV
("tÙ®ãe", 
tÙ®ãe
);

1989 
»t_®l
.
	`pushKV
("txs", (
št64_t
)
block
.
vtx
.
	`size
());

1990 
»t_®l
.
	`pushKV
("utxo_šü—£", 
ouuts
 - 
šputs
);

1991 
»t_®l
.
	`pushKV
("utxo_size_šc", 
utxo_size_šc
);

1993 ià(
do_®l
) {

1994  
»t_®l
;

1997 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1998 cÚ¡ 
¡d
::
¡ršg
& 
¡©
 : 
¡©s
) {

1999 cÚ¡ 
UniV®ue
& 
v®ue
 = 
»t_®l
[
¡©
];

2000 ià(
v®ue
.
	`isNuÎ
()) {

2001 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("Inv®id s–eùed sti¡iø%s", 
¡©
));

2003 
»t
.
	`pushKV
(
¡©
, 
v®ue
);

2005  
»t
;

2006 
	}
}

2008 
UniV®ue
 
	$§vemempoŞ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

2010 
RPCH–pMª
{"savemempool",

2013 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

2014 
RPCExam¶es
{

2015 
	`H–pExam¶eCli
("savemempool", "")

2016 + 
	`H–pExam¶eRpc
("savemempool", "")

2018 }.
	`Check
(
»que¡
);

2020 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

2022 ià(!
mempoŞ
.
	`IsLßded
()) {

2023 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "The mempool was‚ot†oaded yet");

2026 ià(!
	`DumpMempoŞ
(
mempoŞ
)) {

2027 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Unableo dump mempoolo disk");

2030  
NuÎUniV®ue
;

2031 
	}
}

2034 
boŞ
 
FšdSütPubKey
(
¡d
::
©omic
<>& 
sÿn_´og»ss
, cÚ¡ std::©omic<boŞ>& 
should_abÜt
, 
št64_t
& 
couÁ
, 
CCošsV›wCursÜ
* 
cursÜ
, cÚ¡ std::
£t
<
CSüt
>& 
ÃedËs
, std::
m­
<
COutPošt
, 
Coš
>& 
out_»suÉs
) {

2035 
	gsÿn_´og»ss
 = 0;

2036 
	gcouÁ
 = 0;

2037 
	gcursÜ
->
V®id
()) {

2038 
COutPošt
 
	gkey
;

2039 
Coš
 
	gcoš
;

2040 ià(!
	gcursÜ
->
G‘Key
(
key
è|| !cursÜ->
G‘V®ue
(
coš
)è 
	gçl£
;

2041 ià(++
	gcouÁ
 % 8192 == 0) {

2042 
RpcIÁ”ru±iÚPošt
();

2043 ià(
	gshould_abÜt
) {

2045  
	gçl£
;

2048 ià(
	gcouÁ
 % 256 == 0) {

2050 
ušt32_t
 
high
 = 0x100 * *
key
.
hash
.
begš
() + *(key.hash.begin() + 1);

2051 
	gsÿn_´og»ss
 = ()(
high
 * 100.0 / 65536.0 + 0.5);

2053 ià(
	gÃedËs
.
couÁ
(
coš
.
out
.
sütPubKey
)) {

2054 
	gout_»suÉs
.
em¶aû
(
key
, 
coš
);

2056 
	gcursÜ
->
Next
();

2058 
	gsÿn_´og»ss
 = 100;

2059  
	gŒue
;

2063 
	g¡d
::
©omic
<> 
g_sÿn_´og»ss
;

2064 
	g¡d
::
©omic
<
boŞ
> 
g_sÿn_š_´og»ss
;

2065 
	g¡d
::
©omic
<
boŞ
> 
g_should_abÜt_sÿn
;

2066 şas 
	cCošsV›wSÿnRe£rv”


2068 
	m´iv©e
:

2069 
boŞ
 
m_could_»£rve
;

2070 
	mpublic
:

2071 
ex¶ic™
 
	$CošsV›wSÿnRe£rv”
(è: 
	$m_could_»£rve
(
çl£
) {}

2073 
boŞ
 
	$»£rve
() {

2074 
	`CHECK_NONFATAL
(!
m_could_»£rve
);

2075 ià(
g_sÿn_š_´og»ss
.
	`exchªge
(
Œue
)) {

2076  
çl£
;

2078 
m_could_»£rve
 = 
Œue
;

2079  
Œue
;

2080 
	}
}

2082 ~
	$CošsV›wSÿnRe£rv”
() {

2083 ià(
m_could_»£rve
) {

2084 
g_sÿn_š_´og»ss
 = 
çl£
;

2086 
	}
}

2089 
UniV®ue
 
	$sÿÁxout£t
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

2091 
RPCH–pMª
{"scantxoutset",

2106 {"aùiÚ", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The‡ctionoƒxecute\n"

2110 {"sÿnobjeùs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED
, "Array of scan objects. Required for \"start\"‡ction\n"

2113 {"desütÜ", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "An output descriptor"},

2114 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "An object with output descriptor‡nd metadata",

2116 {"desc", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "An output descriptor"},

2117 {"¿nge", 
RPCArg
::
Ty³
::
RANGE
, "1000", "The„ange of HD chain indexesoƒxplore (eitherƒnd or [begin,end])"},

2123 
RPCResuÉ
{

2124 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

2126 {
RPCResuÉ
::
Ty³
::
BOOL
, "success", "Whetherhe scan was completed"},

2127 {
RPCResuÉ
::
Ty³
::
NUM
, "txouts", "The‚umber of unspentransaction outputs scanned"},

2128 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The current block height (index)"},

2129 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "bestblock", "The hash ofhe block‡theip ofhe chain"},

2130 {
RPCResuÉ
::
Ty³
::
ARR
, "unspents", "",

2132 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

2134 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction id"},

2135 {
RPCResuÉ
::
Ty³
::
NUM
, "vout", "The vout value"},

2136 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "scriptPubKey", "The script key"},

2137 {
RPCResuÉ
::
Ty³
::
STR
, "desc", "A specialized descriptor forhe matched scriptPubKey"},

2138 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "amouÁ", "ThtÙ®‡mouÁ iÀ" + 
CURRENCY_UNIT
 + " ofhe unspent output"},

2139 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "Height ofhe unspentransaction output"},

2142 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "tÙ®_amouÁ", "ThtÙ®‡mouÁ oà®Èfound un¥’ˆouut š " + 
CURRENCY_UNIT
},

2144 
RPCExam¶es
{""},

2145 }.
	`Check
(
»que¡
);

2147 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VARR
});

2149 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

2150 ià(
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "status") {

2151 
CošsV›wSÿnRe£rv”
 
»£rv”
;

2152 ià(
»£rv”
.
	`»£rve
()) {

2154  
NuÎUniV®ue
;

2156 
»suÉ
.
	`pushKV
("´og»ss", 
g_sÿn_´og»ss
);

2157  
»suÉ
;

2158 } ià(
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "abort") {

2159 
CošsV›wSÿnRe£rv”
 
»£rv”
;

2160 ià(
»£rv”
.
	`»£rve
()) {

2162  
çl£
;

2165 
g_should_abÜt_sÿn
 = 
Œue
;

2166  
Œue
;

2167 } ià(
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "start") {

2168 
CošsV›wSÿnRe£rv”
 
»£rv”
;

2169 ià(!
»£rv”
.
	`»£rve
()) {

2170 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Scan‡lready in…rogress, use‡ction \"abort\" or \"status\"");

2173 ià(
»que¡
.
·¿ms
.
	`size
() < 2) {

2174 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "scanobjects‡rgument is„equired forhe start‡ction");

2177 
¡d
::
£t
<
CSüt
> 
ÃedËs
;

2178 
¡d
::
m­
<
CSüt
, std::
¡ršg
> 
desütÜs
;

2179 
CAmouÁ
 
tÙ®_š
 = 0;

2182 cÚ¡ 
UniV®ue
& 
sÿnobjeù
 : 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
().
	`g‘V®ues
()) {

2183 
FÏtSignšgProvid”
 
´ovid”
;

2184 autØ
süts
 = 
	`Ev®DesütÜSŒšgOrObjeù
(
sÿnobjeù
, 
´ovid”
);

2185 cÚ¡‡uto& 
süt
 : 
süts
) {

2186 
¡d
::
¡ršg
 
šã¼ed
 = 
	`InãrDesütÜ
(
süt
, 
´ovid”
)->
	`ToSŒšg
();

2187 
ÃedËs
.
	`em¶aû
(
süt
);

2188 
desütÜs
.
	`em¶aû
(
¡d
::
	`move
(
süt
), std::move(
šã¼ed
));

2193 
UniV®ue
 
	`un¥’ts
(UniV®ue::
VARR
);

2194 
¡d
::
veùÜ
<
CTxOut
> 
šput_txos
;

2195 
¡d
::
m­
<
COutPošt
, 
Coš
> 
cošs
;

2196 
g_should_abÜt_sÿn
 = 
çl£
;

2197 
g_sÿn_´og»ss
 = 0;

2198 
št64_t
 
couÁ
 = 0;

2199 
¡d
::
unique_±r
<
CCošsV›wCursÜ
> 
pcursÜ
;

2200 
CBlockIndex
* 
t
;

2202 
	`LOCK
(
cs_maš
);

2203 ::
	`Chaš¡©eAùive
().
	`FÜûFlushS‹ToDisk
();

2204 
pcursÜ
 = 
¡d
::
unique_±r
<
CCošsV›wCursÜ
>(::
	`Chaš¡©eAùive
().
	`CošsDB
().
	`CursÜ
());

2205 
	`CHECK_NONFATAL
(
pcursÜ
);

2206 
t
 = ::
	`ChašAùive
().
	`T
();

2207 
	`CHECK_NONFATAL
(
t
);

2209 
boŞ
 
»s
 = 
	`FšdSütPubKey
(
g_sÿn_´og»ss
, 
g_should_abÜt_sÿn
, 
couÁ
, 
pcursÜ
.
	`g‘
(), 
ÃedËs
, 
cošs
);

2210 
»suÉ
.
	`pushKV
("sucûss", 
»s
);

2211 
»suÉ
.
	`pushKV
("txouts", 
couÁ
);

2212 
»suÉ
.
	`pushKV
("height", 
t
->
nHeight
);

2213 
»suÉ
.
	`pushKV
("be¡block", 
t
->
	`G‘BlockHash
().
	`G‘Hex
());

2215 cÚ¡‡uto& 
™
 : 
cošs
) {

2216 cÚ¡ 
COutPošt
& 
ouošt
 = 
™
.
fœ¡
;

2217 cÚ¡ 
Coš
& 
coš
 = 
™
.
£cÚd
;

2218 cÚ¡ 
CTxOut
& 
txo
 = 
coš
.
out
;

2219 
šput_txos
.
	`push_back
(
txo
);

2220 
tÙ®_š
 +ğ
txo
.
nV®ue
;

2222 
UniV®ue
 
	`un¥’t
(UniV®ue::
VOBJ
);

2223 
un¥’t
.
	`pushKV
("txid", 
ouošt
.
hash
.
	`G‘Hex
());

2224 
un¥’t
.
	`pushKV
("vout", (
št32_t
)
ouošt
.
n
);

2225 
un¥’t
.
	`pushKV
("sütPubKey", 
	`HexSŒ
(
txo
.
sütPubKey
.
	`begš
(),xo.sütPubKey.
	`’d
()));

2226 
un¥’t
.
	`pushKV
("desc", 
desütÜs
[
txo
.
sütPubKey
]);

2227 
un¥’t
.
	`pushKV
("amouÁ", 
	`V®ueFromAmouÁ
(
txo
.
nV®ue
));

2228 
un¥’t
.
	`pushKV
("height", (
št32_t
)
coš
.
nHeight
);

2230 if(!
coš
.
out
.
as£tInfo
.
	`IsNuÎ
()) {

2231 
un¥’t
.
	`pushKV
("as£t_guid", 
coš
.
out
.
as£tInfo
.
nAs£t
);

2232 
un¥’t
.
	`pushKV
("as£t_amouÁ", 
coš
.
out
.
as£tInfo
.
nV®ue
);

2235 
un¥’ts
.
	`push_back
(
un¥’t
);

2237 
»suÉ
.
	`pushKV
("un¥’ts", 
un¥’ts
);

2238 
»suÉ
.
	`pushKV
("tÙ®_amouÁ", 
	`V®ueFromAmouÁ
(
tÙ®_š
));

2240 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid command");

2242  
»suÉ
;

2243 
	}
}

2245 
UniV®ue
 
	$g‘blockf‹r
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

2247 
RPCH–pMª
{"getblockfilter",

2250 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The hash ofhe block"},

2251 {"f‹¹y³", 
RPCArg
::
Ty³
::
STR
, "basic", "Theype‚ame ofhe filter"},

2253 
RPCResuÉ
{

2254 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

2256 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "filter", "the hex-encoded filter data"},

2257 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "header", "the hex-encoded filter header"},

2259 
RPCExam¶es
{

2260 
	`H–pExam¶eCli
("getblockfilter", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\" \"basic\"") +

2261 
	`H–pExam¶eRpc
("getblockfilter", "\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\", \"basic\"")

2263 }.
	`Check
(
»que¡
);

2265 
ušt256
 
block_hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "blockhash");

2266 
¡d
::
¡ršg
 
f‹¹y³_Çme
 = "basic";

2267 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

2268 
f‹¹y³_Çme
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

2271 
BlockF‹rTy³
 
f‹¹y³
;

2272 ià(!
	`BlockF‹rTy³ByName
(
f‹¹y³_Çme
, 
f‹¹y³
)) {

2273 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Unknown filtertype");

2276 
BlockF‹rIndex
* 
šdex
 = 
	`G‘BlockF‹rIndex
(
f‹¹y³
);

2277 ià(!
šdex
) {

2278 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Index i nÙƒÇbËd fÜ f‹¹y³ " + 
f‹¹y³_Çme
);

2281 cÚ¡ 
CBlockIndex
* 
block_šdex
;

2282 
boŞ
 
block_was_cÚÃùed
;

2284 
	`LOCK
(
cs_maš
);

2285 
block_šdex
 = 
	`LookupBlockIndex
(
block_hash
);

2286 ià(!
block_šdex
) {

2287 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

2289 
block_was_cÚÃùed
 = 
block_šdex
->
	`IsV®id
(
BLOCK_VALID_SCRIPTS
);

2292 
boŞ
 
šdex_»ady
 = 
šdex
->
	`BlockUÁSynûdToCu¼’tChaš
();

2294 
BlockF‹r
 
f‹r
;

2295 
ušt256
 
f‹r_h—d”
;

2296 ià(!
šdex
->
	`LookupF‹r
(
block_šdex
, 
f‹r
) ||

2297 !
šdex
->
	`LookupF‹rH—d”
(
block_šdex
, 
f‹r_h—d”
)) {

2298 
”r_code
;

2299 
¡d
::
¡ršg
 
”rmsg
 = "Filter‚ot found.";

2301 ià(!
block_was_cÚÃùed
) {

2302 
”r_code
 = 
RPC_INVALID_ADDRESS_OR_KEY
;

2303 
”rmsg
 += " Block was‚ot connectedo‡ctive chain.";

2304 } ià(!
šdex_»ady
) {

2305 
”r_code
 = 
RPC_MISC_ERROR
;

2306 
”rmsg
 += " Block filters‡re still inhe…rocess of being indexed.";

2308 
”r_code
 = 
RPC_INTERNAL_ERROR
;

2309 
”rmsg
 += " Thisƒrror is unexpected‡nd indicates index corruption.";

2312 
throw
 
	`JSONRPCE¼Ü
(
”r_code
, 
”rmsg
);

2315 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

2316 
»t
.
	`pushKV
("f‹r", 
	`HexSŒ
(
f‹r
.
	`G‘EncodedF‹r
()));

2317 
»t
.
	`pushKV
("h—d”", 
f‹r_h—d”
.
	`G‘Hex
());

2318  
»t
;

2319 
	}
}

2326 
UniV®ue
 
	$dum±xout£t
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

2328 
RPCH–pMª
{

2333 
RPCArg
::
Ty³
::
STR
,

2334 
RPCArg
::
O±iÚ®
::
NO
,

2338 
RPCResuÉ
{

2339 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

2341 {
RPCResuÉ
::
Ty³
::
NUM
, "coins_written", "the‚umber of coins written inhe snapshot"},

2342 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "base_hash", "the hash ofhe base ofhe snapshot"},

2343 {
RPCResuÉ
::
Ty³
::
NUM
, "base_height", "the height ofhe base ofhe snapshot"},

2344 {
RPCResuÉ
::
Ty³
::
STR
, "path", "the‡bsolute…athhathe snapshot was writteno"},

2347 
RPCExam¶es
{

2348 
	`H–pExam¶eCli
("dumptxoutset", "utxo.dat")

2350 }.
	`Check
(
»que¡
);

2352 
fs
::
·th
…©h = fs::
	`absŞu‹
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
	`G‘D©aDœ
());

2355 
fs
::
·th
 
‹mµ©h
 = fs::
	`absŞu‹
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(è+ ".šcom¶‘e", 
	`G‘D©aDœ
());

2357 ià(
fs
::
	`exi¡s
(
·th
)) {

2358 
throw
 
	`JSONRPCE¼Ü
(

2359 
RPC_INVALID_PARAMETER
,

2360 
·th
.
	`¡ršg
() + "‡lreadyƒxists. If you‡re surehis is what you want, "

2364 
FILE
* 
fe
{
fsbridge
::
	`fİ’
(
‹mµ©h
, "wb")};

2365 
CAutoFe
 
afe
{
fe
, 
SER_DISK
, 
CLIENT_VERSION
};

2366 
¡d
::
unique_±r
<
CCošsV›wCursÜ
> 
pcursÜ
;

2367 
CCošsSts
 
¡©s
;

2368 
CBlockIndex
* 
t
;

2383 
	`LOCK
(::
cs_maš
);

2385 ::
	`Chaš¡©eAùive
().
	`FÜûFlushS‹ToDisk
();

2387 ià(!
	`G‘UTXOSts
(&::
	`Chaš¡©eAùive
().
	`CošsDB
(), 
¡©s
, 
RpcIÁ”ru±iÚPošt
)) {

2388 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Unableo„ead UTXO set");

2391 
pcursÜ
 = 
¡d
::
unique_±r
<
CCošsV›wCursÜ
>(::
	`Chaš¡©eAùive
().
	`CošsDB
().
	`CursÜ
());

2392 
t
 = 
	`LookupBlockIndex
(
¡©s
.
hashBlock
);

2393 
	`CHECK_NONFATAL
(
t
);

2396 
SÇpshÙM‘ad©a
 
m‘ad©a
{
t
->
	`G‘BlockHash
(), 
¡©s
.
cošs_couÁ
,->
nChašTx
};

2398 
afe
 << 
m‘ad©a
;

2400 
COutPošt
 
key
;

2401 
Coš
 
coš
;

2402 
™”
{0};

2404 
pcursÜ
->
	`V®id
()) {

2405 ià(
™”
 % 5000 =ğ0è
	`RpcIÁ”ru±iÚPošt
();

2406 ++
™”
;

2407 ià(
pcursÜ
->
	`G‘Key
(
key
è&&…cursÜ->
	`G‘V®ue
(
coš
)) {

2408 
afe
 << 
key
;

2409 
afe
 << 
coš
;

2412 
pcursÜ
->
	`Next
();

2415 
afe
.
	`fşo£
();

2416 
fs
::
	`»Çme
(
‹mµ©h
, 
·th
);

2418 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

2419 
»suÉ
.
	`pushKV
("cošs_wr™‹n", 
¡©s
.
cošs_couÁ
);

2420 
»suÉ
.
	`pushKV
("ba£_hash", 
t
->
	`G‘BlockHash
().
	`ToSŒšg
());

2421 
»suÉ
.
	`pushKV
("ba£_height", 
t
->
nHeight
);

2422 
»suÉ
.
	`pushKV
("·th", 
·th
.
	`¡ršg
());

2423  
»suÉ
;

2424 
	}
}

2426 
	$Regi¡”BlockchašRPCCommªds
(
CRPCTabË
 &
t
)

2429 cÚ¡ 
CRPCCommªd
 
commªds
[] =

2432 { "blockchaš", "g‘blockchaššfo", &
g‘blockchaššfo
, {} },

2433 { "blockchaš", "g‘chaštx¡©s", &
g‘chaštx¡©s
, {"nblocks", "blockhash"} },

2434 { "blockchaš", "g‘block¡©s", &
g‘block¡©s
, {"hash_or_height", "stats"} },

2435 { "blockchaš", "g‘be¡blockhash", &
g‘be¡blockhash
, {} },

2436 { "blockchaš", "g‘blockcouÁ", &
g‘blockcouÁ
, {} },

2437 { "blockchaš", "g‘block", &
g‘block
, {"blockhash","verbosity|verbose"} },

2438 { "blockchaš", "g‘blockhash", &
g‘blockhash
, {"height"} },

2439 { "blockchaš", "g‘blockh—d”", &
g‘blockh—d”
, {"blockhash","verbose"} },

2440 { "blockchaš", "g‘chašts", &
g‘chašts
, {} },

2441 { "blockchaš", "g‘difficuÉy", &
g‘difficuÉy
, {} },

2442 { "blockchaš", "g‘mempoŞªû¡Üs", &
g‘mempoŞªû¡Üs
, {"txid","verbose"} },

2443 { "blockchaš", "g‘mempoŞdesûndªts", &
g‘mempoŞdesûndªts
, {"txid","verbose"} },

2444 { "blockchaš", "g‘mempoŞ’Œy", &
g‘mempoŞ’Œy
, {"txid"} },

2445 { "blockchaš", "g‘mempoŞšfo", &
g‘mempoŞšfo
, {} },

2446 { "blockchaš", "g‘¿wmempoŞ", &
g‘¿wmempoŞ
, {"verbose"} },

2447 { "blockchaš", "g‘txout", &
g‘txout
, {"txid","n","include_mempool"} },

2448 { "blockchaš", "g‘txout£tšfo", &
g‘txout£tšfo
, {} },

2449 { "blockchaš", "´uÃblockchaš", &
´uÃblockchaš
, {"height"} },

2450 { "blockchaš", "§vemempoŞ", &
§vemempoŞ
, {} },

2451 { "blockchaš", "v”ifychaš", &
v”ifychaš
, {"checklevel","nblocks"} },

2453 { "blockchaš", "´eciousblock", &
´eciousblock
, {"blockhash"} },

2454 { "blockchaš", "sÿÁxout£t", &
sÿÁxout£t
, {"action", "scanobjects"} },

2455 { "blockchaš", "g‘blockf‹r", &
g‘blockf‹r
, {"blockhash", "filtertype"} },

2458 { "hidd’", "šv®id©eblock", &
šv®id©eblock
, {"blockhash"} },

2459 { "hidd’", "»cÚsid”block", &
»cÚsid”block
, {"blockhash"} },

2460 { "hidd’", "wa™fÜÃwblock", &
wa™fÜÃwblock
, {"timeout"} },

2461 { "hidd’", "wa™fÜblock", &
wa™fÜblock
, {"blockhash","timeout"} },

2462 { "hidd’", "wa™fÜblockheight", &
wa™fÜblockheight
, {"height","timeout"} },

2463 { "hidd’", "syncw™hv®id©iÚš‹rçûqueue", &
syncw™hv®id©iÚš‹rçûqueue
, {} },

2464 { "hidd’", "dum±xout£t", &
dum±xout£t
, {"path"} },

2468 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

2469 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

2470 
	}
}

	@blockchain.h

5 #iâdeà
SYSCOIN_RPC_BLOCKCHAIN_H


6 
	#SYSCOIN_RPC_BLOCKCHAIN_H


	)

8 
	~<amouÁ.h
>

9 
	~<sync.h
>

11 
	~<¡dšt.h
>

12 
	~<veùÜ
>

14 
RecursiveMu‹x
 
cs_maš
;

16 
şass
 
	gCBlock
;

17 
şass
 
	gCBlockIndex
;

18 
şass
 
	gCTxMemPoŞ
;

19 
şass
 
	gChaš¡©eMªag”
;

20 
şass
 
	gUniV®ue
;

21 
	gNodeCÚ‹xt
;

22 
Çme¥aû
 
	gut
 {

23 
şass
 
	gRef
;

26 
cÚ¡ex´
 
	gNUM_GETBLOCKSTATS_PERCENTILES
 = 5;

34 
G‘DifficuÉy
(cÚ¡ 
CBlockIndex
* 
blockšdex
);

37 
RPCNÙifyBlockChªge
(cÚ¡ 
CBlockIndex
*);

40 
UniV®ue
 
	$blockToJSON
(cÚ¡ 
CBlock
& 
block
, cÚ¡ 
CBlockIndex
* 
t
, cÚ¡ CBlockIndex* 
blockšdex
, 
boŞ
 
txD‘as
 = 
çl£
è
	`LOCKS_EXCLUDED
(
cs_maš
);

43 
UniV®ue
 
	`MempoŞInfoToJSON
(cÚ¡ 
CTxMemPoŞ
& 
poŞ
);

46 
UniV®ue
 
	`MempoŞToJSON
(cÚ¡ 
CTxMemPoŞ
& 
poŞ
, 
boŞ
 
v”bo£
 = 
çl£
);

49 
UniV®ue
 
	$blockh—d”ToJSON
(cÚ¡ 
CBlockIndex
* 
t
, cÚ¡ CBlockIndex* 
blockšdex
è
	`LOCKS_EXCLUDED
(
cs_maš
);

52 
	`C®cuÏ‹P”ûÁesByWeight
(
CAmouÁ
 
»suÉ
[
NUM_GETBLOCKSTATS_PERCENTILES
], 
¡d
::
veùÜ
<¡d::
·œ
<CAmouÁ, 
št64_t
>>& 
scÜes
, iÁ64_ˆ
tÙ®_weight
);

54 
NodeCÚ‹xt
& 
	`Ensu»NodeCÚ‹xt
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
);

55 
CTxMemPoŞ
& 
	`Ensu»MemPoŞ
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
);

56 
Chaš¡©eMªag”
& 
	`Ensu»Chašmª
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
);

	@client.cpp

6 
	~<½c/ş›Á.h
>

7 
	~<ut/sy¡em.h
>

9 
	~<£t
>

10 
	~<¡dšt.h
>

12 şas 
	cCRPCCÚv”tP¬am


14 
	mpublic
:

15 
¡d
::
¡ršg
 
m‘hodName
;

16 
	m·¿mIdx
;

17 
	m¡d
::
¡ršg
 
·¿mName
;

27 cÚ¡ 
CRPCCÚv”tP¬am
 
	gvRPCCÚv”tP¬ams
[] =

223 şas 
	cCRPCCÚv”tTabË


225 
	m´iv©e
:

226 
¡d
::
£t
<¡d::
·œ
<¡d::
¡ršg
, >> 
	mmemb”s
;

227 
	m¡d
::
£t
<
¡d
::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
memb”sByName
;

229 
	mpublic
:

230 
CRPCCÚv”tTabË
();

232 
boŞ
 
	$cÚv”t
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hod
, 
idx
) {

233  (
memb”s
.
	`couÁ
(
¡d
::
	`make_·œ
(
m‘hod
, 
idx
)) > 0);

235 
boŞ
 
	$cÚv”t
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hod
, cÚ¡ std::¡ršg& 
Çme
) {

236  (
memb”sByName
.
	`couÁ
(
¡d
::
	`make_·œ
(
m‘hod
, 
Çme
)) > 0);

237 
	}
}

240 
	gCRPCCÚv”tTabË
::
	$CRPCCÚv”tTabË
()

242 cÚ¡ 
n_–em
 =

243 ((
vRPCCÚv”tP¬ams
) / (vRPCConvertParams[0]));

245 
i
 = 0; i < 
n_–em
; i++) {

246 
memb”s
.
	`š£¹
(
¡d
::
	`make_·œ
(
vRPCCÚv”tP¬ams
[
i
].
m‘hodName
,

247 
vRPCCÚv”tP¬ams
[
i
].
·¿mIdx
));

248 
memb”sByName
.
	`š£¹
(
¡d
::
	`make_·œ
(
vRPCCÚv”tP¬ams
[
i
].
m‘hodName
,

249 
vRPCCÚv”tP¬ams
[
i
].
·¿mName
));

251 
	}
}

253 
CRPCCÚv”tTabË
 
	g½cCvtTabË
;

258 
UniV®ue
 
	$P¬£NÚRFCJSONV®ue
(cÚ¡ 
¡d
::
¡ršg
& 
¡rV®
)

260 
UniV®ue
 
jV®
;

261 ià(!
jV®
.
	`»ad
(
¡d
::
	`¡ršg
("[")+
¡rV®
+std::string("]")) ||

262 !
jV®
.
	`isA¼ay
(è|| jV®.
	`size
()!=1)

263 
throw
 
¡d
::
	`ruÁime_”rÜ
(¡d::
	`¡ršg
("E¼Ü…¬sšg JSON:")+
¡rV®
);

264  
jV®
[0];

265 
	}
}

267 
UniV®ue
 
RPCCÚv”tV®ues
(cÚ¡ 
¡d
::
¡ršg
 &
¡rM‘hod
, cÚ¡ std::
veùÜ
<¡d::¡ršg> &
¡rP¬ams
)

269 
UniV®ue
 
·¿ms
(UniV®ue::
VARR
);

271 
	gidx
 = 0; idx < 
	g¡rP¬ams
.
size
(); idx++) {

272 cÚ¡ 
	g¡d
::
¡ršg
& 
¡rV®
 = 
¡rP¬ams
[
idx
];

274 ià(!
	g½cCvtTabË
.
cÚv”t
(
¡rM‘hod
, 
idx
)) {

276 
	g·¿ms
.
push_back
(
¡rV®
);

279 
	g·¿ms
.
push_back
(
P¬£NÚRFCJSONV®ue
(
¡rV®
));

283  
	g·¿ms
;

286 
UniV®ue
 
RPCCÚv”tNamedV®ues
(cÚ¡ 
¡d
::
¡ršg
 &
¡rM‘hod
, cÚ¡ std::
veùÜ
<¡d::¡ršg> &
¡rP¬ams
)

288 
UniV®ue
 
·¿ms
(UniV®ue::
VOBJ
);

290 cÚ¡ 
	g¡d
::
¡ršg
 &
s
: 
¡rP¬ams
) {

291 
size_t
 
pos
 = 
s
.
fšd
('=');

292 ià(
	gpos
 =ğ
¡d
::
¡ršg
::
Åos
) {

293 
throw
(
¡d
::
ruÁime_”rÜ
("NØ'=' iÀÇmed‡rgum’ˆ'"+
s
+"',his‚eedso be…resent forƒvery‡rgument (even if it isƒmpty)"));

296 
	g¡d
::
¡ršg
 
Çme
 = 
s
.
sub¡r
(0, 
pos
);

297 
	g¡d
::
¡ršg
 
v®ue
 = 
s
.
sub¡r
(
pos
+1);

299 ià(!
	g½cCvtTabË
.
cÚv”t
(
¡rM‘hod
, 
Çme
)) {

301 
	g·¿ms
.
pushKV
(
Çme
, 
v®ue
);

304 
	g·¿ms
.
pushKV
(
Çme
, 
P¬£NÚRFCJSONV®ue
(
v®ue
));

308  
	g·¿ms
;

	@client.h

6 #iâdeà
SYSCOIN_RPC_CLIENT_H


7 
	#SYSCOIN_RPC_CLIENT_H


	)

9 
	~<univ®ue.h
>

12 
UniV®ue
 
RPCCÚv”tV®ues
(cÚ¡ 
¡d
::
¡ršg
& 
¡rM‘hod
, cÚ¡ std::
veùÜ
<¡d::¡ršg>& 
¡rP¬ams
);

15 
UniV®ue
 
RPCCÚv”tNamedV®ues
(cÚ¡ 
¡d
::
¡ršg
& 
¡rM‘hod
, cÚ¡ std::
veùÜ
<¡d::¡ršg>& 
¡rP¬ams
);

20 
UniV®ue
 
P¬£NÚRFCJSONV®ue
(cÚ¡ 
¡d
::
¡ršg
& 
¡rV®
);

	@governance.cpp

5 
	~<ma¡”node/aùivema¡”node.h
>

6 
	~<cÚ£nsus/v®id©iÚ.h
>

7 
	~<cÜe_io.h
>

8 
	~<gov”Çnû/gov”Çnû.h
>

9 
	~<gov”Çnû/gov”Çnû-vÙe.h
>

10 
	~<gov”Çnû/gov”Çnû-şas£s.h
>

11 
	~<gov”Çnû/gov”Çnû-v®id©Üs.h
>

12 
	~<š™.h
>

13 
	~<txmempoŞ.h
>

14 
	~<v®id©iÚ.h
>

15 
	~<ma¡”node/ma¡”node-sync.h
>

16 
	~<mes§gesigÃr.h
>

17 
	~<½c/£rv”.h
>

18 
	~<ut/sy¡em.h
>

19 
	~<ut/mÚey¡r.h
>

20 
	~<w®Ët/½cw®Ët.h
>

21 #ifdeà
ENABLE_WALLET


22 
	~<w®Ët/w®Ët.h
>

24 
	~<½c/ut.h
>

25 
	~<Ãt.h
>

26 
	~<½c/blockchaš.h
>

27 
	~<node/cÚ‹xt.h
>

28 
	$gobjeù_couÁ_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

30 
RPCH–pMª
{"gobject count",

36 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

37 
RPCExam¶es
{""},

38 }.
	`Check
(
»que¡
);

40 
	}
}

42 
UniV®ue
 
	$gobjeù_couÁ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

44 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() > 2)

45 
	`gobjeù_couÁ_h–p
(
»que¡
);

47 
¡d
::
¡ršg
 
¡rMode
{"json"};

49 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

50 
¡rMode
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

53 ià(
¡rMode
 != "json" && strMode != "all")

54 
	`gobjeù_couÁ_h–p
(
»que¡
);

56  
¡rMode
 =ğ"jsÚ" ? 
gov”Çnû
.
	`ToJsÚ
(è: gov”Çnû.
	`ToSŒšg
();

57 
	}
}

59 
	$gobjeù_de£rŸlize_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

61 
RPCH–pMª
{"gobject deserialize",

67 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

68 
RPCExam¶es
{""},

69 }.
	`Check
(
»que¡
);

70 
	}
}

72 
UniV®ue
 
	$gobjeù_de£rŸlize
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

74 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2)

75 
	`gobjeù_de£rŸlize_h–p
(
»que¡
);

77 
¡d
::
¡ršg
 
¡rHex
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

79 
¡d
::
veùÜ
<> 
v
 = 
	`P¬£Hex
(
¡rHex
);

80 
¡d
::
¡ršg
 
	`s
(
v
.
	`begš
(), v.
	`’d
());

82 
UniV®ue
 
	`u
(UniV®ue::
VOBJ
);

83 
u
.
	`»ad
(
s
);

85  
u
.
	`wr™e
().
	`c_¡r
();

86 
	}
}

88 
	$gobjeù_check_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

90 
RPCH–pMª
{"gobject check",

96 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

97 
RPCExam¶es
{""},

98 }.
	`Check
(
»que¡
);

99 
	}
}

101 
UniV®ue
 
	$gobjeù_check
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

103 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2)

104 
	`gobjeù_check_h–p
(
»que¡
);

108 
ušt256
 
hashP¬’t
;

110 
nRevisiÚ
 = 1;

112 
št64_t
 
nTime
 = 
	`G‘Adju¡edTime
();

113 
¡d
::
¡ršg
 
¡rD©aHex
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

115 
CGov”ÇnûObjeù
 
	`govobj
(
hashP¬’t
, 
nRevisiÚ
, 
nTime
, 
	`ušt256
(), 
¡rD©aHex
);

117 ià(
govobj
.
	`G‘ObjeùTy³
(è=ğ
GOVERNANCE_OBJECT_PROPOSAL
) {

118 
CPrİo§lV®id©Ü
 
	`v®id©Ü
(
¡rD©aHex
, 
çl£
);

119 ià(!
v®id©Ü
.
	`V®id©e
()) {

120 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Inv®id…rİo§Èd©a,ƒ¼Ü mes§ges:" + 
v®id©Ü
.
	`G‘E¼ÜMes§ges
());

123 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid objectype, only…roposals can be validated");

126 
UniV®ue
 
	`objResuÉ
(UniV®ue::
VOBJ
);

128 
objResuÉ
.
	`pushKV
("Object status", "OK");

130  
objResuÉ
;

131 
	}
}

133 #ifdeà
ENABLE_WALLET


134 
	$gobjeù_´•¬e_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

136 
RPCH–pMª
{"gobject…repare",

138 + 
HELP_REQUIRING_PASSPHRASE
 +

149 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

150 
RPCExam¶es
{""},

151 }.
	`Check
(
»que¡
);

152 
	}
}

154 
UniV®ue
 
	$gobjeù_´•¬e
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

156 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

157 ià(!
w®Ët
è 
NuÎUniV®ue
;

158 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

159 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 5 &&„equest.params.size() != 6 &&„equest.params.size() != 8))

160 
	`gobjeù_´•¬e_h–p
(
»que¡
);

162 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

163 if(!
node
.
cÚnmª
)

164 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

166 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

170 
ušt256
 
hashP¬’t
;

173 ià(
»que¡
.
·¿ms
[1].
	`g‘_¡r
() == "0") {

174 
hashP¬’t
 = 
	`ušt256
();

176 
hashP¬’t
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "fee-txid,…arameter 1");

179 
¡d
::
¡ršg
 
¡rRevisiÚ
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

180 
¡d
::
¡ršg
 
¡rTime
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

181 
nRevisiÚ
 = 
	`©oi
(
¡rRevisiÚ
);

182 
št64_t
 
nTime
 = 
	`©oi64
(
¡rTime
);

183 
¡d
::
¡ršg
 
¡rD©aHex
 = 
»que¡
.
·¿ms
[4].
	`g‘_¡r
();

187 
CGov”ÇnûObjeù
 
	`govobj
(
hashP¬’t
, 
nRevisiÚ
, 
nTime
, 
	`ušt256
(), 
¡rD©aHex
);

193 
	`LogPrštf
("gobject_prepare --…arams: %s %s %s %s, data: %s, hash: %s\n",

194 
»que¡
.
·¿ms
[1].
	`g‘_¡r
(),„equest.params[2].get_str(),

195 
»que¡
.
·¿ms
[3].
	`g‘_¡r
(),„equest.params[4].get_str(),

196 
govobj
.
	`G‘D©aAsPÏšSŒšg
(), govobj.
	`G‘Hash
().
	`ToSŒšg
());

198 ià(
govobj
.
	`G‘ObjeùTy³
(è=ğ
GOVERNANCE_OBJECT_PROPOSAL
) {

199 
CPrİo§lV®id©Ü
 
	`v®id©Ü
(
¡rD©aHex
, 
çl£
);

200 ià(!
v®id©Ü
.
	`V®id©e
()) {

201 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Inv®id…rİo§Èd©a,ƒ¼Ü mes§ges:" + 
v®id©Ü
.
	`G‘E¼ÜMes§ges
());

205 ià(
govobj
.
	`G‘ObjeùTy³
(è=ğ
GOVERNANCE_OBJECT_TRIGGER
) {

206 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Trigger objects‚eed‚ot be…repared (however only masternodes can createhem)");

209 
	`LOCK2
(
cs_maš
, 
mempoŞ
.
cs
);

210 
	`LOCK
(
pw®Ët
->
cs_w®Ët
);

212 
¡d
::
¡ršg
 
¡rE¼Ü
 = "";

213 ià(!
govobj
.
	`IsV®idLoÿÎy
(
¡rE¼Ü
, 
çl£
))

214 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Gov”Çnû objeù i nÙ v®id - " + 
govobj
.
	`G‘Hash
().
	`ToSŒšg
(è+ " - " + 
¡rE¼Ü
);

217 
COutPošt
 
ouošt
;

218 
ouošt
.
	`S‘NuÎ
();

219 ià(!
»que¡
.
·¿ms
[6].
	`isNuÎ
() && !request.params[7].isNull()) {

220 
ušt256
 
cŞÏ‹¿lHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[6], "outputHash");

221 
št32_t
 
cŞÏ‹¿lIndex
 = 
»que¡
.
·¿ms
[7].
	`g‘_št
();

222 ià(
cŞÏ‹¿lHash
.
	`IsNuÎ
(è|| 
cŞÏ‹¿lIndex
 < 0) {

223 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id hash o¸šdex: %s-%d", 
cŞÏ‹¿lHash
.
	`ToSŒšg
(), 
cŞÏ‹¿lIndex
));

225 
ouošt
 = 
	`COutPošt
(
cŞÏ‹¿lHash
, (
ušt32_t
)
cŞÏ‹¿lIndex
);

228 
CT¿n§ùiÚRef
 
tx
;

229 ià(!
pw®Ët
->
	`G‘Budg‘Sy¡emCŞÏ‹¿lTX
(
tx
, 
govobj
.
	`G‘Hash
(), govobj.
	`G‘MšCŞÏ‹¿lF“
(), 
ouošt
)) {

230 
¡d
::
¡ršg
 
”r
 = "Error making collateralransaction for governance object. Please check your wallet balance‡nd make sure your wallet is unlocked.";

231 ià(!
»que¡
.
·¿ms
[6].
	`isNuÎ
() && !request.params[7].isNull()) {

232 
”r
 += "Please verify your specified output is valid‡nd isƒnough forhe combined…roposal fee‡ndransaction fee.";

234 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, 
”r
);

238 
m­V®ue_t
 
m­V®ue
;

239 
pw®Ët
->
	`Comm™T¿n§ùiÚ
(
tx
, 
¡d
::
	`move
(
m­V®ue
), {} );

241 
	`LogPršt
(
BCLog
::
GOBJECT
, "gobject_prepare -- GetDataAsPlainString = %s, hash = %s,xid = %s\n",

242 
govobj
.
	`G‘D©aAsPÏšSŒšg
(), govobj.
	`G‘Hash
().
	`ToSŒšg
(), 
tx
->GetHash().ToString());

244  
tx
->
	`G‘Hash
().
	`ToSŒšg
();

245 
	}
}

248 
	$gobjeù_subm™_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

250 
RPCH–pMª
{"gobject submit",

260 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

261 
RPCExam¶es
{""},

262 }.
	`Check
(
»que¡
);

263 
	}
}

265 
UniV®ue
 
	$gobjeù_subm™
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

267 ià(
»que¡
.
fH–p
 || (Ôeque¡.
·¿ms
.
	`size
() < 5) || (request.params.size() > 6)))

268 
	`gobjeù_subm™_h–p
(
»que¡
);

270 if(!
ma¡”nodeSync
.
	`IsBlockchašSynûd
()) {

271 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_IN_INITIAL_DOWNLOAD
, "Must wait for cliento sync with masternode‚etwork. Try‡gain in‡ minute or so.");

273 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

274 if(!
node
.
cÚnmª
)

275 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

277 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

278 
boŞ
 
fMnFound
 = 
mnLi¡
.
	`HasV®idMNByCŞÏ‹¿l
(
aùiveMa¡”nodeInfo
.
ouošt
);

280 
	`LogPršt
(
BCLog
::
GOBJECT
, "gobject_submit --…ubKeyOperator = %s, outpoint = %s,…arams.size() = %lld, fMnFound = %d\n",

281 (
aùiveMa¡”nodeInfo
.
blsPubKeyO³¿tÜ
 ?‡ùiveMa¡”nodeInfo.blsPubKeyO³¿tÜ->
	`ToSŒšg
() : "N/A"),

282 
aùiveMa¡”nodeInfo
.
ouošt
.
	`ToSŒšgShÜt
(), 
»que¡
.
·¿ms
.
	`size
(), 
fMnFound
);

286 
ušt256
 
txidF“
;

288 ià(!
»que¡
.
·¿ms
[5].
	`isNuÎ
()) {

289 
txidF“
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[5], "fee-txid,…arameter 6");

291 
ušt256
 
hashP¬’t
;

292 ià(
»que¡
.
·¿ms
[1].
	`g‘_¡r
() == "0") {

293 
hashP¬’t
 = 
	`ušt256
();

295 
hashP¬’t
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "parent object hash,…arameter 2");

300 
¡d
::
¡ršg
 
¡rRevisiÚ
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

301 
¡d
::
¡ršg
 
¡rTime
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

302 
nRevisiÚ
 = 
	`©oi
(
¡rRevisiÚ
);

303 
št64_t
 
nTime
 = 
	`©oi64
(
¡rTime
);

304 
¡d
::
¡ršg
 
¡rD©aHex
 = 
»que¡
.
·¿ms
[4].
	`g‘_¡r
();

306 
CGov”ÇnûObjeù
 
	`govobj
(
hashP¬’t
, 
nRevisiÚ
, 
nTime
, 
txidF“
, 
¡rD©aHex
);

308 
	`LogPršt
(
BCLog
::
GOBJECT
, "gobject_submit -- GetDataAsPlainString = %s, hash = %s,xid = %s\n",

309 
govobj
.
	`G‘D©aAsPÏšSŒšg
(), govobj.
	`G‘Hash
().
	`ToSŒšg
(), 
txidF“
.ToString());

311 ià(
govobj
.
	`G‘ObjeùTy³
(è=ğ
GOVERNANCE_OBJECT_PROPOSAL
) {

312 
CPrİo§lV®id©Ü
 
	`v®id©Ü
(
¡rD©aHex
, 
çl£
);

313 ià(!
v®id©Ü
.
	`V®id©e
()) {

314 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Inv®id…rİo§Èd©a,ƒ¼Ü mes§ges:" + 
v®id©Ü
.
	`G‘E¼ÜMes§ges
());

319 ià(
govobj
.
	`G‘ObjeùTy³
(è=ğ
GOVERNANCE_OBJECT_TRIGGER
) {

320 ià(
fMnFound
) {

321 
govobj
.
	`S‘Ma¡”nodeOuošt
(
aùiveMa¡”nodeInfo
.
ouošt
);

322 
govobj
.
	`Sign
(*
aùiveMa¡”nodeInfo
.
blsKeyO³¿tÜ
);

324 
	`LogPrštf
("gobject(submit) -- Object submission„ejected because‚ode is‚ot‡ masternode\n");

325 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Only valid masternodes can submithisype of object");

327 } ià(
»que¡
.
·¿ms
.
	`size
() != 6) {

328 
	`LogPrštf
("gobject(submit) -- Object submission„ejected because feex‚ot…rovided\n");

329 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "The fee-txid…arameter must be includedo submithisype of object");

332 
¡d
::
¡ršg
 
¡rHash
 = 
govobj
.
	`G‘Hash
().
	`ToSŒšg
();

334 
¡d
::
¡ršg
 
¡rE¼Ü
 = "";

335 
boŞ
 
fMissšgCÚfœm©iÚs
;

337 
	`LOCK
(
cs_maš
);

338 ià(!
govobj
.
	`IsV®idLoÿÎy
(
¡rE¼Ü
, 
fMissšgCÚfœm©iÚs
, 
Œue
) && !fMissingConfirmations) {

339 
	`LogPrštf
("gobjeù(subm™è-- Objeù submissiÚ„ejeùed beÿu£ objeù i nÙ v®id - hash = %s, sŒE¼Ü = %s\n", 
¡rHash
, 
¡rE¼Ü
);

340 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Gov”Çnû objeù i nÙ v®id - " + 
¡rHash
 + " - " + 
¡rE¼Ü
);

346 ià(!
gov”Çnû
.
	`Ma¡”nodeR©eCheck
(
govobj
)) {

347 
	`LogPrštf
("gobjeù(subm™è-- Objeù submissiÚ„ejeùed beÿu£ oà¿‹ check fau» - hash = %s\n", 
¡rHash
);

348 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Object creation„ate†imitƒxceeded");

351 
	`LogPrštf
("gobjeù(subm™è-- Addšg†oÿÎy c»©ed gov”Çnû objeù - %s\n", 
¡rHash
);

353 ià(
fMissšgCÚfœm©iÚs
) {

354 
gov”Çnû
.
	`AddPo¡pÚedObjeù
(
govobj
);

355 
govobj
.
	`R–ay
(*
node
.
cÚnmª
);

357 
gov”Çnû
.
	`AddGov”ÇnûObjeù
(
govobj
, *
node
.
cÚnmª
);

360  
govobj
.
	`G‘Hash
().
	`ToSŒšg
();

361 
	}
}

363 
	$gobjeù_vÙe_cÚf_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

365 
RPCH–pMª
{"gobject vote-conf",

373 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

374 
RPCExam¶es
{""},

375 }.
	`Check
(
»que¡
);

376 
	}
}

378 
UniV®ue
 
	$gobjeù_vÙe_cÚf
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

380 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 4)

381 
	`gobjeù_vÙe_cÚf_h–p
(
»que¡
);

383 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

384 if(!
node
.
cÚnmª
)

385 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

387 
ušt256
 
hash
;

389 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "Object hash");

390 
¡d
::
¡ršg
 
¡rVÙeSigÇl
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

391 
¡d
::
¡ršg
 
¡rVÙeOutcome
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

393 
vÙe_sigÇl_’um_t
 
eVÙeSigÇl
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeSigÇl
(
¡rVÙeSigÇl
);

394 ià(
eVÙeSigÇl
 =ğ
VOTE_SIGNAL_NONE
) {

395 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
,

400 
vÙe_outcome_’um_t
 
eVÙeOutcome
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeOutcome
(
¡rVÙeOutcome
);

401 ià(
eVÙeOutcome
 =ğ
VOTE_OUTCOME_NONE
) {

402 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid vote outcome. Please use one ofhe following: 'yes', 'no' or 'abstain'");

405 
govObjTy³
;

407 
	`LOCK
(
gov”Çnû
.
cs
);

408 
CGov”ÇnûObjeù
 *
pGovObj
 = 
gov”Çnû
.
	`FšdGov”ÇnûObjeù
(
hash
);

409 ià(!
pGovObj
) {

410 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Governance object‚ot found");

412 
govObjTy³
 = 
pGovObj
->
	`G‘ObjeùTy³
();

415 
nSucûssful
 = 0;

416 
nFaed
 = 0;

418 
UniV®ue
 
	`»suÉsObj
(UniV®ue::
VOBJ
);

420 
UniV®ue
 
	`¡©usObj
(UniV®ue::
VOBJ
);

421 
UniV®ue
 
	`»tuºObj
(UniV®ue::
VOBJ
);

423 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘V®idMNByCŞÏ‹¿l
(
aùiveMa¡”nodeInfo
.
ouošt
);

425 ià(!
dmn
) {

426 
nFaed
++;

427 
¡©usObj
.
	`pushKV
("result", "failed");

428 
¡©usObj
.
	`pushKV
("errorMessage", "Can't find masternode by collateral output");

429 
»suÉsObj
.
	`pushKV
("syscoš.cÚf", 
¡©usObj
);

430 
»tuºObj
.
	`pushKV
("ov”®l", 
	`¡½rštf
("VÙed sucûssfuÎy %dime(sèªd faed %dime(s).", 
nSucûssful
, 
nFaed
));

431 
»tuºObj
.
	`pushKV
("d‘a", 
»suÉsObj
);

432  
»tuºObj
;

435 
CGov”ÇnûVÙe
 
	`vÙe
(
dmn
->
cŞÏ‹¿lOuošt
, 
hash
, 
eVÙeSigÇl
, 
eVÙeOutcome
);

437 
boŞ
 
signSucûss
 = 
çl£
;

438 ià(
govObjTy³
 =ğ
GOVERNANCE_OBJECT_PROPOSAL
 && 
eVÙeSigÇl
 =ğ
VOTE_SIGNAL_FUNDING
) {

439 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Can't use vote-conf for…roposals");

441 ià(
aùiveMa¡”nodeInfo
.
blsKeyO³¿tÜ
) {

442 
signSucûss
 = 
vÙe
.
	`Sign
(*
aùiveMa¡”nodeInfo
.
blsKeyO³¿tÜ
);

445 ià(!
signSucûss
) {

446 
nFaed
++;

447 
¡©usObj
.
	`pushKV
("result", "failed");

448 
¡©usObj
.
	`pushKV
("errorMessage", "Failureo sign.");

449 
»suÉsObj
.
	`pushKV
("syscoš.cÚf", 
¡©usObj
);

450 
»tuºObj
.
	`pushKV
("ov”®l", 
	`¡½rštf
("VÙed sucûssfuÎy %dime(sèªd faed %dime(s).", 
nSucûssful
, 
nFaed
));

451 
»tuºObj
.
	`pushKV
("d‘a", 
»suÉsObj
);

452  
»tuºObj
;

455 
CGov”ÇnûExû±iÚ
 
exû±iÚ
;

456 ià(
gov”Çnû
.
	`ProûssVÙeAndR–ay
(
vÙe
, 
exû±iÚ
, *
node
.
cÚnmª
)) {

457 
nSucûssful
++;

458 
¡©usObj
.
	`pushKV
("result", "success");

460 
nFaed
++;

461 
¡©usObj
.
	`pushKV
("result", "failed");

462 
¡©usObj
.
	`pushKV
("”rÜMes§ge", 
exû±iÚ
.
	`G‘Mes§ge
());

465 
»suÉsObj
.
	`pushKV
("syscoš.cÚf", 
¡©usObj
);

467 
»tuºObj
.
	`pushKV
("ov”®l", 
	`¡½rštf
("VÙed sucûssfuÎy %dime(sèªd faed %dime(s).", 
nSucûssful
, 
nFaed
));

468 
»tuºObj
.
	`pushKV
("d‘a", 
»suÉsObj
);

470  
»tuºObj
;

471 
	}
}

473 
UniV®ue
 
VÙeW™hMa¡”nodes
(cÚ¡ 
¡d
::
m­
<
ušt256
, 
CKey
>& 
keys
,

474 cÚ¡ 
ušt256
& 
hash
, 
vÙe_sigÇl_’um_t
 
eVÙeSigÇl
,

475 
vÙe_outcome_’um_t
 
eVÙeOutcome
, 
CCÚnmª
& 
cÚnmª
)

477 
	ggovObjTy³
;

479 
LOCK
(
gov”Çnû
.
cs
);

480 
CGov”ÇnûObjeù
 *
	gpGovObj
 = 
gov”Çnû
.
FšdGov”ÇnûObjeù
(
hash
);

481 ià(!
	gpGovObj
) {

482 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Governance object‚ot found");

484 
	ggovObjTy³
 = 
pGovObj
->
G‘ObjeùTy³
();

487 
	gnSucûssful
 = 0;

488 
	gnFaed
 = 0;

490 autØ
	gmnLi¡
 = 
d‘”mši¡icMNMªag”
->
G‘Li¡AtChašT
();

492 
UniV®ue
 
»suÉsObj
(UniV®ue::
VOBJ
);

494 cÚ¡‡uto& 
	gp
 : 
keys
) {

495 cÚ¡‡uto& 
´oTxHash
 = 
p
.
fœ¡
;

496 cÚ¡‡uto& 
	gkey
 = 
p
.
£cÚd
;

498 
UniV®ue
 
¡©usObj
(UniV®ue::
VOBJ
);

500 autØ
	gdmn
 = 
mnLi¡
.
G‘V®idMN
(
´oTxHash
);

501 ià(!
	gdmn
) {

502 
	gnFaed
++;

503 
	g¡©usObj
.
pushKV
("result", "failed");

504 
	g¡©usObj
.
pushKV
("errorMessage", "Can't find masternode by…roTxHash");

505 
	g»suÉsObj
.
pushKV
(
´oTxHash
.
ToSŒšg
(), 
¡©usObj
);

509 
CGov”ÇnûVÙe
 
vÙe
(
dmn
->
cŞÏ‹¿lOuošt
, 
hash
, 
eVÙeSigÇl
, 
eVÙeOutcome
);

510 ià(!
	gvÙe
.
Sign
(
key
, key.
G‘PubKey
().
G‘ID
())) {

511 
	gnFaed
++;

512 
	g¡©usObj
.
pushKV
("result", "failed");

513 
	g¡©usObj
.
pushKV
("errorMessage", "Failureo sign.");

514 
	g»suÉsObj
.
pushKV
(
´oTxHash
.
ToSŒšg
(), 
¡©usObj
);

518 
CGov”ÇnûExû±iÚ
 
	gexû±iÚ
;

519 ià(
	ggov”Çnû
.
ProûssVÙeAndR–ay
(
vÙe
, 
exû±iÚ
, 
cÚnmª
)) {

520 
	gnSucûssful
++;

521 
	g¡©usObj
.
pushKV
("result", "success");

523 
	gnFaed
++;

524 
	g¡©usObj
.
pushKV
("result", "failed");

525 
	g¡©usObj
.
pushKV
("”rÜMes§ge", 
exû±iÚ
.
G‘Mes§ge
());

528 
	g»suÉsObj
.
pushKV
(
´oTxHash
.
ToSŒšg
(), 
¡©usObj
);

531 
UniV®ue
 
»tuºObj
(UniV®ue::
VOBJ
);

532 
	g»tuºObj
.
pushKV
("ov”®l", 
¡½rštf
("VÙed sucûssfuÎy %dime(sèªd faed %dime(s).", 
nSucûssful
, 
nFaed
));

533 
	g»tuºObj
.
pushKV
("d‘a", 
»suÉsObj
);

535  
	g»tuºObj
;

538 #ifdeà
ENABLE_WALLET


539 
	$gobjeù_vÙe_mªy_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

541 
RPCH–pMª
{"gobject vote-many",

543 + 
HELP_REQUIRING_PASSPHRASE
 +

550 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

551 
RPCExam¶es
{""},

552 }.
	`Check
(
»que¡
);

553 
	}
}

555 
UniV®ue
 
	$gobjeù_vÙe_mªy
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

557 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

558 ià(!
w®Ët
è 
NuÎUniV®ue
;

559 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

560 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 4)

561 
	`gobjeù_vÙe_mªy_h–p
(
»que¡
);

564 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

565 if(!
node
.
cÚnmª
)

566 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

569 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "Object hash");

570 
¡d
::
¡ršg
 
¡rVÙeSigÇl
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

571 
¡d
::
¡ršg
 
¡rVÙeOutcome
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

573 
vÙe_sigÇl_’um_t
 
eVÙeSigÇl
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeSigÇl
(
¡rVÙeSigÇl
);

574 ià(
eVÙeSigÇl
 =ğ
VOTE_SIGNAL_NONE
) {

575 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
,

580 
vÙe_outcome_’um_t
 
eVÙeOutcome
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeOutcome
(
¡rVÙeOutcome
);

581 ià(
eVÙeOutcome
 =ğ
VOTE_OUTCOME_NONE
) {

582 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid vote outcome. Please use one ofhe following: 'yes', 'no' or 'abstain'");

585 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

587 
¡d
::
m­
<
ušt256
, 
CKey
> 
vÙšgKeys
;

590 
pw®Ët
->
	`BlockUÁSynûdToCu¼’tChaš
();

591 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

592 
mnLi¡
.
	`FÜEachMN
(
Œue
, [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

593 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

594 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

596 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

598 
CKey
 
key
;

599 ià(
¥k_mª
.
	`G‘Key
(
	`CKeyID
(
dmn
->
pdmnS‹
->
keyIDVÙšg
), 
key
)) {

600 
vÙšgKeys
.
	`em¶aû
(
dmn
->
´oTxHash
, 
key
);

604  
	`VÙeW™hMa¡”nodes
(
vÙšgKeys
, 
hash
, 
eVÙeSigÇl
, 
eVÙeOutcome
, *
node
.
cÚnmª
);

605 
	}
}

607 
	$gobjeù_vÙe_®Ÿs_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

609 
RPCH–pMª
{"gobject vote-alias",

611 + 
HELP_REQUIRING_PASSPHRASE
 +

619 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

620 
RPCExam¶es
{""},

621 }.
	`Check
(
»que¡
);

622 
	}
}

624 
UniV®ue
 
	$gobjeù_vÙe_®Ÿs
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

626 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

627 ià(!
w®Ët
è 
NuÎUniV®ue
;

628 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

629 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 5)

630 
	`gobjeù_vÙe_®Ÿs_h–p
(
»que¡
);

633 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

634 if(!
node
.
cÚnmª
)

635 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

638 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "Object hash");

639 
¡d
::
¡ršg
 
¡rVÙeSigÇl
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

640 
¡d
::
¡ršg
 
¡rVÙeOutcome
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

642 
vÙe_sigÇl_’um_t
 
eVÙeSigÇl
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeSigÇl
(
¡rVÙeSigÇl
);

643 ià(
eVÙeSigÇl
 =ğ
VOTE_SIGNAL_NONE
) {

644 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
,

649 
vÙe_outcome_’um_t
 
eVÙeOutcome
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeOutcome
(
¡rVÙeOutcome
);

650 ià(
eVÙeOutcome
 =ğ
VOTE_OUTCOME_NONE
) {

651 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid vote outcome. Please use one ofhe following: 'yes', 'no' or 'abstain'");

654 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

656 
ušt256
 
´oTxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[4], "protx-hash");

657 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘V®idMN
(
´oTxHash
);

658 ià(!
dmn
) {

659 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid or unknown…roTxHash");

663 
pw®Ët
->
	`BlockUÁSynûdToCu¼’tChaš
();

664 
CKey
 
key
;

666 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

667 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

670 ià(!
¥k_mª
.
	`G‘Key
(
	`CKeyID
(
dmn
->
pdmnS‹
->
keyIDVÙšg
), 
key
)) {

671 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("Priv©key fÜ vÙšg‡dd»s % nÙ knowÀby w®Ët", 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDVÙšg
)));

675 
¡d
::
m­
<
ušt256
, 
CKey
> 
vÙšgKeys
;

676 
vÙšgKeys
.
	`em¶aû
(
´oTxHash
, 
key
);

678  
	`VÙeW™hMa¡”nodes
(
vÙšgKeys
, 
hash
, 
eVÙeSigÇl
, 
eVÙeOutcome
, *
node
.
cÚnmª
);

679 
	}
}

682 
UniV®ue
 
	$Li¡Objeùs
(cÚ¡ 
¡d
::
¡ršg
& 
¡rCachedSigÇl
, cÚ¡ std::¡ršg& 
¡rTy³
, 
nS¹Time
)

684 
UniV®ue
 
	`objResuÉ
(UniV®ue::
VOBJ
);

688 
	`LOCK2
(
cs_maš
, 
gov”Çnû
.
cs
);

690 
¡d
::
veùÜ
<cÚ¡ 
CGov”ÇnûObjeù
*> 
objs
 = 
gov”Çnû
.
	`G‘AÎNew”Thª
(
nS¹Time
);

691 
gov”Çnû
.
	`Upd©eLa¡DiffTime
(
	`G‘Time
());

695 cÚ¡‡uto& 
pGovObj
 : 
objs
) {

696 ià(
¡rCachedSigÇl
 =ğ"v®id" && !
pGovObj
->
	`IsS‘CachedV®id
()) ;

697 ià(
¡rCachedSigÇl
 =ğ"fundšg" && !
pGovObj
->
	`IsS‘CachedFundšg
()) ;

698 ià(
¡rCachedSigÇl
 =ğ"d–‘e" && !
pGovObj
->
	`IsS‘CachedD–‘e
()) ;

699 ià(
¡rCachedSigÇl
 =ğ"’dÜ£d" && !
pGovObj
->
	`IsS‘CachedEndÜ£d
()) ;

701 ià(
¡rTy³
 =ğ"´İo§ls" && 
pGovObj
->
	`G‘ObjeùTy³
(è!ğ
GOVERNANCE_OBJECT_PROPOSAL
) ;

702 ià(
¡rTy³
 =ğ"Œigg”s" && 
pGovObj
->
	`G‘ObjeùTy³
(è!ğ
GOVERNANCE_OBJECT_TRIGGER
) ;

704 
UniV®ue
 
	`bObj
(UniV®ue::
VOBJ
);

705 
bObj
.
	`pushKV
("D©aHex", 
pGovObj
->
	`G‘D©aAsHexSŒšg
());

706 
bObj
.
	`pushKV
("D©aSŒšg", 
pGovObj
->
	`G‘D©aAsPÏšSŒšg
());

707 
bObj
.
	`pushKV
("Hash", 
pGovObj
->
	`G‘Hash
().
	`ToSŒšg
());

708 
bObj
.
	`pushKV
("CŞÏ‹¿lHash", 
pGovObj
->
	`G‘CŞÏ‹¿lHash
().
	`ToSŒšg
());

709 
bObj
.
	`pushKV
("ObjeùTy³", 
pGovObj
->
	`G‘ObjeùTy³
());

710 
bObj
.
	`pushKV
("C»©iÚTime", 
pGovObj
->
	`G‘C»©iÚTime
());

711 cÚ¡ 
COutPošt
& 
ma¡”nodeOuošt
 = 
pGovObj
->
	`G‘Ma¡”nodeOuošt
();

712 ià(
ma¡”nodeOuošt
 !ğ
	`COutPošt
()) {

713 
bObj
.
	`pushKV
("SignšgMa¡”node", 
ma¡”nodeOuošt
.
	`ToSŒšgShÜt
());

717 
bObj
.
	`pushKV
("AbsŞu‹YesCouÁ", 
pGovObj
->
	`G‘AbsŞu‹YesCouÁ
(
VOTE_SIGNAL_FUNDING
));

718 
bObj
.
	`pushKV
("YesCouÁ", 
pGovObj
->
	`G‘YesCouÁ
(
VOTE_SIGNAL_FUNDING
));

719 
bObj
.
	`pushKV
("NoCouÁ", 
pGovObj
->
	`G‘NoCouÁ
(
VOTE_SIGNAL_FUNDING
));

720 
bObj
.
	`pushKV
("Ab¡ašCouÁ", 
pGovObj
->
	`G‘Ab¡ašCouÁ
(
VOTE_SIGNAL_FUNDING
));

723 
¡d
::
¡ršg
 
¡rE¼Ü
 = "";

724 
bObj
.
	`pushKV
("fBlockchašV®id™y", 
pGovObj
->
	`IsV®idLoÿÎy
(
¡rE¼Ü
, 
çl£
));

725 
bObj
.
	`pushKV
("IsV®idR—sÚ", 
¡rE¼Ü
.
	`c_¡r
());

726 
bObj
.
	`pushKV
("fCachedV®id", 
pGovObj
->
	`IsS‘CachedV®id
());

727 
bObj
.
	`pushKV
("fCachedFundšg", 
pGovObj
->
	`IsS‘CachedFundšg
());

728 
bObj
.
	`pushKV
("fCachedD–‘e", 
pGovObj
->
	`IsS‘CachedD–‘e
());

729 
bObj
.
	`pushKV
("fCachedEndÜ£d", 
pGovObj
->
	`IsS‘CachedEndÜ£d
());

731 
objResuÉ
.
	`pushKV
(
pGovObj
->
	`G‘Hash
().
	`ToSŒšg
(), 
bObj
);

734  
objResuÉ
;

735 
	}
}

737 
	$gobjeù_li¡_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

739 
RPCH–pMª
{"gobject†ist",

746 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

747 
RPCExam¶es
{""},

748 }.
	`Check
(
»que¡
);

749 
	}
}

751 
UniV®ue
 
	$gobjeù_li¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

753 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() > 3)

754 
	`gobjeù_li¡_h–p
(
»que¡
);

756 
¡d
::
¡ršg
 
¡rCachedSigÇl
 = "valid";

757 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

758 
¡rCachedSigÇl
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

760 ià(
¡rCachedSigÇl
 != "valid" && strCachedSignal != "funding" && strCachedSignal != "delete" && strCachedSignal != "endorsed" && strCachedSignal != "all")

763 
¡d
::
¡ršg
 
¡rTy³
 = "all";

764 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

765 
¡rTy³
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

767 ià(
¡rTy³
 != "proposals" && strType != "triggers" && strType != "all")

770  
	`Li¡Objeùs
(
¡rCachedSigÇl
, 
¡rTy³
, 0);

771 
	}
}

773 
	$gobjeù_diff_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

775 
RPCH–pMª
{"gobject diff",

782 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

783 
RPCExam¶es
{""},

784 }.
	`Check
(
»que¡
);

785 
	}
}

787 
UniV®ue
 
	$gobjeù_diff
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

789 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() > 3)

790 
	`gobjeù_diff_h–p
(
»que¡
);

792 
¡d
::
¡ršg
 
¡rCachedSigÇl
 = "valid";

793 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

794 
¡rCachedSigÇl
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

796 ià(
¡rCachedSigÇl
 != "valid" && strCachedSignal != "funding" && strCachedSignal != "delete" && strCachedSignal != "endorsed" && strCachedSignal != "all")

799 
¡d
::
¡ršg
 
¡rTy³
 = "all";

800 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

801 
¡rTy³
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

803 ià(
¡rTy³
 != "proposals" && strType != "triggers" && strType != "all")

806  
	`Li¡Objeùs
(
¡rCachedSigÇl
, 
¡rTy³
, 
gov”Çnû
.
	`G‘La¡DiffTime
());

807 
	}
}

809 
	$gobjeù_g‘_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

811 
RPCH–pMª
{"gobject get",

817 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

818 
RPCExam¶es
{""},

819 }.
	`Check
(
»que¡
);

820 
	}
}

822 
UniV®ue
 
	$gobjeù_g‘
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

824 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2)

825 
	`gobjeù_g‘_h–p
(
»que¡
);

828 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "GovObj hash");

830 
	`LOCK2
(
cs_maš
, 
gov”Çnû
.
cs
);

833 
CGov”ÇnûObjeù
* 
pGovObj
 = 
gov”Çnû
.
	`FšdGov”ÇnûObjeù
(
hash
);

835 ià(
pGovObj
 =ğ
nuÎ±r
) {

836 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Unknown governance object");

841 
UniV®ue
 
	`objResuÉ
(UniV®ue::
VOBJ
);

842 
objResuÉ
.
	`pushKV
("D©aHex", 
pGovObj
->
	`G‘D©aAsHexSŒšg
());

843 
objResuÉ
.
	`pushKV
("D©aSŒšg", 
pGovObj
->
	`G‘D©aAsPÏšSŒšg
());

844 
objResuÉ
.
	`pushKV
("Hash", 
pGovObj
->
	`G‘Hash
().
	`ToSŒšg
());

845 
objResuÉ
.
	`pushKV
("CŞÏ‹¿lHash", 
pGovObj
->
	`G‘CŞÏ‹¿lHash
().
	`ToSŒšg
());

846 
objResuÉ
.
	`pushKV
("ObjeùTy³", 
pGovObj
->
	`G‘ObjeùTy³
());

847 
objResuÉ
.
	`pushKV
("C»©iÚTime", 
pGovObj
->
	`G‘C»©iÚTime
());

848 cÚ¡ 
COutPošt
& 
ma¡”nodeOuošt
 = 
pGovObj
->
	`G‘Ma¡”nodeOuošt
();

849 ià(
ma¡”nodeOuošt
 !ğ
	`COutPošt
()) {

850 
objResuÉ
.
	`pushKV
("SignšgMa¡”node", 
ma¡”nodeOuošt
.
	`ToSŒšgShÜt
());

856 
UniV®ue
 
	`objFundšgResuÉ
(UniV®ue::
VOBJ
);

857 
objFundšgResuÉ
.
	`pushKV
("AbsŞu‹YesCouÁ", 
pGovObj
->
	`G‘AbsŞu‹YesCouÁ
(
VOTE_SIGNAL_FUNDING
));

858 
objFundšgResuÉ
.
	`pushKV
("YesCouÁ", 
pGovObj
->
	`G‘YesCouÁ
(
VOTE_SIGNAL_FUNDING
));

859 
objFundšgResuÉ
.
	`pushKV
("NoCouÁ", 
pGovObj
->
	`G‘NoCouÁ
(
VOTE_SIGNAL_FUNDING
));

860 
objFundšgResuÉ
.
	`pushKV
("Ab¡ašCouÁ", 
pGovObj
->
	`G‘Ab¡ašCouÁ
(
VOTE_SIGNAL_FUNDING
));

861 
objResuÉ
.
	`pushKV
("FundšgResuÉ", 
objFundšgResuÉ
);

864 
UniV®ue
 
	`objV®id
(UniV®ue::
VOBJ
);

865 
objV®id
.
	`pushKV
("AbsŞu‹YesCouÁ", 
pGovObj
->
	`G‘AbsŞu‹YesCouÁ
(
VOTE_SIGNAL_VALID
));

866 
objV®id
.
	`pushKV
("YesCouÁ", 
pGovObj
->
	`G‘YesCouÁ
(
VOTE_SIGNAL_VALID
));

867 
objV®id
.
	`pushKV
("NoCouÁ", 
pGovObj
->
	`G‘NoCouÁ
(
VOTE_SIGNAL_VALID
));

868 
objV®id
.
	`pushKV
("Ab¡ašCouÁ", 
pGovObj
->
	`G‘Ab¡ašCouÁ
(
VOTE_SIGNAL_VALID
));

869 
objResuÉ
.
	`pushKV
("V®idResuÉ", 
objV®id
);

872 
UniV®ue
 
	`objD–‘e
(UniV®ue::
VOBJ
);

873 
objD–‘e
.
	`pushKV
("AbsŞu‹YesCouÁ", 
pGovObj
->
	`G‘AbsŞu‹YesCouÁ
(
VOTE_SIGNAL_DELETE
));

874 
objD–‘e
.
	`pushKV
("YesCouÁ", 
pGovObj
->
	`G‘YesCouÁ
(
VOTE_SIGNAL_DELETE
));

875 
objD–‘e
.
	`pushKV
("NoCouÁ", 
pGovObj
->
	`G‘NoCouÁ
(
VOTE_SIGNAL_DELETE
));

876 
objD–‘e
.
	`pushKV
("Ab¡ašCouÁ", 
pGovObj
->
	`G‘Ab¡ašCouÁ
(
VOTE_SIGNAL_DELETE
));

877 
objResuÉ
.
	`pushKV
("D–‘eResuÉ", 
objD–‘e
);

880 
UniV®ue
 
	`objEndÜ£d
(UniV®ue::
VOBJ
);

881 
objEndÜ£d
.
	`pushKV
("AbsŞu‹YesCouÁ", 
pGovObj
->
	`G‘AbsŞu‹YesCouÁ
(
VOTE_SIGNAL_ENDORSED
));

882 
objEndÜ£d
.
	`pushKV
("YesCouÁ", 
pGovObj
->
	`G‘YesCouÁ
(
VOTE_SIGNAL_ENDORSED
));

883 
objEndÜ£d
.
	`pushKV
("NoCouÁ", 
pGovObj
->
	`G‘NoCouÁ
(
VOTE_SIGNAL_ENDORSED
));

884 
objEndÜ£d
.
	`pushKV
("Ab¡ašCouÁ", 
pGovObj
->
	`G‘Ab¡ašCouÁ
(
VOTE_SIGNAL_ENDORSED
));

885 
objResuÉ
.
	`pushKV
("EndÜ£dResuÉ", 
objEndÜ£d
);

888 
¡d
::
¡ršg
 
¡rE¼Ü
 = "";

889 
objResuÉ
.
	`pushKV
("fLoÿlV®id™y", 
pGovObj
->
	`IsV®idLoÿÎy
(
¡rE¼Ü
, 
çl£
));

890 
objResuÉ
.
	`pushKV
("IsV®idR—sÚ", 
¡rE¼Ü
.
	`c_¡r
());

891 
objResuÉ
.
	`pushKV
("fCachedV®id", 
pGovObj
->
	`IsS‘CachedV®id
());

892 
objResuÉ
.
	`pushKV
("fCachedFundšg", 
pGovObj
->
	`IsS‘CachedFundšg
());

893 
objResuÉ
.
	`pushKV
("fCachedD–‘e", 
pGovObj
->
	`IsS‘CachedD–‘e
());

894 
objResuÉ
.
	`pushKV
("fCachedEndÜ£d", 
pGovObj
->
	`IsS‘CachedEndÜ£d
());

895  
objResuÉ
;

896 
	}
}

898 
	$gobjeù_g‘cu¼’tvÙes_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

900 
RPCH–pMª
{"gobject getcurrentvotes",

908 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

909 
RPCExam¶es
{""},

910 }.
	`Check
(
»que¡
);

911 
	}
}

913 
UniV®ue
 
	$gobjeù_g‘cu¼’tvÙes
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

915 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 2 &&„equest.params.size() != 4))

916 
	`gobjeù_g‘cu¼’tvÙes_h–p
(
»que¡
);

920 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "Governance hash");

922 
COutPošt
 
mnCŞÏ‹¿lOuošt
;

923 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
() && !request.params[3].isNull()) {

924 
ušt256
 
txid
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "Masternode Collateral hash");

925 
¡d
::
¡ršg
 
¡rVout
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

926 
mnCŞÏ‹¿lOuošt
 = 
	`COutPošt
(
txid
, (
ušt32_t
)
	`©oi
(
¡rVout
));

931 
	`LOCK
(
gov”Çnû
.
cs
);

933 
CGov”ÇnûObjeù
* 
pGovObj
 = 
gov”Çnû
.
	`FšdGov”ÇnûObjeù
(
hash
);

935 ià(
pGovObj
 =ğ
nuÎ±r
) {

936 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Unknown governance-hash");

941 
UniV®ue
 
	`bResuÉ
(UniV®ue::
VOBJ
);

945 
¡d
::
veùÜ
<
CGov”ÇnûVÙe
> 
vecVÙes
 = 
gov”Çnû
.
	`G‘Cu¼’tVÙes
(
hash
, 
mnCŞÏ‹¿lOuošt
);

946 cÚ¡‡uto& 
vÙe
 : 
vecVÙes
) {

947 
bResuÉ
.
	`pushKV
(
vÙe
.
	`G‘Hash
().
	`ToSŒšg
(), vote.ToString());

950  
bResuÉ
;

951 
	}
}

953 
	$gobjeù_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

955 
RPCH–pMª
{"gobject",

959 #ifdeà
ENABLE_WALLET


969 #ifdeà
ENABLE_WALLET


973 #ifdeà
ENABLE_WALLET


978 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

979 
RPCExam¶es
{""},

980 }.
	`Check
(
»que¡
);

981 
	}
}

983 
UniV®ue
 
	$gobjeù
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

985 
¡d
::
¡ršg
 
¡rCommªd
;

986 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
())

987 
¡rCommªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

989 ià(
»que¡
.
fH–p
 && 
¡rCommªd
.
	`em±y
()) {

990 
	`gobjeù_h–p
(
»que¡
);

993 ià(
¡rCommªd
 == "count") {

994  
	`gobjeù_couÁ
(
»que¡
);

995 } ià(
¡rCommªd
 == "deserialize") {

997  
	`gobjeù_de£rŸlize
(
»que¡
);

998 } ià(
¡rCommªd
 == "check") {

1000  
	`gobjeù_check
(
»que¡
);

1001 #ifdeà
ENABLE_WALLET


1002 } ià(
¡rCommªd
 == "prepare") {

1004  
	`gobjeù_´•¬e
(
»que¡
);

1006 } ià(
¡rCommªd
 == "submit") {

1013  
	`gobjeù_subm™
(
»que¡
);

1014 } ià(
¡rCommªd
 == "vote-conf") {

1015  
	`gobjeù_vÙe_cÚf
(
»que¡
);

1016 #ifdeà
ENABLE_WALLET


1017 } ià(
¡rCommªd
 == "vote-many") {

1018  
	`gobjeù_vÙe_mªy
(
»que¡
);

1019 } ià(
¡rCommªd
 == "vote-alias") {

1020  
	`gobjeù_vÙe_®Ÿs
(
»que¡
);

1022 } ià(
¡rCommªd
 == "list") {

1024  
	`gobjeù_li¡
(
»que¡
);

1025 } ià(
¡rCommªd
 == "diff") {

1026  
	`gobjeù_diff
(
»que¡
);

1027 } ià(
¡rCommªd
 == "get") {

1029  
	`gobjeù_g‘
(
»que¡
);

1030 } ià(
¡rCommªd
 == "getcurrentvotes") {

1032  
	`gobjeù_g‘cu¼’tvÙes
(
»que¡
);

1034 
	`gobjeù_h–p
(
»que¡
);

1036 
	}
}

1038 
UniV®ue
 
	$vÙ”aw
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1040 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 7){

1041 
RPCH–pMª
{"voteraw",

1046 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1047 
RPCExam¶es
{""},

1048 }.
	`Check
(
»que¡
);

1051 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

1052 if(!
node
.
cÚnmª
)

1053 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

1055 
ušt256
 
hashMnCŞÏ‹¿lTx
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "mn collateralx hash");

1056 
nMnCŞÏ‹¿lTxIndex
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

1057 
COutPošt
 
ouošt
 = 
	`COutPošt
(
hashMnCŞÏ‹¿lTx
, 
nMnCŞÏ‹¿lTxIndex
);

1059 
ušt256
 
hashGovObj
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "Governance hash");

1060 
¡d
::
¡ršg
 
¡rVÙeSigÇl
 = 
»que¡
.
·¿ms
[3].
	`g‘_¡r
();

1061 
¡d
::
¡ršg
 
¡rVÙeOutcome
 = 
»que¡
.
·¿ms
[4].
	`g‘_¡r
();

1063 
vÙe_sigÇl_’um_t
 
eVÙeSigÇl
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeSigÇl
(
¡rVÙeSigÇl
);

1064 ià(
eVÙeSigÇl
 =ğ
VOTE_SIGNAL_NONE
) {

1065 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
,

1070 
vÙe_outcome_’um_t
 
eVÙeOutcome
 = 
CGov”ÇnûVÙšg
::
	`CÚv”tVÙeOutcome
(
¡rVÙeOutcome
);

1071 ià(
eVÙeOutcome
 =ğ
VOTE_OUTCOME_NONE
) {

1072 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid vote outcome. Please use one ofhe following: 'yes', 'no' or 'abstain'");

1075 
govObjTy³
;

1077 
	`LOCK
(
gov”Çnû
.
cs
);

1078 
CGov”ÇnûObjeù
 *
pGovObj
 = 
gov”Çnû
.
	`FšdGov”ÇnûObjeù
(
hashGovObj
);

1079 ià(!
pGovObj
) {

1080 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Governance object‚ot found");

1082 
govObjTy³
 = 
pGovObj
->
	`G‘ObjeùTy³
();

1085 
št64_t
 
nTime
 = 
»que¡
.
·¿ms
[5].
	`g‘_št64
();

1086 
¡d
::
¡ršg
 
¡rSig
 = 
»que¡
.
·¿ms
[6].
	`g‘_¡r
();

1087 
boŞ
 
fInv®id
 = 
çl£
;

1088 
¡d
::
veùÜ
<> 
vchSig
 = 
	`DecodeBa£64
(
¡rSig
.
	`c_¡r
(), &
fInv®id
);

1090 ià(
fInv®id
) {

1091 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Malformed base64ƒncoding");

1094 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘V®idMNByCŞÏ‹¿l
(
ouošt
);

1096 ià(!
dmn
) {

1097 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Fau»Øfšd ma¡”nodš†i¡ : " + 
ouošt
.
	`ToSŒšgShÜt
());

1100 
CGov”ÇnûVÙe
 
	`vÙe
(
ouošt
, 
hashGovObj
, 
eVÙeSigÇl
, 
eVÙeOutcome
);

1101 
vÙe
.
	`S‘Time
(
nTime
);

1102 
vÙe
.
	`S‘SigÇtu»
(
vchSig
);

1104 
boŞ
 
ÚlyVÙšgKeyAÎowed
 = 
govObjTy³
 =ğ
GOVERNANCE_OBJECT_PROPOSAL
 && 
vÙe
.
	`G‘SigÇl
(è=ğ
VOTE_SIGNAL_FUNDING
;

1106 ià(!
vÙe
.
	`IsV®id
(
ÚlyVÙšgKeyAÎowed
)) {

1107 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Failureo verify vote.");

1110 
CGov”ÇnûExû±iÚ
 
exû±iÚ
;

1111 ià(
gov”Çnû
.
	`ProûssVÙeAndR–ay
(
vÙe
, 
exû±iÚ
, *
node
.
cÚnmª
)) {

1114 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "E¼Ü vÙšg : " + 
exû±iÚ
.
	`G‘Mes§ge
());

1116 
	}
}

1118 
UniV®ue
 
	$g‘gov”Çnûšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1120 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 0) {

1121 
RPCH–pMª
{"getgovernanceinfo",

1126 " \"´İo§lãe\": xxx.xx, (num”icèthcŞÏ‹¿ÈŒª§ùiÚ f“ which mu¡ b·idØü—‹‡…rİo§Èš " + 
CURRENCY_UNIT
 + "\n"

1133 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1134 
RPCExam¶es
{""},

1135 }.
	`Check
(
»que¡
);

1138 
	`LOCK
(
cs_maš
);

1140 
nLa¡Su³rblock
 = 0, 
nNextSu³rblock
 = 0;

1141 
nBlockHeight
 = ::
	`ChašAùive
().
	`Height
();

1143 
CSu³rblock
::
	`G‘N—»¡Su³rblocksHeights
(
nBlockHeight
, 
nLa¡Su³rblock
, 
nNextSu³rblock
);

1145 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

1146 
obj
.
	`pushKV
("gov”ÇnûmšquÜum", 
	`P¬ams
().
	`G‘CÚ£nsus
().
nGov”ÇnûMšQuÜum
);

1147 
obj
.
	`pushKV
("´İo§lãe", 
	`V®ueFromAmouÁ
(
GOVERNANCE_PROPOSAL_FEE_TX
));

1148 
obj
.
	`pushKV
("su³rblockcyşe", 
	`P¬ams
().
	`G‘CÚ£nsus
().
nSu³rblockCyşe
);

1149 
obj
.
	`pushKV
("Ï¡su³rblock", 
nLa¡Su³rblock
);

1150 
obj
.
	`pushKV
("Ãxtsu³rblock", 
nNextSu³rblock
);

1152  
obj
;

1153 
	}
}

1155 
UniV®ue
 
	$g‘su³rblockbudg‘
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1157 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 1) {

1158 
RPCH–pMª
{"getsuperblockbudget",

1163 "À (num”icèThabsŞu‹ maximum sum oàsu³rblock…aym’t ®lowed, iÀ" + 
CURRENCY_UNIT
 + "\n",

1166 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1167 
RPCExam¶es
{""},

1168 }.
	`Check
(
»que¡
);

1171 
nBlockHeight
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

1172 ià(
nBlockHeight
 < 0) {

1173 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Block height out of„ange");

1176  
	`V®ueFromAmouÁ
(
CSu³rblock
::
	`G‘Paym’tsLim™
(
nBlockHeight
));

1177 
	}
}

1179 cÚ¡ 
CRPCCommªd
 
	gcommªds
[] =

1182 { "gov”Çnû", "g‘gov”Çnûšfo", &
g‘gov”Çnûšfo
, {} },

1183 { "gov”Çnû", "g‘su³rblockbudg‘", &
g‘su³rblockbudg‘
, {"index"} },

1184 { "gov”Çnû", "gobjeù", &
gobjeù
, {} },

1185 { "gov”Çnû", "vÙ”aw", &
vÙ”aw
, {"tx_hash","tx_index","gov_hash","signal","outcome","time","sig"} },

1189 
	$Regi¡”Gov”ÇnûRPCCommªds
(
CRPCTabË
 &
t
)

1191 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

1192 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

1193 
	}
}

	@masternode.cpp

5 
	~<ma¡”node/aùivema¡”node.h
>

6 
	~<ba£58.h
>

7 
	~<ş›Áv”siÚ.h
>

8 
	~<š™.h
>

9 
	~<Ãtba£.h
>

10 
	~<v®id©iÚ.h
>

11 
	~<ut/sy¡em.h
>

12 
	~<ut/mÚey¡r.h
>

13 
	~<txmempoŞ.h
>

15 
	~<evo/¥ecŸÉx.h
>

16 
	~<evo/d‘”mši¡icmns.h
>

18 
	~<ma¡”node/ma¡”node-·ym’ts.h
>

19 
	~<ma¡”node/ma¡”node-sync.h
>

21 
	~<½c/£rv”.h
>

23 
	~<w®Ët/cošcÚŒŞ.h
>

24 
	~<w®Ët/½cw®Ët.h
>

25 #ifdeà
ENABLE_WALLET


26 
	~<w®Ët/w®Ët.h
>

29 
	~<f¡»am
>

30 
	~<iomª
>

31 
	~<univ®ue.h
>

32 
	~<½c/ut.h
>

33 
	~<½c/blockchaš.h
>

34 
	~<node/cÚ‹xt.h
>

35 
UniV®ue
 
ma¡”nod–i¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
);

37 
	$ma¡”node_li¡_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

39 
RPCH–pMª
{"masternodelist",

63 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

64 
RPCExam¶es
{""},

65 }.
	`Check
(
»que¡
);

66 
	}
}

68 
UniV®ue
 
	$ma¡”node_li¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

70 ià(
»que¡
.
fH–p
)

71 
	`ma¡”node_li¡_h–p
(
»que¡
);

72 
JSONRPCReque¡
 
ÃwReque¡
 = 
»que¡
;

73 
ÃwReque¡
.
·¿ms
.
	`£tA¼ay
();

75 
i
 = 1; i < 
»que¡
.
·¿ms
.
	`size
(); i++) {

76 
ÃwReque¡
.
·¿ms
.
	`push_back
(
»que¡
.·¿ms[
i
]);

78  
	`ma¡”nod–i¡
(
ÃwReque¡
);

79 
	}
}

81 
	$ma¡”node_cÚÃù_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

83 
RPCH–pMª
{"masternode connect",

89 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

90 
RPCExam¶es
{""},

91 }.
	`Check
(
»que¡
);

92 
	}
}

94 
UniV®ue
 
	$ma¡”node_cÚÃù
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

96 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() < 2)

97 
	`ma¡”node_cÚÃù_h–p
(
»que¡
);

99 
¡d
::
¡ršg
 
¡rAdd»ss
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

101 
CS”viû
 
addr
;

102 ià(!
	`Lookup
(
¡rAdd»ss
.
	`c_¡r
(), 
addr
, 0, 
çl£
))

103 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, 
	`¡½rštf
("IncÜ»ù ma¡”nodadd»s %s", 
¡rAdd»ss
));

104 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

105 if(!
node
.
cÚnmª
)

106 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

108 
node
.
cÚnmª
->
	`O³nMa¡”nodeCÚÃùiÚ
(
	`CAdd»ss
(
addr
, 
NODE_NETWORK
));

109 ià(!
node
.
cÚnmª
->
	`IsCÚÃùed
(
	`CAdd»ss
(
addr
, 
NODE_NETWORK
), 
AÎNodes
))

110 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, 
	`¡½rštf
("Couldn'ˆcÚÃùØma¡”nod%s", 
¡rAdd»ss
));

113 
	}
}

115 
	$ma¡”node_couÁ_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

117 
RPCH–pMª
{"masternode count",

130 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

131 
RPCExam¶es
{""},

132 }.
	`Check
(
»que¡
);

133 
	}
}

135 
UniV®ue
 
	$ma¡”node_couÁ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

137 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() > 2)

138 
	`ma¡”node_couÁ_h–p
(
»que¡
);

140 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

141 
tÙ®
 = 
mnLi¡
.
	`G‘AÎMNsCouÁ
();

142 
’abËd
 = 
mnLi¡
.
	`G‘V®idMNsCouÁ
();

144 ià(
»que¡
.
·¿ms
.
	`size
() == 1) {

145 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

147 
obj
.
	`pushKV
("tÙ®", 
tÙ®
);

148 
obj
.
	`pushKV
("’abËd", 
’abËd
);

150  
obj
;

153 
¡d
::
¡ršg
 
¡rMode
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

155 ià(
¡rMode
 == "total")

156  
tÙ®
;

158 ià(
¡rMode
 == "enabled")

159  
’abËd
;

161 ià(
¡rMode
 == "all")

162  
	`¡½rštf
("Total: %d (Enabled: %d)",

163 
tÙ®
, 
’abËd
);

165 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Unknown mode value");

166 
	}
}

168 
UniV®ue
 
	$G‘NextMa¡”nodeFÜPaym’t
(
heightShiá
)

170 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

171 autØ
·y“s
 = 
mnLi¡
.
	`G‘ProjeùedMNPay“s
(
heightShiá
);

172 ià(
·y“s
.
	`em±y
())

174 autØ
·y“
 = 
·y“s
.
	`back
();

175 
CSüt
 
·y“Süt
 = 
·y“
->
pdmnS‹
->
sütPayout
;

177 
CTxDe¡š©iÚ
 
·y“De¡
;

178 
	`ExŒaùDe¡š©iÚ
(
·y“Süt
, 
·y“De¡
);

180 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

182 
obj
.
	`pushKV
("height", 
mnLi¡
.
	`G‘Height
(è+ 
heightShiá
);

183 
obj
.
	`pushKV
("IP:pÜt", 
·y“
->
pdmnS‹
->
addr
.
	`ToSŒšg
());

184 
obj
.
	`pushKV
("´oTxHash", 
·y“
->
´oTxHash
.
	`ToSŒšg
());

185 
obj
.
	`pushKV
("ouošt", 
·y“
->
cŞÏ‹¿lOuošt
.
	`ToSŒšgShÜt
());

186 
obj
.
	`pushKV
("·y“", 
	`IsV®idDe¡š©iÚ
(
·y“De¡
è? 
	`EncodeDe¡š©iÚ
(payeeDest) : "UNKNOWN");

187  
obj
;

188 
	}
}

190 
	$ma¡”node_wšÃr_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

192 
RPCH–pMª
{"masternode winner",

196 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

197 
RPCExam¶es
{""},

198 }.
	`Check
(
»que¡
);

199 
	}
}

201 
UniV®ue
 
	$ma¡”node_wšÃr
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

203 ià(
»que¡
.
fH–p
)

204 
	`ma¡”node_wšÃr_h–p
(
»que¡
);

206  
	`G‘NextMa¡”nodeFÜPaym’t
(10);

207 
	}
}

209 
	$ma¡”node_cu¼’t_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

211 
RPCH–pMª
{"masternode current",

215 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

216 
RPCExam¶es
{""},

217 }.
	`Check
(
»que¡
);

218 
	}
}

220 
UniV®ue
 
	$ma¡”node_cu¼’t
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

222 ià(
»que¡
.
fH–p
)

223 
	`ma¡”node_cu¼’t_h–p
(
»que¡
);

225  
	`G‘NextMa¡”nodeFÜPaym’t
(1);

226 
	}
}

228 #ifdeà
ENABLE_WALLET


229 
	$ma¡”node_ouuts_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

231 
RPCH–pMª
{"masternode outputs",

235 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

236 
RPCExam¶es
{""},

237 }.
	`Check
(
»que¡
);

238 
	}
}

240 
UniV®ue
 
	$ma¡”node_ouuts
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

242 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

243 ià(!
w®Ët
è 
NuÎUniV®ue
;

244 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

245 ià(
»que¡
.
fH–p
)

246 
	`ma¡”node_ouuts_h–p
(
»que¡
);

249 
¡d
::
veùÜ
<
COuut
> 
vPossibËCošs
;

251 
	`LOCK
(
pw®Ët
->
cs_w®Ët
);

252 
pw®Ët
->
	`AvaabËCošs
(
vPossibËCošs
, 
Œue
, 
nuÎ±r
, 
nMNCŞÏ‹¿lRequœed
,‚MNCŞÏ‹¿lRequœed, 
MAX_MONEY
, 0,rue);

255 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

256 cÚ¡‡uto& 
out
 : 
vPossibËCošs
) {

257 
obj
.
	`pushKV
(
out
.
tx
->
	`G‘Hash
().
	`ToSŒšg
(), 
	`¡½rštf
("%d", out.
i
));

260  
obj
;

261 
	}
}

265 
	$ma¡”node_¡©us_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

267 
RPCH–pMª
{"masternode status",

271 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

272 
RPCExam¶es
{""},

273 }.
	`Check
(
»que¡
);

274 
	}
}

276 
UniV®ue
 
	$ma¡”node_¡©us
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

278 ià(
»que¡
.
fH–p
)

279 
	`ma¡”node_¡©us_h–p
(
»que¡
);

281 ià(!
fMa¡”nodeMode
)

282 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "This is‚ot‡ masternode");

284 
UniV®ue
 
	`mnObj
(UniV®ue::
VOBJ
);

287 
mnObj
.
	`pushKV
("ouošt", 
aùiveMa¡”nodeInfo
.
ouošt
.
	`ToSŒšgShÜt
());

288 
mnObj
.
	`pushKV
("£rviû", 
aùiveMa¡”nodeInfo
.
£rviû
.
	`ToSŒšg
());

290 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘MN
(
aùiveMa¡”nodeInfo
.
´oTxHash
);

291 ià(
dmn
) {

292 
mnObj
.
	`pushKV
("´oTxHash", 
dmn
->
´oTxHash
.
	`ToSŒšg
());

293 
mnObj
.
	`pushKV
("cŞÏ‹¿lHash", 
dmn
->
cŞÏ‹¿lOuošt
.
hash
.
	`ToSŒšg
());

294 
mnObj
.
	`pushKV
("cŞÏ‹¿lIndex", ()
dmn
->
cŞÏ‹¿lOuošt
.
n
);

295 
UniV®ue
 
¡©eObj
;

296 
dmn
->
pdmnS‹
->
	`ToJsÚ
(
¡©eObj
);

297 
mnObj
.
	`pushKV
("dmnS‹", 
¡©eObj
);

299 
mnObj
.
	`pushKV
("¡©e", 
aùiveMa¡”nodeMªag”
->
	`G‘S‹SŒšg
());

300 
mnObj
.
	`pushKV
("¡©us", 
aùiveMa¡”nodeMªag”
->
	`G‘Stus
());

302  
mnObj
;

303 
	}
}

305 
	$ma¡”node_wšÃrs_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

307 
RPCH–pMª
{"masternode winners",

314 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

315 
RPCExam¶es
{""},

316 }.
	`Check
(
»que¡
);

317 
	}
}

319 
UniV®ue
 
	$ma¡”node_wšÃrs
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

321 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() > 3)

322 
	`ma¡”node_wšÃrs_h–p
(
»que¡
);

324 
nHeight
;

326 
	`LOCK
(
cs_maš
);

327 
CBlockIndex
* 
pšdex
 = ::
	`ChašAùive
().
	`T
();

328 ià(!
pšdex
è 
NuÎUniV®ue
;

330 
nHeight
 = 
pšdex
->nHeight;

333 
nLa¡
 = 10;

334 
¡d
::
¡ršg
 
¡rF‹r
 = "";

336 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

337 
nLa¡
 = 
	`©oi
(
»que¡
.
·¿ms
[1].
	`g‘_¡r
());

340 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

341 
¡rF‹r
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

344 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

345 autØ
m­Paym’ts
 = 
	`G‘RequœedPaym’tsSŒšgs
(
nHeight
 - 
nLa¡
,‚Height + 20);

346 cÚ¡‡utØ&
p
 : 
m­Paym’ts
) {

347 
obj
.
	`pushKV
(
	`¡½rštf
("%d", 
p
.
fœ¡
),….
£cÚd
);

350  
obj
;

351 
	}
}

353 
	$ma¡”node_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

355 
RPCH–pMª
{"masternode",

360 #ifdeà
ENABLE_WALLET


368 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The commandoƒxecute"}

370 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

371 
RPCExam¶es
{""},

372 }.
	`Check
(
»que¡
);

373 
	}
}

375 
UniV®ue
 
	$ma¡”node
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

377 
¡d
::
¡ršg
 
¡rCommªd
;

378 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

379 
¡rCommªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

382 ià(
»que¡
.
fH–p
 && 
¡rCommªd
.
	`em±y
()) {

383 
	`ma¡”node_h–p
(
»que¡
);

386 ià(
¡rCommªd
 == "list") {

387  
	`ma¡”node_li¡
(
»que¡
);

388 } ià(
¡rCommªd
 == "connect") {

389  
	`ma¡”node_cÚÃù
(
»que¡
);

390 } ià(
¡rCommªd
 == "count") {

391  
	`ma¡”node_couÁ
(
»que¡
);

392 } ià(
¡rCommªd
 == "current") {

393  
	`ma¡”node_cu¼’t
(
»que¡
);

394 } ià(
¡rCommªd
 == "winner") {

395  
	`ma¡”node_wšÃr
(
»que¡
);

396 #ifdeà
ENABLE_WALLET


397 } ià(
¡rCommªd
 == "outputs") {

398  
	`ma¡”node_ouuts
(
»que¡
);

400 } ià(
¡rCommªd
 == "status") {

401  
	`ma¡”node_¡©us
(
»que¡
);

402 } ià(
¡rCommªd
 == "winners") {

403  
	`ma¡”node_wšÃrs
(
»que¡
);

405 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid masternode command");

407 
	}
}

409 
UniV®ue
 
	$ma¡”nod–i¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

411 
¡d
::
¡ršg
 
¡rMode
 = "json";

412 
¡d
::
¡ršg
 
¡rF‹r
 = "";

414 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()è
¡rMode
 =„eque¡.·¿ms[0].
	`g‘_¡r
();

415 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()è
¡rF‹r
 =„eque¡.·¿ms[1].
	`g‘_¡r
();

417 
¡d
::
	`ŒªsfÜm
(
¡rMode
.
	`begš
(), sŒMode.
	`’d
(), sŒMode.begš(), ::
tŞow”
);

419 ià(
»que¡
.
fH–p
 || (

420 
¡rMode
 != "addr" && strMode != "full" && strMode != "info" && strMode != "json" &&

421 
¡rMode
 != "owneraddress" && strMode != "votingaddress" &&

422 
¡rMode
 != "lastpaidtime" && strMode != "lastpaidblock" &&

423 
¡rMode
 != "payee" && strMode != "pubkeyoperator" &&

424 
¡rMode
 != "status"))

426 
	`ma¡”node_li¡_h–p
(
»que¡
);

429 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

431 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

432 autØ
dmnToStus
 = [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

433 ià(
mnLi¡
.
	`IsMNV®id
(
dmn
)) {

436 ià(
mnLi¡
.
	`IsMNPoSeBªÃd
(
dmn
)) {

441 autØ
dmnToLa¡PaidTime
 = [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

442 ià(
dmn
->
pdmnS‹
->
nLa¡PaidHeight
 == 0) {

446 
	`LOCK
(
cs_maš
);

447 cÚ¡ 
CBlockIndex
* 
pšdex
 = ::
	`ChašAùive
()[
dmn
->
pdmnS‹
->
nLa¡PaidHeight
];

448  ()
pšdex
->
nTime
;

451 
mnLi¡
.
	`FÜEachMN
(
çl£
, [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

452 
¡d
::
¡ršg
 
¡rOuošt
 = 
dmn
->
cŞÏ‹¿lOuošt
.
	`ToSŒšgShÜt
();

453 
Coš
 
coš
;

454 
¡d
::
¡ršg
 
cŞÏ‹¿lAdd»ssSŒ
 = "UNKNOWN";

455 ià(
	`G‘UTXOCoš
(
dmn
->
cŞÏ‹¿lOuošt
, 
coš
)) {

456 
CTxDe¡š©iÚ
 
cŞÏ‹¿lDe¡
;

457 ià(
	`ExŒaùDe¡š©iÚ
(
coš
.
out
.
sütPubKey
, 
cŞÏ‹¿lDe¡
)) {

458 
cŞÏ‹¿lAdd»ssSŒ
 = 
	`EncodeDe¡š©iÚ
(
cŞÏ‹¿lDe¡
);

462 
CSüt
 
·y“Süt
 = 
dmn
->
pdmnS‹
->
sütPayout
;

463 
CTxDe¡š©iÚ
 
·y“De¡
;

464 
¡d
::
¡ršg
 
·y“SŒ
 = "UNKNOWN";

465 ià(
	`ExŒaùDe¡š©iÚ
(
·y“Süt
, 
·y“De¡
)) {

466 
·y“SŒ
 = 
	`EncodeDe¡š©iÚ
(
·y“De¡
);

469 ià(
¡rMode
 == "addr") {

470 
¡d
::
¡ršg
 
¡rAdd»ss
 = 
dmn
->
pdmnS‹
->
addr
.
	`ToSŒšg
();

471 ià(
¡rF‹r
 !="" && 
¡rAdd»ss
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

472 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

473 
obj
.
	`pushKV
(
¡rOuošt
, 
¡rAdd»ss
);

474 } ià(
¡rMode
 == "full") {

475 
¡d
::
o¡ršg¡»am
 
¡»amFuÎ
;

476 
¡»amFuÎ
 << 
¡d
::
	`£tw
(18) <<

477 
	`dmnToStus
(
dmn
) << " " <<

478 
·y“SŒ
 << " " << 
¡d
::
	`£tw
(10) <<

479 
	`dmnToLa¡PaidTime
(
dmn
è<< " " << 
¡d
::
	`£tw
(6) <<

480 
dmn
->
pdmnS‹
->
nLa¡PaidHeight
 << " " <<

481 
dmn
->
pdmnS‹
->
addr
.
	`ToSŒšg
();

482 
¡d
::
¡ršg
 
¡rFuÎ
 = 
¡»amFuÎ
.
	`¡r
();

483 ià(
¡rF‹r
 !="" && 
¡rFuÎ
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

484 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

485 
obj
.
	`pushKV
(
¡rOuošt
, 
¡rFuÎ
);

486 } ià(
¡rMode
 == "info") {

487 
¡d
::
o¡ršg¡»am
 
¡»amInfo
;

488 
¡»amInfo
 << 
¡d
::
	`£tw
(18) <<

489 
	`dmnToStus
(
dmn
) << " " <<

490 
·y“SŒ
 << " " <<

491 
dmn
->
pdmnS‹
->
addr
.
	`ToSŒšg
();

492 
¡d
::
¡ršg
 
¡rInfo
 = 
¡»amInfo
.
	`¡r
();

493 ià(
¡rF‹r
 !="" && 
¡rInfo
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

494 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

495 
obj
.
	`pushKV
(
¡rOuošt
, 
¡rInfo
);

496 } ià(
¡rMode
 == "json") {

497 
¡d
::
o¡ršg¡»am
 
¡»amInfo
;

498 
¡»amInfo
 << 
dmn
->
´oTxHash
.
	`ToSŒšg
() << " " <<

499 
dmn
->
pdmnS‹
->
addr
.
	`ToSŒšg
() << " " <<

500 
·y“SŒ
 << " " <<

501 
	`dmnToStus
(
dmn
) << " " <<

502 
	`dmnToLa¡PaidTime
(
dmn
) << " " <<

503 
dmn
->
pdmnS‹
->
nLa¡PaidHeight
 << " " <<

504 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDOwÃr
) << " " <<

505 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDVÙšg
) << " " <<

506 
cŞÏ‹¿lAdd»ssSŒ
 << " " <<

507 
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
().
	`ToSŒšg
();

508 
¡d
::
¡ršg
 
¡rInfo
 = 
¡»amInfo
.
	`¡r
();

509 ià(
¡rF‹r
 !="" && 
¡rInfo
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

510 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

511 
UniV®ue
 
	`objMN
(UniV®ue::
VOBJ
);

512 
objMN
.
	`pushKV
("´oTxHash", 
dmn
->
´oTxHash
.
	`ToSŒšg
());

513 
objMN
.
	`pushKV
("add»ss", 
dmn
->
pdmnS‹
->
addr
.
	`ToSŒšg
());

514 
objMN
.
	`pushKV
("·y“", 
·y“SŒ
);

515 
objMN
.
	`pushKV
("¡©us", 
	`dmnToStus
(
dmn
));

516 
objMN
.
	`pushKV
("cŞÏ‹¿lblock", 
dmn
->
pdmnS‹
->
nCŞÏ‹¿lHeight
);

517 
objMN
.
	`pushKV
("Ï¡·idtime", 
	`dmnToLa¡PaidTime
(
dmn
));

518 
objMN
.
	`pushKV
("Ï¡·idblock", 
dmn
->
pdmnS‹
->
nLa¡PaidHeight
);

519 
objMN
.
	`pushKV
("owÃ¿dd»ss", 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDOwÃr
));

520 
objMN
.
	`pushKV
("vÙšgadd»ss", 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDVÙšg
));

521 
objMN
.
	`pushKV
("cŞÏ‹¿Ïdd»ss", 
cŞÏ‹¿lAdd»ssSŒ
);

522 
objMN
.
	`pushKV
("pubkeyİ”©Ü", 
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
().
	`ToSŒšg
());

523 
obj
.
	`pushKV
(
¡rOuošt
, 
objMN
);

524 } ià(
¡rMode
 == "lastpaidblock") {

525 ià(
¡rF‹r
 !="" && 
¡rOuošt
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
) ;

526 
obj
.
	`pushKV
(
¡rOuošt
, 
dmn
->
pdmnS‹
->
nLa¡PaidHeight
);

527 } ià(
¡rMode
 == "lastpaidtime") {

528 ià(
¡rF‹r
 !="" && 
¡rOuošt
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
) ;

529 
obj
.
	`pushKV
(
¡rOuošt
, 
	`dmnToLa¡PaidTime
(
dmn
));

530 } ià(
¡rMode
 == "payee") {

531 ià(
¡rF‹r
 !="" && 
·y“SŒ
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

532 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

533 
obj
.
	`pushKV
(
¡rOuošt
, 
·y“SŒ
);

534 } ià(
¡rMode
 == "owneraddress") {

535 ià(
¡rF‹r
 !="" && 
¡rOuošt
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
) ;

536 
obj
.
	`pushKV
(
¡rOuošt
, 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDOwÃr
));

537 } ià(
¡rMode
 == "pubkeyoperator") {

538 ià(
¡rF‹r
 !="" && 
¡rOuošt
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
) ;

539 
obj
.
	`pushKV
(
¡rOuošt
, 
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
().
	`ToSŒšg
());

540 } ià(
¡rMode
 == "status") {

541 
¡d
::
¡ršg
 
¡rStus
 = 
	`dmnToStus
(
dmn
);

542 ià(
¡rF‹r
 !="" && 
¡rStus
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
 &&

543 
¡rOuošt
.
	`fšd
(
¡rF‹r
è=ğ
¡d
::
¡ršg
::
Åos
) ;

544 
obj
.
	`pushKV
(
¡rOuošt
, 
¡rStus
);

545 } ià(
¡rMode
 == "votingaddress") {

546 ià(
¡rF‹r
 !="" && 
¡rOuošt
.
	`fšd
(¡rF‹rè=ğ
¡d
::
¡ršg
::
Åos
) ;

547 
obj
.
	`pushKV
(
¡rOuošt
, 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDVÙšg
));

551  
obj
;

552 
	}
}

554 cÚ¡ 
CRPCCommªd
 
	gcommªds
[] =

557 { "ma¡”node", "ma¡”node", &
ma¡”node
, {} },

558 { "ma¡”node", "ma¡”nod–i¡", &
ma¡”nod–i¡
, {} },

561 
	$Regi¡”Ma¡”nodeRPCCommªds
(
CRPCTabË
 &
t
)

563 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

564 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

565 
	}
}

	@mining.cpp

6 
	~<amouÁ.h
>

7 
	~<chaš.h
>

8 
	~<chaš·¿ms.h
>

9 
	~<cÚ£nsus/cÚ£nsus.h
>

10 
	~<cÚ£nsus/·¿ms.h
>

11 
	~<cÚ£nsus/v®id©iÚ.h
>

12 
	~<cÜe_io.h
>

13 
	~<key_io.h
>

14 
	~<mš”.h
>

15 
	~<Ãt.h
>

16 
	~<node/cÚ‹xt.h
>

17 
	~<pŞicy/ães.h
>

18 
	~<pow.h
>

19 
	~<½c/auxpow_mš”.h
>

20 
	~<½c/blockchaš.h
>

21 
	~<½c/£rv”.h
>

22 
	~<½c/ut.h
>

23 
	~<süt/desütÜ.h
>

24 
	~<süt/süt.h
>

25 
	~<süt/signšg´ovid”.h
>

26 
	~<shutdown.h
>

27 
	~<txmempoŞ.h
>

28 
	~<univ®ue.h
>

29 
	~<ut/ães.h
>

30 
	~<ut/¡»ncodšgs.h
>

31 
	~<ut/¡ršg.h
>

32 
	~<ut/sy¡em.h
>

33 
	~<ut/Œª¦©iÚ.h
>

34 
	~<v®id©iÚ.h
>

35 
	~<v®id©iÚš‹rçû.h
>

36 
	~<v”siÚb™sšfo.h
>

37 
	~<w¬nšgs.h
>

39 
	~<memÜy
>

40 
	~<¡dšt.h
>

42 
	~<¥Ük.h
>

43 
	~<boo¡/th»ad.hµ
>

44 
	~<gov”Çnû/gov”Çnû-şas£s.h
>

45 
	~<ma¡”node/ma¡”node-·ym’ts.h
>

46 
	~<ma¡”node/ma¡”node-sync.h
>

52 
UniV®ue
 
	$G‘N‘wÜkHashPS
(
lookup
, 
height
) {

53 
CBlockIndex
 *
pb
 = ::
	`ChašAùive
().
	`T
();

55 ià(
height
 >ğ0 && heighˆ< ::
	`ChašAùive
().
	`Height
())

56 
pb
 = ::
	`ChašAùive
()[
height
];

58 ià(
pb
 =ğ
nuÎ±r
 || !pb->
nHeight
)

62 ià(
lookup
 <= 0)

63 
lookup
 = 
pb
->
nHeight
 % 
	`P¬ams
().
	`G‘CÚ£nsus
().
	`DifficuÉyAdju¡m’tIÁ”v®
() + 1;

66 ià(
lookup
 > 
pb
->
nHeight
)

67 
lookup
 = 
pb
->
nHeight
;

69 
CBlockIndex
 *
pb0
 = 
pb
;

70 
št64_t
 
mšTime
 = 
pb0
->
	`G‘BlockTime
();

71 
št64_t
 
maxTime
 = 
mšTime
;

72 
i
 = 0; i < 
lookup
; i++) {

73 
pb0
 =…b0->
µ»v
;

74 
št64_t
 
time
 = 
pb0
->
	`G‘BlockTime
();

75 
mšTime
 = 
¡d
::
	`mš
(
time
, minTime);

76 
maxTime
 = 
¡d
::
	`max
(
time
, maxTime);

80 ià(
mšTime
 =ğ
maxTime
)

83 
¬™h_ušt256
 
wÜkDiff
 = 
pb
->
nChašWÜk
 - 
pb0
->nChainWork;

84 
št64_t
 
timeDiff
 = 
maxTime
 - 
mšTime
;

86  
wÜkDiff
.
	`g‘doubË
(è/ 
timeDiff
;

87 
	}
}

89 
UniV®ue
 
	$g‘ÃtwÜkhashps
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

91 
RPCH–pMª
{"getnetworkhashps",

96 {"nblocks", 
RPCArg
::
Ty³
::
NUM
, "120", "The‚umber of blocks, or -1 for blocks since†ast difficulty change."},

97 {"height", 
RPCArg
::
Ty³
::
NUM
, "-1", "Toƒstimate‡theime ofhe given height."},

99 
RPCResuÉ
{

100 
RPCResuÉ
::
Ty³
::
NUM
, "", "Hashes…er secondƒstimated"},

101 
RPCExam¶es
{

102 
	`H–pExam¶eCli
("getnetworkhashps", "")

103 + 
	`H–pExam¶eRpc
("getnetworkhashps", "")

105 }.
	`Check
(
»que¡
);

107 
	`LOCK
(
cs_maš
);

108  
	`G‘N‘wÜkHashPS
(!
»que¡
.
·¿ms
[0].
	`isNuÎ
(è?„eque¡.·¿ms[0].
	`g‘_št
() : 120, !request.params[1].isNull() ?„equest.params[1].get_int() : -1);

109 
	}
}

111 
boŞ
 
	$G’”©eBlock
(
Chaš¡©eMªag”
& 
chašmª
, 
CBlock
& 
block
, 
ušt64_t
& 
max_Œ›s
, & 
exŒa_nÚû
, 
ušt256
& 
block_hash
)

113 
block_hash
.
	`S‘NuÎ
();

116 
	`LOCK
(
cs_maš
);

117 
	`Inüem’tExŒaNÚû
(&
block
, ::
	`ChašAùive
().
	`T
(), 
exŒa_nÚû
);

120 
CChašP¬ams
 
	`chaš·¿ms
(
	`P¬ams
());

122 
max_Œ›s
 > 0 && 
block
.
nNÚû
 < 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
(è&& !
	`CheckProofOfWÜk
(block.
	`G‘Hash
(), block.
nB™s
, 
chaš·¿ms
.
	`G‘CÚ£nsus
()è&& !
	`ShutdownReque¡ed
()) {

123 ++
block
.
nNÚû
;

124 --
max_Œ›s
;

126 ià(
max_Œ›s
 =ğ0 || 
	`ShutdownReque¡ed
()) {

127  
çl£
;

129 ià(
block
.
nNÚû
 =ğ
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
()) {

130  
Œue
;

133 
¡d
::
sh¬ed_±r
<cÚ¡ 
CBlock
> 
sh¬ed_pblock
 = std::
make_sh¬ed
<cÚ¡ CBlock>(
block
);

134 ià(!
chašmª
.
	`ProûssNewBlock
(
chaš·¿ms
, 
sh¬ed_pblock
, 
Œue
, 
nuÎ±r
)) {

135 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "ProcessNewBlock, block‚ot‡ccepted");

138 
block_hash
 = 
block
.
	`G‘Hash
();

139  
Œue
;

140 
	}
}

142 
UniV®ue
 
	$g’”©eBlocks
(
Chaš¡©eMªag”
& 
chašmª
, cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
, cÚ¡ 
CSüt
& 
cošba£_süt
, 
nG’”©e
, 
ušt64_t
 
nMaxTr›s
)

144 
nHeightEnd
 = 0;

145 
nHeight
 = 0;

148 
	`LOCK
(
cs_maš
);

149 
nHeight
 = ::
	`ChašAùive
().
	`Height
();

150 
nHeightEnd
 = 
nHeight
+
nG’”©e
;

152 
nExŒaNÚû
 = 0;

153 
UniV®ue
 
	`blockHashes
(UniV®ue::
VARR
);

154 
nHeight
 < 
nHeightEnd
 && !
	`ShutdownReque¡ed
())

156 
¡d
::
unique_±r
<
CBlockTem¶©e
> 
	`pblock‹m¶©e
(
	`BlockAs£mbËr
(
mempoŞ
, 
	`P¬ams
()).
	`C»©eNewBlock
(
cošba£_süt
));

157 ià(!
pblock‹m¶©e
.
	`g‘
())

158 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Couldn't create‚ew block");

159 
CBlock
 *
pblock
 = &
pblock‹m¶©e
->
block
;

161 
ušt256
 
block_hash
;

162 ià(!
	`G’”©eBlock
(
chašmª
, *
pblock
, 
nMaxTr›s
, 
nExŒaNÚû
, 
block_hash
)) {

166 ià(!
block_hash
.
	`IsNuÎ
()) {

167 ++
nHeight
;

168 
blockHashes
.
	`push_back
(
block_hash
.
	`G‘Hex
());

171  
blockHashes
;

172 
	}
}

174 
boŞ
 
	$g‘SütFromDesütÜ
(cÚ¡ 
¡d
::
¡ršg
& 
desütÜ
, 
CSüt
& 
süt
, std::¡ršg& 
”rÜ
)

176 
FÏtSignšgProvid”
 
key_´ovid”
;

177 cÚ¡‡utØ
desc
 = 
	`P¬£
(
desütÜ
, 
key_´ovid”
, 
”rÜ
, 
çl£
);

178 ià(
desc
) {

179 ià(
desc
->
	`IsRªge
()) {

180 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Ranged descriptor‚ot‡ccepted. Maybe…asshrough deriveaddresses first?");

183 
FÏtSignšgProvid”
 
´ovid”
;

184 
¡d
::
veùÜ
<
CSüt
> 
süts
;

185 ià(!
desc
->
	`Ex·nd
(0, 
key_´ovid”
, 
süts
, 
´ovid”
)) {

186 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("Cannot derive script without…rivate keys"));

190 
	`CHECK_NONFATAL
(
süts
.
	`size
() > 0 && scripts.size() <= 4);

192 ià(
süts
.
	`size
() == 1) {

193 
süt
 = 
süts
.
	`©
(0);

194 } ià(
süts
.
	`size
() == 4) {

196 
süt
 = 
süts
.
	`©
(2);

199 
süt
 = 
süts
.
	`©
(1);

202  
Œue
;

204  
çl£
;

206 
	}
}

208 
UniV®ue
 
	$g’”©‘odesütÜ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

210 
RPCH–pMª
{

214 {"num_blocks", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "How many blocks‡re generated immediately."},

215 {"desütÜ", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The descriptoro sendhe‚ewly generated syscoino."},

216 {"maxŒ›s", 
RPCArg
::
Ty³
::
NUM
, "1000000", "How many iterationsory."},

218 
RPCResuÉ
{

219 
RPCResuÉ
::
Ty³
::
ARR
, "", "hashes of blocks generated",

221 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "blockhash"},

224 
RPCExam¶es
{

225 "\nG’”©11 block tØmydesc\n" + 
	`H–pExam¶eCli
("generatetodescriptor", "11 \"mydesc\"")},

227 .
	`Check
(
»que¡
);

229 cÚ¡ 
num_blocks
{
»que¡
.
·¿ms
[0].
	`g‘_št
()};

230 cÚ¡ 
št64_t
 
max_Œ›s
{
»que¡
.
·¿ms
[2].
	`isNuÎ
(è? 1000000 :„eque¡.·¿ms[2].
	`g‘_št
()};

232 
CSüt
 
cošba£_süt
;

233 
¡d
::
¡ršg
 
”rÜ
;

234 ià(!
	`g‘SütFromDesütÜ
(
»que¡
.
·¿ms
[1].
	`g‘_¡r
(), 
cošba£_süt
, 
”rÜ
)) {

235 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
”rÜ
);

238 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

239 
Chaš¡©eMªag”
& 
chašmª
 = 
	`Ensu»Chašmª
(
»que¡
.
cÚ‹xt
);

241  
	`g’”©eBlocks
(
chašmª
, 
mempoŞ
, 
cošba£_süt
, 
num_blocks
, 
max_Œ›s
);

242 
	}
}

244 
UniV®ue
 
	$g’”©‘ßdd»ss
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

246 
RPCH–pMª
{"generatetoaddress",

249 {"nblocks", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "How many blocks‡re generated immediately."},

250 {"add»ss", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The‡ddresso sendhe‚ewly generated syscoino."},

251 {"maxŒ›s", 
RPCArg
::
Ty³
::
NUM
, "1000000", "How many iterationsory."},

253 
RPCResuÉ
{

254 
RPCResuÉ
::
Ty³
::
ARR
, "", "hashes of blocks generated",

256 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "blockhash"},

258 
RPCExam¶es
{

260 + 
	`H–pExam¶eCli
("generatetoaddress", "11 \"myaddress\"")

261 + "Iàyou‡» usšgh" 
PACKAGE_NAME
 " wallet, you can get‡‚ew‡ddresso sendhe‚ewly generated syscoino with:\n"

262 + 
	`H–pExam¶eCli
("getnewaddress", "")

264 }.
	`Check
(
»que¡
);

266 
nG’”©e
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

267 
ušt64_t
 
nMaxTr›s
 = 1000000;

268 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

269 
nMaxTr›s
 = 
»que¡
.
·¿ms
[2].
	`g‘_št
();

272 
CTxDe¡š©iÚ
 
de¡š©iÚ
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[1].
	`g‘_¡r
());

273 ià(!
	`IsV®idDe¡š©iÚ
(
de¡š©iÚ
)) {

274 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Error: Invalid‡ddress");

277 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

278 
Chaš¡©eMªag”
& 
chašmª
 = 
	`Ensu»Chašmª
(
»que¡
.
cÚ‹xt
);

280 
CSüt
 
cošba£_süt
 = 
	`G‘SütFÜDe¡š©iÚ
(
de¡š©iÚ
);

282  
	`g’”©eBlocks
(
chašmª
, 
mempoŞ
, 
cošba£_süt
, 
nG’”©e
, 
nMaxTr›s
);

283 
	}
}

285 
UniV®ue
 
	$g’”©eblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

287 
RPCH–pMª
{"generateblock",

290 {"ouut", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The‡ddress or descriptoro sendhe‚ewly generated syscoino."},

291 {"Œª§ùiÚs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "An‡rray of hex strings which‡reƒitherxids or„awransactions.\n"

295 {"¿wtx/txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, ""},

299 
RPCResuÉ
{

300 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

302 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "hash of generated block"},

305 
RPCExam¶es
{

307 + 
	`H–pExam¶eCli
("g’”©eblock", 
R
"("
myadd»ss
" '["
¿wtx
", "
mempoŞ_txid
"]')")

309 }.
	`Check
(
»que¡
);

311 cÚ¡‡utØ
add»ss_Ü_desütÜ
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

312 
CSüt
 
cošba£_süt
;

313 
¡d
::
¡ršg
 
”rÜ
;

315 ià(!
	`g‘SütFromDesütÜ
(
add»ss_Ü_desütÜ
, 
cošba£_süt
, 
”rÜ
)) {

316 cÚ¡‡utØ
de¡š©iÚ
 = 
	`DecodeDe¡š©iÚ
(
add»ss_Ü_desütÜ
);

317 ià(!
	`IsV®idDe¡š©iÚ
(
de¡š©iÚ
)) {

318 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Error: Invalid‡ddress or descriptor");

321 
cošba£_süt
 = 
	`G‘SütFÜDe¡š©iÚ
(
de¡š©iÚ
);

324 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

326 
¡d
::
veùÜ
<
CT¿n§ùiÚRef
> 
txs
;

327 cÚ¡‡utØ
¿w_txs_Ü_txids
 = 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
();

328 
size_t
 
i
 = 0; i < 
¿w_txs_Ü_txids
.
	`size
(); i++) {

329 cÚ¡‡utØ
	`¡r
(
¿w_txs_Ü_txids
[
i
].
	`g‘_¡r
());

331 
ušt256
 
hash
;

332 
CMubËT¿n§ùiÚ
 
mtx
;

333 ià(
	`P¬£HashSŒ
(
¡r
, 
hash
)) {

335 cÚ¡‡utØ
tx
 = 
mempoŞ
.
	`g‘
(
hash
);

336 ià(!
tx
) {

337 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("T¿n§ùiÚ % nÙ iÀmempoŞ.", 
¡r
));

340 
txs
.
	`em¶aû_back
(
tx
);

342 } ià(
	`DecodeHexTx
(
mtx
, 
¡r
)) {

343 
txs
.
	`push_back
(
	`MakeT¿n§ùiÚRef
(
¡d
::
	`move
(
mtx
)));

346 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("T¿n§ùiÚ decodçed fÜ %s", 
¡r
));

350 
CChašP¬ams
 
	`chaš·¿ms
(
	`P¬ams
());

351 
CBlock
 
block
;

353 
¡d
::
unique_±r
<
CBlockTem¶©e
> 
block‹m¶©e
;

355 
	`LOCK
(
cs_maš
);

357 
CTxMemPoŞ
 
em±y_mempoŞ
;

358 
block‹m¶©e
 = 
	`BlockAs£mbËr
(
em±y_mempoŞ
, 
chaš·¿ms
).
	`C»©eNewBlock
(
cošba£_süt
);

359 ià(!
block‹m¶©e
) {

360 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Couldn't create‚ew block");

362 
block
 = 
block‹m¶©e
->block;

365 
	`CHECK_NONFATAL
(
block
.
vtx
.
	`size
() == 1);

368 
block
.
vtx
.
	`š£¹
(block.vtx.
	`’d
(), 
txs
.
	`begš
(),xs.end());

370 
	`Reg’”©eComm™m’ts
(
block
, 
block‹m¶©e
->
vchCošba£Comm™m’tExŒa
);

373 
	`LOCK
(
cs_maš
);

375 
BlockV®id©iÚS‹
 
¡©e
;

376 ià(!
	`Te¡BlockV®id™y
(
¡©e
, 
chaš·¿ms
, 
block
, 
	`LookupBlockIndex
(block.
hashP»vBlock
), 
çl£
, false)) {

377 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, 
	`¡½rštf
("Te¡BlockV®id™y faed: %s", 
¡©e
.
	`ToSŒšg
()));

381 
ušt256
 
block_hash
;

382 
ušt64_t
 
max_Œ›s
{1000000};

383 
exŒa_nÚû
{0};

385 ià(!
	`G’”©eBlock
(
	`Ensu»Chašmª
(
»que¡
.
cÚ‹xt
), 
block
, 
max_Œ›s
, 
exŒa_nÚû
, 
block_hash
è|| block_hash.
	`IsNuÎ
()) {

386 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Failedo make block.");

389 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

390 
obj
.
	`pushKV
("hash", 
block_hash
.
	`G‘Hex
());

391  
obj
;

392 
	}
}

394 
UniV®ue
 
	$g‘mššgšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

396 
RPCH–pMª
{"getmininginfo",

399 
RPCResuÉ
{

400 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

402 {
RPCResuÉ
::
Ty³
::
NUM
, "blocks", "The current block"},

403 {
RPCResuÉ
::
Ty³
::
NUM
, "cu¼’tblockweight", 
Œue
, "The block weight ofhe†ast‡ssembled block (only…resent if‡ block wasƒver‡ssembled)"},

404 {
RPCResuÉ
::
Ty³
::
NUM
, "cu¼’tblocktx", 
Œue
, "The‚umber of blockransactions ofhe†ast‡ssembled block (only…resent if‡ block wasƒver‡ssembled)"},

405 {
RPCResuÉ
::
Ty³
::
NUM
, "difficulty", "The current difficulty"},

406 {
RPCResuÉ
::
Ty³
::
NUM
, "networkhashps", "The‚etwork hashes…er second"},

407 {
RPCResuÉ
::
Ty³
::
NUM
, "pooledtx", "The size ofhe mempool"},

408 {
RPCResuÉ
::
Ty³
::
STR
, "chain", "current‚etwork‚ame (main,est,„egtest)"},

409 {
RPCResuÉ
::
Ty³
::
STR
, "warnings", "any‚etwork‡nd blockchain warnings"},

411 
RPCExam¶es
{

412 
	`H–pExam¶eCli
("getmininginfo", "")

413 + 
	`H–pExam¶eRpc
("getmininginfo", "")

415 }.
	`Check
(
»que¡
);

417 
	`LOCK
(
cs_maš
);

418 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

420 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

421 
obj
.
	`pushKV
("blocks", ()::
	`ChašAùive
().
	`Height
());

422 ià(
BlockAs£mbËr
::
m_Ï¡_block_weight
è
obj
.
	`pushKV
("currentblockweight", *BlockAssembler::m_last_block_weight);

423 ià(
BlockAs£mbËr
::
m_Ï¡_block_num_txs
è
obj
.
	`pushKV
("currentblocktx", *BlockAssembler::m_last_block_num_txs);

424 
obj
.
	`pushKV
("difficuÉy", ()
	`G‘DifficuÉy
(::
	`ChašAùive
().
	`T
()));

425 
obj
.
	`pushKV
("ÃtwÜkhashps", 
	`g‘ÃtwÜkhashps
(
»que¡
));

426 
obj
.
	`pushKV
("poŞedtx", (
ušt64_t
)
mempoŞ
.
	`size
());

427 
obj
.
	`pushKV
("chaš", 
	`P¬ams
().
	`N‘wÜkIDSŒšg
());

428 
obj
.
	`pushKV
("w¬nšgs", 
	`G‘W¬nšgs
(
çl£
).
Üigš®
);

429  
obj
;

430 
	}
}

434 
UniV®ue
 
	$´iÜ™i£Œª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

436 
RPCH–pMª
{"prioritisetransaction",

439 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id."},

440 {"dummy", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "API-Compatibility for…revious API. Must be zero or‚ull.\n"

442 {"ãe_d–", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The fee value (in satoshis)o‡dd (or subtract, if‚egative).\n"

447 
RPCResuÉ
{

448 
RPCResuÉ
::
Ty³
::
BOOL
, "", "Returnsrue"},

449 
RPCExam¶es
{

450 
	`H–pExam¶eCli
("prioritisetransaction", "\"txid\" 0.0 10000")

451 + 
	`H–pExam¶eRpc
("prioritisetransaction", "\"txid\", 0.0, 10000")

453 }.
	`Check
(
»que¡
);

455 
	`LOCK
(
cs_maš
);

457 
ušt256
 
	`hash
(
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "txid"));

458 
CAmouÁ
 
nAmouÁ
 = 
»que¡
.
·¿ms
[2].
	`g‘_št64
();

460 ià(!(
»que¡
.
·¿ms
[1].
	`isNuÎ
(è||„eque¡.·¿ms[1].
	`g‘_»®
() == 0)) {

461 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Priority is‚o†onger supported, dummy‡rgumento…rioritisetransaction must be 0.");

464 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
).
	`PriÜ™i£T¿n§ùiÚ
(
hash
, 
nAmouÁ
);

465  
Œue
;

466 
	}
}

470 
UniV®ue
 
	$BIP22V®id©iÚResuÉ
(cÚ¡ 
BlockV®id©iÚS‹
& 
¡©e
)

472 ià(
¡©e
.
	`IsV®id
())

473  
NuÎUniV®ue
;

475 ià(
¡©e
.
	`IsE¼Ü
())

476 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, 
¡©e
.
	`ToSŒšg
());

477 ià(
¡©e
.
	`IsInv®id
())

479 
¡d
::
¡ršg
 
¡rRejeùR—sÚ
 = 
¡©e
.
	`G‘RejeùR—sÚ
();

480 ià(
¡rRejeùR—sÚ
.
	`em±y
())

482  
¡rRejeùR—sÚ
;

486 
	}
}

488 
	g¡d
::
¡ršg
 
	$gbt_vb_Çme
(cÚ¡ 
CÚ£nsus
::
D•loym’tPos
 
pos
) {

489 cÚ¡ 
VBD•loym’tInfo
& 
vbšfo
 = 
V”siÚB™sD•loym’tInfo
[
pos
];

490 
¡d
::
¡ršg
 
s
 = 
vbšfo
.
Çme
;

491 ià(!
vbšfo
.
gbt_fÜû
) {

492 
s
.
	`š£¹
(s.
	`begš
(), '!');

494  
s
;

495 
	}
}

497 
UniV®ue
 
	$g‘block‹m¶©e
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

499 
RPCH–pMª
{"getblocktemplate",

508 {"‹m¶©e_»que¡", 
RPCArg
::
Ty³
::
OBJ
, "{}", "Format ofheemplate",

510 {"mode", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "This must be seto \"template\", \"proposal\" (see BIP 23), or omitted"},

511 {"ÿ·b™›s", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "A†ist of strings",

513 {"suµÜt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "client side supported feature, 'longpoll', 'coinbasetxn', 'coinbasevalue', 'proposal', 'serverlist', 'workid'"},

516 {"ruËs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "A†ist of strings",

518 {"suµÜt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "client side supported softfork deployment"},

524 
RPCResuÉ
{

525 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

527 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The…referred block version"},

528 {
RPCResuÉ
::
Ty³
::
ARR
, "rules", "specific block„uleshat‡reo beƒnforced",

530 {
RPCResuÉ
::
Ty³
::
STR
, "", "rulename"},

532 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "vbavailable", "set of…ending, supported versionbit (BIP 9) softfork deployments",

534 {
RPCResuÉ
::
Ty³
::
NUM
, "rulename", "identifieshe bit‚umber‡s indicating‡cceptance‡nd„eadiness forhe‚amed softfork„ule"},

536 {
RPCResuÉ
::
Ty³
::
NUM
, "vbrequired", "bit mask of versionbitshe server„equires set in submissions"},

537 {
RPCResuÉ
::
Ty³
::
STR
, "previousblockhash", "The hash of current highest block"},

538 {
RPCResuÉ
::
Ty³
::
ARR
, "", "contents of‚on-coinbaseransactionshat should be included inhe‚ext block",

540 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

542 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "data", "transaction dataƒncoded in hexadecimal (byte-for-byte)"},

543 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "transaction idƒncoded in†ittle-endian hexadecimal"},

544 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "hashƒncoded in†ittle-endian hexadecimal (including witness data)"},

545 {
RPCResuÉ
::
Ty³
::
ARR
, "depends", "array of‚umbers",

547 {
RPCResuÉ
::
Ty³
::
NUM
, "", "transactions beforehis one (by 1-based index in 'transactions'†ist)hat must be…resent inhe final block ifhis one is"},

549 {
RPCResuÉ
::
Ty³
::
NUM
, "fee", "difference in value betweenransaction inputs‡nd outputs (in satoshis); for coinbaseransactions,his is‡‚egative Number ofheotal collected block fees (ie,‚ot includinghe block subsidy); if key is‚ot…resent, fee is unknown‡nd clients MUST NOT‡ssumehere isn't one"},

550 {
RPCResuÉ
::
Ty³
::
NUM
, "sigops", "total SigOps cost,‡s counted for…urposes of block†imits; if key is‚ot…resent, sigop cost is unknown‡nd clients MUST NOT‡ssume it is zero"},

551 {
RPCResuÉ
::
Ty³
::
NUM
, "weight", "totalransaction weight,‡s counted for…urposes of block†imits"},

554 {
RPCResuÉ
::
Ty³
::
OBJ
, "coinbaseaux", "datahat should be included inhe coinbase's scriptSig content",

556 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

558 {
RPCResuÉ
::
Ty³
::
NUM
, "coinbasevalue", "maximum‡llowable inputo coinbaseransaction, includinghe generation‡ward‡ndransaction fees (in satoshis)"},

559 {
RPCResuÉ
::
Ty³
::
OBJ
, "coinbasetxn", "information for coinbaseransaction",

561 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

563 {
RPCResuÉ
::
Ty³
::
STR
, "target", "The hasharget"},

564 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "mštime", "Thmšimumime¡am°­´İrŸ‹ fÜhÃxˆblockime,ƒx´es£d iÀ" + 
UNIX_EPOCH_TIME
},

565 {
RPCResuÉ
::
Ty³
::
ARR
, "mutable", "list of wayshe blockemplate may be changed",

567 {
RPCResuÉ
::
Ty³
::
STR
, "value", "A wayhe blockemplate may be changed,ƒ.g. 'time', 'transactions', 'prevblock'"},

569 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "noncerange", "A„ange of valid‚onces"},

570 {
RPCResuÉ
::
Ty³
::
NUM
, "sigoplimit", "limit of sigops in blocks"},

571 {
RPCResuÉ
::
Ty³
::
NUM
, "sizelimit", "limit of block size"},

572 {
RPCResuÉ
::
Ty³
::
NUM
, "weightlimit", "limit of block weight"},

573 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "cu¹ime", "cu¼’ˆtime¡am°š " + 
UNIX_EPOCH_TIME
},

574 {
RPCResuÉ
::
Ty³
::
STR
, "bits", "compressedarget of‚ext block"},

575 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "The height ofhe‚ext block"},

577 
RPCExam¶es
{

578 
	`H–pExam¶eCli
("getblocktemplate", "'{\"rules\": [\"segwit\"]}'")

579 + 
	`H–pExam¶eRpc
("getblocktemplate", "{\"rules\": [\"segwit\"]}")

581 }.
	`Check
(
»que¡
);

583 
¡d
::
¡ršg
 
”rÜMes§ge
 = "";

584 if(!
fRegTe¡
 && !
	`CheckS³cs
(
”rÜMes§ge
, 
Œue
)){

585 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, 
”rÜMes§ge
);

587 
	`LOCK
(
cs_maš
);

589 
¡d
::
¡ršg
 
¡rMode
 = "template";

590 
UniV®ue
 
Ív®
 = 
NuÎUniV®ue
;

591 
¡d
::
£t
<¡d::
¡ršg
> 
£tCl›ÁRuËs
;

592 
št64_t
 
nMaxV”siÚP»VB
 = -1;

593 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
())

595 cÚ¡ 
UniV®ue
& 
İ¬am
 = 
»que¡
.
·¿ms
[0].
	`g‘_obj
();

596 cÚ¡ 
UniV®ue
& 
modev®
 = 
	`fšd_v®ue
(
İ¬am
, "mode");

597 ià(
modev®
.
	`isSŒ
())

598 
¡rMode
 = 
modev®
.
	`g‘_¡r
();

599 ià(
modev®
.
	`isNuÎ
())

604 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid mode");

605 
Ív®
 = 
	`fšd_v®ue
(
İ¬am
, "longpollid");

607 ià(
¡rMode
 == "proposal")

609 cÚ¡ 
UniV®ue
& 
d©av®
 = 
	`fšd_v®ue
(
İ¬am
, "data");

610 ià(!
d©av®
.
	`isSŒ
())

611 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Missing data String key for…roposal");

613 
CBlock
 
block
;

614 ià(!
	`DecodeHexBlk
(
block
, 
d©av®
.
	`g‘_¡r
()))

615 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Block decode failed");

617 
ušt256
 
hash
 = 
block
.
	`G‘Hash
();

618 cÚ¡ 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
hash
);

619 ià(
pšdex
) {

620 ià(
pšdex
->
	`IsV®id
(
BLOCK_VALID_SCRIPTS
))

622 ià(
pšdex
->
nStus
 & 
BLOCK_FAILED_MASK
)

627 
CBlockIndex
* cÚ¡ 
pšdexP»v
 = ::
	`ChašAùive
().
	`T
();

629 ià(
block
.
hashP»vBlock
 !ğ
pšdexP»v
->
	`G‘BlockHash
())

631 
BlockV®id©iÚS‹
 
¡©e
;

632 
	`Te¡BlockV®id™y
(
¡©e
, 
	`P¬ams
(), 
block
, 
pšdexP»v
, 
çl£
, 
Œue
);

633  
	`BIP22V®id©iÚResuÉ
(
¡©e
);

636 cÚ¡ 
UniV®ue
& 
aCl›ÁRuËs
 = 
	`fšd_v®ue
(
İ¬am
, "rules");

637 ià(
aCl›ÁRuËs
.
	`isA¼ay
()) {

638 
i
 = 0; i < 
aCl›ÁRuËs
.
	`size
(); ++i) {

639 cÚ¡ 
UniV®ue
& 
v
 = 
aCl›ÁRuËs
[
i
];

640 
£tCl›ÁRuËs
.
	`š£¹
(
v
.
	`g‘_¡r
());

644 cÚ¡ 
UniV®ue
& 
uvMaxV”siÚ
 = 
	`fšd_v®ue
(
İ¬am
, "maxversion");

645 ià(
uvMaxV”siÚ
.
	`isNum
()) {

646 
nMaxV”siÚP»VB
 = 
uvMaxV”siÚ
.
	`g‘_št64
();

651 ià(
¡rMode
 != "template")

652 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid mode");

654 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

655 if(!
node
.
cÚnmª
)

656 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

658 ià(
node
.
cÚnmª
->
	`G‘NodeCouÁ
(
CCÚnmª
::
CONNECTIONS_ALL
) == 0)

659 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NOT_CONNECTED
, 
PACKAGE_NAME
 " is‚ot connected!");

661 ià(::
	`Chaš¡©eAùive
().
	`IsIn™ŸlBlockDowÆßd
())

662 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_IN_INITIAL_DOWNLOAD
, 
PACKAGE_NAME
 " is in initial sync‡nd waiting for blocks...");

667 
¡d
::
veùÜ
<
CTxOut
> 
voutMa¡”nodePaym’ts
;

668 
CAmouÁ
 
mnR‘
;

669 
nCŞÏ‹¿lHeight
;

670 
mÅaym’ts
.
	`G‘BlockTxOuts
(::
	`ChašAùive
().
	`Height
(è+ 1, 0, 
voutMa¡”nodePaym’ts
, 0, 
mnR‘
, 
nCŞÏ‹¿lHeight
);

673 ià(
¥ÜkMªag”
.
	`IsSpÜkAùive
(
SPORK_9_SUPERBLOCKS_ENABLED
)

674 && !
ma¡”nodeSync
.
	`IsSynûd
()

675 && 
CSu³rblock
::
	`IsV®idBlockHeight
(::
	`ChašAùive
().
	`Height
() + 1))

676 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_IN_INITIAL_DOWNLOAD
, "Syscoin Core is syncing with‚etwork...");

679 
nT¿n§ùiÚsUpd©edLa¡
;

680 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

682 ià(!
Ív®
.
	`isNuÎ
())

685 
ušt256
 
hashW©chedChaš
;

686 
¡d
::
chrÚo
::
¡—dy_şock
::
time_pošt
 
checktxtime
;

687 
nT¿n§ùiÚsUpd©edLa¡LP
;

689 ià(
Ív®
.
	`isSŒ
())

692 
¡d
::
¡ršg
 
Í¡r
 = 
Ív®
.
	`g‘_¡r
();

694 
hashW©chedChaš
 = 
	`P¬£HashV
(
Í¡r
.
	`sub¡r
(0, 64), "longpollid");

695 
nT¿n§ùiÚsUpd©edLa¡LP
 = 
	`©oi64
(
Í¡r
.
	`sub¡r
(64));

700 
hashW©chedChaš
 = ::
	`ChašAùive
().
	`T
()->
	`G‘BlockHash
();

701 
nT¿n§ùiÚsUpd©edLa¡LP
 = 
nT¿n§ùiÚsUpd©edLa¡
;

705 
	`LEAVE_CRITICAL_SECTION
(
cs_maš
);

707 
checktxtime
 = 
¡d
::
chrÚo
::
¡—dy_şock
::
	`now
(è+ std::chrÚo::
	`mšu‹s
(1);

709 
	`WAIT_LOCK
(
g_be¡_block_mu‹x
, 
lock
);

710 
g_be¡_block
 =ğ
hashW©chedChaš
 && 
	`IsRPCRuÂšg
())

712 ià(
g_be¡_block_cv
.
	`wa™_uÁ
(
lock
, 
checktxtime
è=ğ
¡d
::
cv_¡©us
::
timeout
)

716 ià(
mempoŞ
.
	`G‘T¿n§ùiÚsUpd©ed
(è!ğ
nT¿n§ùiÚsUpd©edLa¡LP
)

718 
checktxtime
 +ğ
¡d
::
chrÚo
::
	`£cÚds
(10);

722 
	`ENTER_CRITICAL_SECTION
(
cs_maš
);

724 ià(!
	`IsRPCRuÂšg
())

725 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NOT_CONNECTED
, "Shutting down");

730 ià(
£tCl›ÁRuËs
.
	`couÁ
("segwit") != 1) {

731 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "getblocktemplate must be called withhe segwit„ule set (call with {\"rules\": [\"segwit\"]})");

735 
CBlockIndex
* 
pšdexP»v
;

736 
št64_t
 
nS¹
;

737 
¡d
::
unique_±r
<
CBlockTem¶©e
> 
pblock‹m¶©e
;

738 ià(
pšdexP»v
 !ğ::
	`ChašAùive
().
	`T
() ||

739 (
mempoŞ
.
	`G‘T¿n§ùiÚsUpd©ed
(è!ğ
nT¿n§ùiÚsUpd©edLa¡
 && 
	`G‘Time
(è- 
nS¹
 > 5))

742 
pšdexP»v
 = 
nuÎ±r
;

745 
nT¿n§ùiÚsUpd©edLa¡
 = 
mempoŞ
.
	`G‘T¿n§ùiÚsUpd©ed
();

746 
CBlockIndex
* 
pšdexP»vNew
 = ::
	`ChašAùive
().
	`T
();

747 
nS¹
 = 
	`G‘Time
();

750 
CSüt
 
sütDummy
 = 
	`CSüt
(è<< 
OP_TRUE
;

751 
pblock‹m¶©e
 = 
	`BlockAs£mbËr
(
mempoŞ
, 
	`P¬ams
()).
	`C»©eNewBlock
(
sütDummy
);

752 ià(!
pblock‹m¶©e
)

753 
throw
 
	`JSONRPCE¼Ü
(
RPC_OUT_OF_MEMORY
, "Out of memory");

756 
pšdexP»v
 = 
pšdexP»vNew
;

758 
	`CHECK_NONFATAL
(
pšdexP»v
);

759 
CBlock
* 
pblock
 = &
pblock‹m¶©e
->
block
;

760 cÚ¡ 
CÚ£nsus
::
P¬ams
& 
cÚ£nsusP¬ams
 = 
	`P¬ams
().
	`G‘CÚ£nsus
();

763 
	`Upd©eTime
(
pblock
, 
cÚ£nsusP¬ams
, 
pšdexP»v
);

764 
pblock
->
nNÚû
 = 0;

767 cÚ¡ 
boŞ
 
fP»SegW™
 = (
pšdexP»v
->
nHeight
 + 1 < 
cÚ£nsusP¬ams
.
Segw™Height
);

769 
UniV®ue
 
	`aC­s
(UniV®ue::
VARR
); 
aC­s
.
	`push_back
("proposal");

771 
UniV®ue
 
	`Œª§ùiÚs
(UniV®ue::
VARR
);

772 
¡d
::
m­
<
ušt256
, 
št64_t
> 
£tTxIndex
;

773 
i
 = 0;

774 cÚ¡‡uto& 
™
 : 
pblock
->
vtx
) {

775 cÚ¡ 
CT¿n§ùiÚ
& 
tx
 = *
™
;

776 
ušt256
 
txHash
 = 
tx
.
	`G‘Hash
();

777 
£tTxIndex
[
txHash
] = 
i
++;

779 ià(
tx
.
	`IsCošBa£
())

782 
UniV®ue
 
	`’Œy
(UniV®ue::
VOBJ
);

784 
’Œy
.
	`pushKV
("d©a", 
	`EncodeHexTx
(
tx
));

785 
’Œy
.
	`pushKV
("txid", 
txHash
.
	`G‘Hex
());

786 
’Œy
.
	`pushKV
("hash", 
tx
.
	`G‘W™ÃssHash
().
	`G‘Hex
());

788 
UniV®ue
 
	`d•s
(UniV®ue::
VARR
);

789 cÚ¡ 
CTxIn
 &
š
 : 
tx
.
vš
)

791 ià(
£tTxIndex
.
	`couÁ
(
š
.
´evout
.
hash
))

792 
d•s
.
	`push_back
(
£tTxIndex
[
š
.
´evout
.
hash
]);

794 
’Œy
.
	`pushKV
("d•’ds", 
d•s
);

796 
šdex_š_‹m¶©e
 = 
i
 - 1;

797 
’Œy
.
	`pushKV
("ãe", 
pblock‹m¶©e
->
vTxF“s
[
šdex_š_‹m¶©e
]);

798 
št64_t
 
nTxSigOps
 = 
pblock‹m¶©e
->
vTxSigOpsCo¡
[
šdex_š_‹m¶©e
];

799 ià(
fP»SegW™
) {

800 
	`CHECK_NONFATAL
(
nTxSigOps
 % 
WITNESS_SCALE_FACTOR
 == 0);

801 
nTxSigOps
 /ğ
WITNESS_SCALE_FACTOR
;

803 
’Œy
.
	`pushKV
("sigİs", 
nTxSigOps
);

804 
’Œy
.
	`pushKV
("weight", 
	`G‘T¿n§ùiÚWeight
(
tx
));

806 
Œª§ùiÚs
.
	`push_back
(
’Œy
);

809 
UniV®ue
 
	`aux
(UniV®ue::
VOBJ
);

811 
¬™h_ušt256
 
hashT¬g‘
 = 
	`¬™h_ušt256
().
	`S‘Com·ù
(
pblock
->
nB™s
);

813 
UniV®ue
 
	`aMubË
(UniV®ue::
VARR
);

814 
aMubË
.
	`push_back
("time");

815 
aMubË
.
	`push_back
("transactions");

816 
aMubË
.
	`push_back
("prevblock");

818 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

819 
»suÉ
.
	`pushKV
("ÿ·b™›s", 
aC­s
);

821 
UniV®ue
 
	`aRuËs
(UniV®ue::
VARR
);

822 
aRuËs
.
	`push_back
("csv");

823 ià(!
fP»SegW™
è
aRuËs
.
	`push_back
("!segwit");

824 
UniV®ue
 
	`vbavaabË
(UniV®ue::
VOBJ
);

825 
j
 = 0; j < ()
CÚ£nsus
::
MAX_VERSION_BITS_DEPLOYMENTS
; ++j) {

826 
CÚ£nsus
::
D•loym’tPos
 
pos
 = CÚ£nsus::
	`D•loym’tPos
(
j
);

827 
Th»shŞdS‹
 
¡©e
 = 
	`V”siÚB™sS‹
(
pšdexP»v
, 
cÚ£nsusP¬ams
, 
pos
, 
v”siÚb™sÿche
);

828 
¡©e
) {

829 
Th»shŞdS‹
::
DEFINED
:

830 
Th»shŞdS‹
::
FAILED
:

833 
Th»shŞdS‹
::
LOCKED_IN
:

835 
pblock
->
nV”siÚ
 |ğ
	`V”siÚB™sMask
(
cÚ£nsusP¬ams
, 
pos
);

837 
Th»shŞdS‹
::
STARTED
:

839 cÚ¡ 
VBD•loym’tInfo
& 
vbšfo
 = 
V”siÚB™sD•loym’tInfo
[
pos
];

840 
vbavaabË
.
	`pushKV
(
	`gbt_vb_Çme
(
pos
), 
cÚ£nsusP¬ams
.
vD•loym’ts
[pos].
b™
);

841 ià(
£tCl›ÁRuËs
.
	`fšd
(
vbšfo
.
Çme
è=ğ£tCl›ÁRuËs.
	`’d
()) {

842 ià(!
vbšfo
.
gbt_fÜû
) {

844 
pblock
->
nV”siÚ
 &ğ~
	`V”siÚB™sMask
(
cÚ£nsusP¬ams
, 
pos
);

849 
Th»shŞdS‹
::
ACTIVE
:

852 cÚ¡ 
VBD•loym’tInfo
& 
vbšfo
 = 
V”siÚB™sD•loym’tInfo
[
pos
];

853 
aRuËs
.
	`push_back
(
	`gbt_vb_Çme
(
pos
));

854 ià(
£tCl›ÁRuËs
.
	`fšd
(
vbšfo
.
Çme
è=ğ£tCl›ÁRuËs.
	`’d
()) {

856 ià(!
vbšfo
.
gbt_fÜû
) {

858 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("SuµÜˆfÜ '%s'„uË„equœe ex¶ic™ cl›Á suµÜt", 
vbšfo
.
Çme
));

865 
»suÉ
.
	`pushKV
("v”siÚ", 
pblock
->
nV”siÚ
);

866 
»suÉ
.
	`pushKV
("ruËs", 
aRuËs
);

867 
»suÉ
.
	`pushKV
("vbavaabË", 
vbavaabË
);

868 
»suÉ
.
	`pushKV
("vbrequired", (0));

870 ià(
nMaxV”siÚP»VB
 >= 2) {

875 
aMubË
.
	`push_back
("version/force");

878 
»suÉ
.
	`pushKV
("´eviousblockhash", 
pblock
->
hashP»vBlock
.
	`G‘Hex
());

879 
»suÉ
.
	`pushKV
("Œª§ùiÚs", 
Œª§ùiÚs
);

880 
»suÉ
.
	`pushKV
("cošba£aux", 
aux
);

881 
»suÉ
.
	`pushKV
("lÚgpŞlid", ::
	`ChašAùive
().
	`T
()->
	`G‘BlockHash
().
	`G‘Hex
(è+ 
	`ToSŒšg
(
nT¿n§ùiÚsUpd©edLa¡
));

882 
»suÉ
.
	`pushKV
("rg‘", 
hashT¬g‘
.
	`G‘Hex
());

883 
»suÉ
.
	`pushKV
("mštime", (
št64_t
)
pšdexP»v
->
	`G‘MedŸnTimePa¡
()+1);

884 
»suÉ
.
	`pushKV
("mubË", 
aMubË
);

885 
»suÉ
.
	`pushKV
("noncerange", "00000000ffffffff");

886 
št64_t
 
nSigOpLim™
 = 
MAX_BLOCK_SIGOPS_COST
;

887 
št64_t
 
nSizeLim™
 = 
MAX_BLOCK_SERIALIZED_SIZE
;

888 ià(
fP»SegW™
) {

889 
	`CHECK_NONFATAL
(
nSigOpLim™
 % 
WITNESS_SCALE_FACTOR
 == 0);

890 
nSigOpLim™
 /ğ
WITNESS_SCALE_FACTOR
;

891 
	`CHECK_NONFATAL
(
nSizeLim™
 % 
WITNESS_SCALE_FACTOR
 == 0);

892 
nSizeLim™
 /ğ
WITNESS_SCALE_FACTOR
;

894 
»suÉ
.
	`pushKV
("sigİlim™", 
nSigOpLim™
);

895 
»suÉ
.
	`pushKV
("siz–im™", 
nSizeLim™
);

896 ià(!
fP»SegW™
) {

897 
»suÉ
.
	`pushKV
("weighim™", (
št64_t
)
MAX_BLOCK_WEIGHT
);

899 
»suÉ
.
	`pushKV
("cu¹ime", 
pblock
->
	`G‘BlockTime
());

900 
»suÉ
.
	`pushKV
("b™s", 
	`¡½rštf
("%08x", 
pblock
->
nB™s
));

901 
»suÉ
.
	`pushKV
("height", (
št64_t
)(
pšdexP»v
->
nHeight
+1));

902 
»suÉ
.
	`pushKV
("v”siÚ_cošba£", 
pblock
->
vtx
[0]->
nV”siÚ
);

903 ià(!
pblock‹m¶©e
->
vchCošba£Comm™m’t
.
	`em±y
()) {

904 
»suÉ
.
	`pushKV
("deçuÉ_w™Ãss_comm™m’t", 
	`HexSŒ
(
pblock‹m¶©e
->
vchCošba£Comm™m’t
.
	`begš
(),…block‹m¶©e->vchCošba£Comm™m’t.
	`’d
()));

907 
UniV®ue
 
	`ma¡”nodeObj
(UniV®ue::
VARR
);

908 cÚ¡‡uto& 
txout
 : 
pblock‹m¶©e
->
voutMa¡”nodePaym’ts
) {

909 
CTxDe¡š©iÚ
 
add»ss1
;

910 
	`ExŒaùDe¡š©iÚ
(
txout
.
sütPubKey
, 
add»ss1
);

912 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

913 
obj
.
	`pushKV
("·y“", 
	`EncodeDe¡š©iÚ
(
add»ss1
));

914 
obj
.
	`pushKV
("süt", 
	`HexSŒ
(
txout
.
sütPubKey
));

915 
obj
.
	`pushKV
("amouÁ", 
txout
.
nV®ue
);

916 
ma¡”nodeObj
.
	`push_back
(
obj
);

919 
»suÉ
.
	`pushKV
("ma¡”node", 
ma¡”nodeObj
);

920 
»suÉ
.
	`pushKV
("ma¡”node_·ym’ts_¡¬‹d", 
Œue
);

921 
»suÉ
.
	`pushKV
("ma¡”node_·ym’ts_’fÜûd", 
Œue
);

922 
»suÉ
.
	`pushKV
("ma¡”node_cŞÏ‹¿l_height", 
nCŞÏ‹¿lHeight
);

924 
UniV®ue
 
	`su³rblockObjA¼ay
(UniV®ue::
VARR
);

925 if(
pblock‹m¶©e
->
voutSu³rblockPaym’ts
.
	`size
()) {

926 cÚ¡‡uto& 
txout
 : 
pblock‹m¶©e
->
voutSu³rblockPaym’ts
) {

927 
UniV®ue
 
	`’Œy
(UniV®ue::
VOBJ
);

928 
CTxDe¡š©iÚ
 
add»ss1
;

929 
	`ExŒaùDe¡š©iÚ
(
txout
.
sütPubKey
, 
add»ss1
);

930 
’Œy
.
	`pushKV
("·y“", 
	`EncodeDe¡š©iÚ
(
add»ss1
));

931 
’Œy
.
	`pushKV
("süt", 
	`HexSŒ
(
txout
.
sütPubKey
));

932 
’Œy
.
	`pushKV
("amouÁ", 
txout
.
nV®ue
);

933 
su³rblockObjA¼ay
.
	`push_back
(
’Œy
);

936 
»suÉ
.
	`pushKV
("su³rblock", 
su³rblockObjA¼ay
);

937 
»suÉ
.
	`pushKV
("su³rblocks_¡¬‹d", 
pšdexP»v
->
nHeight
 + 1 > 
cÚ£nsusP¬ams
.
nSu³rblockS¹Block
);

938 
»suÉ
.
	`pushKV
("su³rblocks_’abËd", 
¥ÜkMªag”
.
	`IsSpÜkAùive
(
SPORK_9_SUPERBLOCKS_ENABLED
));

939 ià(!
pblock‹m¶©e
->
vchCošba£Comm™m’tExŒa
.
	`em±y
()) {

940 
»suÉ
.
	`pushKV
("deçuÉ_w™Ãss_comm™m’t_exŒa", 
	`HexSŒ
(
pblock‹m¶©e
->
vchCošba£Comm™m’tExŒa
.
	`begš
(),…block‹m¶©e->vchCošba£Comm™m’tExŒa.
	`’d
()));

942  
»suÉ
;

943 
	}
}

945 şas 
	csubm™block_S‹C©ch”
 
	mfš®
 : 
public
 
CV®id©iÚIÁ”çû


947 
public
:

948 
ušt256
 
hash
;

949 
boŞ
 
	mfound
;

950 
BlockV®id©iÚS‹
 
	m¡©e
;

952 
ex¶ic™
 
	$subm™block_S‹C©ch”
(cÚ¡ 
ušt256
 &
hashIn
è: 
	`hash
(hashIn), 
	`found
(
çl£
), 
	$¡©e
() {}

954 
´Ùeùed
:

955 
	$BlockChecked
(cÚ¡ 
CBlock
& 
block
, cÚ¡ 
BlockV®id©iÚS‹
& 
¡©eIn
è
ov”ride
 {

956 ià(
block
.
	`G‘Hash
(è!ğ
hash
)

958 
found
 = 
Œue
;

959 
¡©e
 = 
¡©eIn
;

960 
	}
}

963 
UniV®ue
 
	$subm™block
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

966 
RPCH–pMª
{"submitblock",

970 {"hexd©a", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hex-encoded block datao submit"},

971 {"dummy", 
RPCArg
::
Ty³
::
STR
, "ignored", "dummy value, for compatibility with BIP22. This value is ignored."},

973 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", "Returns JSON Null when valid,‡ string‡ccordingo BIP22 otherwise"},

974 
RPCExam¶es
{

975 
	`H–pExam¶eCli
("submitblock", "\"mydata\"")

976 + 
	`H–pExam¶eRpc
("submitblock", "\"mydata\"")

978 }.
	`Check
(
»que¡
);

980 
¡d
::
sh¬ed_±r
<
CBlock
> 
block±r
 = std::
make_sh¬ed
<CBlock>();

981 
CBlock
& 
block
 = *
block±r
;

982 ià(!
	`DecodeHexBlk
(
block
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
())) {

983 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Block decode failed");

986 ià(
block
.
vtx
.
	`em±y
(è|| !block.vtx[0]->
	`IsCošBa£
()) {

987 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Block does‚ot start with‡ coinbase");

990 
ušt256
 
hash
 = 
block
.
	`G‘Hash
();

992 
	`LOCK
(
cs_maš
);

993 cÚ¡ 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
hash
);

994 ià(
pšdex
) {

995 ià(
pšdex
->
	`IsV®id
(
BLOCK_VALID_SCRIPTS
)) {

998 ià(
pšdex
->
nStus
 & 
BLOCK_FAILED_MASK
) {

1005 
	`LOCK
(
cs_maš
);

1006 cÚ¡ 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
block
.
hashP»vBlock
);

1007 ià(
pšdex
) {

1008 
	`Upd©eUncomm™‹dBlockSŒuùu»s
(
block
, 
pšdex
, 
	`P¬ams
().
	`G‘CÚ£nsus
());

1012 
boŞ
 
Ãw_block
;

1013 autØ
sc
 = 
¡d
::
make_sh¬ed
<
subm™block_S‹C©ch”
>(
block
.
	`G‘Hash
());

1014 
	`Regi¡”Sh¬edV®id©iÚIÁ”çû
(
sc
);

1015 
boŞ
 
acû±ed
 = 
	`Ensu»Chašmª
(
»que¡
.
cÚ‹xt
).
	`ProûssNewBlock
(
	`P¬ams
(), 
block±r
, 
Œue
, &
Ãw_block
);

1016 
	`UÄegi¡”Sh¬edV®id©iÚIÁ”çû
(
sc
);

1017 ià(!
Ãw_block
 && 
acû±ed
) {

1020 ià(!
sc
->
found
) {

1023  
	`BIP22V®id©iÚResuÉ
(
sc
->
¡©e
);

1024 
	}
}

1026 
UniV®ue
 
	$subm™h—d”
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1028 
RPCH–pMª
{"submitheader",

1032 {"hexd©a", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hex-encoded block header data"},

1034 
RPCResuÉ
{

1035 
RPCResuÉ
::
Ty³
::
NONE
, "", "None"},

1036 
RPCExam¶es
{

1037 
	`H–pExam¶eCli
("submitheader", "\"aabbcc\"") +

1038 
	`H–pExam¶eRpc
("submitheader", "\"aabbcc\"")

1040 }.
	`Check
(
»que¡
);

1042 
CBlockH—d”
 
h
;

1043 ià(!
	`DecodeHexBlockH—d”
(
h
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
())) {

1044 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Block header decode failed");

1047 
	`LOCK
(
cs_maš
);

1048 ià(!
	`LookupBlockIndex
(
h
.
hashP»vBlock
)) {

1049 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, "Mu¡ subm™…»viou h—d” (" + 
h
.
hashP»vBlock
.
	`G‘Hex
() + ") first");

1053 
BlockV®id©iÚS‹
 
¡©e
;

1054 
	`Ensu»Chašmª
(
»que¡
.
cÚ‹xt
).
	`ProûssNewBlockH—d”s
({
h
}, 
¡©e
, 
	`P¬ams
());

1055 ià(
¡©e
.
	`IsV®id
()è 
NuÎUniV®ue
;

1056 ià(
¡©e
.
	`IsE¼Ü
()) {

1057 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, 
¡©e
.
	`ToSŒšg
());

1059 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, 
¡©e
.
	`G‘RejeùR—sÚ
());

1060 
	}
}

1062 
UniV®ue
 
	$e¡im©esm¬tãe
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1064 
RPCH–pMª
{"estimatesmartfee",

1070 {"cÚf_rg‘", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "Confirmationarget in blocks (1 - 1008)"},

1071 {"e¡im©e_mode", 
RPCArg
::
Ty³
::
STR
, "CONSERVATIVE", "The feeƒstimate mode.\n"

1081 
RPCResuÉ
{

1082 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1084 {
RPCResuÉ
::
Ty³
::
NUM
, "ã”©e", 
Œue
, "e¡im©ã¿‹ iÀ" + 
CURRENCY_UNIT
 + "/kB (only…resent if‚oƒrrors wereƒncountered)"},

1085 {
RPCResuÉ
::
Ty³
::
ARR
, "errors", "Errorsƒncountered during…rocessing",

1087 {
RPCResuÉ
::
Ty³
::
STR
, "", "error"},

1089 {
RPCResuÉ
::
Ty³
::
NUM
, "blocks", "block‚umber whereƒstimate was found\n"

1095 
RPCExam¶es
{

1096 
	`H–pExam¶eCli
("estimatesmartfee", "6")

1098 }.
	`Check
(
»que¡
);

1100 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VNUM
, UniV®ue::
VSTR
});

1101 
	`RPCTy³CheckArgum’t
(
»que¡
.
·¿ms
[0], 
UniV®ue
::
VNUM
);

1102 
max_rg‘
 = ::
ãeE¡im©Ü
.
	`Highe¡T¬g‘T¿cked
(
F“E¡im©eHÜizÚ
::
LONG_HALFLIFE
);

1103 
cÚf_rg‘
 = 
	`P¬£CÚfœmT¬g‘
(
»que¡
.
·¿ms
[0], 
max_rg‘
);

1104 
boŞ
 
cÚ£rv©ive
 = 
Œue
;

1105 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

1106 
F“E¡im©eMode
 
ãe_mode
;

1107 ià(!
	`F“ModeFromSŒšg
(
»que¡
.
·¿ms
[1].
	`g‘_¡r
(), 
ãe_mode
)) {

1108 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalidƒstimate_mode…arameter");

1110 ià(
ãe_mode
 =ğ
F“E¡im©eMode
::
ECONOMICAL
è
cÚ£rv©ive
 = 
çl£
;

1113 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

1114 
UniV®ue
 
	`”rÜs
(UniV®ue::
VARR
);

1115 
F“C®cuÏtiÚ
 
ãeC®c
;

1116 
CF“R©e
 
ãeR©e
 = ::
ãeE¡im©Ü
.
	`e¡im©eSm¬tF“
(
cÚf_rg‘
, &
ãeC®c
, 
cÚ£rv©ive
);

1117 ià(
ãeR©e
 !ğ
	`CF“R©e
(0)) {

1118 
»suÉ
.
	`pushKV
("ã”©e", 
	`V®ueFromAmouÁ
(
ãeR©e
.
	`G‘F“P”K
()));

1120 
”rÜs
.
	`push_back
("Insufficient data or‚o feerate found");

1121 
»suÉ
.
	`pushKV
("”rÜs", 
”rÜs
);

1123 
»suÉ
.
	`pushKV
("blocks", 
ãeC®c
.
»tuºedT¬g‘
);

1124  
»suÉ
;

1125 
	}
}

1127 
UniV®ue
 
	$e¡im©”awãe
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1129 
RPCH–pMª
{"estimaterawfee",

1138 {"cÚf_rg‘", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "Confirmationarget in blocks (1 - 1008)"},

1139 {"th»shŞd", 
RPCArg
::
Ty³
::
NUM
, "0.95", "The…roportion ofransactions in‡ given feerate„angehat must have been\n"

1143 
RPCResuÉ
{

1144 
RPCResuÉ
::
Ty³
::
OBJ
, "", "Results‡re„eturned for‡ny horizon whichracks blocks upohe confirmationarget",

1146 {
RPCResuÉ
::
Ty³
::
OBJ
, "shÜt", 
Œue
, "estimate for shortime horizon",

1148 {
RPCResuÉ
::
Ty³
::
NUM
, "ã”©e", 
Œue
, "e¡im©ã¿‹ iÀ" + 
CURRENCY_UNIT
 + "/kB"},

1149 {
RPCResuÉ
::
Ty³
::
NUM
, "decay", "exponential decay (per block) for historical moving‡verage of confirmation data"},

1150 {
RPCResuÉ
::
Ty³
::
NUM
, "scale", "The„esolution of confirmationargets‡thisime horizon"},

1151 {
RPCResuÉ
::
Ty³
::
OBJ
, "·ss", 
Œue
, "information‡bouthe†owest„ange of feerateso succeed in meetinghehreshold",

1153 {
RPCResuÉ
::
Ty³
::
NUM
, "startrange", "start of feerate„ange"},

1154 {
RPCResuÉ
::
Ty³
::
NUM
, "endrange", "end of feerate„ange"},

1155 {
RPCResuÉ
::
Ty³
::
NUM
, "withintarget", "number ofxs over history horizon inhe feerate„angehat were confirmed withinarget"},

1156 {
RPCResuÉ
::
Ty³
::
NUM
, "totalconfirmed", "number ofxs over history horizon inhe feerate„angehat were confirmed‡t‡ny…oint"},

1157 {
RPCResuÉ
::
Ty³
::
NUM
, "inmempool", "current‚umber ofxs in mempool inhe feerate„ange unconfirmed for‡t†eastarget blocks"},

1158 {
RPCResuÉ
::
Ty³
::
NUM
, "leftmempool", "number ofxs over history horizon inhe feerate„angehat†eft mempool unconfirmed‡fterarget"},

1160 {
RPCResuÉ
::
Ty³
::
OBJ
, "ç", 
Œue
, "information‡bouthe highest„ange of feerateso failo meethehreshold",

1162 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

1164 {
RPCResuÉ
::
Ty³
::
ARR
, "”rÜs", 
Œue
, "Errorsƒncountered during…rocessing",

1166 {
RPCResuÉ
::
Ty³
::
STR
, "error", ""},

1169 {
RPCResuÉ
::
Ty³
::
OBJ
, "medium", 
Œue
, "estimate for mediumime horizon",

1171 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

1173 {
RPCResuÉ
::
Ty³
::
OBJ
, "lÚg", 
Œue
, "estimate for†ongime horizon",

1175 {
RPCResuÉ
::
Ty³
::
ELISION
, "", ""},

1178 
RPCExam¶es
{

1179 
	`H–pExam¶eCli
("estimaterawfee", "6 0.9")

1181 }.
	`Check
(
»que¡
);

1183 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VNUM
, UniV®ue::VNUM}, 
Œue
);

1184 
	`RPCTy³CheckArgum’t
(
»que¡
.
·¿ms
[0], 
UniV®ue
::
VNUM
);

1185 
max_rg‘
 = ::
ãeE¡im©Ü
.
	`Highe¡T¬g‘T¿cked
(
F“E¡im©eHÜizÚ
::
LONG_HALFLIFE
);

1186 
cÚf_rg‘
 = 
	`P¬£CÚfœmT¬g‘
(
»que¡
.
·¿ms
[0], 
max_rg‘
);

1187 
th»shŞd
 = 0.95;

1188 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

1189 
th»shŞd
 = 
»que¡
.
·¿ms
[1].
	`g‘_»®
();

1191 ià(
th»shŞd
 < 0 ||hreshold > 1) {

1192 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalidhreshold");

1195 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

1197 cÚ¡ 
F“E¡im©eHÜizÚ
 
hÜizÚ
 : {F“E¡im©eHÜizÚ::
SHORT_HALFLIFE
, F“E¡im©eHÜizÚ::
MED_HALFLIFE
, F“E¡im©eHÜizÚ::
LONG_HALFLIFE
}) {

1198 
CF“R©e
 
ãeR©e
;

1199 
E¡im©iÚResuÉ
 
buck‘s
;

1202 ià(
cÚf_rg‘
 > ::
ãeE¡im©Ü
.
	`Highe¡T¬g‘T¿cked
(
hÜizÚ
)) ;

1204 
ãeR©e
 = ::
ãeE¡im©Ü
.
	`e¡im©eRawF“
(
cÚf_rg‘
, 
th»shŞd
, 
hÜizÚ
, &
buck‘s
);

1205 
UniV®ue
 
	`hÜizÚ_»suÉ
(UniV®ue::
VOBJ
);

1206 
UniV®ue
 
	`”rÜs
(UniV®ue::
VARR
);

1207 
UniV®ue
 
	`·ssbuck‘
(UniV®ue::
VOBJ
);

1208 
·ssbuck‘
.
	`pushKV
("¡¬Œªge", 
	`round
(
buck‘s
.
·ss
.
¡¬t
));

1209 
·ssbuck‘
.
	`pushKV
("’d¿nge", 
	`round
(
buck‘s
.
·ss
.
’d
));

1210 
·ssbuck‘
.
	`pushKV
("w™hšrg‘", 
	`round
(
buck‘s
.
·ss
.
w™hšT¬g‘
 * 100.0) / 100.0);

1211 
·ssbuck‘
.
	`pushKV
("tÙ®cÚfœmed", 
	`round
(
buck‘s
.
·ss
.
tÙ®CÚfœmed
 * 100.0) / 100.0);

1212 
·ssbuck‘
.
	`pushKV
("šmempoŞ", 
	`round
(
buck‘s
.
·ss
.
šMempoŞ
 * 100.0) / 100.0);

1213 
·ssbuck‘
.
	`pushKV
("ËámempoŞ", 
	`round
(
buck‘s
.
·ss
.
ËáMempoŞ
 * 100.0) / 100.0);

1214 
UniV®ue
 
	`çbuck‘
(UniV®ue::
VOBJ
);

1215 
çbuck‘
.
	`pushKV
("¡¬Œªge", 
	`round
(
buck‘s
.
ç
.
¡¬t
));

1216 
çbuck‘
.
	`pushKV
("’d¿nge", 
	`round
(
buck‘s
.
ç
.
’d
));

1217 
çbuck‘
.
	`pushKV
("w™hšrg‘", 
	`round
(
buck‘s
.
ç
.
w™hšT¬g‘
 * 100.0) / 100.0);

1218 
çbuck‘
.
	`pushKV
("tÙ®cÚfœmed", 
	`round
(
buck‘s
.
ç
.
tÙ®CÚfœmed
 * 100.0) / 100.0);

1219 
çbuck‘
.
	`pushKV
("šmempoŞ", 
	`round
(
buck‘s
.
ç
.
šMempoŞ
 * 100.0) / 100.0);

1220 
çbuck‘
.
	`pushKV
("ËámempoŞ", 
	`round
(
buck‘s
.
ç
.
ËáMempoŞ
 * 100.0) / 100.0);

1223 ià(
ãeR©e
 !ğ
	`CF“R©e
(0)) {

1224 
hÜizÚ_»suÉ
.
	`pushKV
("ã”©e", 
	`V®ueFromAmouÁ
(
ãeR©e
.
	`G‘F“P”K
()));

1225 
hÜizÚ_»suÉ
.
	`pushKV
("deÿy", 
buck‘s
.
deÿy
);

1226 
hÜizÚ_»suÉ
.
	`pushKV
("sÿË", ()
buck‘s
.
sÿË
);

1227 
hÜizÚ_»suÉ
.
	`pushKV
("·ss", 
·ssbuck‘
);

1229 ià(
buck‘s
.
ç
.
¡¬t
 !ğ-1è
hÜizÚ_»suÉ
.
	`pushKV
("ç", 
çbuck‘
);

1232 
hÜizÚ_»suÉ
.
	`pushKV
("deÿy", 
buck‘s
.
deÿy
);

1233 
hÜizÚ_»suÉ
.
	`pushKV
("sÿË", ()
buck‘s
.
sÿË
);

1234 
hÜizÚ_»suÉ
.
	`pushKV
("ç", 
çbuck‘
);

1235 
”rÜs
.
	`push_back
("Insufficient data or‚o feerate found which meetshreshold");

1236 
hÜizÚ_»suÉ
.
	`pushKV
("”rÜs",
”rÜs
);

1238 
»suÉ
.
	`pushKV
(
	`SŒšgFÜF“E¡im©eHÜizÚ
(
hÜizÚ
), 
hÜizÚ_»suÉ
);

1240  
»suÉ
;

1241 
	}
}

1246 
UniV®ue
 
	$ü—‹auxblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1248 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 1)

1249 
throw
 
¡d
::
	`ruÁime_”rÜ
(

1250 
RPCH–pMª
{"createauxblock",

1254 {"add»ss", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "Payout‡ddress forhe coinbaseransaction"},

1256 
RPCResuÉ
{

1257 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1259 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "hash ofhe created block"},

1260 {
RPCResuÉ
::
Ty³
::
NUM
, "chainid", "chain ID forhis block"},

1261 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "previousblockhash", "hash ofhe…revious block"},

1262 {
RPCResuÉ
::
Ty³
::
NUM
, "coinbasevalue", "value ofhe block's coinbase"},

1263 {
RPCResuÉ
::
Ty³
::
STR
, "bits", "compressedarget ofhe block"},

1264 {
RPCResuÉ
::
Ty³
::
NUM
, "height", "height ofhe block"},

1265 {
RPCResuÉ
::
Ty³
::
STR
, "chain", "current‚etwork‚ame (main,est,„egtest)"},

1266 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "_target", "target in„eversed byte order, deprecated"},

1268 
RPCExam¶es
{

1269 
	`H–pExam¶eCli
("createauxblock", "\"address\"")

1270 + 
	`H–pExam¶eRpc
("createauxblock", "\"address\"")

1272 }.
	`ToSŒšg
());

1274 cÚ¡ 
CTxDe¡š©iÚ
 
cošba£Süt


1275 ğ
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
());

1276 ià(!
	`IsV®idDe¡š©iÚ
(
cošba£Süt
)) {

1277 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
,

1280 cÚ¡ 
CSüt
 
sütPubKey
 = 
	`G‘SütFÜDe¡š©iÚ
(
cošba£Süt
);

1282  
AuxpowMš”
::
	`g‘
 ().
	`ü—‹AuxBlock
(
sütPubKey
, 
»que¡
.
cÚ‹xt
);

1283 
	}
}

1285 
UniV®ue
 
	$subm™auxblock
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1287 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2)

1288 
throw
 
¡d
::
	`ruÁime_”rÜ
(

1289 
RPCH–pMª
{"submitauxblock",

1293 {"hash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Hash ofhe blocko submit"},

1294 {"auxpow", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Serialised‡uxpow found"},

1296 
RPCResuÉ
{

1297 
RPCResuÉ
::
Ty³
::
BOOL
, "xxxxx", "whetherhe submitted block was correct"},

1298 
RPCExam¶es
{

1299 
	`H–pExam¶eCli
("submitauxblock", "\"hash\" \"serialised‡uxpow\"")

1300 + 
	`H–pExam¶eRpc
("submitauxblock", "\"hash\" \"serialised‡uxpow\"")

1302 }.
	`ToSŒšg
());

1303  
AuxpowMš”
::
	`g‘
 ().
	`subm™AuxBlock
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(),

1304 
»que¡
.
·¿ms
[1].
	`g‘_¡r
(),„eque¡.
cÚ‹xt
);

1305 
	}
}

1309 
	$Regi¡”MššgRPCCommªds
(
CRPCTabË
 &
t
)

1312 cÚ¡ 
CRPCCommªd
 
commªds
[] =

1315 { "mššg", "g‘ÃtwÜkhashps", &
g‘ÃtwÜkhashps
, {"nblocks","height"} },

1316 { "mššg", "g‘mššgšfo", &
g‘mššgšfo
, {} },

1317 { "mššg", "´iÜ™i£Œª§ùiÚ", &
´iÜ™i£Œª§ùiÚ
, {"txid","dummy","fee_delta"} },

1318 { "mššg", "g‘block‹m¶©e", &
g‘block‹m¶©e
, {"template_request"} },

1319 { "mššg", "subm™block", &
subm™block
, {"hexdata","dummy"} },

1320 { "mššg", "subm™h—d”", &
subm™h—d”
, {"hexdata"} },

1322 { "mššg", "ü—‹auxblock", &
ü—‹auxblock
, {"address"} },

1323 { "mššg", "subm™auxblock", &
subm™auxblock
, {"hash", "auxpow"} },

1325 { "g’”©šg", "g’”©‘ßdd»ss", &
g’”©‘ßdd»ss
, {"nblocks","address","maxtries"} },

1326 { "g’”©šg", "g’”©‘odesütÜ", &
g’”©‘odesütÜ
, {"num_blocks","descriptor","maxtries"} },

1327 { "g’”©šg", "g’”©eblock", &
g’”©eblock
, {"output","transactions"} },

1329 { "ut", "e¡im©esm¬tãe", &
e¡im©esm¬tãe
, {"conf_target", "estimate_mode"} },

1331 { "hidd’", "e¡im©”awãe", &
e¡im©”awãe
, {"conf_target", "threshold"} },

1335 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

1336 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

1337 
	}
}

	@misc.cpp

6 
	~<h‰p£rv”.h
>

7 
	~<š‹rçûs/chaš.h
>

8 
	~<key_io.h
>

9 
	~<node/cÚ‹xt.h
>

10 
	~<ouu‰y³.h
>

11 
	~<½c/blockchaš.h
>

12 
	~<½c/£rv”.h
>

13 
	~<½c/ut.h
>

14 
	~<scheduËr.h
>

15 
	~<süt/desütÜ.h
>

16 
	~<ut/check.h
>

17 
	~<ut/mes§ge.h
>

18 
	~<ut/»f.h
>

19 
	~<ut/¡»ncodšgs.h
>

20 
	~<ut/sy¡em.h
>

22 
	~<¡dšt.h
>

23 
	~<tu¶e
>

24 #ifdeà
HAVE_MALLOC_INFO


25 
	~<m®loc.h
>

28 
	~<univ®ue.h
>

30 
	~<ma¡”node/ma¡”node-sync.h
>

31 
	~<¥Ük.h
>

32 
UniV®ue
 
mnsync
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
);

33 
UniV®ue
 
¥Ük
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
);

34 
UniV®ue
 
	$mnsync
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

36 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 1)

37 
throw
 
¡d
::
	`ruÁime_”rÜ
(

38 
RPCH–pMª
{"mnsync",

41 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The commando issue (status|next|reset)"}

43 
RPCResuÉ
{

44 
RPCResuÉ
::
Ty³
::
STR
, "result", "Result"},

45 
RPCExam¶es
{

46 
	`H–pExam¶eCli
("mnsync", "status")

47 + 
	`H–pExam¶eRpc
("mnsync", "status")

49 }.
	`ToSŒšg
());

51 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

52 
¡d
::
¡ršg
 
¡rMode
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

54 if(
¡rMode
 == "status") {

55 
UniV®ue
 
	`objStus
(UniV®ue::
VOBJ
);

56 
objStus
.
	`pushKV
("As£tID", 
ma¡”nodeSync
.
	`G‘As£tID
());

57 
objStus
.
	`pushKV
("As£tName", 
ma¡”nodeSync
.
	`G‘As£tName
());

58 
objStus
.
	`pushKV
("As£tS¹Time", 
ma¡”nodeSync
.
	`G‘As£tS¹Time
());

59 
objStus
.
	`pushKV
("A‰em±", 
ma¡”nodeSync
.
	`G‘A‰em±
());

60 
objStus
.
	`pushKV
("IsBlockchašSynûd", 
ma¡”nodeSync
.
	`IsBlockchašSynûd
());

61 
objStus
.
	`pushKV
("IsSynûd", 
ma¡”nodeSync
.
	`IsSynûd
());

62 
objStus
.
	`pushKV
("IsFaed", 
ma¡”nodeSync
.
	`IsFaed
());

63  
objStus
;

66 if(
¡rMode
 == "next")

68 ià(!
node
.
cÚnmª
)

69 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

71 
ma¡”nodeSync
.
	`Sw™chToNextAs£t
(*
node
.
cÚnmª
);

72  "synøupd©edØ" + 
ma¡”nodeSync
.
	`G‘As£tName
();

75 if(
¡rMode
 == "reset")

77 ià(!
node
.
cÚnmª
)

78 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

80 
ma¡”nodeSync
.
	`Re£t
();

81 
ma¡”nodeSync
.
	`Sw™chToNextAs£t
(*
node
.
cÚnmª
);

85 
	}
}

90 
UniV®ue
 
	$¥Ük
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

92 ià(
»que¡
.
·¿ms
.
	`size
() == 1) {

94 
¡d
:: 
¡ršg
 
¡rCommªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

95 ià(
¡rCommªd
 == "show") {

96 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

97 cÚ¡‡uto& 
¥ÜkDef
 : 
¥ÜkDefs
) {

98 
»t
.
	`pushKV
(
¥ÜkDef
.
Çme
, 
¥ÜkMªag”
.
	`G‘SpÜkV®ue
(¥ÜkDef.
¥ÜkId
));

100  
»t
;

101 } if(
¡rCommªd
 == "active"){

102 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

103 cÚ¡‡uto& 
¥ÜkDef
 : 
¥ÜkDefs
) {

104 
»t
.
	`pushKV
(
¥ÜkDef
.
Çme
, 
¥ÜkMªag”
.
	`IsSpÜkAùive
(¥ÜkDef.
¥ÜkId
));

106  
»t
;

109 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

110 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2) {

112 
throw
 
¡d
::
	`ruÁime_”rÜ
(

113 
RPCH–pMª
{"spork",

116 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "\"show\"o show‡ll current spork values, \"active\"o show which sporks‡re‡ctive"}

119 
RPCResuÉ
{"for command = \"show\"",

120 
RPCResuÉ
::
Ty³
::
NUM
, "SPORK_NAME", "The value ofhe specific spork withhe‚ame SPORK_NAME"},

121 
RPCResuÉ
{"for command = \"active\"",

122 
RPCResuÉ
::
Ty³
::
BOOL
, "SPORK_NAME", "'true' forime-based sporks if spork is‡ctive‡nd 'false' otherwise"},

124 
RPCExam¶es
{

125 
	`H–pExam¶eCli
("spork", "show")

126 + 
	`H–pExam¶eRpc
("spork", "\"show\"")

128 }.
	`ToSŒšg
());

131 
nSpÜkID
 = 
¥ÜkMªag”
.
	`G‘SpÜkIDByName
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
());

132 if(
nSpÜkID
 =ğ
SPORK_INVALID
)

133 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid spork‚ame");

135 ià(!
node
.
cÚnmª
)

136 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

139 
št64_t
 
nV®ue
 = 
»que¡
.
·¿ms
[1].
	`g‘_št64
();

142 if(
¥ÜkMªag”
.
	`Upd©eSpÜk
(
nSpÜkID
, 
nV®ue
, *
node
.
cÚnmª
)){

145 
throw
 
¡d
::
	`ruÁime_”rÜ
(

146 
RPCH–pMª
{"spork",

149 {"Çme", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The‚ame ofhe sporko update"},

150 {"v®ue", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The‚ew desired value ofhe spork"}

152 
RPCResuÉ
{

153 
RPCResuÉ
::
Ty³
::
STR
, "result", "\"success\" if spork value was updated orhis help otherwise"},

154 
RPCExam¶es
{

155 
	`H–pExam¶eCli
("spork", "SPORK_6_NEW_SIGS 4070908800")

156 + 
	`H–pExam¶eRpc
("spork", "\"SPORK_6_NEW_SIGS\", 4070908800")

158 }.
	`ToSŒšg
());

162 
	}
}

163 
UniV®ue
 
	$v®id©—dd»ss
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

165 
RPCH–pMª
{"validateaddress",

168 {"add»ss", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The syscoin‡ddresso validate"},

170 
RPCResuÉ
{

171 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

173 {
RPCResuÉ
::
Ty³
::
BOOL
, "isvalid", "Ifhe‡ddress is valid or‚ot. If‚ot,his ishe only…roperty„eturned."},

174 {
RPCResuÉ
::
Ty³
::
STR
, "address", "The syscoin‡ddress validated"},

175 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "scriptPubKey", "The hex-encoded scriptPubKey generated byhe‡ddress"},

176 {
RPCResuÉ
::
Ty³
::
BOOL
, "isscript", "Ifhe key is‡ script"},

177 {
RPCResuÉ
::
Ty³
::
BOOL
, "iswitness", "Ifhe‡ddress is‡ witness‡ddress"},

178 {
RPCResuÉ
::
Ty³
::
NUM
, "w™Ãss_v”siÚ", 
Œue
, "The version‚umber ofhe witness…rogram"},

179 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "w™Ãss_´og¿m", 
Œue
, "The hex value ofhe witness…rogram"},

182 
RPCExam¶es
{

183 
	`H–pExam¶eCli
("v®id©—dd»ss", "\"" + 
EXAMPLE_ADDRESS
[0] + "\"") +

184 
	`H–pExam¶eRpc
("v®id©—dd»ss", "\"" + 
EXAMPLE_ADDRESS
[0] + "\"")

186 }.
	`Check
(
»que¡
);

188 
CTxDe¡š©iÚ
 
de¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
());

189 
boŞ
 
isV®id
 = 
	`IsV®idDe¡š©iÚ
(
de¡
);

191 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

192 
»t
.
	`pushKV
("isv®id", 
isV®id
);

193 ià(
isV®id
)

195 
¡d
::
¡ršg
 
cu¼’tAdd»ss
 = 
	`EncodeDe¡š©iÚ
(
de¡
);

196 
»t
.
	`pushKV
("add»ss", 
cu¼’tAdd»ss
);

198 
CSüt
 
sütPubKey
 = 
	`G‘SütFÜDe¡š©iÚ
(
de¡
);

199 
»t
.
	`pushKV
("sütPubKey", 
	`HexSŒ
(
sütPubKey
.
	`begš
(), sütPubKey.
	`’d
()));

201 
UniV®ue
 
d‘a
 = 
	`DesüibeAdd»ss
(
de¡
);

202 
»t
.
	`pushKVs
(
d‘a
);

204  
»t
;

205 
	}
}

207 
UniV®ue
 
	$ü—‹muÉisig
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

209 
RPCH–pMª
{"createmultisig",

213 {"Äequœed", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The‚umber of„equired signatures out ofhe‚ keys."},

214 {"keys", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The hex-encoded…ublic keys.",

216 {"key", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "The hex-encoded…ublic key"},

218 {"add»ss_ty³", 
RPCArg
::
Ty³
::
STR
, "bech32", "The‡ddressypeo use. Options‡re \"legacy\", \"p2sh-segwit\",‡nd \"bech32\"."},

220 
RPCResuÉ
{

221 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

223 {
RPCResuÉ
::
Ty³
::
STR
, "address", "The value ofhe‚ew multisig‡ddress."},

224 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "redeemScript", "The string value ofhe hex-encoded„edemption script."},

225 {
RPCResuÉ
::
Ty³
::
STR
, "descriptor", "The descriptor forhis multisig"},

228 
RPCExam¶es
{

230 + 
	`H–pExam¶eCli
("createmultisig", "2 \"[\\\"03789ed0bb717d88f7d321a368d905e7430207ebbd82bd342cf11ae157a7ace5fd\\\",\\\"03dbc6764b8884a92e871274b87583e6d5c2a58819473e17e107ef3f6aa5a61626\\\"]\"") +

232 + 
	`H–pExam¶eRpc
("createmultisig", "2, \"[\\\"03789ed0bb717d88f7d321a368d905e7430207ebbd82bd342cf11ae157a7ace5fd\\\",\\\"03dbc6764b8884a92e871274b87583e6d5c2a58819473e17e107ef3f6aa5a61626\\\"]\"")

234 }.
	`Check
(
»que¡
);

236 
»quœed
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

239 cÚ¡ 
UniV®ue
& 
keys
 = 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
();

240 
¡d
::
veùÜ
<
CPubKey
> 
pubkeys
;

241 
i
 = 0; i < 
keys
.
	`size
(); ++i) {

242 ià(
	`IsHex
(
keys
[
i
].
	`g‘_¡r
()è&& (keys[i].g‘_¡r().
	`Ëngth
() == 66 || keys[i].get_str().length() == 130)) {

243 
pubkeys
.
	`push_back
(
	`HexToPubKey
(
keys
[
i
].
	`g‘_¡r
()));

245 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("Inv®id…ubliøkey: %s\n.", 
keys
[
i
].
	`g‘_¡r
()));

250 
OuutTy³
 
ouut_ty³
 = OuutTy³::
BECH32
;

251 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

252 ià(!
	`P¬£OuutTy³
(
»que¡
.
·¿ms
[2].
	`g‘_¡r
(), 
ouut_ty³
)) {

253 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("UnknowÀadd»s ty³ '%s'", 
»que¡
.
·¿ms
[2].
	`g‘_¡r
()));

258 
FÏbËSignšgProvid”
 
key¡Üe
;

259 
CSüt
 
šÃr
;

260 cÚ¡ 
CTxDe¡š©iÚ
 
de¡
 = 
	`AddAndG‘MuÉisigDe¡š©iÚ
(
»quœed
, 
pubkeys
, 
ouut_ty³
, 
key¡Üe
, 
šÃr
);

263 
¡d
::
unique_±r
<
DesütÜ
> 
desütÜ
 = 
	`InãrDesütÜ
(
	`G‘SütFÜDe¡š©iÚ
(
de¡
), 
key¡Üe
);

265 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

266 
»suÉ
.
	`pushKV
("add»ss", 
	`EncodeDe¡š©iÚ
(
de¡
));

267 
»suÉ
.
	`pushKV
("»d“mSüt", 
	`HexSŒ
(
šÃr
.
	`begš
(), iÂ”.
	`’d
()));

268 
»suÉ
.
	`pushKV
("desütÜ", 
desütÜ
->
	`ToSŒšg
());

270  
»suÉ
;

271 
	}
}

273 
UniV®ue
 
	$g‘desütÜšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

275 
RPCH–pMª
{"getdescriptorinfo",

278 {"desütÜ", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The descriptor."},

280 
RPCResuÉ
{

281 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

283 {
RPCResuÉ
::
Ty³
::
STR
, "descriptor", "The descriptor in canonical form, without…rivate keys"},

284 {
RPCResuÉ
::
Ty³
::
STR
, "checksum", "The checksum forhe input descriptor"},

285 {
RPCResuÉ
::
Ty³
::
BOOL
, "isrange", "Whetherhe descriptor is„anged"},

286 {
RPCResuÉ
::
Ty³
::
BOOL
, "issolvable", "Whetherhe descriptor is solvable"},

287 {
RPCResuÉ
::
Ty³
::
BOOL
, "hasprivatekeys", "Whetherhe input descriptor contained‡t†east one…rivate key"},

290 
RPCExam¶es
{

292 
	`H–pExam¶eCli
("getdescriptorinfo", "\"wpkh([d34db33f/84h/0h/0h]0279be667ef9dcbbac55a06295Ce870b07029Bfcdb2dce28d959f2815b16f81798)\"")

293 }}.
	`Check
(
»que¡
);

295 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
});

297 
FÏtSignšgProvid”
 
´ovid”
;

298 
¡d
::
¡ršg
 
”rÜ
;

299 autØ
desc
 = 
	`P¬£
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
´ovid”
, 
”rÜ
);

300 ià(!
desc
) {

301 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
”rÜ
);

304 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

305 
»suÉ
.
	`pushKV
("desütÜ", 
desc
->
	`ToSŒšg
());

306 
»suÉ
.
	`pushKV
("checksum", 
	`G‘DesütÜChecksum
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
()));

307 
»suÉ
.
	`pushKV
("i¤ªge", 
desc
->
	`IsRªge
());

308 
»suÉ
.
	`pushKV
("issŞvabË", 
desc
->
	`IsSŞvabË
());

309 
»suÉ
.
	`pushKV
("ha¥riv©ekeys", 
´ovid”
.
keys
.
	`size
() > 0);

310  
»suÉ
;

311 
	}
}

313 
UniV®ue
 
	$d”iv—dd»s£s
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

315 
RPCH–pMª
{"deriveaddresses",

326 {"desütÜ", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The descriptor."},

327 {"¿nge", 
RPCArg
::
Ty³
::
RANGE
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "If‡„anged descriptor is used,his specifiesheƒnd orhe„ange (in [begin,end]‚otation)o derive."},

329 
RPCResuÉ
{

330 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

332 {
RPCResuÉ
::
Ty³
::
STR
, "address", "the derived‡ddresses"},

335 
RPCExam¶es
{

337 
	`H–pExam¶eCli
("deriveaddresses", "\"wpkh([d34db33f/84h/0h/0h]xpub6DJ2dNUysrn5Vt36jH2KLBT2i1auw1tTSSomg8PhqNiUtx8QX2SvC9nrHu81fT41fvDUnhMjEzQgXnQjKEu3oaqMSzhSrHMxyyoEAmUHQbY/0/*)#cjjspncu\" \"[0,2]\"")

338 }}.
	`Check
(
»que¡
);

340 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, 
	`UniV®ueTy³
()});

341 cÚ¡ 
¡d
::
¡ršg
 
desc_¡r
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

343 
št64_t
 
¿nge_begš
 = 0;

344 
št64_t
 
¿nge_’d
 = 0;

346 ià(
»que¡
.
·¿ms
.
	`size
(è>ğ2 && !»que¡.·¿ms[1].
	`isNuÎ
()) {

347 
¡d
::
	`t›
(
¿nge_begš
, 
¿nge_’d
èğ
	`P¬£DesütÜRªge
(
»que¡
.
·¿ms
[1]);

350 
FÏtSignšgProvid”
 
key_´ovid”
;

351 
¡d
::
¡ršg
 
”rÜ
;

352 autØ
desc
 = 
	`P¬£
(
desc_¡r
, 
key_´ovid”
, 
”rÜ
, 
Œue
);

353 ià(!
desc
) {

354 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
”rÜ
);

357 ià(!
desc
->
	`IsRªge
(è&& 
»que¡
.
·¿ms
.
	`size
() > 1) {

358 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range should‚ot be specified for‡n un-ranged descriptor");

361 ià(
desc
->
	`IsRªge
(è&& 
»que¡
.
·¿ms
.
	`size
() == 1) {

362 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range must be specified for‡„anged descriptor");

365 
UniV®ue
 
	`add»s£s
(UniV®ue::
VARR
);

367 
i
 = 
¿nge_begš
; i <ğ
¿nge_’d
; ++i) {

368 
FÏtSignšgProvid”
 
´ovid”
;

369 
¡d
::
veùÜ
<
CSüt
> 
süts
;

370 ià(!
desc
->
	`Ex·nd
(
i
, 
key_´ovid”
, 
süts
, 
´ovid”
)) {

371 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("Cannot derive script without…rivate keys"));

374 cÚ¡ 
CSüt
 &
süt
 : 
süts
) {

375 
CTxDe¡š©iÚ
 
de¡
;

376 ià(!
	`ExŒaùDe¡š©iÚ
(
süt
, 
de¡
)) {

377 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("Descriptor does‚ot have‡ corresponding‡ddress"));

380 
add»s£s
.
	`push_back
(
	`EncodeDe¡š©iÚ
(
de¡
));

385 ià(
add»s£s
.
	`em±y
()) {

386 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Unexpectedƒmpty„esult");

389  
add»s£s
;

390 
	}
}

392 
UniV®ue
 
	$v”ifymes§ge
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

394 
RPCH–pMª
{"verifymessage",

397 {"add»ss", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The syscoin‡ddresso use forhe signature."},

398 {"sigÇtu»", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The signature…rovided byhe signer in base 64ƒncoding (see signmessage)."},

399 {"mes§ge", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The messagehat was signed."},

401 
RPCResuÉ
{

402 
RPCResuÉ
::
Ty³
::
BOOL
, "", "Ifhe signature is verified or‚ot."

404 
RPCExam¶es
{

406 + 
	`H–pExam¶eCli
("walletpassphrase", "\"mypassphrase\" 30") +

408 + 
	`H–pExam¶eCli
("signmessage", "\"1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\" \"my message\"") +

410 + 
	`H–pExam¶eCli
("verifymessage", "\"1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\" \"signature\" \"my message\"") +

412 + 
	`H–pExam¶eRpc
("verifymessage", "\"1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\", \"signature\", \"my message\"")

414 }.
	`Check
(
»que¡
);

416 
	`LOCK
(
cs_maš
);

418 
¡d
::
¡ršg
 
¡rAdd»ss
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

419 
¡d
::
¡ršg
 
¡rSign
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

420 
¡d
::
¡ršg
 
¡rMes§ge
 = 
»que¡
.
·¿ms
[2].
	`g‘_¡r
();

422 
	`Mes§geV”ify
(
¡rAdd»ss
, 
¡rSign
, 
¡rMes§ge
)) {

423 
Mes§geV”ifiÿtiÚResuÉ
::
ERR_INVALID_ADDRESS
:

424 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Invalid‡ddress");

425 
Mes§geV”ifiÿtiÚResuÉ
::
ERR_ADDRESS_NO_KEY
:

426 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Address does‚ot„efero key");

427 
Mes§geV”ifiÿtiÚResuÉ
::
ERR_MALFORMED_SIGNATURE
:

428 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Malformed base64ƒncoding");

429 
Mes§geV”ifiÿtiÚResuÉ
::
ERR_PUBKEY_NOT_RECOVERED
:

430 
Mes§geV”ifiÿtiÚResuÉ
::
ERR_NOT_SIGNED
:

431  
çl£
;

432 
Mes§geV”ifiÿtiÚResuÉ
::
OK
:

433  
Œue
;

436  
çl£
;

437 
	}
}

439 
UniV®ue
 
	$signmes§gew™h´ivkey
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

441 
RPCH–pMª
{"signmessagewithprivkey",

444 {"´ivkey", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The…rivate keyo signhe message with."},

445 {"mes§ge", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The messageo create‡ signature of."},

447 
RPCResuÉ
{

448 
RPCResuÉ
::
Ty³
::
STR
, "signature", "The signature ofhe messageƒncoded in base 64"

450 
RPCExam¶es
{

452 + 
	`H–pExam¶eCli
("signmessagewithprivkey", "\"privkey\" \"my message\"") +

454 + 
	`H–pExam¶eCli
("verifymessage", "\"1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\" \"signature\" \"my message\"") +

456 + 
	`H–pExam¶eRpc
("signmessagewithprivkey", "\"privkey\", \"my message\"")

458 }.
	`Check
(
»que¡
);

460 
¡d
::
¡ršg
 
¡rPrivkey
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

461 
¡d
::
¡ršg
 
¡rMes§ge
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

463 
CKey
 
key
 = 
	`DecodeSeü‘
(
¡rPrivkey
);

464 ià(!
key
.
	`IsV®id
()) {

465 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Invalid…rivate key");

468 
¡d
::
¡ršg
 
sigÇtu»
;

470 ià(!
	`Mes§geSign
(
key
, 
¡rMes§ge
, 
sigÇtu»
)) {

471 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Sign failed");

474  
sigÇtu»
;

475 
	}
}

477 
UniV®ue
 
	$£tmocktime
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

479 
RPCH–pMª
{"setmocktime",

482 {"time¡amp", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, 
UNIX_EPOCH_TIME
 + "\n"

485 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

486 
RPCExam¶es
{""},

487 }.
	`Check
(
»que¡
);

489 ià(!
	`P¬ams
().
	`IsMockabËChaš
()) {

490 
throw
 
¡d
::
	`ruÁime_”rÜ
("setmocktime is for„egressionesting (-regtest mode) only");

498 
	`LOCK
(
cs_maš
);

500 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VNUM
});

501 
št64_t
 
time
 = 
»que¡
.
·¿ms
[0].
	`g‘_št64
();

502 
	`S‘MockTime
(
time
);

503 ià(
»que¡
.
cÚ‹xt
.
Has
<
NodeCÚ‹xt
>()) {

504 cÚ¡‡uto& 
chaš_ş›Á
 : 
»que¡
.
cÚ‹xt
.
G‘
<
NodeCÚ‹xt
>().
chaš_ş›Ás
) {

505 
chaš_ş›Á
->
	`£tMockTime
(
time
);

509  
NuÎUniV®ue
;

510 
	}
}

512 
UniV®ue
 
	$mockscheduËr
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

514 
RPCH–pMª
{"mockscheduler",

517 {"d–_time", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "Number of secondso forwardhe scheduler intohe future." },

519 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

520 
RPCExam¶es
{""},

521 }.
	`Check
(
»que¡
);

523 ià(!
	`P¬ams
().
	`IsMockabËChaš
()) {

524 
throw
 
¡d
::
	`ruÁime_”rÜ
("mockscheduler is for„egressionesting (-regtest mode) only");

528 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VNUM
});

529 
št64_t
 
d–_£cÚds
 = 
»que¡
.
·¿ms
[0].
	`g‘_št64
();

530 ià((
d–_£cÚds
 <= 0) || (delta_seconds > 3600)) {

531 
throw
 
¡d
::
	`ruÁime_”rÜ
("delta_time must be between 1‡nd 3600 seconds (1 hr)");

535 
	`CHECK_NONFATAL
(
»que¡
.
cÚ‹xt
.
Has
<
NodeCÚ‹xt
>());

536 
NodeCÚ‹xt
& 
node
 = 
»que¡
.
cÚ‹xt
.
G‘
<NodeContext>();

537 
	`CHECK_NONFATAL
(
node
.
scheduËr
);

538 
node
.
scheduËr
->
	`MockFÜw¬d
(
¡d
::
chrÚo
::
	`£cÚds
(
d–_£cÚds
));

540  
NuÎUniV®ue
;

541 
	}
}

543 
UniV®ue
 
	$RPCLockedMemÜyInfo
()

545 
LockedPoŞ
::
Sts
 
¡©s
 = 
LockedPoŞMªag”
::
	`In¡ªû
().
	`¡©s
();

546 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

547 
obj
.
	`pushKV
("u£d", 
	`ušt64_t
(
¡©s
.
u£d
));

548 
obj
.
	`pushKV
("ä“", 
	`ušt64_t
(
¡©s
.
ä“
));

549 
obj
.
	`pushKV
("tÙ®", 
	`ušt64_t
(
¡©s
.
tÙ®
));

550 
obj
.
	`pushKV
("locked", 
	`ušt64_t
(
¡©s
.
locked
));

551 
obj
.
	`pushKV
("chunks_u£d", 
	`ušt64_t
(
¡©s
.
chunks_u£d
));

552 
obj
.
	`pushKV
("chunks_ä“", 
	`ušt64_t
(
¡©s
.
chunks_ä“
));

553  
obj
;

554 
	}
}

556 #ifdeà
HAVE_MALLOC_INFO


557 
	g¡d
::
¡ršg
 
	$RPCM®locInfo
()

559 *
±r
 = 
nuÎ±r
;

560 
size_t
 
size
 = 0;

561 
FILE
 *
f
 = 
	`İ’_mem¡»am
(&
±r
, &
size
);

562 ià(
f
) {

563 
	`m®loc_šfo
(0, 
f
);

564 
	`fşo£
(
f
);

565 ià(
±r
) {

566 
¡d
::
¡ršg
 
	`rv
(
±r
, 
size
);

567 
	`ä“
(
±r
);

568  
rv
;

572 
	}
}

575 
UniV®ue
 
	$g‘memÜyšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

580 
RPCH–pMª
{"getmemoryinfo",

583 {"mode", 
RPCArg
::
Ty³
::
STR
, "\"stats\"", "determines what kind of information is„eturned.\n"

588 
RPCResuÉ
{"mode \"stats\"",

589 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

591 {
RPCResuÉ
::
Ty³
::
OBJ
, "locked", "Information‡bout†ocked memory manager",

593 {
RPCResuÉ
::
Ty³
::
NUM
, "used", "Number of bytes used"},

594 {
RPCResuÉ
::
Ty³
::
NUM
, "free", "Number of bytes‡vailable in current‡renas"},

595 {
RPCResuÉ
::
Ty³
::
NUM
, "total", "Total‚umber of bytes managed"},

596 {
RPCResuÉ
::
Ty³
::
NUM
, "locked", "Amount of byteshat succeeded†ocking. Ifhis‚umber is smallerhanotal,†ocking…ages failed‡t some…oint‡nd key data could be swappedo disk."},

597 {
RPCResuÉ
::
Ty³
::
NUM
, "chunks_used", "Number‡llocated chunks"},

598 {
RPCResuÉ
::
Ty³
::
NUM
, "chunks_free", "Number unused chunks"},

602 
RPCResuÉ
{"mode \"mallocinfo\"",

603 
RPCResuÉ
::
Ty³
::
STR
, "", "\"<malloc version=\"1\">...\""

606 
RPCExam¶es
{

607 
	`H–pExam¶eCli
("getmemoryinfo", "")

608 + 
	`H–pExam¶eRpc
("getmemoryinfo", "")

610 }.
	`Check
(
»que¡
);

612 
¡d
::
¡ršg
 
mode
 = 
»que¡
.
·¿ms
[0].
	`isNuÎ
(è? "¡©s" :„eque¡.·¿ms[0].
	`g‘_¡r
();

613 ià(
mode
 == "stats") {

614 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

615 
obj
.
	`pushKV
("locked", 
	`RPCLockedMemÜyInfo
());

616  
obj
;

617 } ià(
mode
 == "mallocinfo") {

618 #ifdeà
HAVE_MALLOC_INFO


619  
	`RPCM®locInfo
();

621 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "mallocinfo is only‡vailable when compiled with glibc 2.10+");

624 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "unknowÀmod" + 
mode
);

626 
	}
}

628 
	$EÇbËOrDi§bËLogC©egÜ›s
(
UniV®ue
 
ÿts
, 
boŞ
 
’abË
) {

629 
ÿts
 = c©s.
	`g‘_¬¿y
();

630 
i
 = 0; i < 
ÿts
.
	`size
(); ++i) {

631 
¡d
::
¡ršg
 
ÿt
 = 
ÿts
[
i
].
	`g‘_¡r
();

633 
boŞ
 
sucûss
;

634 ià(
’abË
) {

635 
sucûss
 = 
	`LogIn¡ªû
().
	`EÇbËC©egÜy
(
ÿt
);

637 
sucûss
 = 
	`LogIn¡ªû
().
	`Di§bËC©egÜy
(
ÿt
);

640 ià(!
sucûss
) {

641 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "unknowÀloggšg c©egÜy " + 
ÿt
);

644 
	}
}

646 
UniV®ue
 
	$loggšg
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

648 
RPCH–pMª
{"logging",

654 "Thv®id†oggšg c©egÜ› ¬e: " + 
	`LogIn¡ªû
().
	`LogC©egÜ›sSŒšg
() + "\n"

660 {"šşude", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "The categorieso‡ddo debug†ogging",

662 {"šşude_ÿ‹gÜy", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "the valid†ogging category"},

664 {"exşude", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "The categorieso„emove from debug†ogging",

666 {"exşude_ÿ‹gÜy", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "the valid†ogging category"},

669 
RPCResuÉ
{

670 
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "", "keys‡rehe†ogging categories,‡nd values indicates its status",

672 {
RPCResuÉ
::
Ty³
::
BOOL
, "category", "if being debug†ogged or‚ot. false:inactive,rue:active"},

675 
RPCExam¶es
{

676 
	`H–pExam¶eCli
("logging", "\"[\\\"all\\\"]\" \"[\\\"http\\\"]\"")

677 + 
	`H–pExam¶eRpc
("logging", "[\"all\"], [\"libevent\"]")

679 }.
	`Check
(
»que¡
);

681 
ušt32_t
 
Üigš®_log_ÿ‹gÜ›s
 = 
	`LogIn¡ªû
().
	`G‘C©egÜyMask
();

682 ià(
»que¡
.
·¿ms
[0].
	`isA¼ay
()) {

683 
	`EÇbËOrDi§bËLogC©egÜ›s
(
»que¡
.
·¿ms
[0], 
Œue
);

685 ià(
»que¡
.
·¿ms
[1].
	`isA¼ay
()) {

686 
	`EÇbËOrDi§bËLogC©egÜ›s
(
»que¡
.
·¿ms
[1], 
çl£
);

688 
ušt32_t
 
upd©ed_log_ÿ‹gÜ›s
 = 
	`LogIn¡ªû
().
	`G‘C©egÜyMask
();

689 
ušt32_t
 
chªged_log_ÿ‹gÜ›s
 = 
Üigš®_log_ÿ‹gÜ›s
 ^ 
upd©ed_log_ÿ‹gÜ›s
;

696 ià(
chªged_log_ÿ‹gÜ›s
 & 
BCLog
::
LIBEVENT
) {

697 ià(!
	`Upd©eHTTPS”v”Loggšg
(
	`LogIn¡ªû
().
	`WlLogC©egÜy
(
BCLog
::
LIBEVENT
))) {

698 
	`LogIn¡ªû
().
	`Di§bËC©egÜy
(
BCLog
::
LIBEVENT
);

699 ià(
chªged_log_ÿ‹gÜ›s
 =ğ
BCLog
::
LIBEVENT
) {

700 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "libevent†ogging cannot be updated when using†ibevent before v2.1.1.");

705 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

706 cÚ¡‡uto& 
logC©Aùive
 : 
	`LogIn¡ªû
().
	`LogC©egÜ›sLi¡
()) {

707 
»suÉ
.
	`pushKV
(
logC©Aùive
.
ÿ‹gÜy
,†ogC©Aùive.
aùive
);

710  
»suÉ
;

711 
	}
}

713 
UniV®ue
 
	$echo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

715 ià(
»que¡
.
fH–p
)

716 
throw
 
¡d
::
	`ruÁime_”rÜ
(

717 
RPCH–pMª
{"echo|echojson ...",

723 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", "Returns whatever was…assed in"},

724 
RPCExam¶es
{""},

725 }.
	`ToSŒšg
()

728 
	`CHECK_NONFATAL
(
»que¡
.
·¿ms
.
	`size
() != 100);

730  
»que¡
.
·¿ms
;

731 
	}
}

733 
	$Regi¡”MiscRPCCommªds
(
CRPCTabË
 &
t
)

736 cÚ¡ 
CRPCCommªd
 
commªds
[] =

739 { "cÚŒŞ", "g‘memÜyšfo", &
g‘memÜyšfo
, {"mode"} },

740 { "cÚŒŞ", "loggšg", &
loggšg
, {"include", "exclude"}},

741 { "ut", "v®id©—dd»ss", &
v®id©—dd»ss
, {"address"} },

742 { "ut", "ü—‹muÉisig", &
ü—‹muÉisig
, {"nrequired","keys","address_type"} },

743 { "ut", "d”iv—dd»s£s", &
d”iv—dd»s£s
, {"descriptor", "range"} },

744 { "ut", "g‘desütÜšfo", &
g‘desütÜšfo
, {"descriptor"} },

745 { "ut", "v”ifymes§ge", &
v”ifymes§ge
, {"address","signature","message"} },

746 { "ut", "signmes§gew™h´ivkey", &
signmes§gew™h´ivkey
, {"privkey","message"} },

748 { "syscoš", "mnsync", &
mnsync
, {} },

749 { "syscoš", "¥Ük", &
¥Ük
, {"arg0","value"} },

751 { "hidd’", "£tmocktime", &
£tmocktime
, {"timestamp"}},

752 { "hidd’", "mockscheduËr", &
mockscheduËr
, {"delta_time"}},

753 { "hidd’", "echo", &
echo
, {"arg0","arg1","arg2","arg3","arg4","arg5","arg6","arg7","arg8","arg9"}},

754 { "hidd’", "echojsÚ", &
echo
, {"arg0","arg1","arg2","arg3","arg4","arg5","arg6","arg7","arg8","arg9"}},

758 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

759 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

760 
	}
}

	@net.cpp

5 
	~<½c/£rv”.h
>

7 
	~<bªmª.h
>

8 
	~<ş›Áv”siÚ.h
>

9 
	~<cÜe_io.h
>

10 
	~<Ãt.h
>

11 
	~<Ãt_³rmissiÚs.h
>

12 
	~<Ãt_´oûssšg.h
>

13 
	~<Ãt_ty³s.h
>

14 
	~<Ãtba£.h
>

15 
	~<node/cÚ‹xt.h
>

16 
	~<pŞicy/£‰šgs.h
>

17 
	~<½c/blockchaš.h
>

18 
	~<½c/´ÙocŞ.h
>

19 
	~<½c/ut.h
>

20 
	~<sync.h
>

21 
	~<timed©a.h
>

22 
	~<ut/¡»ncodšgs.h
>

23 
	~<ut/¡ršg.h
>

24 
	~<ut/sy¡em.h
>

25 
	~<ut/Œª¦©iÚ.h
>

26 
	~<v®id©iÚ.h
>

27 
	~<v”siÚ.h
>

28 
	~<w¬nšgs.h
>

30 
	~<univ®ue.h
>

32 
UniV®ue
 
	$g‘cÚÃùiÚcouÁ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

34 
RPCH–pMª
{"getconnectioncount",

37 
RPCResuÉ
{

38 
RPCResuÉ
::
Ty³
::
NUM
, "", "The connection count"

40 
RPCExam¶es
{

41 
	`H–pExam¶eCli
("getconnectioncount", "")

42 + 
	`H–pExam¶eRpc
("getconnectioncount", "")

44 }.
	`Check
(
»que¡
);

46 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

47 if(!
node
.
cÚnmª
)

48 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

50  ()
node
.
cÚnmª
->
	`G‘NodeCouÁ
(
CCÚnmª
::
CONNECTIONS_ALL
);

51 
	}
}

53 
UniV®ue
 
	$pšg
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

55 
RPCH–pMª
{"ping",

60 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

61 
RPCExam¶es
{

62 
	`H–pExam¶eCli
("ping", "")

63 + 
	`H–pExam¶eRpc
("ping", "")

65 }.
	`Check
(
»que¡
);

67 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

68 if(!
node
.
cÚnmª
)

69 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

72 
node
.
cÚnmª
->
	`FÜEachNode
([](
CNode
* 
²ode
) {

73 
²ode
->
fPšgQueued
 = 
Œue
;

75  
NuÎUniV®ue
;

76 
	}
}

78 
UniV®ue
 
	$g‘³”šfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

80 
RPCH–pMª
{"getpeerinfo",

83 
RPCResuÉ
{

84 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

86 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

89 {
RPCResuÉ
::
Ty³
::
NUM
, "id", "Peer index"},

90 {
RPCResuÉ
::
Ty³
::
STR
, "addr", "(host:port) The IP‡ddress‡nd…ort ofhe…eer"},

91 {
RPCResuÉ
::
Ty³
::
STR
, "addrbind", "(ip:port) Bind‡ddress ofhe connectionohe…eer"},

92 {
RPCResuÉ
::
Ty³
::
STR
, "addrlocal", "(ip:port) Local‡ddress‡s„eported byhe…eer"},

93 {
RPCResuÉ
::
Ty³
::
NUM
, "mapped_as", "The AS inhe BGP„outeohe…eer used for diversifying\n"

95 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "services", "The services offered"},

97 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "verified_proregtx_hash", "Only…resent whenhe…eer is‡ masternode‡nd succesfully\n"

100 {
RPCResuÉ
::
Ty³
::
ARR
, "servicesnames", "the services offered, in human-readable form",

102 {
RPCResuÉ
::
Ty³
::
STR
, "SERVICE_NAME", "the service‚ame if it is„ecognised"}

104 {
RPCResuÉ
::
Ty³
::
BOOL
, "relaytxes", "Whether…eer has‡sked uso„elayransactionso it"},

105 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "Ï¡£nd", "Th" + 
UNIX_EPOCH_TIME
 + " ofhe†ast send"},

106 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "Ï¡»cv", "Th" + 
UNIX_EPOCH_TIME
 + " ofhe†ast„eceive"},

107 {
RPCResuÉ
::
Ty³
::
NUM
, "bytessent", "Theotal bytes sent"},

108 {
RPCResuÉ
::
Ty³
::
NUM
, "bytesrecv", "Theotal bytes„eceived"},

109 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "cÚÁime", "Th" + 
UNIX_EPOCH_TIME
 + " ofhe connection"},

110 {
RPCResuÉ
::
Ty³
::
NUM
, "timeoffset", "Theime offset in seconds"},

111 {
RPCResuÉ
::
Ty³
::
NUM
, "pingtime", "pingime (if‡vailable)"},

112 {
RPCResuÉ
::
Ty³
::
NUM
, "minping", "minimum observed…ingime (if‡ny‡t‡ll)"},

113 {
RPCResuÉ
::
Ty³
::
NUM
, "pingwait", "ping wait (if‚on-zero)"},

114 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The…eer version, such‡s 70001"},

115 {
RPCResuÉ
::
Ty³
::
STR
, "subver", "The string version"},

116 {
RPCResuÉ
::
Ty³
::
BOOL
, "inbound", "Inbound (true) or Outbound (false)"},

117 {
RPCResuÉ
::
Ty³
::
BOOL
, "addnode", "Whether connection was dueo‡ddnode/-connect or if it was‡n‡utomatic/inbound connection"},

118 {
RPCResuÉ
::
Ty³
::
BOOL
, "masternode", "Whether connection was dueo masternode connection‡ttempt"},

119 {
RPCResuÉ
::
Ty³
::
NUM
, "startingheight", "The starting height (block) ofhe…eer"},

120 {
RPCResuÉ
::
Ty³
::
NUM
, "banscore", "The ban score"},

121 {
RPCResuÉ
::
Ty³
::
NUM
, "synced_headers", "The†ast header we have in common withhis…eer"},

122 {
RPCResuÉ
::
Ty³
::
NUM
, "synced_blocks", "The†ast block we have in common withhis…eer"},

123 {
RPCResuÉ
::
Ty³
::
ARR
, "inflight", "",

125 {
RPCResuÉ
::
Ty³
::
NUM
, "n", "The heights of blocks we're currently‡sking fromhis…eer"},

127 {
RPCResuÉ
::
Ty³
::
BOOL
, "whitelisted", "Whetherhe…eer is whitelisted"},

128 {
RPCResuÉ
::
Ty³
::
NUM
, "minfeefilter", "The minimum fee„ate forransactionshis…eer‡ccepts"},

129 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "bytessent_per_msg", "",

131 {
RPCResuÉ
::
Ty³
::
NUM
, "msg", "Theotal bytes sent‡ggregated by messageype\n"

135 {
RPCResuÉ
::
Ty³
::
OBJ
, "bytesrecv_per_msg", "",

137 {
RPCResuÉ
::
Ty³
::
NUM
, "msg", "Theotal bytes„eceived‡ggregated by messageype\n"

139 "OÆy knowÀmes§gty³ ÿÀ­³¬‡ key šhobjeù‡nd‡Î by‹ »ûived oàunknowÀmes§gty³ ¬li¡ed und” '"+
NET_MESSAGE_COMMAND_OTHER
+"'."}

144 
RPCExam¶es
{

145 
	`H–pExam¶eCli
("getpeerinfo", "")

146 + 
	`H–pExam¶eRpc
("getpeerinfo", "")

148 }.
	`Check
(
»que¡
);

150 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

151 if(!
node
.
cÚnmª
)

152 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

154 
¡d
::
veùÜ
<
CNodeSts
> 
v¡©s
;

155 
node
.
cÚnmª
->
	`G‘NodeSts
(
v¡©s
);

157 
UniV®ue
 
	`»t
(UniV®ue::
VARR
);

159 cÚ¡ 
CNodeSts
& 
¡©s
 : 
v¡©s
) {

160 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

161 
CNodeS‹Sts
 
¡©e¡©s
;

162 
boŞ
 
fS‹Sts
 = 
	`G‘NodeS‹Sts
(
¡©s
.
nodeid
, 
¡©e¡©s
);

163 
obj
.
	`pushKV
("id", 
¡©s
.
nodeid
);

164 
obj
.
	`pushKV
("addr", 
¡©s
.
addrName
);

165 ià(!(
¡©s
.
addrLoÿl
.
	`em±y
()))

166 
obj
.
	`pushKV
("add¾oÿl", 
¡©s
.
addrLoÿl
);

167 ià(
¡©s
.
addrBšd
.
	`IsV®id
())

168 
obj
.
	`pushKV
("addrbšd", 
¡©s
.
addrBšd
.
	`ToSŒšg
());

169 ià(
¡©s
.
m_m­³d_as
 != 0) {

170 
obj
.
	`pushKV
("m­³d_as", 
	`ušt64_t
(
¡©s
.
m_m­³d_as
));

172 
obj
.
	`pushKV
("£rviûs", 
	`¡½rštf
("%016x", 
¡©s
.
nS”viûs
));

173 
obj
.
	`pushKV
("£rviû¢ames", 
	`G‘S”viûsNames
(
¡©s
.
nS”viûs
));

175 ià(!
¡©s
.
v”if›dProRegTxHash
.
	`IsNuÎ
()) {

176 
obj
.
	`pushKV
("v”if›d_´Üegtx_hash", 
¡©s
.
v”if›dProRegTxHash
.
	`ToSŒšg
());

178 
obj
.
	`pushKV
("»Ïytxes", 
¡©s
.
fR–ayTxes
);

179 
obj
.
	`pushKV
("Ï¡£nd", 
¡©s
.
nLa¡S’d
);

180 
obj
.
	`pushKV
("Ï¡»cv", 
¡©s
.
nLa¡Recv
);

181 
obj
.
	`pushKV
("by‹s£Á", 
¡©s
.
nS’dBy‹s
);

182 
obj
.
	`pushKV
("by‹¤ecv", 
¡©s
.
nRecvBy‹s
);

183 
obj
.
	`pushKV
("cÚÁime", 
¡©s
.
nTimeCÚÃùed
);

184 
obj
.
	`pushKV
("timeoff£t", 
¡©s
.
nTimeOff£t
);

185 ià(
¡©s
.
m_pšg_u£c
 > 0) {

186 
obj
.
	`pushKV
("pšgtime", (()
¡©s
.
m_pšg_u£c
) / 1e6);

188 ià(
¡©s
.
m_mš_pšg_u£c
 < 
¡d
::
num”ic_lim™s
<
št64_t
>::
	`max
()) {

189 
obj
.
	`pushKV
("mšpšg", (()
¡©s
.
m_mš_pšg_u£c
) / 1e6);

191 ià(
¡©s
.
m_pšg_wa™_u£c
 > 0) {

192 
obj
.
	`pushKV
("pšgwa™", (()
¡©s
.
m_pšg_wa™_u£c
) / 1e6);

194 
obj
.
	`pushKV
("v”siÚ", 
¡©s
.
nV”siÚ
);

198 
obj
.
	`pushKV
("subv”", 
¡©s
.
ş—nSubV”
);

199 
obj
.
	`pushKV
("šbound", 
¡©s
.
fInbound
);

200 
obj
.
	`pushKV
("addnode", 
¡©s
.
m_mªu®_cÚÃùiÚ
);

202 
obj
.
	`pushKV
("ma¡”node", 
¡©s
.
fMa¡”node
);

203 
obj
.
	`pushKV
("¡¬tšgheight", 
¡©s
.
nS¹šgHeight
);

204 ià(
fS‹Sts
) {

205 
obj
.
	`pushKV
("bªscÜe", 
¡©e¡©s
.
nMisbehaviÜ
);

206 
obj
.
	`pushKV
("synûd_h—d”s", 
¡©e¡©s
.
nSyncHeight
);

207 
obj
.
	`pushKV
("synûd_blocks", 
¡©e¡©s
.
nCommÚHeight
);

208 
UniV®ue
 
	`heights
(UniV®ue::
VARR
);

209 cÚ¡ 
height
 : 
¡©e¡©s
.
vHeightInFlight
) {

210 
heights
.
	`push_back
(
height
);

212 
obj
.
	`pushKV
("šæight", 
heights
);

214 
obj
.
	`pushKV
("wh™–i¡ed", 
¡©s
.
m_ËgacyWh™–i¡ed
);

215 
UniV®ue
 
	`³rmissiÚs
(UniV®ue::
VARR
);

216 cÚ¡‡uto& 
³rmissiÚ
 : 
N‘P”missiÚs
::
	`ToSŒšgs
(
¡©s
.
m_³rmissiÚFÏgs
)) {

217 
³rmissiÚs
.
	`push_back
(
³rmissiÚ
);

219 
obj
.
	`pushKV
("³rmissiÚs", 
³rmissiÚs
);

220 
obj
.
	`pushKV
("mšãef‹r", 
	`V®ueFromAmouÁ
(
¡©s
.
mšF“F‹r
));

222 
UniV®ue
 
	`£ndP”MsgCmd
(UniV®ue::
VOBJ
);

223 cÚ¡‡uto& 
i
 : 
¡©s
.
m­S’dBy‹sP”MsgCmd
) {

224 ià(
i
.
£cÚd
 > 0)

225 
£ndP”MsgCmd
.
	`pushKV
(
i
.
fœ¡
, i.
£cÚd
);

227 
obj
.
	`pushKV
("by‹s£Á_³r_msg", 
£ndP”MsgCmd
);

229 
UniV®ue
 
	`»cvP”MsgCmd
(UniV®ue::
VOBJ
);

230 cÚ¡‡uto& 
i
 : 
¡©s
.
m­RecvBy‹sP”MsgCmd
) {

231 ià(
i
.
£cÚd
 > 0)

232 
»cvP”MsgCmd
.
	`pushKV
(
i
.
fœ¡
, i.
£cÚd
);

234 
obj
.
	`pushKV
("by‹¤ecv_³r_msg", 
»cvP”MsgCmd
);

236 
»t
.
	`push_back
(
obj
);

239  
»t
;

240 
	}
}

242 
UniV®ue
 
	$addnode
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

244 
¡d
::
¡ršg
 
¡rCommªd
;

245 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

246 
¡rCommªd
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

247 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2 ||

248 (
¡rCommªd
 != "onetry" && strCommand != "add" && strCommand != "remove"))

249 
throw
 
¡d
::
	`ruÁime_”rÜ
(

250 
RPCH–pMª
{"addnode",

256 {"node", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The‚ode (see getpeerinfo for‚odes)"},

257 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "'add'o‡dd‡‚odeohe†ist, 'remove'o„emove‡‚ode fromhe†ist, 'onetry'ory‡ connectionohe‚ode once"},

259 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

260 
RPCExam¶es
{

261 
	`H–pExam¶eCli
("addnode", "\"192.168.0.6:8369\" \"onetry\"")

262 + 
	`H–pExam¶eRpc
("addnode", "\"192.168.0.6:8369\", \"onetry\"")

264 }.
	`ToSŒšg
());

266 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

267 if(!
node
.
cÚnmª
)

268 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

270 
¡d
::
¡ršg
 
¡rNode
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

272 ià(
¡rCommªd
 == "onetry")

274 
CAdd»ss
 
addr
;

275 
node
.
cÚnmª
->
	`O³nN‘wÜkCÚÃùiÚ
(
addr
, 
çl£
, 
nuÎ±r
, 
¡rNode
.
	`c_¡r
(), f®£, f®£, 
Œue
);

276  
NuÎUniV®ue
;

279 ià(
¡rCommªd
 == "add")

281 if(!
node
.
cÚnmª
->
	`AddNode
(
¡rNode
))

282 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NODE_ALREADY_ADDED
, "Error: Node‡lready‡dded");

284 if(
¡rCommªd
 == "remove")

286 if(!
node
.
cÚnmª
->
	`RemoveAddedNode
(
¡rNode
))

287 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NODE_NOT_ADDED
, "Error: Node has‚ot been‡dded.");

290  
NuÎUniV®ue
;

291 
	}
}

293 
UniV®ue
 
	$discÚÃùnode
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

295 
RPCH–pMª
{"disconnectnode",

300 {"add»ss", 
RPCArg
::
Ty³
::
STR
, "fallbacko‚odeid", "The IP‡ddress/port ofhe‚ode"},

301 {"nodeid", 
RPCArg
::
Ty³
::
NUM
, "fallbacko‡ddress", "The‚ode ID (see getpeerinfo for‚ode IDs)"},

303 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

304 
RPCExam¶es
{

305 
	`H–pExam¶eCli
("disconnectnode", "\"192.168.0.6:8369\"")

306 + 
	`H–pExam¶eCli
("disconnectnode", "\"\" 1")

307 + 
	`H–pExam¶eRpc
("disconnectnode", "\"192.168.0.6:8369\"")

308 + 
	`H–pExam¶eRpc
("disconnectnode", "\"\", 1")

310 }.
	`Check
(
»que¡
);

312 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

313 if(!
node
.
cÚnmª
)

314 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

316 
boŞ
 
sucûss
;

317 cÚ¡ 
UniV®ue
 &
add»ss_¬g
 = 
»que¡
.
·¿ms
[0];

318 cÚ¡ 
UniV®ue
 &
id_¬g
 = 
»que¡
.
·¿ms
[1];

320 ià(!
add»ss_¬g
.
	`isNuÎ
(è&& 
id_¬g
.isNull()) {

322 
sucûss
 = 
node
.
cÚnmª
->
	`DiscÚÃùNode
(
add»ss_¬g
.
	`g‘_¡r
());

323 } ià(!
id_¬g
.
	`isNuÎ
(è&& (
add»ss_¬g
.isNuÎ(è|| (add»ss_¬g.
	`isSŒ
(è&&‡dd»ss_¬g.
	`g‘_¡r
().
	`em±y
()))) {

325 
NodeId
 
nodeid
 = (NodeIdè
id_¬g
.
	`g‘_št64
();

326 
sucûss
 = 
node
.
cÚnmª
->
	`DiscÚÃùNode
(
nodeid
);

328 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMS
, "Only one of‡ddress‡nd‚odeid should be…rovided.");

331 ià(!
sucûss
) {

332 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NODE_NOT_CONNECTED
, "Node‚ot found in connected‚odes");

335  
NuÎUniV®ue
;

336 
	}
}

338 
UniV®ue
 
	$g‘addednodešfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

340 
RPCH–pMª
{"getaddednodeinfo",

344 {"node", 
RPCArg
::
Ty³
::
STR
, "all‚odes", "If…rovided,„eturn information‡bouthis specific‚ode, otherwise‡ll‚odes‡re„eturned."},

346 
RPCResuÉ
{

347 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

349 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

351 {
RPCResuÉ
::
Ty³
::
STR
, "addednode", "The‚ode IP‡ddress or‚ame (as…rovidedo‡ddnode)"},

352 {
RPCResuÉ
::
Ty³
::
BOOL
, "connected", "If connected"},

353 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "Only when connected =rue",

355 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

357 {
RPCResuÉ
::
Ty³
::
STR
, "address", "The syscoin server IP‡nd…ort we're connectedo"},

358 {
RPCResuÉ
::
Ty³
::
STR
, "connected", "connection, inbound or outbound"},

364 
RPCExam¶es
{

365 
	`H–pExam¶eCli
("getaddednodeinfo", "\"192.168.0.201\"")

366 + 
	`H–pExam¶eRpc
("getaddednodeinfo", "\"192.168.0.201\"")

368 }.
	`Check
(
»que¡
);

370 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

371 if(!
node
.
cÚnmª
)

372 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

374 
¡d
::
veùÜ
<
AddedNodeInfo
> 
vInfo
 = 
node
.
cÚnmª
->
	`G‘AddedNodeInfo
();

376 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

377 
boŞ
 
found
 = 
çl£
;

378 cÚ¡ 
AddedNodeInfo
& 
šfo
 : 
vInfo
) {

379 ià(
šfo
.
¡rAddedNode
 =ğ
»que¡
.
·¿ms
[0].
	`g‘_¡r
()) {

380 
vInfo
.
	`assign
(1, 
šfo
);

381 
found
 = 
Œue
;

385 ià(!
found
) {

386 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NODE_NOT_ADDED
, "Error: Node has‚ot been‡dded.");

390 
UniV®ue
 
	`»t
(UniV®ue::
VARR
);

392 cÚ¡ 
AddedNodeInfo
& 
šfo
 : 
vInfo
) {

393 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

394 
obj
.
	`pushKV
("addednode", 
šfo
.
¡rAddedNode
);

395 
obj
.
	`pushKV
("cÚÃùed", 
šfo
.
fCÚÃùed
);

396 
UniV®ue
 
	`add»s£s
(UniV®ue::
VARR
);

397 ià(
šfo
.
fCÚÃùed
) {

398 
UniV®ue
 
	`add»ss
(UniV®ue::
VOBJ
);

399 
add»ss
.
	`pushKV
("add»ss", 
šfo
.
»sŞvedAdd»ss
.
	`ToSŒšg
());

400 
add»ss
.
	`pushKV
("cÚÃùed", 
šfo
.
fInbound
 ? "inbound" : "outbound");

401 
add»s£s
.
	`push_back
(
add»ss
);

403 
obj
.
	`pushKV
("add»s£s", 
add»s£s
);

404 
»t
.
	`push_back
(
obj
);

407  
»t
;

408 
	}
}

410 
UniV®ue
 
	$g‘Ã‰Ù®s
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

412 
RPCH–pMª
{"getnettotals",

416 
RPCResuÉ
{

417 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

419 {
RPCResuÉ
::
Ty³
::
NUM
, "totalbytesrecv", "Total bytes„eceived"},

420 {
RPCResuÉ
::
Ty³
::
NUM
, "totalbytessent", "Total bytes sent"},

421 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "timemillis", "Current UNIXime in milliseconds"},

422 {
RPCResuÉ
::
Ty³
::
OBJ
, "uploadtarget", "",

424 {
RPCResuÉ
::
Ty³
::
NUM
, "timeframe", "Length ofhe measuringimeframe in seconds"},

425 {
RPCResuÉ
::
Ty³
::
NUM
, "target", "Target in bytes"},

426 {
RPCResuÉ
::
Ty³
::
BOOL
, "target_reached", "True ifarget is„eached"},

427 {
RPCResuÉ
::
Ty³
::
BOOL
, "serve_historical_blocks", "True if serving historical blocks"},

428 {
RPCResuÉ
::
Ty³
::
NUM
, "bytes_left_in_cycle", "Bytes†eft in currentime cycle"},

429 {
RPCResuÉ
::
Ty³
::
NUM
, "time_left_in_cycle", "Seconds†eft in currentime cycle"},

433 
RPCExam¶es
{

434 
	`H–pExam¶eCli
("getnettotals", "")

435 + 
	`H–pExam¶eRpc
("getnettotals", "")

437 }.
	`Check
(
»que¡
);

438 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

439 if(!
node
.
cÚnmª
)

440 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

442 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

443 
obj
.
	`pushKV
("tÙ®by‹¤ecv", 
node
.
cÚnmª
->
	`G‘TÙ®By‹sRecv
());

444 
obj
.
	`pushKV
("tÙ®by‹s£Á", 
node
.
cÚnmª
->
	`G‘TÙ®By‹sS’t
());

445 
obj
.
	`pushKV
("timemlis", 
	`G‘TimeMlis
());

447 
UniV®ue
 
	`outboundLim™
(UniV®ue::
VOBJ
);

448 
outboundLim™
.
	`pushKV
("timeäame", 
node
.
cÚnmª
->
	`G‘MaxOutboundTimeäame
());

449 
outboundLim™
.
	`pushKV
("rg‘", 
node
.
cÚnmª
->
	`G‘MaxOutboundT¬g‘
());

450 
outboundLim™
.
	`pushKV
("rg‘_»ached", 
node
.
cÚnmª
->
	`OutboundT¬g‘R—ched
(
çl£
));

451 
outboundLim™
.
	`pushKV
("£rve_hi¡Üiÿl_blocks", !
node
.
cÚnmª
->
	`OutboundT¬g‘R—ched
(
Œue
));

452 
outboundLim™
.
	`pushKV
("by‹s_Ëá_š_cyşe", 
node
.
cÚnmª
->
	`G‘OutboundT¬g‘By‹sLeá
());

453 
outboundLim™
.
	`pushKV
("time_Ëá_š_cyşe", 
node
.
cÚnmª
->
	`G‘MaxOutboundTimeLeáInCyşe
());

454 
obj
.
	`pushKV
("u¶ßdrg‘", 
outboundLim™
);

455  
obj
;

456 
	}
}

458 
UniV®ue
 
	$G‘N‘wÜksInfo
()

460 
UniV®ue
 
	`ÃtwÜks
(UniV®ue::
VARR
);

461 
n
=0;‚<
NET_MAX
; ++n)

463 
N‘wÜk
 
ÃtwÜk
 = 
¡©ic_ÿ¡
<N‘wÜk>(
n
);

464 if(
ÃtwÜk
 =ğ
NET_UNROUTABLE
 ||‚‘wÜk =ğ
NET_INTERNAL
)

466 
´oxyTy³
 
´oxy
;

467 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

468 
	`G‘Proxy
(
ÃtwÜk
, 
´oxy
);

469 
obj
.
	`pushKV
("Çme", 
	`G‘N‘wÜkName
(
ÃtwÜk
));

470 
obj
.
	`pushKV
("lim™ed", !
	`IsR—chabË
(
ÃtwÜk
));

471 
obj
.
	`pushKV
("»achabË", 
	`IsR—chabË
(
ÃtwÜk
));

472 
obj
.
	`pushKV
("´oxy", 
´oxy
.
	`IsV®id
(è?…roxy.´oxy.
	`ToSŒšgIPPÜt
(è: 
¡d
::
	`¡ršg
());

473 
obj
.
	`pushKV
("´oxy_¿ndomize_üed’tŸls", 
´oxy
.
¿ndomize_üed’tŸls
);

474 
ÃtwÜks
.
	`push_back
(
obj
);

476  
ÃtwÜks
;

477 
	}
}

479 
UniV®ue
 
	$g‘ÃtwÜkšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

481 
RPCH–pMª
{"getnetworkinfo",

484 
RPCResuÉ
{

485 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

487 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "the server version"},

488 {
RPCResuÉ
::
Ty³
::
STR
, "subversion", "the server subversion string"},

489 {
RPCResuÉ
::
Ty³
::
NUM
, "protocolversion", "the…rotocol version"},

490 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "localservices", "the services we offerohe‚etwork"},

491 {
RPCResuÉ
::
Ty³
::
ARR
, "localservicesnames", "the services we offerohe‚etwork, in human-readable form",

493 {
RPCResuÉ
::
Ty³
::
STR
, "SERVICE_NAME", "the service‚ame"},

495 {
RPCResuÉ
::
Ty³
::
BOOL
, "localrelay", "true ifransaction„elay is„equested from…eers"},

496 {
RPCResuÉ
::
Ty³
::
NUM
, "timeoffset", "theime offset"},

497 {
RPCResuÉ
::
Ty³
::
NUM
, "connections", "the‚umber of connections"},

498 {
RPCResuÉ
::
Ty³
::
NUM
, "geth_sync_status", "Sync status of Geth (Ethereum‚etwork). Valid values‡re: synced, syncing or waitingo sync.."},

499 {
RPCResuÉ
::
Ty³
::
NUM
, "geth_total_blocks", "The highest height seen onhe Ethereum‚etwork by Geth"},

500 {
RPCResuÉ
::
Ty³
::
NUM
, "geth_current_block", "The highest height ofhe block header of Ethereumhat is stored in our database"},

501 {
RPCResuÉ
::
Ty³
::
BOOL
, "networkactive", "whether…2p‚etworking isƒnabled"},

502 {
RPCResuÉ
::
Ty³
::
ARR
, "networks", "information…er‚etwork",

504 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

506 {
RPCResuÉ
::
Ty³
::
STR
, "name", "network (ipv4, ipv6 or onion)"},

507 {
RPCResuÉ
::
Ty³
::
BOOL
, "limited", "ishe‚etwork†imited using -onlynet?"},

508 {
RPCResuÉ
::
Ty³
::
BOOL
, "reachable", "ishe‚etwork„eachable?"},

509 {
RPCResuÉ
::
Ty³
::
STR
, "proxy", "(\"host:port\")he…roxyhat is used forhis‚etwork, orƒmpty if‚one"},

510 {
RPCResuÉ
::
Ty³
::
BOOL
, "proxy_randomize_credentials", "Whether„andomized credentials‡re used"},

513 {
RPCResuÉ
::
Ty³
::
NUM
, "»Ïyãe", "mšimum„–ay f“ fÜ¿n§ùiÚ š " + 
CURRENCY_UNIT
 + "/kB"},

514 {
RPCResuÉ
::
Ty³
::
NUM
, "šüem’lãe", "mšimum f“ inüem’ˆfÜ mempoŞ†im™šg o¸BIP 125„•Ïûm’ˆš " + 
CURRENCY_UNIT
 + "/kB"},

515 {
RPCResuÉ
::
Ty³
::
ARR
, "localaddresses", "list of†ocal‡ddresses",

517 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

519 {
RPCResuÉ
::
Ty³
::
STR
, "address", "network‡ddress"},

520 {
RPCResuÉ
::
Ty³
::
NUM
, "port", "network…ort"},

521 {
RPCResuÉ
::
Ty³
::
NUM
, "score", "relative score"},

524 {
RPCResuÉ
::
Ty³
::
STR
, "warnings", "any‚etwork‡nd blockchain warnings"},

527 
RPCExam¶es
{

528 
	`H–pExam¶eCli
("getnetworkinfo", "")

529 + 
	`H–pExam¶eRpc
("getnetworkinfo", "")

531 }.
	`Check
(
»que¡
);

533 
	`LOCK
(
cs_maš
);

534 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

535 
obj
.
	`pushKV
("v”siÚ", 
CLIENT_VERSION
);

536 
obj
.
	`pushKV
("subv”siÚ", 
¡rSubV”siÚ
);

537 
obj
.
	`pushKV
("´ÙocŞv”siÚ",
PROTOCOL_VERSION
);

538 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

539 ià(
node
.
cÚnmª
) {

540 
S”viûFÏgs
 
£rviûs
 = 
node
.
cÚnmª
->
	`G‘LoÿlS”viûs
();

541 
obj
.
	`pushKV
("loÿl£rviûs", 
	`¡½rštf
("%016x", 
£rviûs
));

542 
obj
.
	`pushKV
("loÿl£rviû¢ames", 
	`G‘S”viûsNames
(
£rviûs
));

544 
obj
.
	`pushKV
("loÿÌ–ay", 
g_»Ïy_txes
);

545 
obj
.
	`pushKV
("timeoff£t", 
	`G‘TimeOff£t
());

546 ià(
node
.
cÚnmª
) {

547 
obj
.
	`pushKV
("ÃtwÜkaùive", 
node
.
cÚnmª
->
	`G‘N‘wÜkAùive
());

548 
obj
.
	`pushKV
("cÚÃùiÚs", ()
node
.
cÚnmª
->
	`G‘NodeCouÁ
(
CCÚnmª
::
CONNECTIONS_ALL
));

551 
obj
.
	`pushKV
("g‘h_sync_¡©us", 
fG‘hSyncStus
);

552 
obj
.
	`pushKV
("g‘h_tÙ®_blocks", 
fG‘hSyncHeight
);

553 
obj
.
	`pushKV
("g‘h_cu¼’t_block", 
fG‘hCu¼’tHeight
);

554 
obj
.
	`pushKV
("ÃtwÜks", 
	`G‘N‘wÜksInfo
());

555 
obj
.
	`pushKV
("»Ïyãe", 
	`V®ueFromAmouÁ
(::
mšR–ayTxF“
.
	`G‘F“P”K
()));

556 
obj
.
	`pushKV
("šüem’lãe", 
	`V®ueFromAmouÁ
(::
šüem’lR–ayF“
.
	`G‘F“P”K
()));

557 
UniV®ue
 
	`loÿlAdd»s£s
(UniV®ue::
VARR
);

559 
	`LOCK
(
cs_m­LoÿlHo¡
);

560 cÚ¡ 
¡d
::
·œ
<cÚ¡ 
CN‘Addr
, 
LoÿlS”viûInfo
> &
™em
 : 
m­LoÿlHo¡
)

562 
UniV®ue
 
	`»c
(UniV®ue::
VOBJ
);

563 
»c
.
	`pushKV
("add»ss", 
™em
.
fœ¡
.
	`ToSŒšg
());

564 
»c
.
	`pushKV
("pÜt", 
™em
.
£cÚd
.
nPÜt
);

565 
»c
.
	`pushKV
("scÜe", 
™em
.
£cÚd
.
nScÜe
);

566 
loÿlAdd»s£s
.
	`push_back
(
»c
);

569 
obj
.
	`pushKV
("loÿÏdd»s£s", 
loÿlAdd»s£s
);

570 
obj
.
	`pushKV
("w¬nšgs", 
	`G‘W¬nšgs
(
çl£
).
Üigš®
);

571  
obj
;

572 
	}
}

574 
UniV®ue
 
	$£tbª
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

576 cÚ¡ 
RPCH–pMª
 
h–p
{"setban",

579 {"subÃt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The IP/Subnet (see getpeerinfo for‚odes IP) with‡n optional‚etmask (default is /32 = single IP)"},

580 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "'add'o‡dd‡n IP/Subnetohe†ist, 'remove'o„emove‡n IP/Subnet fromhe†ist"},

581 {"bªtime", 
RPCArg
::
Ty³
::
NUM
, "0", "time in seconds how†ong (or until when if [absolute] is set)he IP is banned (0 orƒmpty means usinghe defaultime of 24h which can‡lso be overwritten byhe -bantime startup‡rgument)"},

582 {"absŞu‹", 
RPCArg
::
Ty³
::
BOOL
, "çl£", "Ià£t,hbªtimmu¡ bª‡bsŞu‹ime¡am°ex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

584 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

585 
RPCExam¶es
{

586 
	`H–pExam¶eCli
("setban", "\"192.168.0.6\" \"add\" 86400")

587 + 
	`H–pExam¶eCli
("setban", "\"192.168.0.0/24\" \"add\"")

588 + 
	`H–pExam¶eRpc
("setban", "\"192.168.0.6\", \"add\", 86400")

591 
¡d
::
¡ršg
 
¡rCommªd
;

592 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
())

593 
¡rCommªd
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

594 ià(
»que¡
.
fH–p
 || !
h–p
.
	`IsV®idNumArgs
Ôeque¡.
·¿ms
.
	`size
()è|| (
¡rCommªd
 != "add" && strCommand != "remove")) {

595 
throw
 
¡d
::
	`ruÁime_”rÜ
(
h–p
.
	`ToSŒšg
());

597 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

598 ià(!
node
.
bªmª
) {

599 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, "Error: Ban database‚ot†oaded");

602 
CSubN‘
 
subN‘
;

603 
CN‘Addr
 
ÃtAddr
;

604 
boŞ
 
isSubÃt
 = 
çl£
;

606 ià(
»que¡
.
·¿ms
[0].
	`g‘_¡r
().
	`fšd
('/'è!ğ
¡d
::
¡ršg
::
Åos
)

607 
isSubÃt
 = 
Œue
;

609 ià(!
isSubÃt
) {

610 
CN‘Addr
 
»sŞved
;

611 
	`LookupHo¡
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
»sŞved
, 
çl£
);

612 
ÃtAddr
 = 
»sŞved
;

615 
	`LookupSubN‘
(
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
subN‘
);

617 ià(! (
isSubÃt
 ? 
subN‘
.
	`IsV®id
(è: 
ÃtAddr
.IsValid()) )

618 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_INVALID_IP_OR_SUBNET
, "Error: Invalid IP/Subnet");

620 ià(
¡rCommªd
 == "add")

622 ià(
isSubÃt
 ? 
node
.
bªmª
->
	`IsBªÃd
(
subN‘
è:‚ode.bªmª->IsBªÃd(
ÃtAddr
)) {

623 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NODE_ALREADY_ADDED
, "Error: IP/Subnet‡lready banned");

626 
št64_t
 
bªTime
 = 0;

627 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
())

628 
bªTime
 = 
»que¡
.
·¿ms
[2].
	`g‘_št64
();

630 
boŞ
 
absŞu‹
 = 
çl£
;

631 ià(
»que¡
.
·¿ms
[3].
	`isTrue
())

632 
absŞu‹
 = 
Œue
;

634 ià(
isSubÃt
) {

635 
node
.
bªmª
->
	`Bª
(
subN‘
, 
BªR—sÚMªu®lyAdded
, 
bªTime
, 
absŞu‹
);

636 ià(
node
.
cÚnmª
) {

637 
node
.
cÚnmª
->
	`DiscÚÃùNode
(
subN‘
);

640 
node
.
bªmª
->
	`Bª
(
ÃtAddr
, 
BªR—sÚMªu®lyAdded
, 
bªTime
, 
absŞu‹
);

641 ià(
node
.
cÚnmª
) {

642 
node
.
cÚnmª
->
	`DiscÚÃùNode
(
ÃtAddr
);

646 if(
¡rCommªd
 == "remove")

648 ià(!Ğ
isSubÃt
 ? 
node
.
bªmª
->
	`Unbª
(
subN‘
è:‚ode.bªmª->Unbª(
ÃtAddr
) )) {

649 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_INVALID_IP_OR_SUBNET
, "Error: Unban failed. Requested‡ddress/subnet was‚ot…reviously banned.");

652  
NuÎUniV®ue
;

653 
	}
}

655 
UniV®ue
 
	$li¡bªÃd
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

657 
RPCH–pMª
{"listbanned",

660 
RPCResuÉ
{RPCResuÉ::
Ty³
::
ARR
, "", "",

662 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

664 {
RPCResuÉ
::
Ty³
::
STR
, "address", ""},

665 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "banned_until", ""},

666 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "ban_created", ""},

667 {
RPCResuÉ
::
Ty³
::
STR
, "ban_reason", ""},

670 
RPCExam¶es
{

671 
	`H–pExam¶eCli
("listbanned", "")

672 + 
	`H–pExam¶eRpc
("listbanned", "")

674 }.
	`Check
(
»que¡
);

676 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

677 if(!
node
.
bªmª
) {

678 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, "Error: Ban database‚ot†oaded");

681 
bªm­_t
 
bªM­
;

682 
node
.
bªmª
->
	`G‘BªÃd
(
bªM­
);

684 
UniV®ue
 
	`bªÃdAdd»s£s
(UniV®ue::
VARR
);

685 cÚ¡‡uto& 
’Œy
 : 
bªM­
)

687 cÚ¡ 
CBªEÁry
& 
bªEÁry
 = 
’Œy
.
£cÚd
;

688 
UniV®ue
 
	`»c
(UniV®ue::
VOBJ
);

689 
»c
.
	`pushKV
("add»ss", 
’Œy
.
fœ¡
.
	`ToSŒšg
());

690 
»c
.
	`pushKV
("bªÃd_uÁ", 
bªEÁry
.
nBªUÁ
);

691 
»c
.
	`pushKV
("bª_ü—‹d", 
bªEÁry
.
nC»©eTime
);

692 
»c
.
	`pushKV
("bª_»asÚ", 
bªEÁry
.
	`bªR—sÚToSŒšg
());

694 
bªÃdAdd»s£s
.
	`push_back
(
»c
);

697  
bªÃdAdd»s£s
;

698 
	}
}

700 
UniV®ue
 
	$ş—rbªÃd
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

702 
RPCH–pMª
{"clearbanned",

705 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

706 
RPCExam¶es
{

707 
	`H–pExam¶eCli
("clearbanned", "")

708 + 
	`H–pExam¶eRpc
("clearbanned", "")

710 }.
	`Check
(
»que¡
);

711 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

712 ià(!
node
.
bªmª
) {

713 
throw
 
	`JSONRPCE¼Ü
(
RPC_DATABASE_ERROR
, "Error: Ban database‚ot†oaded");

716 
node
.
bªmª
->
	`CË¬BªÃd
();

718  
NuÎUniV®ue
;

719 
	}
}

721 
UniV®ue
 
	$£Š‘wÜkaùive
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

723 
RPCH–pMª
{"setnetworkactive",

726 {"¡©e", 
RPCArg
::
Ty³
::
BOOL
, RPCArg::
O±iÚ®
::
NO
, "trueoƒnable‚etworking, falseo disable"},

728 
RPCResuÉ
{RPCResuÉ::
Ty³
::
BOOL
, "", "The valuehat was…assed in"},

729 
RPCExam¶es
{""},

730 }.
	`Check
(
»que¡
);

732 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

733 ià(!
node
.
cÚnmª
) {

734 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

737 
node
.
cÚnmª
->
	`S‘N‘wÜkAùive
(
»que¡
.
·¿ms
[0].
	`g‘_boŞ
());

739  
node
.
cÚnmª
->
	`G‘N‘wÜkAùive
();

740 
	}
}

742 
UniV®ue
 
	$g‘nod—dd»s£s
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

744 
RPCH–pMª
{"getnodeaddresses",

747 {"couÁ", 
RPCArg
::
Ty³
::
NUM
, "1", "How mªy‡dd»s£ tØ»tuº. Lim™edØthsm®Ë¸oà" + 
	`ToSŒšg
(
ADDRMAN_GETADDR_MAX
è+ " o¸" + ToSŒšg(
ADDRMAN_GETADDR_MAX_PCT
) + "% of‡ll known‡ddresses."},

749 
RPCResuÉ
{

750 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

752 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

754 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "time", "Th" + 
UNIX_EPOCH_TIME
 + " of whenhe‚ode was†ast seen"},

755 {
RPCResuÉ
::
Ty³
::
NUM
, "services", "The services offered"},

756 {
RPCResuÉ
::
Ty³
::
STR
, "address", "The‡ddress ofhe‚ode"},

757 {
RPCResuÉ
::
Ty³
::
NUM
, "port", "The…ort ofhe‚ode"},

761 
RPCExam¶es
{

762 
	`H–pExam¶eCli
("getnodeaddresses", "8")

763 + 
	`H–pExam¶eRpc
("getnodeaddresses", "8")

765 }.
	`Check
(
»que¡
);

766 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

767 ià(!
node
.
cÚnmª
) {

768 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

771 
couÁ
 = 1;

772 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

773 
couÁ
 = 
»que¡
.
·¿ms
[0].
	`g‘_št
();

774 ià(
couÁ
 <= 0) {

775 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Address count out of„ange");

779 
¡d
::
veùÜ
<
CAdd»ss
> 
vAddr
 = 
node
.
cÚnmª
->
	`G‘Add»s£s
();

780 
UniV®ue
 
	`»t
(UniV®ue::
VARR
);

782 
add»ss_»tuº_couÁ
 = 
¡d
::
mš
<>(
couÁ
, 
vAddr
.
	`size
());

783 
i
 = 0; i < 
add»ss_»tuº_couÁ
; ++i) {

784 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

785 cÚ¡ 
CAdd»ss
& 
addr
 = 
vAddr
[
i
];

786 
obj
.
	`pushKV
("time", ()
addr
.
nTime
);

787 
obj
.
	`pushKV
("£rviûs", (
ušt64_t
)
addr
.
nS”viûs
);

788 
obj
.
	`pushKV
("add»ss", 
addr
.
	`ToSŒšgIP
());

789 
obj
.
	`pushKV
("pÜt", 
addr
.
	`G‘PÜt
());

790 
»t
.
	`push_back
(
obj
);

792  
»t
;

793 
	}
}

795 
	$Regi¡”N‘RPCCommªds
(
CRPCTabË
 &
t
)

798 cÚ¡ 
CRPCCommªd
 
commªds
[] =

801 { "ÃtwÜk", "g‘cÚÃùiÚcouÁ", &
g‘cÚÃùiÚcouÁ
, {} },

802 { "ÃtwÜk", "pšg", &
pšg
, {} },

803 { "ÃtwÜk", "g‘³”šfo", &
g‘³”šfo
, {} },

804 { "ÃtwÜk", "addnode", &
addnode
, {"node","command"} },

805 { "ÃtwÜk", "discÚÃùnode", &
discÚÃùnode
, {"address", "nodeid"} },

806 { "ÃtwÜk", "g‘addednodešfo", &
g‘addednodešfo
, {"node"} },

807 { "ÃtwÜk", "g‘Ã‰Ù®s", &
g‘Ã‰Ù®s
, {} },

808 { "ÃtwÜk", "g‘ÃtwÜkšfo", &
g‘ÃtwÜkšfo
, {} },

809 { "ÃtwÜk", "£tbª", &
£tbª
, {"subnet", "command", "bantime", "absolute"} },

810 { "ÃtwÜk", "li¡bªÃd", &
li¡bªÃd
, {} },

811 { "ÃtwÜk", "ş—rbªÃd", &
ş—rbªÃd
, {} },

812 { "ÃtwÜk", "£Š‘wÜkaùive", &
£Š‘wÜkaùive
, {"state"} },

813 { "ÃtwÜk", "g‘nod—dd»s£s", &
g‘nod—dd»s£s
, {"count"} },

817 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

818 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

819 
	}
}

	@protocol.h

6 #iâdeà
SYSCOIN_RPC_PROTOCOL_H


7 
	#SYSCOIN_RPC_PROTOCOL_H


	)

10 
	eHTTPStusCode


12 
	mHTTP_OK
 = 200,

13 
	mHTTP_BAD_REQUEST
 = 400,

14 
	mHTTP_UNAUTHORIZED
 = 401,

15 
	mHTTP_FORBIDDEN
 = 403,

16 
	mHTTP_NOT_FOUND
 = 404,

17 
	mHTTP_BAD_METHOD
 = 405,

18 
	mHTTP_INTERNAL_SERVER_ERROR
 = 500,

19 
	mHTTP_SERVICE_UNAVAILABLE
 = 503,

23 
	eRPCE¼ÜCode


28 
	mRPC_INVALID_REQUEST
 = -32600,

31 
	mRPC_METHOD_NOT_FOUND
 = -32601,

32 
	mRPC_INVALID_PARAMS
 = -32602,

35 
	mRPC_INTERNAL_ERROR
 = -32603,

36 
	mRPC_PARSE_ERROR
 = -32700,

39 
	mRPC_MISC_ERROR
 = -1,

40 
	mRPC_TYPE_ERROR
 = -3,

41 
	mRPC_INVALID_ADDRESS_OR_KEY
 = -5,

42 
	mRPC_OUT_OF_MEMORY
 = -7,

43 
	mRPC_INVALID_PARAMETER
 = -8,

44 
	mRPC_DATABASE_ERROR
 = -20,

45 
	mRPC_DESERIALIZATION_ERROR
 = -22,

46 
	mRPC_VERIFY_ERROR
 = -25,

47 
	mRPC_VERIFY_REJECTED
 = -26,

48 
	mRPC_VERIFY_ALREADY_IN_CHAIN
 = -27,

49 
	mRPC_IN_WARMUP
 = -28,

50 
	mRPC_METHOD_DEPRECATED
 = -32,

53 
	mRPC_TRANSACTION_ERROR
 = 
RPC_VERIFY_ERROR
,

54 
	mRPC_TRANSACTION_REJECTED
 = 
RPC_VERIFY_REJECTED
,

55 
	mRPC_TRANSACTION_ALREADY_IN_CHAIN
ğ
RPC_VERIFY_ALREADY_IN_CHAIN
,

58 
	mRPC_CLIENT_NOT_CONNECTED
 = -9,

59 
	mRPC_CLIENT_IN_INITIAL_DOWNLOAD
 = -10,

60 
	mRPC_CLIENT_NODE_ALREADY_ADDED
 = -23,

61 
	mRPC_CLIENT_NODE_NOT_ADDED
 = -24,

62 
	mRPC_CLIENT_NODE_NOT_CONNECTED
 = -29,

63 
	mRPC_CLIENT_INVALID_IP_OR_SUBNET
 = -30,

64 
	mRPC_CLIENT_P2P_DISABLED
 = -31,

67 
	mRPC_CLIENT_MEMPOOL_DISABLED
 = -33,

70 
	mRPC_WALLET_ERROR
 = -4,

71 
	mRPC_WALLET_INSUFFICIENT_FUNDS
 = -6,

72 
	mRPC_WALLET_INVALID_LABEL_NAME
 = -11,

73 
	mRPC_WALLET_KEYPOOL_RAN_OUT
 = -12,

74 
	mRPC_WALLET_UNLOCK_NEEDED
 = -13,

75 
	mRPC_WALLET_PASSPHRASE_INCORRECT
 = -14,

76 
	mRPC_WALLET_WRONG_ENC_STATE
 = -15,

77 
	mRPC_WALLET_ENCRYPTION_FAILED
 = -16,

78 
	mRPC_WALLET_ALREADY_UNLOCKED
 = -17,

79 
	mRPC_WALLET_NOT_FOUND
 = -18,

80 
	mRPC_WALLET_NOT_SPECIFIED
 = -19,

83 
	mRPC_WALLET_INVALID_ACCOUNT_NAME
 = 
RPC_WALLET_INVALID_LABEL_NAME
,

86 
	mRPC_FORBIDDEN_BY_SAFE_MODE
 = -2,

	@rawtransaction.cpp

6 
	~<chaš.h
>

7 
	~<cošs.h
>

8 
	~<cÚ£nsus/v®id©iÚ.h
>

9 
	~<cÜe_io.h
>

10 
	~<šdex/txšdex.h
>

11 
	~<key_io.h
>

12 
	~<m”kËblock.h
>

13 
	~<node/coš.h
>

14 
	~<node/cÚ‹xt.h
>

15 
	~<node/psbt.h
>

16 
	~<node/Œª§ùiÚ.h
>

17 
	~<pŞicy/pŞicy.h
>

18 
	~<pŞicy/rbf.h
>

19 
	~<´im™ives/Œª§ùiÚ.h
>

20 
	~<psbt.h
>

21 
	~<¿ndom.h
>

22 
	~<½c/blockchaš.h
>

23 
	~<½c/¿wŒª§ùiÚ_ut.h
>

24 
	~<½c/£rv”.h
>

25 
	~<½c/ut.h
>

26 
	~<süt/süt.h
>

27 
	~<süt/sign.h
>

28 
	~<süt/signšg´ovid”.h
>

29 
	~<süt/¡ªd¬d.h
>

30 
	~<ušt256.h
>

31 
	~<ut/mÚey¡r.h
>

32 
	~<ut/¡»ncodšgs.h
>

33 
	~<ut/¡ršg.h
>

34 
	~<v®id©iÚ.h
>

35 
	~<v®id©iÚš‹rçû.h
>

38 
	~<num”ic
>

39 
	~<¡dšt.h
>

41 
	~<univ®ue.h
>

43 
	$TxToJSON
(cÚ¡ 
CT¿n§ùiÚ
& 
tx
, cÚ¡ 
ušt256
 
hashBlock
, 
UniV®ue
& 
’Œy
)

50 
	`TxToUniv
(
tx
, 
	`ušt256
(), 
’Œy
, 
Œue
, 
	`RPCS”Ÿliz©iÚFÏgs
());

52 ià(!
hashBlock
.
	`IsNuÎ
()) {

53 
	`LOCK
(
cs_maš
);

55 
’Œy
.
	`pushKV
("blockhash", 
hashBlock
.
	`G‘Hex
());

56 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
hashBlock
);

57 ià(
pšdex
) {

58 ià(::
	`ChašAùive
().
	`CÚšs
(
pšdex
)) {

59 
’Œy
.
	`pushKV
("cÚfœm©iÚs", 1 + ::
	`ChašAùive
().
	`Height
(è- 
pšdex
->
nHeight
);

60 
’Œy
.
	`pushKV
("time", 
pšdex
->
	`G‘BlockTime
());

61 
’Œy
.
	`pushKV
("blocktime", 
pšdex
->
	`G‘BlockTime
());

64 
’Œy
.
	`pushKV
("confirmations", 0);

67 
	}
}

69 
UniV®ue
 
	$g‘¿wŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

71 
RPCH–pMª
{

86 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id"},

87 {"v”bo£", 
RPCArg
::
Ty³
::
BOOL
, "false", "If false,„eturn‡ string, otherwise„eturn‡ json object"},

88 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "The block in whicho†ook forheransaction"},

91 
RPCResuÉ
{"if verbose is‚ot set or seto false",

92 
RPCResuÉ
::
Ty³
::
STR
, "data", "The serialized, hex-encoded data for 'txid'"

94 
RPCResuÉ
{"if verbose is setorue",

95 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

97 {
RPCResuÉ
::
Ty³
::
BOOL
, "in_active_chain", "Whether specified block is inhe‡ctive chain or‚ot (only…resent withƒxplicit \"blockhash\"‡rgument)"},

98 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The serialized, hex-encoded data for 'txid'"},

99 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction id (same‡s…rovided)"},

100 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "Theransaction hash (differs fromxid for witnessransactions)"},

101 {
RPCResuÉ
::
Ty³
::
NUM
, "size", "The serializedransaction size"},

102 {
RPCResuÉ
::
Ty³
::
NUM
, "vsize", "The virtualransaction size (differs from size for witnessransactions)"},

103 {
RPCResuÉ
::
Ty³
::
NUM
, "weight", "Theransaction's weight (between vsize*4-3‡nd vsize*4)"},

104 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The version"},

105 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "locktime", "The†ockime"},

106 {
RPCResuÉ
::
Ty³
::
ARR
, "vin", "",

108 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

110 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction id"},

111 {
RPCResuÉ
::
Ty³
::
STR
, "vout", ""},

112 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptSig", "The script",

114 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "asm"},

115 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "hex"},

117 {
RPCResuÉ
::
Ty³
::
NUM
, "sequence", "The script sequence‚umber"},

118 {
RPCResuÉ
::
Ty³
::
ARR
, "txinwitness", "",

120 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "hex-encoded witness data (if‡ny)"},

124 {
RPCResuÉ
::
Ty³
::
ARR
, "vout", "",

126 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

128 {
RPCResuÉ
::
Ty³
::
NUM
, "v®ue", "Thv®uš " + 
CURRENCY_UNIT
},

129 {
RPCResuÉ
::
Ty³
::
NUM
, "n", "index"},

130 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptPubKey", "",

132 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "the‡sm"},

133 {
RPCResuÉ
::
Ty³
::
STR
, "hex", "the hex"},

134 {
RPCResuÉ
::
Ty³
::
NUM
, "reqSigs", "The„equired sigs"},

135 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

136 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "",

138 {
RPCResuÉ
::
Ty³
::
STR
, "address", "syscoin‡ddress"},

143 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "blockhash", "the block hash"},

144 {
RPCResuÉ
::
Ty³
::
NUM
, "confirmations", "The confirmations"},

145 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "blocktime", "Thblockimex´es£d iÀ" + 
UNIX_EPOCH_TIME
},

146 {
RPCResuÉ
::
Ty³
::
NUM
, "time", "Same‡s \"blocktime\""},

150 
RPCExam¶es
{

151 
	`H–pExam¶eCli
("getrawtransaction", "\"mytxid\"")

152 + 
	`H–pExam¶eCli
("getrawtransaction", "\"mytxid\"rue")

153 + 
	`H–pExam¶eRpc
("getrawtransaction", "\"mytxid\",rue")

154 + 
	`H–pExam¶eCli
("getrawtransaction", "\"mytxid\" false \"myblockhash\"")

155 + 
	`H–pExam¶eCli
("getrawtransaction", "\"mytxid\"rue \"myblockhash\"")

157 }.
	`Check
(
»que¡
);

159 
boŞ
 
š_aùive_chaš
 = 
Œue
;

160 
ušt256
 
hash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[0], "parameter 1");

161 
CBlockIndex
* 
blockšdex
 = 
nuÎ±r
;

163 ià(
hash
 =ğ
	`P¬ams
().
	`G’esisBlock
().
hashM”kËRoÙ
) {

165 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "The genesis block coinbase is‚ot considered‡n ordinaryransaction‡nd cannot be„etrieved");

169 
boŞ
 
fV”bo£
 = 
çl£
;

170 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

171 
fV”bo£
 = 
»que¡
.
·¿ms
[1].
	`isNum
(è? (»que¡.·¿ms[1].
	`g‘_št
(è!ğ0è:„eque¡.·¿ms[1].
	`g‘_boŞ
();

174 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

175 
	`LOCK
(
cs_maš
);

177 
ušt256
 
blockhash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "parameter 3");

178 
blockšdex
 = 
	`LookupBlockIndex
(
blockhash
);

179 ià(!
blockšdex
) {

180 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block hash‚ot found");

182 
š_aùive_chaš
 = ::
	`ChašAùive
().
	`CÚšs
(
blockšdex
);

185 
ušt32_t
 
nBlockHeight
;

186 if(
pblockšdexdb
->
	`R—dBlockHeight
(
hash
, 
nBlockHeight
)){

187 
	`LOCK
(
cs_maš
);

188 
blockšdex
 = ::
	`ChašAùive
()[
nBlockHeight
];

193 
boŞ
 
f_txšdex_»ady
 = 
çl£
;

194 ià(
g_txšdex
 && !
blockšdex
) {

195 
f_txšdex_»ady
 = 
g_txšdex
->
	`BlockUÁSynûdToCu¼’tChaš
();

198 
CT¿n§ùiÚRef
 
tx
;

199 
ušt256
 
hash_block
;

200 ià(!
	`G‘T¿n§ùiÚ
(
hash
, 
tx
, 
	`P¬ams
().
	`G‘CÚ£nsus
(), 
hash_block
, 
blockšdex
)) {

201 
¡d
::
¡ršg
 
”rmsg
;

202 ià(
blockšdex
) {

203 ià(!(
blockšdex
->
nStus
 & 
BLOCK_HAVE_DATA
)) {

204 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "Block‚ot‡vailable");

206 
”rmsg
 = "No suchransaction found inhe…rovided block";

207 } ià(!
g_txšdex
) {

208 
”rmsg
 = "No such mempoolransaction. Use -txindex or…rovide‡ block hashoƒnable blockchainransaction queries";

209 } ià(!
f_txšdex_»ady
) {

210 
”rmsg
 = "No such mempoolransaction. Blockchainransactions‡re still inhe…rocess of being indexed";

212 
”rmsg
 = "No such mempool or blockchainransaction";

214 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
”rmsg
 + ". Use gettransaction for walletransactions.");

217 ià(!
fV”bo£
) {

218  
	`EncodeHexTx
(*
tx
, 
	`RPCS”Ÿliz©iÚFÏgs
());

221 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

222 ià(
blockšdex
è
»suÉ
.
	`pushKV
("š_aùive_chaš", 
š_aùive_chaš
);

223 
	`TxToJSON
(*
tx
, 
hash_block
, 
»suÉ
);

224  
»suÉ
;

225 
	}
}

226 
UniV®ue
 
	$g‘txouroof
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

228 
RPCH–pMª
{"gettxoutproof",

235 {"txids", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "Thexidso filter",

237 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "Aransaction hash"},

240 {"blockhash", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "If specified,†ooks forxid inhe block withhis hash"},

242 
RPCResuÉ
{

243 
RPCResuÉ
::
Ty³
::
STR
, "data", "A stringhat is‡ serialized, hex-encoded data forhe…roof."

245 
RPCExam¶es
{""},

246 }.
	`Check
(
»que¡
);

248 
¡d
::
£t
<
ušt256
> 
£tTxids
;

249 
ušt256
 
ÚeTxid
;

250 
UniV®ue
 
txids
 = 
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
();

251 
idx
 = 0; idx < 
txids
.
	`size
(); idx++) {

252 cÚ¡ 
UniV®ue
& 
txid
 = 
txids
[
idx
];

253 
ušt256
 
	`hash
(
	`P¬£HashV
(
txid
, "txid"));

254 ià(
£tTxids
.
	`couÁ
(
hash
))

255 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
¡d
::
	`¡ršg
("Inv®id…¬am‘”, du¶iÿ‹dxid: ")+
txid
.
	`g‘_¡r
());

256 
£tTxids
.
	`š£¹
(
hash
);

257 
ÚeTxid
 = 
hash
;

260 
CBlockIndex
* 
pblockšdex
 = 
nuÎ±r
;

261 
ušt256
 
hashBlock
;

262 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

263 
	`LOCK
(
cs_maš
);

264 
hashBlock
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "blockhash");

265 
pblockšdex
 = 
	`LookupBlockIndex
(
hashBlock
);

266 ià(!
pblockšdex
) {

267 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found");

270 
	`LOCK
(
cs_maš
);

273 cÚ¡‡uto& 
tx
 : 
£tTxids
) {

274 cÚ¡ 
Coš
& 
coš
 = 
	`AcûssByTxid
(::
	`Chaš¡©eAùive
().
	`CošsT
(), 
tx
);

275 ià(!
coš
.
	`IsS³Á
()) {

276 
pblockšdex
 = ::
	`ChašAùive
()[
coš
.
nHeight
];

283 ià(
g_txšdex
 && !
pblockšdex
) {

284 
g_txšdex
->
	`BlockUÁSynûdToCu¼’tChaš
();

287 
	`LOCK
(
cs_maš
);

289 ià(
pblockšdex
 =ğ
nuÎ±r
)

291 
CT¿n§ùiÚRef
 
tx
;

292 ià(!
	`G‘T¿n§ùiÚ
(
ÚeTxid
, 
tx
, 
	`P¬ams
().
	`G‘CÚ£nsus
(), 
hashBlock
è|| hashBlock.
	`IsNuÎ
())

293 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Transaction‚ot yet in block");

294 
pblockšdex
 = 
	`LookupBlockIndex
(
hashBlock
);

295 ià(!
pblockšdex
) {

296 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Transaction index corrupt");

300 
CBlock
 
block
;

301 if(!
	`R—dBlockFromDisk
(
block
, 
pblockšdex
, 
	`P¬ams
().
	`G‘CÚ£nsus
()))

302 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Can't„ead block from disk");

304 
ÁxFound
 = 0;

305 cÚ¡‡uto& 
tx
 : 
block
.
vtx
)

306 ià(
£tTxids
.
	`couÁ
(
tx
->
	`G‘Hash
()))

307 
ÁxFound
++;

308 ià(
ÁxFound
 !ğ
£tTxids
.
	`size
())

309 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Not‡llransactions found in specified or„etrieved block");

311 
CD©aSŒ—m
 
	`ssMB
(
SER_NETWORK
, 
PROTOCOL_VERSION
 | 
SERIALIZE_TRANSACTION_NO_WITNESS
);

312 
CM”kËBlock
 
	`mb
(
block
, 
£tTxids
);

313 
ssMB
 << 
mb
;

314 
¡d
::
¡ršg
 
¡rHex
 = 
	`HexSŒ
(
ssMB
.
	`begš
(), ssMB.
	`’d
());

315  
¡rHex
;

316 
	}
}

318 
UniV®ue
 
	$v”ifytxouroof
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

320 
RPCH–pMª
{"verifytxoutproof",

324 {"´oof", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The hex-encoded…roof generated by gettxoutproof"},

326 
RPCResuÉ
{

327 
RPCResuÉ
::
Ty³
::
ARR
, "", "",

329 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Thexid(s) whichhe…roof commitso, orƒmpty‡rray ifhe…roof can‚ot be validated."},

332 
RPCExam¶es
{""},

333 }.
	`Check
(
»que¡
);

335 
CD©aSŒ—m
 
	`ssMB
(
	`P¬£HexV
(
»que¡
.
·¿ms
[0], "´oof"), 
SER_NETWORK
, 
PROTOCOL_VERSION
 | 
SERIALIZE_TRANSACTION_NO_WITNESS
);

336 
CM”kËBlock
 
m”kËBlock
;

337 
ssMB
 >> 
m”kËBlock
;

339 
UniV®ue
 
	`»s
(UniV®ue::
VARR
);

341 
¡d
::
veùÜ
<
ušt256
> 
vM©ch
;

342 
¡d
::
veùÜ
<> 
vIndex
;

343 ià(
m”kËBlock
.
txn
.
	`ExŒaùM©ches
(
vM©ch
, 
vIndex
è!ğm”kËBlock.
h—d”
.
hashM”kËRoÙ
)

344  
»s
;

346 
	`LOCK
(
cs_maš
);

348 cÚ¡ 
CBlockIndex
* 
pšdex
 = 
	`LookupBlockIndex
(
m”kËBlock
.
h—d”
.
	`G‘Hash
());

349 ià(!
pšdex
 || !::
	`ChašAùive
().
	`CÚšs
Õšdexè||…šdex->
nTx
 == 0) {

350 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Block‚ot found in chain");

354 ià(
pšdex
->
nTx
 =ğ
m”kËBlock
.
txn
.
	`G‘NumT¿n§ùiÚs
()) {

355 cÚ¡ 
ušt256
& 
hash
 : 
vM©ch
) {

356 
»s
.
	`push_back
(
hash
.
	`G‘Hex
());

360  
»s
;

361 
	}
}

363 
UniV®ue
 
	$ü—‹¿wŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

365 
RPCH–pMª
{"createrawtransaction",

372 {"šputs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The inputs",

374 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

376 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id"},

377 {"vout", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The output‚umber"},

378 {"£qu’û", 
RPCArg
::
Ty³
::
NUM
, "depends onhe value ofhe 'replaceable'‡nd 'locktime'‡rguments", "The sequence‚umber"},

383 {"ouuts", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The outputs (key-value…airs), where‚one ofhe keys‡re duplicated.\n"

388 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

390 {"add»ss", 
RPCArg
::
Ty³
::
AMOUNT
, RPCArg::
O±iÚ®
::
NO
, "A key-v®u·œ. Thkey (¡ršgèi thsyscoš‡dd»ss,hv®u(æßˆÜ sŒšgèi thamouÁ iÀ" + 
CURRENCY_UNIT
},

393 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

395 {"d©a", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "A key-value…air. The key must be \"data\",he value is hex-encoded data"},

400 {"locktime", 
RPCArg
::
Ty³
::
NUM
, "0", "Raw†ocktime. Non-0 value‡lso†ocktime-activates inputs"},

401 {"»¶aûabË", 
RPCArg
::
Ty³
::
BOOL
, "false", "Markshisransaction‡s BIP125-replaceable.\n"

404 
RPCResuÉ
{

405 
RPCResuÉ
::
Ty³
::
STR_HEX
, "transaction", "hex string ofheransaction"

407 
RPCExam¶es
{

408 
	`H–pExam¶eCli
("createrawtransaction", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\" \"[{\\\"address\\\":0.01}]\"")

409 + 
	`H–pExam¶eCli
("createrawtransaction", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\" \"[{\\\"data\\\":\\\"00010203\\\"}]\"")

410 + 
	`H–pExam¶eRpc
("createrawtransaction", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\", \"[{\\\"address\\\":0.01}]\"")

411 + 
	`H–pExam¶eRpc
("createrawtransaction", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\", \"[{\\\"data\\\":\\\"00010203\\\"}]\"")

413 }.
	`Check
(
»que¡
);

415 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {

416 
UniV®ue
::
VARR
,

417 
	`UniV®ueTy³
(),

418 
UniV®ue
::
VNUM
,

419 
UniV®ue
::
VBOOL


420 }, 
Œue


423 
boŞ
 
rbf
 = 
çl£
;

424 ià(!
»que¡
.
·¿ms
[3].
	`isNuÎ
()) {

425 
rbf
 = 
»que¡
.
·¿ms
[3].
	`isTrue
();

427 
CMubËT¿n§ùiÚ
 
¿wTx
 = 
	`CÚ¡ruùT¿n§ùiÚ
(
»que¡
.
·¿ms
[0],„eque¡.·¿ms[1],„eque¡.·¿ms[2], 
rbf
);

429  
	`EncodeHexTx
(
	`CT¿n§ùiÚ
(
¿wTx
));

430 
	}
}

432 
UniV®ue
 
	$decod”awŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

434 
RPCH–pMª
{"decoderawtransaction",

437 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction hex string"},

438 {"isw™Ãss", 
RPCArg
::
Ty³
::
BOOL
, "depends on heuristicests", "Whetherheransaction hex is‡ serialized witnessransaction.\n"

446 
RPCResuÉ
{

447 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

449 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction id"},

450 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hash", "Theransaction hash (differs fromxid for witnessransactions)"},

451 {
RPCResuÉ
::
Ty³
::
NUM
, "size", "Theransaction size"},

452 {
RPCResuÉ
::
Ty³
::
NUM
, "vsize", "The virtualransaction size (differs from size for witnessransactions)"},

453 {
RPCResuÉ
::
Ty³
::
NUM
, "weight", "Theransaction's weight (between vsize*4 - 3‡nd vsize*4)"},

454 {
RPCResuÉ
::
Ty³
::
NUM
, "version", "The version"},

455 {
RPCResuÉ
::
Ty³
::
NUM_TIME
, "locktime", "The†ockime"},

456 {
RPCResuÉ
::
Ty³
::
ARR
, "vin", "",

458 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

460 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction id"},

461 {
RPCResuÉ
::
Ty³
::
NUM
, "vout", "The output‚umber"},

462 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptSig", "The script",

464 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "asm"},

465 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "hex"},

467 {
RPCResuÉ
::
Ty³
::
ARR
, "txinwitness", "",

469 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "hex-encoded witness data (if‡ny)"},

471 {
RPCResuÉ
::
Ty³
::
NUM
, "sequence", "The script sequence‚umber"},

474 {
RPCResuÉ
::
Ty³
::
ARR
, "vout", "",

476 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

478 {
RPCResuÉ
::
Ty³
::
NUM
, "v®ue", "Thv®uš " + 
CURRENCY_UNIT
},

479 {
RPCResuÉ
::
Ty³
::
NUM
, "n", "index"},

480 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptPubKey", "",

482 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "the‡sm"},

483 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "the hex"},

484 {
RPCResuÉ
::
Ty³
::
NUM
, "reqSigs", "The„equired sigs"},

485 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

486 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "",

488 {
RPCResuÉ
::
Ty³
::
STR
, "address", "syscoin‡ddress"},

495 
RPCExam¶es
{

496 
	`H–pExam¶eCli
("decoderawtransaction", "\"hexstring\"")

497 + 
	`H–pExam¶eRpc
("decoderawtransaction", "\"hexstring\"")

499 }.
	`Check
(
»que¡
);

501 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VBOOL
});

503 
CMubËT¿n§ùiÚ
 
mtx
;

505 
boŞ
 
Œy_w™Ãss
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
(è? 
Œue
 :„eque¡.·¿ms[1].
	`g‘_boŞ
();

506 
boŞ
 
Œy_no_w™Ãss
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
(è? 
Œue
 : !»que¡.·¿ms[1].
	`g‘_boŞ
();

508 ià(!
	`DecodeHexTx
(
mtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
Œy_no_w™Ãss
, 
Œy_w™Ãss
)) {

509 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "TX decode failed");

512 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

513 
	`TxToUniv
(
	`CT¿n§ùiÚ
(
¡d
::
	`move
(
mtx
)), 
	`ušt256
(), 
»suÉ
, 
çl£
);

515  
»suÉ
;

516 
	}
}

518 
	g¡d
::
¡ršg
 
	$G‘AÎOuutTy³s
()

520 
¡d
::
¡ršg
 
»t
;

521 
i
 = 
TX_NONSTANDARD
; i <ğ
TX_WITNESS_UNKNOWN
; ++i) {

522 ià(
i
 !ğ
TX_NONSTANDARD
è
»t
 += ", ";

523 
»t
 +ğ
	`G‘TxnOuutTy³
(
¡©ic_ÿ¡
<
txnou‰y³
>(
i
));

525  
»t
;

526 
	}
}

528 
UniV®ue
 
	$decodesüt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

530 
RPCH–pMª
{"decodescript",

533 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "the hex-encoded script"},

535 
RPCResuÉ
{

536 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

538 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "Script…ublic key"},

539 {
RPCResuÉ
::
Ty³
::
STR
, "ty³", "Thouuˆty³ (e.g. "+
	`G‘AÎOuutTy³s
()+")"},

540 {
RPCResuÉ
::
Ty³
::
NUM
, "reqSigs", "The„equired signatures"},

541 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "",

543 {
RPCResuÉ
::
Ty³
::
STR
, "address", "syscoin‡ddress"},

545 {
RPCResuÉ
::
Ty³
::
STR
, "p2sh", "address of P2SH script wrappinghis„edeem script (not„eturned ifhe script is‡lready‡ P2SH)"},

546 {
RPCResuÉ
::
Ty³
::
OBJ
, "segwit", "Result of‡ witness script…ublic key wrappinghis„edeem script (not„eturned ifhe script is‡ P2SH or witness)",

548 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "String„epresentation ofhe script…ublic key"},

549 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "Hex string ofhe script…ublic key"},

550 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype ofhe script…ublic key (e.g. witness_v0_keyhash or witness_v0_scripthash)"},

551 {
RPCResuÉ
::
Ty³
::
NUM
, "reqSigs", "The„equired signatures (always 1)"},

552 {
RPCResuÉ
::
Ty³
::
ARR
, "addresses", "(always†ength 1)",

554 {
RPCResuÉ
::
Ty³
::
STR
, "address", "segwit‡ddress"},

556 {
RPCResuÉ
::
Ty³
::
STR
, "p2sh-segwit", "address ofhe P2SH script wrappinghis witness„edeem script"},

560 
RPCExam¶es
{

561 
	`H–pExam¶eCli
("decodescript", "\"hexstring\"")

562 + 
	`H–pExam¶eRpc
("decodescript", "\"hexstring\"")

564 }.
	`Check
(
»que¡
);

566 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
});

568 
UniV®ue
 
	`r
(UniV®ue::
VOBJ
);

569 
CSüt
 
süt
;

570 ià(
»que¡
.
·¿ms
[0].
	`g‘_¡r
().
	`size
() > 0){

571 
¡d
::
veùÜ
<> 
	`sütD©a
(
	`P¬£HexV
(
»que¡
.
·¿ms
[0], "argument"));

572 
süt
 = 
	`CSüt
(
sütD©a
.
	`begš
(), sütD©a.
	`’d
());

576 
	`SütPubKeyToUniv
(
süt
, 
r
, 
çl£
);

578 
UniV®ue
 
ty³
;

579 
ty³
 = 
	`fšd_v®ue
(
r
, "type");

581 ià(
ty³
.
	`isSŒ
(è&&y³.
	`g‘_¡r
() != "scripthash") {

584 
r
.
	`pushKV
("p2sh", 
	`EncodeDe¡š©iÚ
(
	`SütHash
(
süt
)));

587 ià(
ty³
.
	`g‘_¡r
() == "pubkey" ||ype.get_str() == "pubkeyhash" ||ype.get_str() == "multisig" ||ype.get_str() == "nonstandard") {

588 
¡d
::
veùÜ
<¡d::veùÜ<>> 
sŞutiÚs_d©a
;

589 
txnou‰y³
 
which_ty³
 = 
	`SŞv”
(
süt
, 
sŞutiÚs_d©a
);

592 ià((
which_ty³
 =ğ
TX_PUBKEY
è|| (which_ty³ =ğ
TX_MULTISIG
)) {

593 cÚ¡‡uto& 
sŞutiÚ
 : 
sŞutiÚs_d©a
) {

594 ià((
sŞutiÚ
.
	`size
(è!ğ1è&& !
	`CPubKey
(sŞutiÚ).
	`IsCom´es£d
()) {

595  
r
;

599 
UniV®ue
 
	`¤
(UniV®ue::
VOBJ
);

600 
CSüt
 
£gw™Sü
;

601 ià(
which_ty³
 =ğ
TX_PUBKEY
) {

602 
£gw™Sü
 = 
	`G‘SütFÜDe¡š©iÚ
(
	`W™ÃssV0KeyHash
(
	`Hash160
(
sŞutiÚs_d©a
[0].
	`begš
(), sŞutiÚs_d©a[0].
	`’d
())));

603 } ià(
which_ty³
 =ğ
TX_PUBKEYHASH
) {

604 
£gw™Sü
 = 
	`G‘SütFÜDe¡š©iÚ
(
	`W™ÃssV0KeyHash
(
sŞutiÚs_d©a
[0]));

608 
£gw™Sü
 = 
	`G‘SütFÜDe¡š©iÚ
(
	`W™ÃssV0SütHash
(
süt
));

610 
	`SütPubKeyToUniv
(
£gw™Sü
, 
¤
, 
Œue
);

611 
¤
.
	`pushKV
("p2sh-£gw™", 
	`EncodeDe¡š©iÚ
(
	`SütHash
(
£gw™Sü
)));

612 
r
.
	`pushKV
("£gw™", 
¤
);

616  
r
;

617 
	}
}

619 
UniV®ue
 
	$combš”awŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

621 
RPCH–pMª
{"combinerawtransaction",

626 {"txs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The hex strings of…artially signedransactions",

628 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "Aransaction hash"},

632 
RPCResuÉ
{

633 
RPCResuÉ
::
Ty³
::
STR
, "", "The hex-encoded„awransaction with signature(s)"

635 
RPCExam¶es
{

636 
	`H–pExam¶eCli
("combš”awŒª§ùiÚ", 
R
"('["
myhex1
", "
myhex2
", "
myhex3
"]')")

638 }.
	`Check
(
»que¡
);

641 
UniV®ue
 
txs
 = 
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
();

642 
¡d
::
veùÜ
<
CMubËT¿n§ùiÚ
> 
	`txV¬ŸÁs
(
txs
.
	`size
());

644 
idx
 = 0; idx < 
txs
.
	`size
(); idx++) {

645 ià(!
	`DecodeHexTx
(
txV¬ŸÁs
[
idx
], 
txs
[idx].
	`g‘_¡r
(), 
Œue
)) {

646 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed fÜx %d", 
idx
));

650 ià(
txV¬ŸÁs
.
	`em±y
()) {

651 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Missingransactions");

656 
CMubËT¿n§ùiÚ
 
	`m”gedTx
(
txV¬ŸÁs
[0]);

659 
CCošsV›w
 
v›wDummy
;

660 
CCošsV›wCache
 
	`v›w
(&
v›wDummy
);

662 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

663 
	`LOCK
(
cs_maš
);

664 
	`LOCK
(
mempoŞ
.
cs
);

665 
CCošsV›wCache
 &
v›wChaš
 = ::
	`Chaš¡©eAùive
().
	`CošsT
();

666 
CCošsV›wMemPoŞ
 
	`v›wMempoŞ
(&
v›wChaš
, 
mempoŞ
);

667 
v›w
.
	`S‘Back’d
(
v›wMempoŞ
);

669 cÚ¡ 
CTxIn
& 
txš
 : 
m”gedTx
.
vš
) {

670 
v›w
.
	`AcûssCoš
(
txš
.
´evout
);

673 
v›w
.
	`S‘Back’d
(
v›wDummy
);

678 cÚ¡ 
CT¿n§ùiÚ
 
	`txCÚ¡
(
m”gedTx
);

680 
i
 = 0; i < 
m”gedTx
.
vš
.
	`size
(); i++) {

681 
CTxIn
& 
txš
 = 
m”gedTx
.
vš
[
i
];

682 cÚ¡ 
Coš
& 
coš
 = 
v›w
.
	`AcûssCoš
(
txš
.
´evout
);

683 ià(
coš
.
	`IsS³Á
()) {

684 
throw
 
	`JSONRPCE¼Ü
(
RPC_VERIFY_ERROR
, "Input‚ot found or‡lready spent");

686 
SigÇtu»D©a
 
sigd©a
;

689 cÚ¡ 
CMubËT¿n§ùiÚ
& 
txv
 : 
txV¬ŸÁs
) {

690 ià(
txv
.
vš
.
	`size
(è> 
i
) {

691 
sigd©a
.
	`M”geSigÇtu»D©a
(
	`D©aFromT¿n§ùiÚ
(
txv
, 
i
, 
coš
.
out
));

694 
	`ProduûSigÇtu»
(
DUMMY_SIGNING_PROVIDER
, 
	`MubËT¿n§ùiÚSigÇtu»C»©Ü
(&
m”gedTx
, 
i
, 
coš
.
out
.
nV®ue
, 1), coš.out.
sütPubKey
, 
sigd©a
);

696 
	`Upd©eIÅut
(
txš
, 
sigd©a
);

699  
	`EncodeHexTx
(
	`CT¿n§ùiÚ
(
m”gedTx
));

700 
	}
}

702 
UniV®ue
 
	$sigÄawŒª§ùiÚw™hkey
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

704 
RPCH–pMª
{"signrawtransactionwithkey",

711 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "Theransaction hex string"},

712 {"´ivkeys", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The base58-encoded…rivate keys for signing",

714 {"´iv©ekey", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "private key in base58-encoding"},

717 {"´evtxs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "The…revious dependentransaction outputs",

719 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

721 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id"},

722 {"vout", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The output‚umber"},

723 {"sütPubKey", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "script key"},

724 {"»d“mSüt", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "(required for P2SH)„edeem script"},

725 {"w™ÃssSüt", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, "(required for P2WSH or P2SH-P2WSH) witness script"},

726 {"amouÁ", 
RPCArg
::
Ty³
::
AMOUNT
, RPCArg::
O±iÚ®
::
OMITTED
, "(required for Segwit inputs)he‡mount spent"},

731 {"sighashty³", 
RPCArg
::
Ty³
::
STR
, "ALL", "The signature hashype. Must be one of:\n"

740 
RPCResuÉ
{

741 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

743 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex-encoded„awransaction with signature(s)"},

744 {
RPCResuÉ
::
Ty³
::
BOOL
, "complete", "Ifheransaction has‡ complete set of signatures"},

745 {
RPCResuÉ
::
Ty³
::
ARR
, "errors", "Script verificationƒrrors (ifhere‡re‡ny)",

747 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

749 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "The hash ofhe„eferenced,…reviousransaction"},

750 {
RPCResuÉ
::
Ty³
::
NUM
, "vout", "The index ofhe outputo spent‡nd used‡s input"},

751 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "scriptSig", "The hex-encoded signature script"},

752 {
RPCResuÉ
::
Ty³
::
NUM
, "sequence", "Script sequence‚umber"},

753 {
RPCResuÉ
::
Ty³
::
STR
, "error", "Verification or signingƒrror„elatedohe input"},

758 
RPCExam¶es
{

759 
	`H–pExam¶eCli
("signrawtransactionwithkey", "\"myhex\" \"[\\\"key1\\\",\\\"key2\\\"]\"")

760 + 
	`H–pExam¶eRpc
("signrawtransactionwithkey", "\"myhex\", \"[\\\"key1\\\",\\\"key2\\\"]\"")

762 }.
	`Check
(
»que¡
);

764 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VARR
, UniV®ue::VARR, UniV®ue::VSTR}, 
Œue
);

766 
CMubËT¿n§ùiÚ
 
mtx
;

767 ià(!
	`DecodeHexTx
(
mtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
Œue
)) {

768 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "TX decode failed");

771 
FÏbËSignšgProvid”
 
key¡Üe
;

772 cÚ¡ 
UniV®ue
& 
keys
 = 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
();

773 
idx
 = 0; idx < 
keys
.
	`size
(); ++idx) {

774 
UniV®ue
 
k
 = 
keys
[
idx
];

775 
CKey
 
key
 = 
	`DecodeSeü‘
(
k
.
	`g‘_¡r
());

776 ià(!
key
.
	`IsV®id
()) {

777 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Invalid…rivate key");

779 
key¡Üe
.
	`AddKey
(
key
);

783 
¡d
::
m­
<
COutPošt
, 
Coš
> 
cošs
;

784 cÚ¡ 
CTxIn
& 
txš
 : 
mtx
.
vš
) {

785 
cošs
[
txš
.
´evout
];

787 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

788 
	`FšdCošs
(
node
, 
cošs
);

791 
	`P¬£P»vouts
(
»que¡
.
·¿ms
[2], &
key¡Üe
, 
cošs
);

793 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

794 
	`SignT¿n§ùiÚ
(
mtx
, &
key¡Üe
, 
cošs
, 
»que¡
.
·¿ms
[3], 
»suÉ
);

795  
»suÉ
;

796 
	}
}

798 
UniV®ue
 
	$£nd¿wŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

800 
RPCH–pMª
{"sendrawtransaction",

807 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The hex string ofhe„awransaction"},

808 {"maxã”©e", 
RPCArg
::
Ty³
::
AMOUNT
, 
	`FÜm©MÚey
(
DEFAULT_MAX_RAW_TX_FEE_RATE
.
	`G‘F“P”K
()),

809 "Rejeù¿n§ùiÚ who£ f“„©i high”hªh¥ecif›d v®ue,ƒx´es£d iÀ" + 
CURRENCY_UNIT
 +

812 
RPCResuÉ
{

813 
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "Theransaction hash in hex"

815 
RPCExam¶es
{

817 + 
	`H–pExam¶eCli
("createrawtransaction", "\"[{\\\"txid\\\" : \\\"mytxid\\\",\\\"vout\\\":0}]\" \"{\\\"myaddress\\\":0.01}\"") +

819 + 
	`H–pExam¶eCli
("signrawtransactionwithwallet", "\"myhex\"") +

821 + 
	`H–pExam¶eCli
("sendrawtransaction", "\"signedhex\"") +

823 + 
	`H–pExam¶eRpc
("sendrawtransaction", "\"signedhex\"")

825 }.
	`Check
(
»que¡
);

827 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {

828 
UniV®ue
::
VSTR
,

829 
	`UniV®ueTy³
(),

833 
CMubËT¿n§ùiÚ
 
mtx
;

834 ià(!
	`DecodeHexTx
(
mtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
()))

835 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "TX decode failed");

836 
CT¿n§ùiÚRef
 
	`tx
(
	`MakeT¿n§ùiÚRef
(
¡d
::
	`move
(
mtx
)));

838 cÚ¡ 
CF“R©e
 
max_¿w_tx_ãe_¿‹
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
() ?

839 
DEFAULT_MAX_RAW_TX_FEE_RATE
 :

840 
	`CF“R©e
(
	`AmouÁFromV®ue
(
»que¡
.
·¿ms
[1]));

842 
št64_t
 
vœtu®_size
 = 
	`G‘Vœtu®T¿n§ùiÚSize
(*
tx
);

843 
CAmouÁ
 
max_¿w_tx_ãe
 = 
max_¿w_tx_ãe_¿‹
.
	`G‘F“
(
vœtu®_size
);

845 
¡d
::
¡ršg
 
”r_¡ršg
;

846 
	`As£¹LockNÙH–d
(
cs_maš
);

847 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

848 cÚ¡ 
T¿n§ùiÚE¼Ü
 
”r
 = 
	`Brßdÿ¡T¿n§ùiÚ
(
node
, 
tx
, 
”r_¡ršg
, 
max_¿w_tx_ãe
, 
Œue
,rue);

849 ià(
T¿n§ùiÚE¼Ü
::
OK
 !ğ
”r
) {

850 
throw
 
	`JSONRPCT¿n§ùiÚE¼Ü
(
”r
, 
”r_¡ršg
);

852  
tx
->
	`G‘Hash
().
	`G‘Hex
();

853 
	}
}

855 
UniV®ue
 
	$‹¡mempoŞacû±
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

857 
RPCH–pMª
{"testmempoolaccept",

862 {"¿wtxs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "An‡rray of hex strings of„awransactions.\n"

865 {"¿wtx", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
OMITTED
, ""},

868 {"maxã”©e", 
RPCArg
::
Ty³
::
AMOUNT
, 
	`FÜm©MÚey
(
DEFAULT_MAX_RAW_TX_FEE_RATE
.
	`G‘F“P”K
()), "Rejeù¿n§ùiÚ who£ f“„©i high”hªh¥ecif›d v®ue,ƒx´es£d iÀ" + 
CURRENCY_UNIT
 + "/kB\n"},

870 
RPCResuÉ
{

871 
RPCResuÉ
::
Ty³
::
ARR
, "", "The„esult ofhe mempool‡cceptanceest forƒach„awransaction inhe input‡rray.\n"

874 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

876 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "txid", "Theransaction hash in hex"},

877 {
RPCResuÉ
::
Ty³
::
BOOL
, "allowed", "Ifhe mempool‡llowshisxo be inserted"},

878 {
RPCResuÉ
::
Ty³
::
STR
, "reject-reason", "Rejection string (only…resent when 'allowed' is false)"},

882 
RPCExam¶es
{

884 + 
	`H–pExam¶eCli
("createrawtransaction", "\"[{\\\"txid\\\" : \\\"mytxid\\\",\\\"vout\\\":0}]\" \"{\\\"myaddress\\\":0.01}\"") +

886 + 
	`H–pExam¶eCli
("signrawtransactionwithwallet", "\"myhex\"") +

888 + 
	`H–pExam¶eCli
("‹¡mempoŞacû±", 
R
"('["
sigÃdhex
"]')") +

890 + 
	`H–pExam¶eRpc
("testmempoolaccept", "[\"signedhex\"]")

892 }.
	`Check
(
»que¡
);

894 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {

895 
UniV®ue
::
VARR
,

896 
	`UniV®ueTy³
(),

899 ià(
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
().
	`size
() != 1) {

900 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Array must containƒxactly one„awransaction for‚ow");

903 
CMubËT¿n§ùiÚ
 
mtx
;

904 ià(!
	`DecodeHexTx
(
mtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
()[0].
	`g‘_¡r
())) {

905 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "TX decode failed");

907 
CT¿n§ùiÚRef
 
	`tx
(
	`MakeT¿n§ùiÚRef
(
¡d
::
	`move
(
mtx
)));

908 cÚ¡ 
ušt256
& 
tx_hash
 = 
tx
->
	`G‘Hash
();

910 cÚ¡ 
CF“R©e
 
max_¿w_tx_ãe_¿‹
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
() ?

911 
DEFAULT_MAX_RAW_TX_FEE_RATE
 :

912 
	`CF“R©e
(
	`AmouÁFromV®ue
(
»que¡
.
·¿ms
[1]));

914 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

915 
št64_t
 
vœtu®_size
 = 
	`G‘Vœtu®T¿n§ùiÚSize
(*
tx
);

916 
CAmouÁ
 
max_¿w_tx_ãe
 = 
max_¿w_tx_ãe_¿‹
.
	`G‘F“
(
vœtu®_size
);

918 
UniV®ue
 
	`»suÉ
(UniV®ue::
VARR
);

919 
UniV®ue
 
	`»suÉ_0
(UniV®ue::
VOBJ
);

920 
»suÉ_0
.
	`pushKV
("txid", 
tx_hash
.
	`G‘Hex
());

922 
TxV®id©iÚS‹
 
¡©e
;

923 
boŞ
 
‹¡_acû±_»s
;

925 
	`LOCK
(
cs_maš
);

926 
‹¡_acû±_»s
 = 
	`Acû±ToMemÜyPoŞ
(
mempoŞ
, 
¡©e
, 
¡d
::
	`move
(
tx
),

927 
nuÎ±r
 , 
çl£
 , 
max_¿w_tx_ãe
, 
Œue
);

929 
»suÉ_0
.
	`pushKV
("®lowed", 
‹¡_acû±_»s
);

930 ià(!
‹¡_acû±_»s
) {

931 ià(
¡©e
.
	`IsInv®id
()) {

932 ià(
¡©e
.
	`G‘ResuÉ
(è=ğ
TxV®id©iÚResuÉ
::
TX_MISSING_INPUTS
) {

933 
»suÉ_0
.
	`pushKV
("reject-reason", "missing-inputs");

935 
»suÉ_0
.
	`pushKV
("»jeù-»asÚ", 
	`¡½rštf
("%s", 
¡©e
.
	`G‘RejeùR—sÚ
()));

938 
»suÉ_0
.
	`pushKV
("»jeù-»asÚ", 
¡©e
.
	`G‘RejeùR—sÚ
());

942 
»suÉ
.
	`push_back
(
¡d
::
	`move
(
»suÉ_0
));

943  
»suÉ
;

944 
	}
}

946 
	g¡d
::
¡ršg
 
Wr™eHDKey·th
(
¡d
::
veùÜ
<
ušt32_t
>& 
key·th
)

948 
¡d
::
¡ršg
 
key·th_¡r
 = "m";

949 
ušt32_t
 
	gnum
 : 
key·th
) {

950 
key·th_¡r
 += "/";

951 
boŞ
 
	gh¬d’ed
 = 
çl£
;

952 ià(
	gnum
 & 0x80000000) {

953 
	gh¬d’ed
 = 
Œue
;

954 
	gnum
 &= ~0x80000000;

957 
	gkey·th_¡r
 +ğ
ToSŒšg
(
num
);

958 ià(
	gh¬d’ed
) {

959 
	gkey·th_¡r
 += "'";

962  
	gkey·th_¡r
;

965 
UniV®ue
 
	$decod•sbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

967 
RPCH–pMª
{"decodepsbt",

970 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The PSBT base64 string"},

972 
RPCResuÉ
{

973 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

975 {
RPCResuÉ
::
Ty³
::
OBJ
, "tx", "The decoded‚etwork-serialized unsignedransaction.",

977 {
RPCResuÉ
::
Ty³
::
ELISION
, "", "The†ayout ishe same‡she output of decoderawtransaction."},

979 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "unknown", "The unknown global fields",

981 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "key", "(key-value…air) An unknown key-value…air"},

983 {
RPCResuÉ
::
Ty³
::
ARR
, "inputs", "",

985 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

987 {
RPCResuÉ
::
Ty³
::
OBJ
, "nÚ_w™Ãss_utxo", 
Œue
, "Decoded‚etworkransaction for‚on-witness UTXOs",

989 {
RPCResuÉ
::
Ty³
::
ELISION
, "",""},

991 {
RPCResuÉ
::
Ty³
::
OBJ
, "w™Ãss_utxo", 
Œue
, "Transaction output for witness UTXOs",

993 {
RPCResuÉ
::
Ty³
::
NUM
, "amouÁ", "Thv®uš " + 
CURRENCY_UNIT
},

994 {
RPCResuÉ
::
Ty³
::
OBJ
, "scriptPubKey", "",

996 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

997 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex"},

998 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

999 {
RPCResuÉ
::
Ty³
::
STR
, "address"," Syscoin‡ddress ifhere is one"},

1002 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "·¹Ÿl_sigÇtu»s", 
Œue
, "",

1004 {
RPCResuÉ
::
Ty³
::
STR
, "pubkey", "The…ublic key‡nd signaturehat correspondso it."},

1006 {
RPCResuÉ
::
Ty³
::
STR
, "sighash", 
Œue
, "The sighashypeo be used"},

1007 {
RPCResuÉ
::
Ty³
::
OBJ
, "»d“m_süt", 
Œue
, "",

1009 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

1010 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex"},

1011 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

1013 {
RPCResuÉ
::
Ty³
::
OBJ
, "w™Ãss_süt", 
Œue
, "",

1015 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

1016 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex"},

1017 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

1019 {
RPCResuÉ
::
Ty³
::
ARR
, "b32_d”ivs", 
Œue
, "",

1021 {
RPCResuÉ
::
Ty³
::
OBJ
, "pubkey", 
Œue
, "The…ublic key withhe derivation…ath‡she value.",

1023 {
RPCResuÉ
::
Ty³
::
STR
, "master_fingerprint", "The fingerprint ofhe master key"},

1024 {
RPCResuÉ
::
Ty³
::
STR
, "path", "The…ath"},

1027 {
RPCResuÉ
::
Ty³
::
OBJ
, "fš®_sütsig", 
Œue
, "",

1029 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

1030 {
RPCResuÉ
::
Ty³
::
STR
, "hex", "The hex"},

1032 {
RPCResuÉ
::
Ty³
::
ARR
, "final_scriptwitness", "",

1034 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "", "hex-encoded witness data (if‡ny)"},

1036 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "unknown", "The unknown global fields",

1038 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "key", "(key-value…air) An unknown key-value…air"},

1042 {
RPCResuÉ
::
Ty³
::
ARR
, "outputs", "",

1044 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1046 {
RPCResuÉ
::
Ty³
::
OBJ
, "»d“m_süt", 
Œue
, "",

1048 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

1049 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex"},

1050 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

1052 {
RPCResuÉ
::
Ty³
::
OBJ
, "w™Ãss_süt", 
Œue
, "",

1054 {
RPCResuÉ
::
Ty³
::
STR
, "asm", "The‡sm"},

1055 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex"},

1056 {
RPCResuÉ
::
Ty³
::
STR
, "type", "Theype,ƒg 'pubkeyhash'"},

1058 {
RPCResuÉ
::
Ty³
::
ARR
, "b32_d”ivs", 
Œue
, "",

1060 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1062 {
RPCResuÉ
::
Ty³
::
STR
, "pubkey", "The…ublic keyhis…ath correspondso"},

1063 {
RPCResuÉ
::
Ty³
::
STR
, "master_fingerprint", "The fingerprint ofhe master key"},

1064 {
RPCResuÉ
::
Ty³
::
STR
, "path", "The…ath"},

1067 {
RPCResuÉ
::
Ty³
::
OBJ_DYN
, "unknown", "The unknown global fields",

1069 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "key", "(key-value…air) An unknown key-value…air"},

1073 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "ãe", 
Œue
, "Theransaction fee…aid if‡ll UTXOs slots inhe PSBT have been filled."},

1076 
RPCExam¶es
{

1077 
	`H–pExam¶eCli
("decodepsbt", "\"psbt\"")

1079 }.
	`Check
(
»que¡
);

1081 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
});

1084 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1085 
¡d
::
¡ršg
 
”rÜ
;

1086 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
”rÜ
)) {

1087 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1090 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

1093 
UniV®ue
 
	`tx_univ
(UniV®ue::
VOBJ
);

1094 
	`TxToUniv
(
	`CT¿n§ùiÚ
(*
psbtx
.
tx
), 
	`ušt256
(), 
tx_univ
, 
çl£
);

1095 
»suÉ
.
	`pushKV
("tx", 
tx_univ
);

1098 
UniV®ue
 
	`unknowns
(UniV®ue::
VOBJ
);

1099 autØ
’Œy
 : 
psbtx
.
unknown
) {

1100 
unknowns
.
	`pushKV
(
	`HexSŒ
(
’Œy
.
fœ¡
), HexSŒÓÁry.
£cÚd
));

1102 
»suÉ
.
	`pushKV
("unknown", 
unknowns
);

1105 
CAmouÁ
 
tÙ®_š
 = 0;

1106 
boŞ
 
have_®l_utxos
 = 
Œue
;

1107 
UniV®ue
 
	`šputs
(UniV®ue::
VARR
);

1108 
i
 = 0; i < 
psbtx
.
šputs
.
	`size
(); ++i) {

1109 cÚ¡ 
PSBTIÅut
& 
šput
 = 
psbtx
.
šputs
[
i
];

1110 
UniV®ue
 
	`š
(UniV®ue::
VOBJ
);

1112 ià(!
šput
.
w™Ãss_utxo
.
	`IsNuÎ
()) {

1113 cÚ¡ 
CTxOut
& 
txout
 = 
šput
.
w™Ãss_utxo
;

1115 
UniV®ue
 
	`out
(UniV®ue::
VOBJ
);

1117 
out
.
	`pushKV
("amouÁ", 
	`V®ueFromAmouÁ
(
txout
.
nV®ue
));

1118 ià(
	`MÚeyRªge
(
txout
.
nV®ue
è&& MÚeyRªge(
tÙ®_š
 +xout.nValue)) {

1119 
tÙ®_š
 +ğ
txout
.
nV®ue
;

1122 
have_®l_utxos
 = 
çl£
;

1125 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

1126 
	`SütToUniv
(
txout
.
sütPubKey
, 
o
, 
Œue
);

1127 
out
.
	`pushKV
("sütPubKey", 
o
);

1128 
š
.
	`pushKV
("w™Ãss_utxo", 
out
);

1129 } ià(
šput
.
nÚ_w™Ãss_utxo
) {

1130 
UniV®ue
 
	`nÚ_w™
(UniV®ue::
VOBJ
);

1131 
	`TxToUniv
(*
šput
.
nÚ_w™Ãss_utxo
, 
	`ušt256
(), 
nÚ_w™
, 
çl£
);

1132 
š
.
	`pushKV
("nÚ_w™Ãss_utxo", 
nÚ_w™
);

1133 
CAmouÁ
 
utxo_v®
 = 
šput
.
nÚ_w™Ãss_utxo
->
vout
[
psbtx
.
tx
->
vš
[
i
].
´evout
.
n
].
nV®ue
;

1134 ià(
	`MÚeyRªge
(
utxo_v®
è&& MÚeyRªge(
tÙ®_š
 + utxo_val)) {

1135 
tÙ®_š
 +ğ
utxo_v®
;

1138 
have_®l_utxos
 = 
çl£
;

1141 
have_®l_utxos
 = 
çl£
;

1145 ià(!
šput
.
·¹Ÿl_sigs
.
	`em±y
()) {

1146 
UniV®ue
 
	`·¹Ÿl_sigs
(UniV®ue::
VOBJ
);

1147 cÚ¡‡uto& 
sig
 : 
šput
.
·¹Ÿl_sigs
) {

1148 
·¹Ÿl_sigs
.
	`pushKV
(
	`HexSŒ
(
sig
.
£cÚd
.
fœ¡
), HexStr(sig.second.second));

1150 
š
.
	`pushKV
("·¹Ÿl_sigÇtu»s", 
·¹Ÿl_sigs
);

1154 ià(
šput
.
sighash_ty³
 > 0) {

1155 
š
.
	`pushKV
("sighash", 
	`SighashToSŒ
(()
šput
.
sighash_ty³
));

1159 ià(!
šput
.
»d“m_süt
.
	`em±y
()) {

1160 
UniV®ue
 
	`r
(UniV®ue::
VOBJ
);

1161 
	`SütToUniv
(
šput
.
»d“m_süt
, 
r
, 
çl£
);

1162 
š
.
	`pushKV
("»d“m_süt", 
r
);

1164 ià(!
šput
.
w™Ãss_süt
.
	`em±y
()) {

1165 
UniV®ue
 
	`r
(UniV®ue::
VOBJ
);

1166 
	`SütToUniv
(
šput
.
w™Ãss_süt
, 
r
, 
çl£
);

1167 
š
.
	`pushKV
("w™Ãss_süt", 
r
);

1171 ià(!
šput
.
hd_key·ths
.
	`em±y
()) {

1172 
UniV®ue
 
	`key·ths
(UniV®ue::
VARR
);

1173 autØ
’Œy
 : 
šput
.
hd_key·ths
) {

1174 
UniV®ue
 
	`key·th
(UniV®ue::
VOBJ
);

1175 
key·th
.
	`pushKV
("pubkey", 
	`HexSŒ
(
’Œy
.
fœ¡
));

1177 
key·th
.
	`pushKV
("ma¡”_fšg”´št", 
	`¡½rštf
("%08x", 
	`R—dBE32
(
’Œy
.
£cÚd
.
fšg”´št
)));

1178 
key·th
.
	`pushKV
("·th", 
	`Wr™eHDKey·th
(
’Œy
.
£cÚd
.
·th
));

1179 
key·ths
.
	`push_back
(
key·th
);

1181 
š
.
	`pushKV
("b32_d”ivs", 
key·ths
);

1185 ià(!
šput
.
fš®_süt_sig
.
	`em±y
()) {

1186 
UniV®ue
 
	`sütsig
(UniV®ue::
VOBJ
);

1187 
sütsig
.
	`pushKV
("asm", 
	`SütToAsmSŒ
(
šput
.
fš®_süt_sig
, 
Œue
));

1188 
sütsig
.
	`pushKV
("hex", 
	`HexSŒ
(
šput
.
fš®_süt_sig
));

1189 
š
.
	`pushKV
("fš®_sütSig", 
sütsig
);

1191 ià(!
šput
.
fš®_süt_w™Ãss
.
	`IsNuÎ
()) {

1192 
UniV®ue
 
	`txšw™Ãss
(UniV®ue::
VARR
);

1193 cÚ¡‡uto& 
™em
 : 
šput
.
fš®_süt_w™Ãss
.
¡ack
) {

1194 
txšw™Ãss
.
	`push_back
(
	`HexSŒ
(
™em
.
	`begš
(), i‹m.
	`’d
()));

1196 
š
.
	`pushKV
("fš®_sütw™Ãss", 
txšw™Ãss
);

1200 ià(
šput
.
unknown
.
	`size
() > 0) {

1201 
UniV®ue
 
	`unknowns
(UniV®ue::
VOBJ
);

1202 autØ
’Œy
 : 
šput
.
unknown
) {

1203 
unknowns
.
	`pushKV
(
	`HexSŒ
(
’Œy
.
fœ¡
), HexSŒÓÁry.
£cÚd
));

1205 
š
.
	`pushKV
("unknown", 
unknowns
);

1208 
šputs
.
	`push_back
(
š
);

1210 
»suÉ
.
	`pushKV
("šputs", 
šputs
);

1213 
CAmouÁ
 
ouut_v®ue
 = 0;

1214 
UniV®ue
 
	`ouuts
(UniV®ue::
VARR
);

1215 
i
 = 0; i < 
psbtx
.
ouuts
.
	`size
(); ++i) {

1216 cÚ¡ 
PSBTOuut
& 
ouut
 = 
psbtx
.
ouuts
[
i
];

1217 
UniV®ue
 
	`out
(UniV®ue::
VOBJ
);

1219 ià(!
ouut
.
»d“m_süt
.
	`em±y
()) {

1220 
UniV®ue
 
	`r
(UniV®ue::
VOBJ
);

1221 
	`SütToUniv
(
ouut
.
»d“m_süt
, 
r
, 
çl£
);

1222 
out
.
	`pushKV
("»d“m_süt", 
r
);

1224 ià(!
ouut
.
w™Ãss_süt
.
	`em±y
()) {

1225 
UniV®ue
 
	`r
(UniV®ue::
VOBJ
);

1226 
	`SütToUniv
(
ouut
.
w™Ãss_süt
, 
r
, 
çl£
);

1227 
out
.
	`pushKV
("w™Ãss_süt", 
r
);

1231 ià(!
ouut
.
hd_key·ths
.
	`em±y
()) {

1232 
UniV®ue
 
	`key·ths
(UniV®ue::
VARR
);

1233 autØ
’Œy
 : 
ouut
.
hd_key·ths
) {

1234 
UniV®ue
 
	`key·th
(UniV®ue::
VOBJ
);

1235 
key·th
.
	`pushKV
("pubkey", 
	`HexSŒ
(
’Œy
.
fœ¡
));

1236 
key·th
.
	`pushKV
("ma¡”_fšg”´št", 
	`¡½rštf
("%08x", 
	`R—dBE32
(
’Œy
.
£cÚd
.
fšg”´št
)));

1237 
key·th
.
	`pushKV
("·th", 
	`Wr™eHDKey·th
(
’Œy
.
£cÚd
.
·th
));

1238 
key·ths
.
	`push_back
(
key·th
);

1240 
out
.
	`pushKV
("b32_d”ivs", 
key·ths
);

1244 ià(
ouut
.
unknown
.
	`size
() > 0) {

1245 
UniV®ue
 
	`unknowns
(UniV®ue::
VOBJ
);

1246 autØ
’Œy
 : 
ouut
.
unknown
) {

1247 
unknowns
.
	`pushKV
(
	`HexSŒ
(
’Œy
.
fœ¡
), HexSŒÓÁry.
£cÚd
));

1249 
out
.
	`pushKV
("unknown", 
unknowns
);

1252 
ouuts
.
	`push_back
(
out
);

1255 ià(
	`MÚeyRªge
(
psbtx
.
tx
->
vout
[
i
].
nV®ue
è&& MÚeyRªge(
ouut_v®ue
 +…sbtx.tx->vout[i].nValue)) {

1256 
ouut_v®ue
 +ğ
psbtx
.
tx
->
vout
[
i
].
nV®ue
;

1259 
have_®l_utxos
 = 
çl£
;

1262 
»suÉ
.
	`pushKV
("ouuts", 
ouuts
);

1263 ià(
have_®l_utxos
) {

1264 
»suÉ
.
	`pushKV
("ãe", 
	`V®ueFromAmouÁ
(
tÙ®_š
 - 
ouut_v®ue
));

1267  
»suÉ
;

1268 
	}
}

1270 
UniV®ue
 
	$combš•sbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1272 
RPCH–pMª
{"combinepsbt",

1276 {"txs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The base64 strings of…artially signedransactions",

1278 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "A base64 string of‡ PSBT"},

1282 
RPCResuÉ
{

1283 
RPCResuÉ
::
Ty³
::
STR
, "", "The base64-encoded…artially signedransaction"

1285 
RPCExam¶es
{

1286 
	`H–pExam¶eCli
("combš•sbt", 
R
"('["
myba£64_1
", "
myba£64_2
", "
myba£64_3
"]')")

1288 }.
	`Check
(
»que¡
);

1290 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VARR
}, 
Œue
);

1293 
¡d
::
veùÜ
<
P¬tŸÎySigÃdT¿n§ùiÚ
> 
psbtxs
;

1294 
UniV®ue
 
txs
 = 
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
();

1295 ià(
txs
.
	`em±y
()) {

1296 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Parameter 'txs' cannot beƒmpty");

1298 
i
 = 0; i < 
txs
.
	`size
(); ++i) {

1299 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1300 
¡d
::
¡ršg
 
”rÜ
;

1301 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
txs
[
i
].
	`g‘_¡r
(), 
”rÜ
)) {

1302 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1304 
psbtxs
.
	`push_back
(
psbtx
);

1307 
P¬tŸÎySigÃdT¿n§ùiÚ
 
m”ged_psbt
;

1308 cÚ¡ 
T¿n§ùiÚE¼Ü
 
”rÜ
 = 
	`CombšePSBTs
(
m”ged_psbt
, 
psbtxs
);

1309 ià(
”rÜ
 !ğ
T¿n§ùiÚE¼Ü
::
OK
) {

1310 
throw
 
	`JSONRPCT¿n§ùiÚE¼Ü
(
”rÜ
);

1313 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1314 
ssTx
 << 
m”ged_psbt
;

1315  
	`EncodeBa£64
((*)
ssTx
.
	`d©a
(), ssTx.
	`size
());

1316 
	}
}

1318 
UniV®ue
 
	$fš®iz•sbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1320 
RPCH–pMª
{"finalizepsbt",

1326 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "A base64 string of‡ PSBT"},

1327 {"exŒaù", 
RPCArg
::
Ty³
::
BOOL
, "true", "Ifrue‡ndheransaction is complete,\n"

1330 
RPCResuÉ
{

1331 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1333 {
RPCResuÉ
::
Ty³
::
STR
, "psbt", "The base64-encoded…artially signedransaction if‚otƒxtracted"},

1334 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "hex", "The hex-encoded‚etworkransaction ifƒxtracted"},

1335 {
RPCResuÉ
::
Ty³
::
BOOL
, "complete", "Ifheransaction has‡ complete set of signatures"},

1338 
RPCExam¶es
{

1339 
	`H–pExam¶eCli
("finalizepsbt", "\"psbt\"")

1341 }.
	`Check
(
»que¡
);

1343 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VBOOL
}, 
Œue
);

1346 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1347 
¡d
::
¡ršg
 
”rÜ
;

1348 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
”rÜ
)) {

1349 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1352 
boŞ
 
exŒaù
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
(è|| (!»que¡.·¿ms[1].isNuÎ(è&&„eque¡.·¿ms[1].
	`g‘_boŞ
());

1354 
CMubËT¿n§ùiÚ
 
mtx
;

1355 
boŞ
 
com¶‘e
 = 
	`Fš®izeAndExŒaùPSBT
(
psbtx
, 
mtx
);

1357 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

1358 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1359 
¡d
::
¡ršg
 
»suÉ_¡r
;

1361 ià(
com¶‘e
 && 
exŒaù
) {

1362 
ssTx
 << 
mtx
;

1363 
»suÉ_¡r
 = 
	`HexSŒ
(
ssTx
.
	`¡r
());

1364 
»suÉ
.
	`pushKV
("hex", 
»suÉ_¡r
);

1366 
ssTx
 << 
psbtx
;

1367 
»suÉ_¡r
 = 
	`EncodeBa£64
(
ssTx
.
	`¡r
());

1368 
»suÉ
.
	`pushKV
("psbt", 
»suÉ_¡r
);

1370 
»suÉ
.
	`pushKV
("com¶‘e", 
com¶‘e
);

1372  
»suÉ
;

1373 
	}
}

1375 
UniV®ue
 
	$ü—‹psbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1377 
RPCH–pMª
{"createpsbt",

1381 {"šputs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The json objects",

1383 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

1385 {"txid", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "Theransaction id"},

1386 {"vout", 
RPCArg
::
Ty³
::
NUM
, RPCArg::
O±iÚ®
::
NO
, "The output‚umber"},

1387 {"£qu’û", 
RPCArg
::
Ty³
::
NUM
, "depends onhe value ofhe 'replaceable'‡nd 'locktime'‡rguments", "The sequence‚umber"},

1392 {"ouuts", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The outputs (key-value…airs), where‚one ofhe keys‡re duplicated.\n"

1397 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

1399 {"add»ss", 
RPCArg
::
Ty³
::
AMOUNT
, RPCArg::
O±iÚ®
::
NO
, "A key-v®u·œ. Thkey (¡ršgèi thsyscoš‡dd»ss,hv®u(æßˆÜ sŒšgèi thamouÁ iÀ" + 
CURRENCY_UNIT
},

1402 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "",

1404 {"d©a", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "A key-value…air. The key must be \"data\",he value is hex-encoded data"},

1409 {"locktime", 
RPCArg
::
Ty³
::
NUM
, "0", "Raw†ocktime. Non-0 value‡lso†ocktime-activates inputs"},

1410 {"»¶aûabË", 
RPCArg
::
Ty³
::
BOOL
, "false", "Markshisransaction‡s BIP125„eplaceable.\n"

1413 
RPCResuÉ
{

1414 
RPCResuÉ
::
Ty³
::
STR
, "", "The„esulting„awransaction (base64-encoded string)"

1416 
RPCExam¶es
{

1417 
	`H–pExam¶eCli
("createpsbt", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\" \"[{\\\"data\\\":\\\"00010203\\\"}]\"")

1419 }.
	`Check
(
»que¡
);

1422 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {

1423 
UniV®ue
::
VARR
,

1424 
	`UniV®ueTy³
(),

1425 
UniV®ue
::
VNUM
,

1426 
UniV®ue
::
VBOOL
,

1427 }, 
Œue


1430 
boŞ
 
rbf
 = 
çl£
;

1431 ià(!
»que¡
.
·¿ms
[3].
	`isNuÎ
()) {

1432 
rbf
 = 
»que¡
.
·¿ms
[3].
	`isTrue
();

1434 
CMubËT¿n§ùiÚ
 
¿wTx
 = 
	`CÚ¡ruùT¿n§ùiÚ
(
»que¡
.
·¿ms
[0],„eque¡.·¿ms[1],„eque¡.·¿ms[2], 
rbf
);

1437 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1438 
psbtx
.
tx
 = 
¿wTx
;

1439 
i
 = 0; i < 
¿wTx
.
vš
.
	`size
(); ++i) {

1440 
psbtx
.
šputs
.
	`push_back
(
	`PSBTIÅut
());

1442 
i
 = 0; i < 
¿wTx
.
vout
.
	`size
(); ++i) {

1443 
psbtx
.
ouuts
.
	`push_back
(
	`PSBTOuut
());

1447 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1448 
ssTx
 << 
psbtx
;

1450  
	`EncodeBa£64
((*)
ssTx
.
	`d©a
(), ssTx.
	`size
());

1451 
	}
}

1453 
UniV®ue
 
	$cÚv”‰İsbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1455 
RPCH–pMª
{"converttopsbt",

1459 {"hex¡ršg", 
RPCArg
::
Ty³
::
STR_HEX
, RPCArg::
O±iÚ®
::
NO
, "The hex string of‡„awransaction"},

1460 {"³rm™sigd©a", 
RPCArg
::
Ty³
::
BOOL
, "false", "Ifrue,‡ny signatures inhe input will be discarded‡nd conversion\n"

1462 {"isw™Ãss", 
RPCArg
::
Ty³
::
BOOL
, "depends on heuristicests", "Whetherheransaction hex is‡ serialized witnessransaction.\n"

1470 
RPCResuÉ
{

1471 
RPCResuÉ
::
Ty³
::
STR
, "", "The„esulting„awransaction (base64-encoded string)"

1473 
RPCExam¶es
{

1475 + 
	`H–pExam¶eCli
("createrawtransaction", "\"[{\\\"txid\\\":\\\"myid\\\",\\\"vout\\\":0}]\" \"[{\\\"data\\\":\\\"00010203\\\"}]\"") +

1477 + 
	`H–pExam¶eCli
("converttopsbt", "\"rawtransaction\"")

1479 }.
	`Check
(
»que¡
);

1481 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VBOOL
, UniV®ue::VBOOL}, 
Œue
);

1484 
CMubËT¿n§ùiÚ
 
tx
;

1485 
boŞ
 
³rm™sigd©a
 = 
»que¡
.
·¿ms
[1].
	`isNuÎ
(è? 
çl£
 :„eque¡.·¿ms[1].
	`g‘_boŞ
();

1486 
boŞ
 
w™Ãss_¥ecif›d
 = !
»que¡
.
·¿ms
[2].
	`isNuÎ
();

1487 
boŞ
 
isw™Ãss
 = 
w™Ãss_¥ecif›d
 ? 
»que¡
.
·¿ms
[2].
	`g‘_boŞ
(è: 
çl£
;

1488 cÚ¡ 
boŞ
 
Œy_w™Ãss
 = 
w™Ãss_¥ecif›d
 ? 
isw™Ãss
 : 
Œue
;

1489 cÚ¡ 
boŞ
 
Œy_no_w™Ãss
 = 
w™Ãss_¥ecif›d
 ? !
isw™Ãss
 : 
Œue
;

1490 ià(!
	`DecodeHexTx
(
tx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
Œy_no_w™Ãss
, 
Œy_w™Ãss
)) {

1491 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "TX decode failed");

1495 
CTxIn
& 
šput
 : 
tx
.
vš
) {

1496 ià((!
šput
.
sütSig
.
	`em±y
(è|| !šput.
sütW™Ãss
.
	`IsNuÎ
()è&& !
³rm™sigd©a
) {

1497 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "Inputs must‚ot have scriptSigs‡nd scriptWitnesses");

1499 
šput
.
sütSig
.
	`ş—r
();

1500 
šput
.
sütW™Ãss
.
	`S‘NuÎ
();

1504 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1505 
psbtx
.
tx
 =x;

1506 
i
 = 0; i < 
tx
.
vš
.
	`size
(); ++i) {

1507 
psbtx
.
šputs
.
	`push_back
(
	`PSBTIÅut
());

1509 
i
 = 0; i < 
tx
.
vout
.
	`size
(); ++i) {

1510 
psbtx
.
ouuts
.
	`push_back
(
	`PSBTOuut
());

1514 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1515 
ssTx
 << 
psbtx
;

1517  
	`EncodeBa£64
((*)
ssTx
.
	`d©a
(), ssTx.
	`size
());

1518 
	}
}

1520 
UniV®ue
 
	$utxoupd©•sbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1522 
RPCH–pMª
{"utxoupdatepsbt",

1525 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "A base64 string of‡ PSBT"},

1526 {"desütÜs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
OMITTED_NAMED_ARG
, "An‡rray ofƒither strings or objects", {

1527 {"", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
OMITTED
, "An output descriptor"},

1528 {"", 
RPCArg
::
Ty³
::
OBJ
, RPCArg::
O±iÚ®
::
OMITTED
, "An object with‡n output descriptor‡ndƒxtra information", {

1529 {"desc", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "An output descriptor"},

1530 {"¿nge", 
RPCArg
::
Ty³
::
RANGE
, "1000", "Upo what index HD chains should beƒxplored (eitherƒnd or [begin,end])"},

1534 
RPCResuÉ
 {

1535 
RPCResuÉ
::
Ty³
::
STR
, "", "The base64-encoded…artially signedransaction with inputs updated"

1537 
RPCExam¶es
 {

1538 
	`H–pExam¶eCli
("utxoupdatepsbt", "\"psbt\"")

1539 }}.
	`Check
(
»que¡
);

1541 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
, UniV®ue::
VARR
}, 
Œue
);

1544 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1545 
¡d
::
¡ršg
 
”rÜ
;

1546 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
”rÜ
)) {

1547 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1551 
FÏtSignšgProvid”
 
´ovid”
;

1552 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

1553 autØ
descs
 = 
»que¡
.
·¿ms
[1].
	`g‘_¬¿y
();

1554 
size_t
 
i
 = 0; i < 
descs
.
	`size
(); ++i) {

1555 
	`Ev®DesütÜSŒšgOrObjeù
(
descs
[
i
], 
´ovid”
);

1559 
HidšgSignšgProvid”
 
	`public_´ovid”
(&
´ovid”
, 
Œue
, 
çl£
);

1562 
CCošsV›w
 
v›wDummy
;

1563 
CCošsV›wCache
 
	`v›w
(&
v›wDummy
);

1565 cÚ¡ 
CTxMemPoŞ
& 
mempoŞ
 = 
	`Ensu»MemPoŞ
(
»que¡
.
cÚ‹xt
);

1566 
	`LOCK2
(
cs_maš
, 
mempoŞ
.
cs
);

1567 
CCošsV›wCache
 &
v›wChaš
 = ::
	`Chaš¡©eAùive
().
	`CošsT
();

1568 
CCošsV›wMemPoŞ
 
	`v›wMempoŞ
(&
v›wChaš
, 
mempoŞ
);

1569 
v›w
.
	`S‘Back’d
(
v›wMempoŞ
);

1571 cÚ¡ 
CTxIn
& 
txš
 : 
psbtx
.
tx
->
vš
) {

1572 
v›w
.
	`AcûssCoš
(
txš
.
´evout
);

1575 
v›w
.
	`S‘Back’d
(
v›wDummy
);

1579 
i
 = 0; i < 
psbtx
.
tx
->
vš
.
	`size
(); ++i) {

1580 
PSBTIÅut
& 
šput
 = 
psbtx
.
šputs
.
	`©
(
i
);

1582 ià(
šput
.
nÚ_w™Ãss_utxo
 || !šput.
w™Ãss_utxo
.
	`IsNuÎ
()) {

1586 cÚ¡ 
Coš
& 
coš
 = 
v›w
.
	`AcûssCoš
(
psbtx
.
tx
->
vš
[
i
].
´evout
);

1588 ià(
	`IsSegW™Ouut
(
´ovid”
, 
coš
.
out
.
sütPubKey
)) {

1589 
šput
.
w™Ãss_utxo
 = 
coš
.
out
;

1595 
	`SignPSBTIÅut
(
public_´ovid”
, 
psbtx
, 
i
, 1);

1599 
i
 = 0; i < 
psbtx
.
tx
->
vout
.
	`size
(); ++i) {

1600 
	`Upd©ePSBTOuut
(
public_´ovid”
, 
psbtx
, 
i
);

1603 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1604 
ssTx
 << 
psbtx
;

1605  
	`EncodeBa£64
((*)
ssTx
.
	`d©a
(), ssTx.
	`size
());

1606 
	}
}

1608 
UniV®ue
 
	$jošpsbts
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1610 
RPCH–pMª
{"joinpsbts",

1614 {"txs", 
RPCArg
::
Ty³
::
ARR
, RPCArg::
O±iÚ®
::
NO
, "The base64 strings of…artially signedransactions",

1616 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "A base64 string of‡ PSBT"}

1619 
RPCResuÉ
 {

1620 
RPCResuÉ
::
Ty³
::
STR
, "", "The base64-encoded…artially signedransaction"

1622 
RPCExam¶es
 {

1623 
	`H–pExam¶eCli
("joinpsbts", "\"psbt\"")

1624 }}.
	`Check
(
»que¡
);

1626 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VARR
}, 
Œue
);

1629 
¡d
::
veùÜ
<
P¬tŸÎySigÃdT¿n§ùiÚ
> 
psbtxs
;

1630 
UniV®ue
 
txs
 = 
»que¡
.
·¿ms
[0].
	`g‘_¬¿y
();

1632 ià(
txs
.
	`size
() <= 1) {

1633 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "At†eastwo PSBTs‡re„equiredo join PSBTs.");

1636 
št32_t
 
be¡_v”siÚ
 = 1;

1637 
ušt32_t
 
be¡_locktime
 = 0xffffffff;

1638 
i
 = 0; i < 
txs
.
	`size
(); ++i) {

1639 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1640 
¡d
::
¡ršg
 
”rÜ
;

1641 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
txs
[
i
].
	`g‘_¡r
(), 
”rÜ
)) {

1642 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1644 
psbtxs
.
	`push_back
(
psbtx
);

1646 ià(
psbtx
.
tx
->
nV”siÚ
 > 
be¡_v”siÚ
) {

1647 
be¡_v”siÚ
 = 
psbtx
.
tx
->
nV”siÚ
;

1650 ià(
psbtx
.
tx
->
nLockTime
 < 
be¡_locktime
) {

1651 
be¡_locktime
 = 
psbtx
.
tx
->
nLockTime
;

1656 
P¬tŸÎySigÃdT¿n§ùiÚ
 
m”ged_psbt
;

1657 
m”ged_psbt
.
tx
 = 
	`CMubËT¿n§ùiÚ
();

1658 
m”ged_psbt
.
tx
->
nV”siÚ
 = 
be¡_v”siÚ
;

1659 
m”ged_psbt
.
tx
->
nLockTime
 = 
be¡_locktime
;

1662 auto& 
psbt
 : 
psbtxs
) {

1663 
i
 = 0; i < 
psbt
.
tx
->
vš
.
	`size
(); ++i) {

1664 ià(!
m”ged_psbt
.
	`AddIÅut
(
psbt
.
tx
->
vš
[
i
],…sbt.
šputs
[i])) {

1665 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("IÅuˆ%s:%dƒxi¡ š muÉË PSBTs", 
psbt
.
tx
->
vš
[
i
].
´evout
.
hash
.
	`ToSŒšg
(),…sbt.tx->vš[i].´evout.
n
));

1668 
i
 = 0; i < 
psbt
.
tx
->
vout
.
	`size
(); ++i) {

1669 
m”ged_psbt
.
	`AddOuut
(
psbt
.
tx
->
vout
[
i
],…sbt.
ouuts
[i]);

1671 
m”ged_psbt
.
unknown
.
	`š£¹
(
psbt
.unknown.
	`begš
(),…sbt.unknown.
	`’d
());

1675 
¡d
::
veùÜ
<> 
	`šput_šdiûs
(
m”ged_psbt
.
šputs
.
	`size
());

1676 
¡d
::
	`iÙa
(
šput_šdiûs
.
	`begš
(), iÅut_šdiûs.
	`’d
(), 0);

1677 
¡d
::
veùÜ
<> 
	`ouut_šdiûs
(
m”ged_psbt
.
ouuts
.
	`size
());

1678 
¡d
::
	`iÙa
(
ouut_šdiûs
.
	`begš
(), ouut_šdiûs.
	`’d
(), 0);

1681 
	`Shufæe
(
šput_šdiûs
.
	`begš
(), iÅut_šdiûs.
	`’d
(), 
	`Fa¡RªdomCÚ‹xt
());

1682 
	`Shufæe
(
ouut_šdiûs
.
	`begš
(), ouut_šdiûs.
	`’d
(), 
	`Fa¡RªdomCÚ‹xt
());

1684 
P¬tŸÎySigÃdT¿n§ùiÚ
 
shufæed_psbt
;

1685 
shufæed_psbt
.
tx
 = 
	`CMubËT¿n§ùiÚ
();

1686 
shufæed_psbt
.
tx
->
nV”siÚ
 = 
m”ged_psbt
.tx->nVersion;

1687 
shufæed_psbt
.
tx
->
nLockTime
 = 
m”ged_psbt
.tx->nLockTime;

1688 
i
 : 
šput_šdiûs
) {

1689 
shufæed_psbt
.
	`AddIÅut
(
m”ged_psbt
.
tx
->
vš
[
i
], m”ged_psbt.
šputs
[i]);

1691 
i
 : 
ouut_šdiûs
) {

1692 
shufæed_psbt
.
	`AddOuut
(
m”ged_psbt
.
tx
->
vout
[
i
], m”ged_psbt.
ouuts
[i]);

1694 
shufæed_psbt
.
unknown
.
	`š£¹
(
m”ged_psbt
.unknown.
	`begš
(), m”ged_psbt.unknown.
	`’d
());

1696 
CD©aSŒ—m
 
	`ssTx
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

1697 
ssTx
 << 
shufæed_psbt
;

1698  
	`EncodeBa£64
((*)
ssTx
.
	`d©a
(), ssTx.
	`size
());

1699 
	}
}

1701 
UniV®ue
 
	$ª®yz•sbt
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1703 
RPCH–pMª
{"analyzepsbt",

1706 {"psbt", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "A base64 string of‡ PSBT"}

1708 
RPCResuÉ
 {

1709 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1711 {
RPCResuÉ
::
Ty³
::
ARR
, "inputs", "",

1713 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

1715 {
RPCResuÉ
::
Ty³
::
BOOL
, "has_utxo", "Whether‡ UTXO is…rovided"},

1716 {
RPCResuÉ
::
Ty³
::
BOOL
, "is_final", "Whetherhe input is finalized"},

1717 {
RPCResuÉ
::
Ty³
::
OBJ
, "missšg", 
Œue
, "Thingshat‡re missinghat‡re„equiredo completehis input",

1719 {
RPCResuÉ
::
Ty³
::
ARR
, "pubkeys", 
Œue
, "",

1721 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "keyid", "Public key ID, hash160 ofhe…ublic key, of‡…ublic key whose BIP 32 derivation…ath is missing"},

1723 {
RPCResuÉ
::
Ty³
::
ARR
, "sigÇtu»s", 
Œue
, "",

1725 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "keyid", "Public key ID, hash160 ofhe…ublic key, of‡…ublic key whose signature is missing"},

1727 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "»d“msüt", 
Œue
, "Hash160 ofhe„edeemScripthat is missing"},

1728 {
RPCResuÉ
::
Ty³
::
STR_HEX
, "w™Ãsssüt", 
Œue
, "SHA256 ofhe witnessScripthat is missing"},

1730 {
RPCResuÉ
::
Ty³
::
STR
, "Ãxt", 
Œue
, "Role ofhe‚ext…ersonhathis input‚eedso goo"},

1733 {
RPCResuÉ
::
Ty³
::
NUM
, "e¡im©ed_vsize", 
Œue
, "Estimated vsize ofhe final signedransaction"},

1734 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "e¡im©ed_ã”©e", 
Œue
, "E¡im©ed f“¿‹ oàthfš® sigÃd¿n§ùiÚ iÀ" + 
CURRENCY_UNIT
 + "/kB. Shown only if‡ll UTXO slots inhe PSBT have been filled"},

1735 {
RPCResuÉ
::
Ty³
::
STR_AMOUNT
, "ãe", 
Œue
, "Theransaction fee…aid. Shown only if‡ll UTXO slots inhe PSBT have been filled"},

1736 {
RPCResuÉ
::
Ty³
::
STR
, "next", "Role ofhe‚ext…ersonhathis…sbt‚eedso goo"},

1737 {
RPCResuÉ
::
Ty³
::
STR
, "error", "Error message ifhere is one"},

1740 
RPCExam¶es
 {

1741 
	`H–pExam¶eCli
("analyzepsbt", "\"psbt\"")

1742 }}.
	`Check
(
»que¡
);

1744 
	`RPCTy³Check
(
»que¡
.
·¿ms
, {
UniV®ue
::
VSTR
});

1747 
P¬tŸÎySigÃdT¿n§ùiÚ
 
psbtx
;

1748 
¡d
::
¡ršg
 
”rÜ
;

1749 ià(!
	`DecodeBa£64PSBT
(
psbtx
, 
»que¡
.
·¿ms
[0].
	`g‘_¡r
(), 
”rÜ
)) {

1750 
throw
 
	`JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
	`¡½rštf
("TX decodçed %s", 
”rÜ
));

1753 
PSBTAÇlysis
 
psb
 = 
	`AÇlyzePSBT
(
psbtx
);

1755 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

1756 
UniV®ue
 
	`šputs_»suÉ
(UniV®ue::
VARR
);

1757 cÚ¡‡uto& 
šput
 : 
psb
.
šputs
) {

1758 
UniV®ue
 
	`šput_univ
(UniV®ue::
VOBJ
);

1759 
UniV®ue
 
	`missšg
(UniV®ue::
VOBJ
);

1761 
šput_univ
.
	`pushKV
("has_utxo", 
šput
.
has_utxo
);

1762 
šput_univ
.
	`pushKV
("is_fš®", 
šput
.
is_fš®
);

1763 
šput_univ
.
	`pushKV
("Ãxt", 
	`PSBTRŞeName
(
šput
.
Ãxt
));

1765 ià(!
šput
.
missšg_pubkeys
.
	`em±y
()) {

1766 
UniV®ue
 
	`missšg_pubkeys_univ
(UniV®ue::
VARR
);

1767 cÚ¡ 
CKeyID
& 
pubkey
 : 
šput
.
missšg_pubkeys
) {

1768 
missšg_pubkeys_univ
.
	`push_back
(
	`HexSŒ
(
pubkey
));

1770 
missšg
.
	`pushKV
("pubkeys", 
missšg_pubkeys_univ
);

1772 ià(!
šput
.
missšg_»d“m_süt
.
	`IsNuÎ
()) {

1773 
missšg
.
	`pushKV
("»d“msüt", 
	`HexSŒ
(
šput
.
missšg_»d“m_süt
));

1775 ià(!
šput
.
missšg_w™Ãss_süt
.
	`IsNuÎ
()) {

1776 
missšg
.
	`pushKV
("w™Ãsssüt", 
	`HexSŒ
(
šput
.
missšg_w™Ãss_süt
));

1778 ià(!
šput
.
missšg_sigs
.
	`em±y
()) {

1779 
UniV®ue
 
	`missšg_sigs_univ
(UniV®ue::
VARR
);

1780 cÚ¡ 
CKeyID
& 
pubkey
 : 
šput
.
missšg_sigs
) {

1781 
missšg_sigs_univ
.
	`push_back
(
	`HexSŒ
(
pubkey
));

1783 
missšg
.
	`pushKV
("sigÇtu»s", 
missšg_sigs_univ
);

1785 ià(!
missšg
.
	`g‘Keys
().
	`em±y
()) {

1786 
šput_univ
.
	`pushKV
("missšg", 
missšg
);

1788 
šputs_»suÉ
.
	`push_back
(
šput_univ
);

1790 ià(!
šputs_»suÉ
.
	`em±y
()è
»suÉ
.
	`pushKV
("inputs", inputs_result);

1792 ià(
psb
.
e¡im©ed_vsize
 !ğ
nuÎİt
) {

1793 
»suÉ
.
	`pushKV
("e¡im©ed_vsize", ()*
psb
.
e¡im©ed_vsize
);

1795 ià(
psb
.
e¡im©ed_ã”©e
 !ğ
nuÎİt
) {

1796 
»suÉ
.
	`pushKV
("e¡im©ed_ã”©e", 
	`V®ueFromAmouÁ
(
psb
.
e¡im©ed_ã”©e
->
	`G‘F“P”K
()));

1798 ià(
psb
.
ãe
 !ğ
nuÎİt
) {

1799 
»suÉ
.
	`pushKV
("ãe", 
	`V®ueFromAmouÁ
(*
psb
.
ãe
));

1801 
»suÉ
.
	`pushKV
("Ãxt", 
	`PSBTRŞeName
(
psb
.
Ãxt
));

1802 ià(!
psb
.
”rÜ
.
	`em±y
()) {

1803 
»suÉ
.
	`pushKV
("”rÜ", 
psb
.
”rÜ
);

1806  
»suÉ
;

1807 
	}
}

1809 
	$Regi¡”RawT¿n§ùiÚRPCCommªds
(
CRPCTabË
 &
t
)

1812 cÚ¡ 
CRPCCommªd
 
commªds
[] =

1815 { "¿wŒª§ùiÚs", "g‘¿wŒª§ùiÚ", &
g‘¿wŒª§ùiÚ
, {"txid","verbose","blockhash"} },

1816 { "¿wŒª§ùiÚs", "ü—‹¿wŒª§ùiÚ", &
ü—‹¿wŒª§ùiÚ
, {"inputs","outputs","locktime","replaceable"} },

1817 { "¿wŒª§ùiÚs", "decod”awŒª§ùiÚ", &
decod”awŒª§ùiÚ
, {"hexstring","iswitness"} },

1818 { "¿wŒª§ùiÚs", "decodesüt", &
decodesüt
, {"hexstring"} },

1819 { "¿wŒª§ùiÚs", "£nd¿wŒª§ùiÚ", &
£nd¿wŒª§ùiÚ
, {"hexstring","maxfeerate"} },

1820 { "¿wŒª§ùiÚs", "combš”awŒª§ùiÚ", &
combš”awŒª§ùiÚ
, {"txs"} },

1821 { "¿wŒª§ùiÚs", "sigÄawŒª§ùiÚw™hkey", &
sigÄawŒª§ùiÚw™hkey
, {"hexstring","privkeys","prevtxs","sighashtype"} },

1822 { "¿wŒª§ùiÚs", "‹¡mempoŞacû±", &
‹¡mempoŞacû±
, {"rawtxs","maxfeerate"} },

1823 { "¿wŒª§ùiÚs", "decod•sbt", &
decod•sbt
, {"psbt"} },

1824 { "¿wŒª§ùiÚs", "combš•sbt", &
combš•sbt
, {"txs"} },

1825 { "¿wŒª§ùiÚs", "fš®iz•sbt", &
fš®iz•sbt
, {"psbt", "extract"} },

1826 { "¿wŒª§ùiÚs", "ü—‹psbt", &
ü—‹psbt
, {"inputs","outputs","locktime","replaceable"} },

1827 { "¿wŒª§ùiÚs", "cÚv”‰İsbt", &
cÚv”‰İsbt
, {"hexstring","permitsigdata","iswitness"} },

1828 { "¿wŒª§ùiÚs", "utxoupd©•sbt", &
utxoupd©•sbt
, {"psbt", "descriptors"} },

1829 { "¿wŒª§ùiÚs", "jošpsbts", &
jošpsbts
, {"txs"} },

1830 { "¿wŒª§ùiÚs", "ª®yz•sbt", &
ª®yz•sbt
, {"psbt"} },

1832 { "blockchaš", "g‘txouroof", &
g‘txouroof
, {"txids", "blockhash"} },

1833 { "blockchaš", "v”ifytxouroof", &
v”ifytxouroof
, {"proof"} },

1837 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

1838 
t
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

1839 
	}
}

	@rawtransaction_util.cpp

6 
	~<½c/¿wŒª§ùiÚ_ut.h
>

8 
	~<cošs.h
>

9 
	~<cÜe_io.h
>

10 
	~<key_io.h
>

11 
	~<pŞicy/pŞicy.h
>

12 
	~<´im™ives/Œª§ùiÚ.h
>

13 
	~<½c/»que¡.h
>

14 
	~<½c/ut.h
>

15 
	~<süt/sign.h
>

16 
	~<süt/signšg´ovid”.h
>

17 
	~<tšyfÜm©.h
>

18 
	~<univ®ue.h
>

19 
	~<ut/rbf.h
>

20 
	~<ut/¡»ncodšgs.h
>

22 
CMubËT¿n§ùiÚ
 
	$CÚ¡ruùT¿n§ùiÚ
(cÚ¡ 
UniV®ue
& 
šputs_š
, cÚ¡ UniV®ue& 
ouuts_š
, cÚ¡ UniV®ue& 
locktime
, 
boŞ
 
rbf
)

24 ià(
šputs_š
.
	`isNuÎ
(è|| 
ouuts_š
.isNull())

25 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter,‡rguments 1‡nd 2 must be‚on-null");

27 
UniV®ue
 
šputs
 = 
šputs_š
.
	`g‘_¬¿y
();

28 cÚ¡ 
boŞ
 
ouuts_is_obj
 = 
ouuts_š
.
	`isObjeù
();

29 
UniV®ue
 
ouuts
 = 
ouuts_is_obj
 ? 
ouuts_š
.
	`g‘_obj
(è: ouuts_š.
	`g‘_¬¿y
();

31 
CMubËT¿n§ùiÚ
 
¿wTx
;

33 ià(!
locktime
.
	`isNuÎ
()) {

34 
št64_t
 
nLockTime
 = 
locktime
.
	`g‘_št64
();

35 ià(
nLockTime
 < 0 ||‚LockTim> 
LOCKTIME_MAX
)

36 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter,†ocktime out of„ange");

37 
¿wTx
.
nLockTime
 =‚LockTime;

40 
idx
 = 0; idx < 
šputs
.
	`size
(); idx++) {

41 cÚ¡ 
UniV®ue
& 
šput
 = 
šputs
[
idx
];

42 cÚ¡ 
UniV®ue
& 
o
 = 
šput
.
	`g‘_obj
();

44 
ušt256
 
txid
 = 
	`P¬£HashO
(
o
, "txid");

46 cÚ¡ 
UniV®ue
& 
vout_v
 = 
	`fšd_v®ue
(
o
, "vout");

47 ià(!
vout_v
.
	`isNum
())

48 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, missing vout key");

49 
nOuut
 = 
vout_v
.
	`g‘_št
();

50 ià(
nOuut
 < 0)

51 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, vout must be…ositive");

53 
ušt32_t
 
nSequ’û
;

54 ià(
rbf
) {

55 
nSequ’û
 = 
MAX_BIP125_RBF_SEQUENCE
;

56 } ià(
¿wTx
.
nLockTime
) {

57 
nSequ’û
 = 
CTxIn
::
SEQUENCE_FINAL
 - 1;

59 
nSequ’û
 = 
CTxIn
::
SEQUENCE_FINAL
;

63 cÚ¡ 
UniV®ue
& 
£qu’ûObj
 = 
	`fšd_v®ue
(
o
, "sequence");

64 ià(
£qu’ûObj
.
	`isNum
()) {

65 
št64_t
 
£qNr64
 = 
£qu’ûObj
.
	`g‘_št64
();

66 ià(
£qNr64
 < 0 || seqNr64 > 
CTxIn
::
SEQUENCE_FINAL
) {

67 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, sequence‚umber is out of„ange");

69 
nSequ’û
 = (
ušt32_t
)
£qNr64
;

73 
CTxIn
 
	`š
(
	`COutPošt
(
txid
, 
nOuut
), 
	`CSüt
(), 
nSequ’û
);

75 
¿wTx
.
vš
.
	`push_back
(
š
);

78 ià(!
ouuts_is_obj
) {

80 
UniV®ue
 
ouuts_diù
 = 
	`UniV®ue
(UniV®ue::
VOBJ
);

81 
size_t
 
i
 = 0; i < 
ouuts
.
	`size
(); ++i) {

82 cÚ¡ 
UniV®ue
& 
ouut
 = 
ouuts
[
i
];

83 ià(!
ouut
.
	`isObjeù
()) {

84 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, key-value…air‚ot‡n object‡sƒxpected");

86 ià(
ouut
.
	`size
() != 1) {

87 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, key-value…air must containƒxactly one key");

89 
ouuts_diù
.
	`pushKVs
(
ouut
);

91 
ouuts
 = 
¡d
::
	`move
(
ouuts_diù
);

95 
¡d
::
£t
<
CTxDe¡š©iÚ
> 
de¡š©iÚs
;

96 
boŞ
 
has_d©a
{
çl£
};

98 cÚ¡ 
¡d
::
¡ršg
& 
Çme_
 : 
ouuts
.
	`g‘Keys
()) {

99 ià(
Çme_
 == "data") {

100 ià(
has_d©a
) {

101 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter, duplicate key: data");

103 
has_d©a
 = 
Œue
;

104 
¡d
::
veùÜ
<> 
d©a
 = 
	`P¬£HexV
(
ouuts
[
Çme_
].
	`g‘V®SŒ
(), "Data");

106 
CTxOut
 
	`out
(0, 
	`CSüt
(è<< 
OP_RETURN
 << 
d©a
);

107 
¿wTx
.
vout
.
	`push_back
(
out
);

109 
CTxDe¡š©iÚ
 
de¡š©iÚ
 = 
	`DecodeDe¡š©iÚ
(
Çme_
);

110 ià(!
	`IsV®idDe¡š©iÚ
(
de¡š©iÚ
)) {

111 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
¡d
::
	`¡ršg
("Inv®id Syscoš‡dd»ss: "è+ 
Çme_
);

114 ià(!
de¡š©iÚs
.
	`š£¹
(
de¡š©iÚ
).
£cÚd
) {

115 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
¡d
::
	`¡ršg
("Inv®id…¬am‘”, du¶iÿ‹d‡dd»ss: "è+ 
Çme_
);

118 
CSüt
 
sütPubKey
 = 
	`G‘SütFÜDe¡š©iÚ
(
de¡š©iÚ
);

119 
CAmouÁ
 
nAmouÁ
 = 
	`AmouÁFromV®ue
(
ouuts
[
Çme_
]);

121 
CTxOut
 
	`out
(
nAmouÁ
, 
sütPubKey
);

122 
¿wTx
.
vout
.
	`push_back
(
out
);

126 ià(
rbf
 && 
¿wTx
.
vš
.
	`size
(è> 0 && !
	`SigÇlsO±InRBF
(
	`CT¿n§ùiÚ
(rawTx))) {

127 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…arameter combination: Sequence‚umber(s) contradict„eplaceable option");

130  
¿wTx
;

131 
	}
}

134 
	$TxInE¼ÜToJSON
(cÚ¡ 
CTxIn
& 
txš
, 
UniV®ue
& 
vE¼ÜsR‘
, cÚ¡ 
¡d
::
¡ršg
& 
¡rMes§ge
)

136 
UniV®ue
 
	`’Œy
(UniV®ue::
VOBJ
);

137 
’Œy
.
	`pushKV
("txid", 
txš
.
´evout
.
hash
.
	`ToSŒšg
());

138 
’Œy
.
	`pushKV
("vout", (
ušt64_t
)
txš
.
´evout
.
n
);

139 
UniV®ue
 
	`w™Ãss
(UniV®ue::
VARR
);

140 
i
 = 0; i < 
txš
.
sütW™Ãss
.
¡ack
.
	`size
(); i++) {

141 
w™Ãss
.
	`push_back
(
	`HexSŒ
(
txš
.
sütW™Ãss
.
¡ack
[
i
].
	`begš
(),xš.sütW™Ãss.¡ack[i].
	`’d
()));

143 
’Œy
.
	`pushKV
("w™Ãss", 
w™Ãss
);

144 
’Œy
.
	`pushKV
("sütSig", 
	`HexSŒ
(
txš
.
sütSig
.
	`begš
(),xš.sütSig.
	`’d
()));

145 
’Œy
.
	`pushKV
("£qu’û", (
ušt64_t
)
txš
.
nSequ’û
);

146 
’Œy
.
	`pushKV
("”rÜ", 
¡rMes§ge
);

147 
vE¼ÜsR‘
.
	`push_back
(
’Œy
);

148 
	}
}

150 
P¬£P»vouts
(cÚ¡ 
UniV®ue
& 
´evTxsUniv®
, 
FÏbËSignšgProvid”
* 
key¡Üe
, 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
)

152 ià(!
	g´evTxsUniv®
.
isNuÎ
()) {

153 
UniV®ue
 
	g´evTxs
 = 
´evTxsUniv®
.
g‘_¬¿y
();

154 
	gidx
 = 0; idx < 
	g´evTxs
.
size
(); ++idx) {

155 cÚ¡ 
	gUniV®ue
& 
	gp
 = 
´evTxs
[
idx
];

156 ià(!
	gp
.
isObjeù
()) {

157 
throw
 
JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "expected object with {\"txid'\",\"vout\",\"scriptPubKey\"}");

160 
UniV®ue
 
	g´evOut
 = 
p
.
g‘_obj
();

162 
RPCTy³CheckObj
(
´evOut
,

164 {"txid", 
UniV®ueTy³
(
UniV®ue
::
VSTR
)},

165 {"vout", 
UniV®ueTy³
(
UniV®ue
::
VNUM
)},

166 {"sütPubKey", 
UniV®ueTy³
(
UniV®ue
::
VSTR
)},

169 
ušt256
 
	gtxid
 = 
P¬£HashO
(
´evOut
, "txid");

171 
	gnOut
 = 
fšd_v®ue
(
´evOut
, "vout").
g‘_št
();

172 ià(
	gnOut
 < 0) {

173 
throw
 
JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, "vout must be…ositive");

176 
COutPošt
 
out
(
txid
, 
nOut
);

177 
	g¡d
::
veùÜ
<> 
pkD©a
(
P¬£HexO
(
´evOut
, "scriptPubKey"));

178 
CSüt
 
sütPubKey
(
pkD©a
.
begš
(),…kD©a.
’d
());

181 autØ
	gcoš
 = 
cošs
.
fšd
(
out
);

182 ià(
	gcoš
 !ğ
cošs
.
’d
(è&& !
coš
->
£cÚd
.
IsS³Á
(è&& coš->£cÚd.
out
.
sütPubKey
 != scriptPubKey) {

183 
¡d
::
¡ršg
 
”r
("Previous output scriptPubKey mismatch:\n");

184 
	g”r
 = 
”r
 + 
SütToAsmSŒ
(
coš
->
£cÚd
.
out
.
sütPubKey
) + "\nvs:\n"+

185 
SütToAsmSŒ
(
sütPubKey
);

186 
throw
 
JSONRPCE¼Ü
(
RPC_DESERIALIZATION_ERROR
, 
”r
);

188 
Coš
 
	gÃwcoš
;

189 
	gÃwcoš
.
	gout
.
	gsütPubKey
 = 
sütPubKey
;

190 
	gÃwcoš
.
	gout
.
	gnV®ue
 = 
MAX_MONEY
;

191 ià(
	g´evOut
.
exi¡s
("amount")) {

192 
	gÃwcoš
.
	gout
.
	gnV®ue
 = 
AmouÁFromV®ue
(
fšd_v®ue
(
´evOut
, "amount"));

194 
	gÃwcoš
.
	gnHeight
 = 1;

195 
	gcošs
[
out
] = 
¡d
::
move
(
Ãwcoš
);

199 cÚ¡ 
boŞ
 
	gis_p2sh
 = 
sütPubKey
.
IsPayToSütHash
();

200 cÚ¡ 
boŞ
 
	gis_p2wsh
 = 
sütPubKey
.
IsPayToW™ÃssSütHash
();

201 ià(
	gkey¡Üe
 && (
	gis_p2sh
 || 
	gis_p2wsh
)) {

202 
RPCTy³CheckObj
(
´evOut
,

204 {"»d“mSüt", 
UniV®ueTy³
(
UniV®ue
::
VSTR
)},

205 {"w™ÃssSüt", 
UniV®ueTy³
(
UniV®ue
::
VSTR
)},

206 }, 
Œue
);

207 
UniV®ue
 
	grs
 = 
fšd_v®ue
(
´evOut
, "redeemScript");

208 
UniV®ue
 
	gws
 = 
fšd_v®ue
(
´evOut
, "witnessScript");

209 ià(
	grs
.
isNuÎ
(è&& 
	gws
.isNull()) {

210 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Missing„edeemScript/witnessScript");

214 
	g¡d
::
veùÜ
<> 
sütD©a
(!
ws
.
isNuÎ
(è? 
P¬£HexV
(ws, "w™ÃssSüt"è: P¬£HexV(
rs
, "redeemScript"));

215 
CSüt
 
süt
(
sütD©a
.
begš
(), sütD©a.
’d
());

216 
	gkey¡Üe
->
AddCSüt
(
süt
);

219 
CSüt
 
	gw™Ãss_ouut_süt
{
G‘SütFÜDe¡š©iÚ
(
W™ÃssV0SütHash
(
süt
))};

220 
	gkey¡Üe
->
AddCSüt
(
w™Ãss_ouut_süt
);

222 ià(!
	gws
.
isNuÎ
(è&& !
	grs
.isNull()) {

227 ià(
	gws
.
g‘_¡r
(è!ğ
rs
.get_str()) {

228 
¡d
::
veùÜ
<> 
»d“mSütD©a
(
P¬£HexV
(
rs
, "redeemScript"));

229 
CSüt
 
»d“mSüt
(
»d“mSütD©a
.
begš
(),„ed“mSütD©a.
’d
());

230 ià(
	g»d“mSüt
 !ğ
w™Ãss_ouut_süt
) {

231 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "redeemScript does‚ot correspondo witnessScript");

236 ià(
	gis_p2sh
) {

237 cÚ¡ 
CTxDe¡š©iÚ
 
	gp2sh
{
SütHash
(
süt
)};

238 cÚ¡ 
CTxDe¡š©iÚ
 
	gp2sh_p2wsh
{
SütHash
(
w™Ãss_ouut_süt
)};

239 ià(
	gsütPubKey
 =ğ
G‘SütFÜDe¡š©iÚ
(
p2sh
)) {

245 } ià(
sütPubKey
 =ğ
G‘SütFÜDe¡š©iÚ
(
p2sh_p2wsh
)) {

254 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "redeemScript/witnessScript does‚ot match scriptPubKey");

256 } ià(
	gis_p2wsh
) {

261 cÚ¡ 
CTxDe¡š©iÚ
 
	gp2wsh
{
W™ÃssV0SütHash
(
süt
)};

262 ià(
	gsütPubKey
 !ğ
G‘SütFÜDe¡š©iÚ
(
p2wsh
)) {

263 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "redeemScript/witnessScript does‚ot match scriptPubKey");

271 
SignT¿n§ùiÚ
(
CMubËT¿n§ùiÚ
& 
mtx
, cÚ¡ 
SignšgProvid”
* 
key¡Üe
, cÚ¡ 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
, cÚ¡ 
UniV®ue
& 
hashTy³
, UniV®ue& 
»suÉ
)

273 
	gnHashTy³
 = 
P¬£SighashSŒšg
(
hashTy³
);

276 
	g¡d
::
m­
<, std::
¡ršg
> 
šput_”rÜs
;

278 
boŞ
 
	gcom¶‘e
 = 
SignT¿n§ùiÚ
(
mtx
, 
key¡Üe
, 
cošs
, 
nHashTy³
, 
šput_”rÜs
);

279 
SignT¿n§ùiÚResuÉToJSON
(
mtx
, 
com¶‘e
, 
cošs
, 
šput_”rÜs
, 
»suÉ
);

282 
SignT¿n§ùiÚResuÉToJSON
(
CMubËT¿n§ùiÚ
& 
mtx
, 
boŞ
 
com¶‘e
, cÚ¡ 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
, std::m­<, std::
¡ršg
>& 
šput_”rÜs
, 
UniV®ue
& 
»suÉ
)

285 
UniV®ue
 
vE¼Üs
(UniV®ue::
VARR
);

286 cÚ¡‡uto& 
	g”r_·œ
 : 
šput_”rÜs
) {

287 ià(
”r_·œ
.
£cÚd
 == "Missing‡mount") {

289 
throw
 
JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, 
¡½rštf
("Missšg‡mouÁ fÜ %s", 
cošs
.
©
(
mtx
.
vš
.©(
”r_·œ
.
fœ¡
).
´evout
).
out
.
ToSŒšg
()));

291 
TxInE¼ÜToJSON
(
mtx
.
vš
.
©
(
”r_·œ
.
fœ¡
), 
vE¼Üs
,ƒ¼_·œ.
£cÚd
);

294 
	g»suÉ
.
pushKV
("hex", 
EncodeHexTx
(
CT¿n§ùiÚ
(
mtx
)));

295 
	g»suÉ
.
pushKV
("com¶‘e", 
com¶‘e
);

296 ià(!
	gvE¼Üs
.
em±y
()) {

297 ià(
	g»suÉ
.
exi¡s
("errors")) {

298 
	gvE¼Üs
.
push_backV
(
»suÉ
["”rÜs"].
g‘V®ues
());

300 
	g»suÉ
.
pushKV
("”rÜs", 
vE¼Üs
);

	@rawtransaction_util.h

5 #iâdeà
SYSCOIN_RPC_RAWTRANSACTION_UTIL_H


6 
	#SYSCOIN_RPC_RAWTRANSACTION_UTIL_H


	)

8 
	~<m­
>

9 
	~<¡ršg
>

11 
şass
 
	gFÏbËSignšgProvid”
;

12 
şass
 
	gUniV®ue
;

13 
şass
 
	gušt256
;

14 
	gCMubËT¿n§ùiÚ
;

15 
şass
 
	gCoš
;

16 
şass
 
	gCOutPošt
;

17 
şass
 
	gSignšgProvid”
;

18 
şass
 
	gCT¿n§ùiÚ
;

28 
SignT¿n§ùiÚ
(
CMubËT¿n§ùiÚ
& 
mtx
, cÚ¡ 
SignšgProvid”
* 
key¡Üe
, cÚ¡ 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
, cÚ¡ 
UniV®ue
& 
hashTy³
, UniV®ue& 
»suÉ
);

29 
SignT¿n§ùiÚResuÉToJSON
(
CMubËT¿n§ùiÚ
& 
mtx
, 
boŞ
 
com¶‘e
, cÚ¡ 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
, std::m­<, std::
¡ršg
>& 
šput_”rÜs
, 
UniV®ue
& 
»suÉ
);

38 
P¬£P»vouts
(cÚ¡ 
UniV®ue
& 
´evTxsUniv®
, 
FÏbËSignšgProvid”
* 
key¡Üe
, 
¡d
::
m­
<
COutPošt
, 
Coš
>& 
cošs
);

41 
CMubËT¿n§ùiÚ
 
CÚ¡ruùT¿n§ùiÚ
(cÚ¡ 
UniV®ue
& 
šputs_š
, cÚ¡ UniV®ue& 
ouuts_š
, cÚ¡ UniV®ue& 
locktime
, 
boŞ
 
rbf
);

43 
TxToJSON
(cÚ¡ 
CT¿n§ùiÚ
& 
tx
, cÚ¡ 
ušt256
 
hashBlock
, 
UniV®ue
& 
’Œy
);

	@register.h

5 #iâdeà
SYSCOIN_RPC_REGISTER_H


6 
	#SYSCOIN_RPC_REGISTER_H


	)

10 
şass
 
	gCRPCTabË
;

13 
Regi¡”BlockchašRPCCommªds
(
CRPCTabË
 &
bËRPC
);

15 
Regi¡”N‘RPCCommªds
(
CRPCTabË
 &
bËRPC
);

17 
Regi¡”MiscRPCCommªds
(
CRPCTabË
 &
bËRPC
);

19 
Regi¡”MššgRPCCommªds
(
CRPCTabË
 &
bËRPC
);

21 
Regi¡”RawT¿n§ùiÚRPCCommªds
(
CRPCTabË
 &
bËRPC
);

24 
Regi¡”As£tRPCCommªds
(
CRPCTabË
 &
bËRPC
);

26 
Regi¡”Ma¡”nodeRPCCommªds
(
CRPCTabË
 &
bËRPC
);

28 
Regi¡”Gov”ÇnûRPCCommªds
(
CRPCTabË
 &
bËRPC
);

30 
Regi¡”EvoRPCCommªds
(
CRPCTabË
 &
bËRPC
);

32 
Regi¡”QuÜumsRPCCommªds
(
CRPCTabË
 &
bËRPC
);

33 
šlše
 
	$Regi¡”AÎCÜeRPCCommªds
(
CRPCTabË
 &
t
)

35 
	`Regi¡”BlockchašRPCCommªds
(
t
);

36 
	`Regi¡”N‘RPCCommªds
(
t
);

37 
	`Regi¡”MiscRPCCommªds
(
t
);

38 
	`Regi¡”MššgRPCCommªds
(
t
);

39 
	`Regi¡”RawT¿n§ùiÚRPCCommªds
(
t
);

41 
	`Regi¡”As£tRPCCommªds
(
t
);

42 
	`Regi¡”Ma¡”nodeRPCCommªds
(
t
);

43 
	`Regi¡”Gov”ÇnûRPCCommªds
(
t
);

44 
	`Regi¡”EvoRPCCommªds
(
t
);

45 
	`Regi¡”QuÜumsRPCCommªds
(
t
);

46 
	}
}

	@request.cpp

6 
	~<½c/»que¡.h
>

8 
	~<fs.h
>

10 
	~<¿ndom.h
>

11 
	~<½c/´ÙocŞ.h
>

12 
	~<ut/sy¡em.h
>

13 
	~<ut/¡»ncodšgs.h
>

24 
UniV®ue
 
	$JSONRPCReque¡Obj
(cÚ¡ 
¡d
::
¡ršg
& 
¡rM‘hod
, cÚ¡ 
UniV®ue
& 
·¿ms
, cÚ¡ UniV®ue& 
id
)

26 
UniV®ue
 
	`»que¡
(UniV®ue::
VOBJ
);

27 
»que¡
.
	`pushKV
("m‘hod", 
¡rM‘hod
);

28 
»que¡
.
	`pushKV
("·¿ms", 
·¿ms
);

29 
»que¡
.
	`pushKV
("id", 
id
);

30  
»que¡
;

31 
	}
}

33 
UniV®ue
 
	$JSONRPCR•lyObj
(cÚ¡ 
UniV®ue
& 
»suÉ
, cÚ¡ UniV®ue& 
”rÜ
, cÚ¡ UniV®ue& 
id
)

35 
UniV®ue
 
	`»¶y
(UniV®ue::
VOBJ
);

36 ià(!
”rÜ
.
	`isNuÎ
())

37 
»¶y
.
	`pushKV
("»suÉ", 
NuÎUniV®ue
);

39 
»¶y
.
	`pushKV
("»suÉ", 
»suÉ
);

40 
»¶y
.
	`pushKV
("”rÜ", 
”rÜ
);

41 
»¶y
.
	`pushKV
("id", 
id
);

42  
»¶y
;

43 
	}
}

45 
	g¡d
::
¡ršg
 
	$JSONRPCR•ly
(cÚ¡ 
UniV®ue
& 
»suÉ
, cÚ¡ UniV®ue& 
”rÜ
, cÚ¡ UniV®ue& 
id
)

47 
UniV®ue
 
»¶y
 = 
	`JSONRPCR•lyObj
(
»suÉ
, 
”rÜ
, 
id
);

48  
»¶y
.
	`wr™e
() + "\n";

49 
	}
}

51 
UniV®ue
 
	$JSONRPCE¼Ü
(
code
, cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
)

53 
UniV®ue
 
	`”rÜ
(UniV®ue::
VOBJ
);

54 
”rÜ
.
	`pushKV
("code", 
code
);

55 
”rÜ
.
	`pushKV
("mes§ge", 
mes§ge
);

56  
”rÜ
;

57 
	}
}

62 cÚ¡ 
	g¡d
::
¡ršg
 
COOKIEAUTH_USER
 = "__cookie__";

64 cÚ¡ 
	g¡d
::
¡ršg
 
COOKIEAUTH_FILE
 = ".cookie";

67 
	gfs
::
·th
 
	$G‘AuthCook›Fe
(
boŞ
 
‹mp
=
çl£
)

69 
¡d
::
¡ršg
 
¬g
 = 
gArgs
.
	`G‘Arg
("-½ccook›fe", 
COOKIEAUTH_FILE
);

70 ià(
‹mp
) {

71 
¬g
 += ".tmp";

73  
	`AbsP©hFÜCÚfigV®
(
fs
::
	`·th
(
¬g
));

74 
	}
}

76 
boŞ
 
	$G’”©eAuthCook›
(
¡d
::
¡ršg
 *
cook›_out
)

78 cÚ¡ 
size_t
 
COOKIE_SIZE
 = 32;

79 
¿nd_pwd
[
COOKIE_SIZE
];

80 
	`G‘RªdBy‹s
(
¿nd_pwd
, 
COOKIE_SIZE
);

81 
¡d
::
¡ršg
 
cook›
 = 
COOKIEAUTH_USER
 + ":" + 
	`HexSŒ
(
¿nd_pwd
,„ªd_pwd+
COOKIE_SIZE
);

86 
fsbridge
::
of¡»am
 
fe
;

87 
fs
::
·th
 
f•©h_tmp
 = 
	`G‘AuthCook›Fe
(
Œue
);

88 
fe
.
	`İ’
(
f•©h_tmp
);

89 ià(!
fe
.
	`is_İ’
()) {

90 
	`LogPrštf
("UÇbËØİ’ cook›‡uth’tiÿtiÚ f% fÜ wr™šg\n", 
f•©h_tmp
.
	`¡ršg
());

91  
çl£
;

93 
fe
 << 
cook›
;

94 
fe
.
	`şo£
();

96 
fs
::
·th
 
f•©h
 = 
	`G‘AuthCook›Fe
(
çl£
);

97 ià(!
	`R’ameOv”
(
f•©h_tmp
, 
f•©h
)) {

98 
	`LogPrštf
("UÇbËØ»Çmcook›‡uth’tiÿtiÚ f% tØ%s\n", 
f•©h_tmp
.
	`¡ršg
(), 
f•©h
.string());

99  
çl£
;

101 
	`LogPrštf
("G’”©ed RPC‡uth’tiÿtiÚ cook› %s\n", 
f•©h
.
	`¡ršg
());

103 ià(
cook›_out
)

104 *
cook›_out
 = 
cook›
;

105  
Œue
;

106 
	}
}

108 
boŞ
 
	$G‘AuthCook›
(
¡d
::
¡ršg
 *
cook›_out
)

110 
fsbridge
::
if¡»am
 
fe
;

111 
¡d
::
¡ršg
 
cook›
;

112 
fs
::
·th
 
f•©h
 = 
	`G‘AuthCook›Fe
();

113 
fe
.
	`İ’
(
f•©h
);

114 ià(!
fe
.
	`is_İ’
())

115  
çl£
;

116 
¡d
::
	`g‘lše
(
fe
, 
cook›
);

117 
fe
.
	`şo£
();

119 ià(
cook›_out
)

120 *
cook›_out
 = 
cook›
;

121  
Œue
;

122 
	}
}

124 
	$D–‘eAuthCook›
()

126 
Œy
 {

127 
fs
::
	`»move
(
	`G‘AuthCook›Fe
());

128 } 
	`ÿtch
 (cÚ¡ 
fs
::
fesy¡em_”rÜ
& 
e
) {

129 
	`LogPrštf
("%s: UÇbËØ»mov¿ndom‡uth cook› fe: %s\n", 
__func__
, 
fsbridge
::
	`g‘_fesy¡em_”rÜ_mes§ge
(
e
));

131 
	}
}

133 
	g¡d
::
veùÜ
<
UniV®ue
> 
	$JSONRPCProûssB©chR•ly
(cÚ¡ 
UniV®ue
& 
š
)

135 ià(!
š
.
	`isA¼ay
()) {

136 
throw
 
¡d
::
	`ruÁime_”rÜ
("Batch must be‡n‡rray");

138 cÚ¡ 
size_t
 
num
 {
š
.
	`size
()};

139 
¡d
::
veùÜ
<
UniV®ue
> 
	`b©ch
(
num
);

140 cÚ¡ 
UniV®ue
& 
»c
 : 
š
.
	`g‘V®ues
()) {

141 ià(!
»c
.
	`isObjeù
()) {

142 
throw
 
¡d
::
	`ruÁime_”rÜ
("Batch member must be‡n object");

144 
size_t
 
id
 = 
»c
["id"].
	`g‘_št
();

145 ià(
id
 >ğ
num
) {

146 
throw
 
¡d
::
	`ruÁime_”rÜ
("Batch member id is†argerhan batch size");

148 
b©ch
[
id
] = 
»c
;

150  
b©ch
;

151 
	}
}

153 
	gJSONRPCReque¡
::
	$·r£
(cÚ¡ 
UniV®ue
& 
v®Reque¡
)

156 ià(!
v®Reque¡
.
	`isObjeù
())

157 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_REQUEST
, "Invalid Request object");

158 cÚ¡ 
UniV®ue
& 
»que¡
 = 
v®Reque¡
.
	`g‘_obj
();

161 
id
 = 
	`fšd_v®ue
(
»que¡
, "id");

164 
UniV®ue
 
v®M‘hod
 = 
	`fšd_v®ue
(
»que¡
, "method");

165 ià(
v®M‘hod
.
	`isNuÎ
())

166 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_REQUEST
, "Missing method");

167 ià(!
v®M‘hod
.
	`isSŒ
())

168 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_REQUEST
, "Method must be‡ string");

169 
¡rM‘hod
 = 
v®M‘hod
.
	`g‘_¡r
();

170 ià(
fLogIPs
)

171 
	`LogPršt
(
BCLog
::
RPC
, "Th»adRPCS”v” m‘hod=% u£r=% ³”addr=%s\n", 
	`Sª™izeSŒšg
(
¡rM‘hod
),

172 
this
->
authU£r
,his->
³”Addr
);

174 
	`LogPršt
(
BCLog
::
RPC
, "Th»adRPCS”v” m‘hod=% u£r=%s\n", 
	`Sª™izeSŒšg
(
¡rM‘hod
), 
this
->
authU£r
);

177 
UniV®ue
 
v®P¬ams
 = 
	`fšd_v®ue
(
»que¡
, "params");

178 ià(
v®P¬ams
.
	`isA¼ay
(è|| v®P¬ams.
	`isObjeù
())

179 
·¿ms
 = 
v®P¬ams
;

180 ià(
v®P¬ams
.
	`isNuÎ
())

181 
·¿ms
 = 
	`UniV®ue
(
UniV®ue
::
VARR
);

183 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_REQUEST
, "Params must be‡n‡rray or object");

184 
	}
}

	@request.h

6 #iâdeà
SYSCOIN_RPC_REQUEST_H


7 
	#SYSCOIN_RPC_REQUEST_H


	)

9 
	~<¡ršg
>

11 
	~<univ®ue.h
>

13 
Çme¥aû
 
	gut
 {

14 
şass
 
	gRef
;

17 
UniV®ue
 
JSONRPCReque¡Obj
(cÚ¡ 
¡d
::
¡ršg
& 
¡rM‘hod
, cÚ¡ UniV®ue& 
·¿ms
, cÚ¡ UniV®ue& 
id
);

18 
UniV®ue
 
JSONRPCR•lyObj
(cÚ¡ UniV®ue& 
»suÉ
, cÚ¡ UniV®ue& 
”rÜ
, cÚ¡ UniV®ue& 
id
);

19 
	g¡d
::
¡ršg
 
JSONRPCR•ly
(cÚ¡ 
UniV®ue
& 
»suÉ
, cÚ¡ UniV®ue& 
”rÜ
, cÚ¡ UniV®ue& 
id
);

20 
UniV®ue
 
JSONRPCE¼Ü
(
code
, cÚ¡ 
¡d
::
¡ršg
& 
mes§ge
);

23 
boŞ
 
G’”©eAuthCook›
(
¡d
::
¡ršg
 *
cook›_out
);

25 
boŞ
 
G‘AuthCook›
(
¡d
::
¡ršg
 *
cook›_out
);

27 
D–‘eAuthCook›
();

29 
	g¡d
::
veùÜ
<
UniV®ue
> 
JSONRPCProûssB©chR•ly
(cÚ¡ UniV®ue& 
š
);

31 şas 
	cJSONRPCReque¡


33 
	mpublic
:

34 
UniV®ue
 
id
;

35 
	m¡d
::
¡ršg
 
¡rM‘hod
;

36 
UniV®ue
 
	m·¿ms
;

37 
boŞ
 
	mfH–p
;

38 
	m¡d
::
¡ršg
 
URI
;

39 
	m¡d
::
¡ršg
 
authU£r
;

40 
	m¡d
::
¡ršg
 
³”Addr
;

41 cÚ¡ 
	mut
::
Ref
& 
cÚ‹xt
;

43 
	$JSONRPCReque¡
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
è: 
	`id
(
NuÎUniV®ue
), 
	`·¿ms
(NuÎUniV®ue), 
	`fH–p
(
çl£
), 
	$cÚ‹xt
(
cÚ‹xt
) {}

48 
	$JSONRPCReque¡
(cÚ¡ 
JSONRPCReque¡
& 
Ùh”
, cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
)

49 : 
	`id
(
Ùh”
.
id
), 
	`¡rM‘hod
(Ùh”.
¡rM‘hod
), 
	`·¿ms
(Ùh”.
·¿ms
), 
	`fH–p
(Ùh”.
fH–p
), 
	`URI
(Ùh”.
URI
),

50 
	`authU£r
(
Ùh”
.
authU£r
), 
	`³”Addr
(Ùh”.
³”Addr
), 
	$cÚ‹xt
(
cÚ‹xt
)

52 
	}
}

54 
·r£
(cÚ¡ 
UniV®ue
& 
v®Reque¡
);

	@rpcevo.cpp

5 
	~<ba£58.h
>

6 
	~<cÚ£nsus/v®id©iÚ.h
>

7 
	~<cÜe_io.h
>

8 
	~<š™.h
>

9 
	~<mes§gesigÃr.h
>

10 
	~<½c/£rv”.h
>

11 
	~<txmempoŞ.h
>

12 
	~<ut/mÚey¡r.h
>

13 
	~<v®id©iÚ.h
>

15 #ifdeà
ENABLE_WALLET


16 
	~<w®Ët/cošcÚŒŞ.h
>

17 
	~<w®Ët/w®Ët.h
>

18 
	~<w®Ët/½cw®Ët.h
>

21 
	~<Ãtba£.h
>

23 
	~<evo/¥ecŸÉx.h
>

24 
	~<evo/´ovid”tx.h
>

25 
	~<evo/d‘”mši¡icmns.h
>

26 
	~<evo/sim¶if›dmns.h
>

28 
	~<bls/bls.h
>

30 
	~<ma¡”node/ma¡”node-m‘a.h
>

31 
	~<½c/ut.h
>

32 
	~<ut/Œª¦©iÚ.h
>

33 #ifdeà
ENABLE_WALLET


34 
UniV®ue
 
sigÄawŒª§ùiÚw™hw®Ët
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
);

35 
UniV®ue
 
£nd¿wŒª§ùiÚ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
);

38 
	g¡d
::
¡ršg
 
	$G‘H–pSŒšg
(
nP¬amNum
, 
¡d
::
¡ršg
 
¡rP¬amName
)

40 cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, std::¡ršg> 
m­P¬amH–p
 = {

116 autØ
™
 = 
m­P¬amH–p
.
	`fšd
(
¡rP¬amName
);

117 ià(
™
 =ğ
m­P¬amH–p
.
	`’d
())

118 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("FIXME: WRONG PARAM NAME %s!", 
¡rP¬amName
));

120  
	`¡½rštf
(
™
->
£cÚd
, 
nP¬amNum
);

121 
	}
}

124 
CKey
 
	$P¬£PrivKey
(
CW®Ët
* 
pw®Ët
, cÚ¡ 
¡d
::
¡ršg
 &
¡rKeyOrAdd»ss
, 
boŞ
 
®lowAdd»s£s
 = 
Œue
) {

125 #ifdeà
ENABLE_WALLET


126 ià(!
pw®Ët
) {

127 
throw
 
¡d
::
	`ruÁime_”rÜ
("addresses‚ot supported when wallet is disabled");

129 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

131 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

133 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

135 
CTxDe¡š©iÚ
 
de¡
 = 
	`DecodeDe¡š©iÚ
(
¡rKeyOrAdd»ss
);

136 ià(
®lowAdd»s£s
 && 
	`IsV®idDe¡š©iÚ
(
de¡
)) {

137 autØ
keyId
 = 
	`G‘KeyFÜDe¡š©iÚ
(
¥k_mª
, 
de¡
);

138 ià(
keyId
.
	`IsNuÎ
())

139 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Address does‚ot„efero‡ key");

140 
CKey
 
key
;

141 ià(!
¥k_mª
.
	`G‘Key
(
keyId
, 
key
))

142 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("nÚ-w®ËˆÜ inv®id‡dd»s %s", 
¡rKeyOrAdd»ss
));

143  
key
;

146 
throw
 
¡d
::
	`ruÁime_”rÜ
("addresses‚ot supported in‚o-wallet builds");

148 
CKey
 
key
 = 
	`DecodeSeü‘
(
¡rKeyOrAdd»ss
);

149 ià(!
key
.
	`IsV®id
()) {

150 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("šv®id…riv-key/add»s %s", 
¡rKeyOrAdd»ss
));

152  
key
;

153 
	}
}

155 
W™ÃssV0KeyHash
 
	$P¬£PubKeyIDFromAdd»ss
(cÚ¡ 
¡d
::
¡ršg
& 
¡rAdd»ss
, cÚ¡ std::¡ršg& 
·¿mName
)

157 
CTxDe¡š©iÚ
 
de¡
 = 
	`DecodeDe¡š©iÚ
(
¡rAdd»ss
);

158 cÚ¡ 
W™ÃssV0KeyHash
 *
keyID
 = 
boo¡
::
g‘
<W™ÃssV0KeyHash>(&
de¡
);

159 ià(!
keyID
) {

160 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("% mu¡ b¨v®id P2PWKH‡dd»ss,‚Ù %s", 
·¿mName
, 
¡rAdd»ss
));

162  *
keyID
;

163 
	}
}

165 
CBLSPublicKey
 
	$P¬£BLSPubKey
(cÚ¡ 
¡d
::
¡ršg
& 
hexKey
, cÚ¡ std::¡ršg& 
·¿mName
)

167 
CBLSPublicKey
 
pubKey
;

168 ià(!
pubKey
.
	`S‘HexSŒ
(
hexKey
)) {

169 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("% mu¡ b¨v®id BLS…ubliøkey,‚Ù %s", 
·¿mName
, 
hexKey
));

171  
pubKey
;

172 
	}
}

174 
CBLSSeü‘Key
 
	$P¬£BLSSeü‘Key
(cÚ¡ 
¡d
::
¡ršg
& 
hexKey
, cÚ¡ std::¡ršg& 
·¿mName
)

176 
CBLSSeü‘Key
 
£cKey
;

177 ià(!
£cKey
.
	`S‘HexSŒ
(
hexKey
)) {

178 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("% mu¡ b¨v®id BLS seü‘ key", 
·¿mName
));

180  
£cKey
;

181 
	}
}

183 #ifdeà
ENABLE_WALLET


185 
	g‹m¶©e
<
ty³Çme
 
	gS³cŸlTxPaylßd
>

186 
	$FundS³cŸlTx
(
CW®Ët
* 
pw®Ët
, 
CMubËT¿n§ùiÚ
& 
tx
, cÚ¡ 
S³cŸlTxPaylßd
& 
·ylßd
, cÚ¡ 
CTxDe¡š©iÚ
& 
fundDe¡
)

188 
	`as£¹
(
pw®Ët
 !ğ
nuÎ±r
);

192 
pw®Ët
->
	`BlockUÁSynûdToCu¼’tChaš
();

194 
	`LOCK2
(
cs_maš
, 
mempoŞ
.
cs
);

195 
	`LOCK
(
pw®Ët
->
cs_w®Ët
);

197 
CTxDe¡š©iÚ
 
node¡
 = 
	`CNoDe¡š©iÚ
();

198 ià(
fundDe¡
 =ğ
node¡
) {

199 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "No source of funds specified");

202 
	`S‘TxPaylßd
(
tx
, 
·ylßd
);

203 
¡d
::
veùÜ
<
CRec›Á
> 
vecS’d
;

204 cÚ¡‡uto& 
txOut
 : 
tx
.
vout
) {

205 
CRec›Á
 
»c›Á
 = {
txOut
.
sütPubKey
,xOut.
nV®ue
, 
çl£
};

206 
vecS’d
.
	`push_back
(
»c›Á
);

209 
CCošCÚŒŞ
 
cošCÚŒŞ
;

210 
cošCÚŒŞ
.
de¡Chªge
 = 
fundDe¡
;

212 
¡d
::
veùÜ
<
COuut
> 
vecOuuts
;

213 
pw®Ët
->
	`AvaabËCošs
(
vecOuuts
);

215 cÚ¡‡uto& 
out
 : 
vecOuuts
) {

216 
CTxDe¡š©iÚ
 
txDe¡
;

217 ià(
	`ExŒaùDe¡š©iÚ
(
out
.
tx
->tx->
vout
[out.
i
].
sütPubKey
, 
txDe¡
è&&xDe¡ =ğ
fundDe¡
) {

218 
cošCÚŒŞ
.
	`S–eù
(
	`COutPošt
(
out
.
tx
->tx->
	`G‘Hash
(), out.
i
));

222 ià(!
cošCÚŒŞ
.
	`HasS–eùed
()) {

223 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "No funds‡t specified‡ddress");

225 
CCošCÚŒŞ
 
coš_cÚŒŞ
;

226 
CAmouÁ
 
nF“Requœed
 = 0;

227 
nChªgePosR‘
 = -1;

228 
bšgu®_¡r
 
”rÜ
;

229 
CT¿n§ùiÚRef
 
wtx
;

230 
boŞ
 
fC»©ed
 = 
pw®Ët
->
	`C»©eT¿n§ùiÚ
(
vecS’d
, 
wtx
, 
nF“Requœed
, 
nChªgePosR‘
, 
”rÜ
, 
coš_cÚŒŞ
);

231 ià(!
fC»©ed
)

232 
throw
 
	`JSONRPCE¼Ü
(
RPC_WALLET_INSUFFICIENT_FUNDS
, 
”rÜ
.
Üigš®
);

234 
tx
.
vš
 = 
wtx
->vin;

235 
tx
.
vout
 = 
wtx
->vout;

237 
	}
}

239 
	g‹m¶©e
<
ty³Çme
 
	gS³cŸlTxPaylßd
>

240 
	$Upd©eS³cŸlTxIÅutsHash
(cÚ¡ 
CMubËT¿n§ùiÚ
& 
tx
, 
S³cŸlTxPaylßd
& 
·ylßd
)

242 
·ylßd
.
šputsHash
 = 
	`C®cTxIÅutsHash
(
	`CT¿n§ùiÚ
(
tx
));

243 
	}
}

245 
	g‹m¶©e
<
ty³Çme
 
	gS³cŸlTxPaylßd
>

246 
	$SignS³cŸlTxPaylßdByHash
(cÚ¡ 
CMubËT¿n§ùiÚ
& 
tx
, 
S³cŸlTxPaylßd
& 
·ylßd
, cÚ¡ 
CKey
& 
key
)

248 
	`Upd©eS³cŸlTxIÅutsHash
(
tx
, 
·ylßd
);

249 
·ylßd
.
vchSig
.
	`ş—r
();

251 
ušt256
 
hash
 = ::
	`S”ŸlizeHash
(
·ylßd
);

252 ià(!
CHashSigÃr
::
	`SignHash
(
hash
, 
key
, 
·ylßd
.
vchSig
)) {

253 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "failedo sign specialx");

255 
	}
}

257 
	g‹m¶©e
<
ty³Çme
 
	gS³cŸlTxPaylßd
>

258 
	$SignS³cŸlTxPaylßdBySŒšg
(cÚ¡ 
CMubËT¿n§ùiÚ
& 
tx
, 
S³cŸlTxPaylßd
& 
·ylßd
, cÚ¡ 
CKey
& 
key
)

260 
	`Upd©eS³cŸlTxIÅutsHash
(
tx
, 
·ylßd
);

261 
·ylßd
.
vchSig
.
	`ş—r
();

263 
¡d
::
¡ršg
 
m
 = 
·ylßd
.
	`MakeSignSŒšg
();

264 ià(!
CMes§geSigÃr
::
	`SignMes§ge
(
m
, 
·ylßd
.
vchSig
, 
key
)) {

265 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "failedo sign specialx");

267 
	}
}

269 
	g‹m¶©e
<
ty³Çme
 
	gS³cŸlTxPaylßd
>

270 
	$SignS³cŸlTxPaylßdByHash
(cÚ¡ 
CMubËT¿n§ùiÚ
& 
tx
, 
S³cŸlTxPaylßd
& 
·ylßd
, cÚ¡ 
CBLSSeü‘Key
& 
key
)

272 
	`Upd©eS³cŸlTxIÅutsHash
(
tx
, 
·ylßd
);

274 
ušt256
 
hash
 = ::
	`S”ŸlizeHash
(
·ylßd
);

275 
·ylßd
.
sig
 = 
key
.
	`Sign
(
hash
);

276 
	}
}

278 
	g¡d
::
¡ršg
 
	$SignAndS’dS³cŸlTx
(cÚ¡ 
ut
::
Ref
& 
cÚ‹xt
, cÚ¡ 
CMubËT¿n§ùiÚ
& 
tx
)

281 
	`LOCK
(
cs_maš
);

283 
TxV®id©iÚS‹
 
¡©e
;

284 ià(!
	`CheckS³cŸlTx
(
	`CT¿n§ùiÚ
(
tx
), ::
	`ChašAùive
().
	`T
(), 
¡©e
, 
Œue
)) {

285 
throw
 
¡d
::
	`ruÁime_”rÜ
(
¡©e
.
	`ToSŒšg
());

289 
CD©aSŒ—m
 
	`ds
(
SER_NETWORK
, 
PROTOCOL_VERSION
);

290 
ds
 << 
tx
;

292 
JSONRPCReque¡
 
	`signReque¡
(
cÚ‹xt
);

293 
signReque¡
.
·¿ms
.
	`£tA¼ay
();

294 
signReque¡
.
·¿ms
.
	`push_back
(
	`HexSŒ
(
ds
.
	`begš
(), ds.
	`’d
()));

295 
UniV®ue
 
signResuÉ
 = 
	`sigÄawŒª§ùiÚw™hw®Ët
(
signReque¡
);

297 
JSONRPCReque¡
 
	`£ndReque¡
(
cÚ‹xt
);

298 
£ndReque¡
.
·¿ms
.
	`£tA¼ay
();

299 
£ndReque¡
.
·¿ms
.
	`push_back
(
signResuÉ
["hex"].
	`g‘_¡r
());

300  
	`£nd¿wŒª§ùiÚ
(
£ndReque¡
).
	`g‘_¡r
();

301 
	}
}

303 
	$´Ùx_»gi¡”_fund_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

305 
RPCH–pMª
{"protx„egister_fund",

311 + 
HELP_REQUIRING_PASSPHRASE
 +

313 + 
	`G‘H–pSŒšg
(1, "collateralAddress")

314 + 
	`G‘H–pSŒšg
(2, "ipAndPort")

315 + 
	`G‘H–pSŒšg
(3, "ownerAddress")

316 + 
	`G‘H–pSŒšg
(4, "operatorPubKey_register")

317 + 
	`G‘H–pSŒšg
(5, "votingAddress_register")

318 + 
	`G‘H–pSŒšg
(6, "operatorReward")

319 + 
	`G‘H–pSŒšg
(7, "payoutAddress_register")

320 + 
	`G‘H–pSŒšg
(8, "fundAddress"),

323 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

324 
RPCExam¶es
{""},

325 }.
	`Check
(
»que¡
);

326 
	}
}

328 
	$´Ùx_»gi¡”_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

330 
RPCH–pMª
{"protx„egister",

334 + 
HELP_REQUIRING_PASSPHRASE
 +

336 + 
	`G‘H–pSŒšg
(1, "collateralHash")

337 + 
	`G‘H–pSŒšg
(2, "collateralIndex")

338 + 
	`G‘H–pSŒšg
(3, "ipAndPort")

339 + 
	`G‘H–pSŒšg
(4, "ownerAddress")

340 + 
	`G‘H–pSŒšg
(5, "operatorPubKey_register")

341 + 
	`G‘H–pSŒšg
(6, "votingAddress_register")

342 + 
	`G‘H–pSŒšg
(7, "operatorReward")

343 + 
	`G‘H–pSŒšg
(8, "payoutAddress_register")

344 + 
	`G‘H–pSŒšg
(9, "feeSourceAddress"),

347 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

348 
RPCExam¶es
{""},

349 }.
	`Check
(
»que¡
);

350 
	}
}

352 
	$´Ùx_»gi¡”_´•¬e_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

354 
RPCH–pMª
{"protx„egister_prepare",

359 + 
	`G‘H–pSŒšg
(1, "collateralHash")

360 + 
	`G‘H–pSŒšg
(2, "collateralIndex")

361 + 
	`G‘H–pSŒšg
(3, "ipAndPort")

362 + 
	`G‘H–pSŒšg
(4, "ownerAddress")

363 + 
	`G‘H–pSŒšg
(5, "operatorPubKey_register")

364 + 
	`G‘H–pSŒšg
(6, "votingAddress_register")

365 + 
	`G‘H–pSŒšg
(7, "operatorReward")

366 + 
	`G‘H–pSŒšg
(8, "payoutAddress_register")

367 + 
	`G‘H–pSŒšg
(9, "feeSourceAddress"),

370 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

371 
RPCExam¶es
{""},

372 }.
	`Check
(
»que¡
);

373 
	}
}

375 
	$´Ùx_»gi¡”_subm™_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

377 
RPCH–pMª
{"protx„egister_submit",

380 + 
HELP_REQUIRING_PASSPHRASE
 +

386 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

387 
RPCExam¶es
{""},

388 }.
	`Check
(
»que¡
);

389 
	}
}

392 
UniV®ue
 
	$´Ùx_»gi¡”
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

394 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

395 ià(!
w®Ët
è 
NuÎUniV®ue
;

396 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

397 
boŞ
 
isEx‹º®Regi¡”
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "register";

398 
boŞ
 
isFundRegi¡”
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "register_fund";

399 
boŞ
 
isP»·»Regi¡”
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
() == "register_prepare";

401 ià(
isFundRegi¡”
 && (
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 8 &&„equest.params.size() != 9))) {

402 
	`´Ùx_»gi¡”_fund_h–p
(
»que¡
);

403 } ià(
isEx‹º®Regi¡”
 && (
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 9 &&„equest.params.size() != 10))) {

404 
	`´Ùx_»gi¡”_h–p
(
»que¡
);

405 } ià(
isP»·»Regi¡”
 && (
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 9 &&„equest.params.size() != 10))) {

406 
	`´Ùx_»gi¡”_´•¬e_h–p
(
»que¡
);

412 
pw®Ët
->
	`BlockUÁSynûdToCu¼’tChaš
();

413 ià(
isEx‹º®Regi¡”
 || 
isFundRegi¡”
) {

414 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

417 
size_t
 
·¿mIdx
 = 1;

420 
CMubËT¿n§ùiÚ
 
tx
;

421 
tx
.
nV”siÚ
 = 
SYSCOIN_TX_VERSION_MN_REGISTER
;

423 
CProRegTx
 
±x
;

424 
±x
.
nV”siÚ
 = 
CProRegTx
::
CURRENT_VERSION
;

426 ià(
isFundRegi¡”
) {

427 
CTxDe¡š©iÚ
 
cŞÏ‹¿lDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[
·¿mIdx
].
	`g‘_¡r
());

428 ià(!
	`IsV®idDe¡š©iÚ
(
cŞÏ‹¿lDe¡
)) {

429 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id cŞÏ‹¿Î‡dd»ss: %s", 
»que¡
.
·¿ms
[
·¿mIdx
].
	`g‘_¡r
()));

431 
CSüt
 
cŞÏ‹¿lSüt
 = 
	`G‘SütFÜDe¡š©iÚ
(
cŞÏ‹¿lDe¡
);

433 
CTxOut
 
	`cŞÏ‹¿lTxOut
(
nMNCŞÏ‹¿lRequœed
, 
cŞÏ‹¿lSüt
);

434 
tx
.
vout
.
	`em¶aû_back
(
cŞÏ‹¿lTxOut
);

436 
·¿mIdx
++;

438 
ušt256
 
cŞÏ‹¿lHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[
·¿mIdx
], "collateralHash");

439 
št32_t
 
cŞÏ‹¿lIndex
 = 
»que¡
.
·¿ms
[
·¿mIdx
 + 1].
	`g‘_št
();

440 ià(
cŞÏ‹¿lHash
.
	`IsNuÎ
(è|| 
cŞÏ‹¿lIndex
 < 0) {

441 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id hash o¸šdex: %s-%d", 
cŞÏ‹¿lHash
.
	`ToSŒšg
(), 
cŞÏ‹¿lIndex
));

444 
±x
.
cŞÏ‹¿lOuošt
 = 
	`COutPošt
(
cŞÏ‹¿lHash
, (
ušt32_t
)
cŞÏ‹¿lIndex
);

445 
·¿mIdx
 += 2;

447 
	`LOCK
Ğ
pw®Ët
->
cs_w®Ët
);

448 
pw®Ët
->
	`LockCoš
(
±x
.
cŞÏ‹¿lOuošt
);

451 ià(
»que¡
.
·¿ms
[
·¿mIdx
].
	`g‘_¡r
() != "") {

452 ià(!
	`Lookup
(
»que¡
.
·¿ms
[
·¿mIdx
].
	`g‘_¡r
().
	`c_¡r
(), 
±x
.
addr
, 
	`P¬ams
().
	`G‘DeçuÉPÜt
(), 
çl£
)) {

453 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("šv®id‚‘wÜk‡dd»s %s", 
»que¡
.
·¿ms
[
·¿mIdx
].
	`g‘_¡r
()));

457 
CKey
 
keyOwÃr
 = 
	`P¬£PrivKey
(
pw®Ët
, 
»que¡
.
·¿ms
[
·¿mIdx
 + 1].
	`g‘_¡r
(), 
Œue
);

458 
CBLSPublicKey
 
pubKeyO³¿tÜ
 = 
	`P¬£BLSPubKey
(
»que¡
.
·¿ms
[
·¿mIdx
 + 2].
	`g‘_¡r
(), "operator BLS‡ddress");

459 
W™ÃssV0KeyHash
 
keyIDVÙšg
 = 
	`W™ÃssV0KeyHash
(
keyOwÃr
.
	`G‘PubKey
().
	`G‘ID
());

460 ià(
»que¡
.
·¿ms
[
·¿mIdx
 + 3].
	`g‘_¡r
() != "") {

461 
keyIDVÙšg
 = 
	`P¬£PubKeyIDFromAdd»ss
(
»que¡
.
·¿ms
[
·¿mIdx
 + 3].
	`g‘_¡r
(), "voting‡ddress");

464 
št64_t
 
İ”©ÜRew¬d
;

465 ià(!
	`P¬£FixedPošt
(
»que¡
.
·¿ms
[
·¿mIdx
 + 4].
	`g‘V®SŒ
(), 2, &
İ”©ÜRew¬d
)) {

466 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "operatorReward must be‡‚umber");

468 ià(
İ”©ÜRew¬d
 < 0 || operatorReward > 10000) {

469 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "operatorReward must be between 0.00‡nd 100.00");

471 
±x
.
nO³¿tÜRew¬d
 = 
İ”©ÜRew¬d
;

473 
CTxDe¡š©iÚ
 
·youtDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[
·¿mIdx
 + 5].
	`g‘_¡r
());

474 ià(!
	`IsV®idDe¡š©iÚ
(
·youtDe¡
)) {

475 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id…ayouˆadd»ss: %s", 
»que¡
.
·¿ms
[
·¿mIdx
 + 5].
	`g‘_¡r
()));

478 
±x
.
keyIDOwÃr
 = 
	`W™ÃssV0KeyHash
(
keyOwÃr
.
	`G‘PubKey
().
	`G‘ID
());

479 
±x
.
pubKeyO³¿tÜ
 =…ubKeyOperator;

480 
±x
.
keyIDVÙšg
 = keyIDVoting;

481 
±x
.
sütPayout
 = 
	`G‘SütFÜDe¡š©iÚ
(
·youtDe¡
);

483 ià(!
isFundRegi¡”
) {

485 
±x
.
vchSig
.
	`»size
(65);

488 
CTxDe¡š©iÚ
 
fundDe¡
 = 
·youtDe¡
;

489 ià(!
»que¡
.
·¿ms
[
·¿mIdx
 + 6].
	`isNuÎ
()) {

490 
fundDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[
·¿mIdx
 + 6].
	`g‘_¡r
());

491 ià(!
	`IsV®idDe¡š©iÚ
(
fundDe¡
))

492 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
¡d
::
	`¡ršg
("Inv®id Syscoš‡dd»ss: "è+ 
»que¡
.
·¿ms
[
·¿mIdx
 + 6].
	`g‘_¡r
());

495 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
fundDe¡
);

496 
	`Upd©eS³cŸlTxIÅutsHash
(
tx
, 
±x
);

498 ià(
isFundRegi¡”
) {

499 
ušt32_t
 
cŞÏ‹¿lIndex
 = (uint32_t) -1;

500 
ušt32_t
 
i
 = 0; i < 
tx
.
vout
.
	`size
(); i++) {

501 ià(
tx
.
vout
[
i
].
nV®ue
 =ğ
nMNCŞÏ‹¿lRequœed
) {

502 
cŞÏ‹¿lIndex
 = 
i
;

506 
	`as£¹
(
cŞÏ‹¿lIndex
 !ğ(
ušt32_t
) -1);

507 
±x
.
cŞÏ‹¿lOuošt
.
n
 = 
cŞÏ‹¿lIndex
;

509 
	`S‘TxPaylßd
(
tx
, 
±x
);

510  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

514 
Coš
 
coš
;

515 ià(!
	`G‘UTXOCoš
(
±x
.
cŞÏ‹¿lOuošt
, 
coš
)) {

516 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("cŞÏ‹¿ÈnÙ found: %s", 
±x
.
cŞÏ‹¿lOuošt
.
	`ToSŒšgShÜt
()));

518 
CTxDe¡š©iÚ
 
txDe¡
;

519 
	`ExŒaùDe¡š©iÚ
(
coš
.
out
.
sütPubKey
, 
txDe¡
);

520 
CKeyID
 
keyID
;

521 ià×utØ
w™Ãss_id
 = 
boo¡
::
g‘
<
W™ÃssV0KeyHash
>(&
txDe¡
)) {

522 
keyID
 = 
	`CKeyID
(*
w™Ãss_id
);

524 ià×utØ
key_id
 = 
boo¡
::
g‘
<
PKHash
>(&
txDe¡
)) {

525 
keyID
 = 
	`CKeyID
(*
key_id
);

527 ià(
keyID
.
	`IsNuÎ
()) {

528 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("cŞÏ‹¿Èty³‚Ù suµÜ‹d: %s", 
±x
.
cŞÏ‹¿lOuošt
.
	`ToSŒšgShÜt
()));

531 ià(
isP»·»Regi¡”
) {

533 
±x
.
vchSig
.
	`ş—r
();

534 
	`S‘TxPaylßd
(
tx
, 
±x
);

536 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

537 
»t
.
	`pushKV
("tx", 
	`EncodeHexTx
(
	`CT¿n§ùiÚ
(
tx
)));

538 
»t
.
	`pushKV
("cŞÏ‹¿lAdd»ss", 
	`EncodeDe¡š©iÚ
(
txDe¡
));

539 
»t
.
	`pushKV
("signMes§ge", 
±x
.
	`MakeSignSŒšg
());

540  
»t
;

542 
CKey
 
key
;

546 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

547 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

548 ià(!
¥k_mª
.
	`G‘Key
(
keyID
, 
key
)) {

549 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("cŞÏ‹¿Èkey‚Ù iÀw®Ët: %s", 
	`EncodeDe¡š©iÚ
(
txDe¡
)));

552 
	`SignS³cŸlTxPaylßdBySŒšg
(
tx
, 
±x
, 
key
);

553 
	`S‘TxPaylßd
(
tx
, 
±x
);

554  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

557 
	}
}

559 
UniV®ue
 
	$´Ùx_»gi¡”_subm™
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

561 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

562 ià(!
w®Ët
è 
NuÎUniV®ue
;

563 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

564 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 3) {

565 
	`´Ùx_»gi¡”_subm™_h–p
(
»que¡
);

569 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

571 
CMubËT¿n§ùiÚ
 
tx
;

572 ià(!
	`DecodeHexTx
(
tx
, 
»que¡
.
·¿ms
[1].
	`g‘_¡r
())) {

573 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "transaction‚ot deserializable");

575 ià(
tx
.
nV”siÚ
 !ğ
SYSCOIN_TX_VERSION_MN_REGISTER
) {

576 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "transaction‚ot‡ ProRegTx");

578 
CProRegTx
 
±x
;

579 ià(!
	`G‘TxPaylßd
(
tx
, 
±x
)) {

580 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "transaction…ayload‚ot deserializable");

582 ià(!
±x
.
vchSig
.
	`em±y
()) {

583 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "payload signature‚otƒmpty");

586 
±x
.
vchSig
 = 
	`DecodeBa£64
(
»que¡
.
·¿ms
[2].
	`g‘_¡r
().
	`c_¡r
());

588 
	`S‘TxPaylßd
(
tx
, 
±x
);

589  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

590 
	}
}

592 
	$´Ùx_upd©e_£rviû_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

594 
RPCH–pMª
{"protx update_service",

598 + 
HELP_REQUIRING_PASSPHRASE
 +

600 + 
	`G‘H–pSŒšg
(1, "proTxHash")

601 + 
	`G‘H–pSŒšg
(2, "ipAndPort")

602 + 
	`G‘H–pSŒšg
(3, "operatorKey")

603 + 
	`G‘H–pSŒšg
(4, "operatorPayoutAddress")

604 + 
	`G‘H–pSŒšg
(5, "feeSourceAddress"),

607 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

608 
RPCExam¶es
{""},

609 }.
	`Check
(
»que¡
);

610 
	}
}

612 
UniV®ue
 
	$´Ùx_upd©e_£rviû
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

614 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

615 ià(!
w®Ët
è 
NuÎUniV®ue
;

616 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

617 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() < 4 ||„equest.params.size() > 6))

618 
	`´Ùx_upd©e_£rviû_h–p
(
»que¡
);

621 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

623 
CProUpS”vTx
 
±x
;

624 
±x
.
nV”siÚ
 = 
CProUpS”vTx
::
CURRENT_VERSION
;

625 
±x
.
´oTxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "proTxHash");

627 ià(!
	`Lookup
(
»que¡
.
·¿ms
[2].
	`g‘_¡r
().
	`c_¡r
(), 
±x
.
addr
, 
	`P¬ams
().
	`G‘DeçuÉPÜt
(), 
çl£
)) {

628 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("šv®id‚‘wÜk‡dd»s %s", 
»que¡
.
·¿ms
[2].
	`g‘_¡r
()));

631 
CBLSSeü‘Key
 
keyO³¿tÜ
 = 
	`P¬£BLSSeü‘Key
(
»que¡
.
·¿ms
[3].
	`g‘_¡r
(), "operatorKey");

633 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘MN
(
±x
.
´oTxHash
);

634 ià(!
dmn
) {

635 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("ma¡”nodw™h…roTxHash % nÙ found", 
±x
.
´oTxHash
.
	`ToSŒšg
()));

638 ià(
keyO³¿tÜ
.
	`G‘PublicKey
(è!ğ
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
()) {

639 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("the operator key does‚ot belongohe„egistered…ublic key"));

642 
CMubËT¿n§ùiÚ
 
tx
;

643 
tx
.
nV”siÚ
 = 
SYSCOIN_TX_VERSION_MN_UPDATE_SERVICE
;

646 ià(!
»que¡
.
·¿ms
[4].
	`isNuÎ
()) {

647 ià(
»que¡
.
·¿ms
[4].
	`g‘_¡r
().
	`em±y
()) {

648 
±x
.
sütO³¿tÜPayout
 = 
dmn
->
pdmnS‹
->scriptOperatorPayout;

650 
CTxDe¡š©iÚ
 
·youtDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[4].
	`g‘_¡r
());

651 ià(!
	`IsV®idDe¡š©iÚ
(
·youtDe¡
)) {

652 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id o³¿tÜ…ayouˆadd»ss: %s", 
»que¡
.
·¿ms
[4].
	`g‘_¡r
()));

654 
±x
.
sütO³¿tÜPayout
 = 
	`G‘SütFÜDe¡š©iÚ
(
·youtDe¡
);

657 
±x
.
sütO³¿tÜPayout
 = 
dmn
->
pdmnS‹
->scriptOperatorPayout;

660 
CTxDe¡š©iÚ
 
ãeSourû
;

663 ià(!
»que¡
.
·¿ms
[5].
	`isNuÎ
()) {

664 
ãeSourû
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[5].
	`g‘_¡r
());

665 ià(!
	`IsV®idDe¡š©iÚ
(
ãeSourû
))

666 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
¡d
::
	`¡ršg
("Inv®id Syscoš‡dd»ss: "è+ 
»que¡
.
·¿ms
[5].
	`g‘_¡r
());

668 ià(
±x
.
sütO³¿tÜPayout
 !ğ
	`CSüt
()) {

670 
	`ExŒaùDe¡š©iÚ
(
±x
.
sütO³¿tÜPayout
, 
ãeSourû
);

673 
	`ExŒaùDe¡š©iÚ
(
dmn
->
pdmnS‹
->
sütPayout
, 
ãeSourû
);

677 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
ãeSourû
);

679 
	`SignS³cŸlTxPaylßdByHash
(
tx
, 
±x
, 
keyO³¿tÜ
);

680 
	`S‘TxPaylßd
(
tx
, 
±x
);

682  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

683 
	}
}

685 
	$´Ùx_upd©e_»gi¡¿r_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

687 
RPCH–pMª
{"protx update_registrar",

691 + 
HELP_REQUIRING_PASSPHRASE
 +

693 + 
	`G‘H–pSŒšg
(1, "proTxHash")

694 + 
	`G‘H–pSŒšg
(2, "operatorPubKey_update")

695 + 
	`G‘H–pSŒšg
(3, "votingAddress_update")

696 + 
	`G‘H–pSŒšg
(4, "payoutAddress_update")

697 + 
	`G‘H–pSŒšg
(5, "feeSourceAddress"),

700 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

701 
RPCExam¶es
{""},

702 }.
	`Check
(
»que¡
);

703 
	}
}

705 
UniV®ue
 
	$´Ùx_upd©e_»gi¡¿r
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

707 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

708 ià(!
w®Ët
è 
NuÎUniV®ue
;

709 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

710 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 5 &&„equest.params.size() != 6)) {

711 
	`´Ùx_upd©e_»gi¡¿r_h–p
(
»que¡
);

716 
pw®Ët
->
	`BlockUÁSynûdToCu¼’tChaš
();

717 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

719 
CProUpRegTx
 
±x
;

720 
±x
.
nV”siÚ
 = 
CProUpRegTx
::
CURRENT_VERSION
;

721 
±x
.
´oTxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "proTxHash");

723 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘MN
(
±x
.
´oTxHash
);

724 ià(!
dmn
) {

725 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("ma¡”nod% nÙ found", 
±x
.
´oTxHash
.
	`ToSŒšg
()));

727 
±x
.
pubKeyO³¿tÜ
 = 
dmn
->
pdmnS‹
->pubKeyO³¿tÜ.
	`G‘
();

728 
±x
.
keyIDVÙšg
 = 
dmn
->
pdmnS‹
->keyIDVoting;

729 
±x
.
sütPayout
 = 
dmn
->
pdmnS‹
->scriptPayout;

731 ià(
»que¡
.
·¿ms
[2].
	`g‘_¡r
() != "") {

732 
±x
.
pubKeyO³¿tÜ
 = 
	`P¬£BLSPubKey
(
»que¡
.
·¿ms
[2].
	`g‘_¡r
(), "operator BLS‡ddress");

734 ià(
»que¡
.
·¿ms
[3].
	`g‘_¡r
() != "") {

735 
±x
.
keyIDVÙšg
 = 
	`P¬£PubKeyIDFromAdd»ss
(
»que¡
.
·¿ms
[3].
	`g‘_¡r
(), "voting‡ddress");

738 
CTxDe¡š©iÚ
 
·youtDe¡
;

739 
	`ExŒaùDe¡š©iÚ
(
±x
.
sütPayout
, 
·youtDe¡
);

740 ià(
»que¡
.
·¿ms
[4].
	`g‘_¡r
() != "") {

741 
·youtDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[4].
	`g‘_¡r
());

742 ià(!
	`IsV®idDe¡š©iÚ
(
·youtDe¡
)) {

743 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("šv®id…ayouˆadd»ss: %s", 
»que¡
.
·¿ms
[4].
	`g‘_¡r
()));

745 
±x
.
sütPayout
 = 
	`G‘SütFÜDe¡š©iÚ
(
·youtDe¡
);

750 
CKey
 
keyOwÃr
;

752 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

753 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

754 ià(!
¥k_mª
.
	`G‘Key
(
	`CKeyID
(
dmn
->
pdmnS‹
->
keyIDOwÃr
), 
keyOwÃr
)) {

755 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("Priv©key fÜ owÃ¸add»s % nÙ found iÀyou¸w®Ët", 
	`EncodeDe¡š©iÚ
(
dmn
->
pdmnS‹
->
keyIDOwÃr
)));

759 
CMubËT¿n§ùiÚ
 
tx
;

760 
tx
.
nV”siÚ
 = 
SYSCOIN_TX_VERSION_MN_UPDATE_REGISTRAR
;

763 
±x
.
vchSig
.
	`»size
(65);

765 
CTxDe¡š©iÚ
 
ãeSourûDe¡
 = 
·youtDe¡
;

766 ià(!
»que¡
.
·¿ms
[5].
	`isNuÎ
()) {

767 
ãeSourûDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[5].
	`g‘_¡r
());

768 ià(!
	`IsV®idDe¡š©iÚ
(
ãeSourûDe¡
))

769 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
¡d
::
	`¡ršg
("Inv®id Syscoš‡dd»ss: "è+ 
»que¡
.
·¿ms
[5].
	`g‘_¡r
());

772 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
ãeSourûDe¡
);

773 
	`SignS³cŸlTxPaylßdByHash
(
tx
, 
±x
, 
keyOwÃr
);

774 
	`S‘TxPaylßd
(
tx
, 
±x
);

776  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

777 
	}
}

779 
	$´Ùx_»voke_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

781 
RPCH–pMª
{"protx„evoke",

786 + 
HELP_REQUIRING_PASSPHRASE
 +

788 + 
	`G‘H–pSŒšg
(1, "proTxHash")

789 + 
	`G‘H–pSŒšg
(2, "operatorKey")

790 + 
	`G‘H–pSŒšg
(3, "reason")

791 + 
	`G‘H–pSŒšg
(4, "feeSourceAddress"),

794 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

795 
RPCExam¶es
{""},

796 }.
	`Check
(
»que¡
);

797 
	}
}

799 
UniV®ue
 
	$´Ùx_»voke
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

801 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

802 ià(!
w®Ët
è 
NuÎUniV®ue
;

803 
CW®Ët
* cÚ¡ 
pw®Ët
 = 
w®Ët
.
	`g‘
();

804 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() < 3 ||„equest.params.size() > 5)) {

805 
	`´Ùx_»voke_h–p
(
»que¡
);

809 
	`Ensu»W®ËtIsUÆocked
(
pw®Ët
);

811 
CProUpRevTx
 
±x
;

812 
±x
.
nV”siÚ
 = 
CProUpRevTx
::
CURRENT_VERSION
;

813 
±x
.
´oTxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "proTxHash");

815 
CBLSSeü‘Key
 
keyO³¿tÜ
 = 
	`P¬£BLSSeü‘Key
(
»que¡
.
·¿ms
[2].
	`g‘_¡r
(), "operatorKey");

817 ià(!
»que¡
.
·¿ms
[3].
	`isNuÎ
()) {

818 
št32_t
 
nR—sÚ
 = 
»que¡
.
·¿ms
[3].
	`g‘_št
();

819 ià(
nR—sÚ
 < 0 ||‚R—sÚ > 
CProUpRevTx
::
REASON_LAST
) {

820 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("šv®id„—sÚ %d, mu¡ bb‘w“À0‡nd %d", 
nR—sÚ
, 
CProUpRevTx
::
REASON_LAST
));

822 
±x
.
nR—sÚ
 = (
ušt16_t
)nReason;

825 autØ
dmn
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
().
	`G‘MN
(
±x
.
´oTxHash
);

826 ià(!
dmn
) {

827 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("ma¡”nod% nÙ found", 
±x
.
´oTxHash
.
	`ToSŒšg
()));

830 ià(
keyO³¿tÜ
.
	`G‘PublicKey
(è!ğ
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
()) {

831 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("the operator key does‚ot belongohe„egistered…ublic key"));

834 
CMubËT¿n§ùiÚ
 
tx
;

835 
tx
.
nV”siÚ
 = 
SYSCOIN_TX_VERSION_MN_UPDATE_REVOKE
;

837 ià(!
»que¡
.
·¿ms
[4].
	`isNuÎ
()) {

838 
CTxDe¡š©iÚ
 
ãeSourûDe¡
 = 
	`DecodeDe¡š©iÚ
(
»que¡
.
·¿ms
[4].
	`g‘_¡r
());

839 ià(!
	`IsV®idDe¡š©iÚ
(
ãeSourûDe¡
))

840 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
¡d
::
	`¡ršg
("Inv®id Syscoš‡dd»ss: "è+ 
»que¡
.
·¿ms
[4].
	`g‘_¡r
());

841 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
ãeSourûDe¡
);

842 } ià(
dmn
->
pdmnS‹
->
sütO³¿tÜPayout
 !ğ
	`CSüt
()) {

844 
CTxDe¡š©iÚ
 
txDe¡
;

845 
	`ExŒaùDe¡š©iÚ
(
dmn
->
pdmnS‹
->
sütO³¿tÜPayout
, 
txDe¡
);

846 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
txDe¡
);

847 } ià(
dmn
->
pdmnS‹
->
sütPayout
 !ğ
	`CSüt
()) {

849 
CTxDe¡š©iÚ
 
txDe¡
;

850 
	`ExŒaùDe¡š©iÚ
(
dmn
->
pdmnS‹
->
sütPayout
, 
txDe¡
);

851 
	`FundS³cŸlTx
(
pw®Ët
, 
tx
, 
±x
, 
txDe¡
);

853 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "No…ayout or fee source‡ddresses found, can't„evoke");

856 
	`SignS³cŸlTxPaylßdByHash
(
tx
, 
±x
, 
keyO³¿tÜ
);

857 
	`S‘TxPaylßd
(
tx
, 
±x
);

859  
	`SignAndS’dS³cŸlTx
(
»que¡
.
cÚ‹xt
, 
tx
);

860 
	}
}

863 
	$´Ùx_li¡_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

865 
RPCH–pMª
{"protx†ist",

874 #ifdeà
ENABLE_WALLET


880 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

881 
RPCExam¶es
{""},

882 }.
	`Check
(
»que¡
);

883 
	}
}

885 
boŞ
 
	$CheckW®ËtOwnsKey
(
CW®Ët
* 
pw®Ët
, cÚ¡ 
W™ÃssV0KeyHash
& 
keyID
) {

886 #iâdeà
ENABLE_WALLET


887  
çl£
;

889 ià(!
pw®Ët
) {

890  
çl£
;

892 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

893 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

894  
¥k_mª
.
	`IsMše
(
	`G‘SütFÜDe¡š©iÚ
(
	`CTxDe¡š©iÚ
(
keyID
)));

896 
	}
}

898 
boŞ
 
	$CheckW®ËtOwnsSüt
(
CW®Ët
* 
pw®Ët
, cÚ¡ 
CSüt
& 
süt
) {

899 #iâdeà
ENABLE_WALLET


900  
çl£
;

902 ià(!
pw®Ët
) {

903  
çl£
;

905 
LegacySütPubKeyMª
& 
¥k_mª
 = 
	`Ensu»LegacySütPubKeyMª
(*
pw®Ët
);

906 
	`LOCK2
(
pw®Ët
->
cs_w®Ët
, 
¥k_mª
.
cs_KeyStÜe
);

907  
¥k_mª
.
	`IsMše
(
süt
);

909 
	}
}

911 
UniV®ue
 
	$BudDMNLi¡EÁry
(
CW®Ët
* 
pw®Ët
, cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
, 
boŞ
 
d‘aed
)

913 ià(!
d‘aed
) {

914  
dmn
->
´oTxHash
.
	`ToSŒšg
();

917 
UniV®ue
 
	`o
(UniV®ue::
VOBJ
);

919 
dmn
->
	`ToJsÚ
(
o
);

921 
cÚfœm©iÚs
 = 
	`G‘UTXOCÚfœm©iÚs
(
dmn
->
cŞÏ‹¿lOuošt
);

922 
o
.
	`pushKV
("cÚfœm©iÚs", 
cÚfœm©iÚs
);

924 
boŞ
 
hasOwÃrKey
 = 
	`CheckW®ËtOwnsKey
(
pw®Ët
, 
dmn
->
pdmnS‹
->
keyIDOwÃr
);

925 
boŞ
 
hasO³¿tÜKey
 = 
çl£
;

926 
boŞ
 
hasVÙšgKey
 = 
	`CheckW®ËtOwnsKey
(
pw®Ët
, 
dmn
->
pdmnS‹
->
keyIDVÙšg
);

928 
boŞ
 
ownsCŞÏ‹¿l
 = 
çl£
;

929 
CT¿n§ùiÚRef
 
cŞÏ‹¿lTx
;

930 
ušt256
 
tmpHashBlock
;

931 ià(
	`G‘T¿n§ùiÚ
(
dmn
->
cŞÏ‹¿lOuošt
.
hash
, 
cŞÏ‹¿lTx
, 
	`P¬ams
().
	`G‘CÚ£nsus
(), 
tmpHashBlock
)) {

932 
ownsCŞÏ‹¿l
 = 
	`CheckW®ËtOwnsSüt
(
pw®Ët
, 
cŞÏ‹¿lTx
->
vout
[
dmn
->
cŞÏ‹¿lOuošt
.
n
].
sütPubKey
);

935 #ifdeà
ENABLE_WALLET


936 ià(
pw®Ët
) {

937 
UniV®ue
 
	`w®ËtObj
(UniV®ue::
VOBJ
);

938 
w®ËtObj
.
	`pushKV
("hasOwÃrKey", 
hasOwÃrKey
);

939 
w®ËtObj
.
	`pushKV
("hasO³¿tÜKey", 
hasO³¿tÜKey
);

940 
w®ËtObj
.
	`pushKV
("hasVÙšgKey", 
hasVÙšgKey
);

941 
w®ËtObj
.
	`pushKV
("ownsCŞÏ‹¿l", 
ownsCŞÏ‹¿l
);

942 
w®ËtObj
.
	`pushKV
("ownsPay“Süt", 
	`CheckW®ËtOwnsSüt
(
pw®Ët
, 
dmn
->
pdmnS‹
->
sütPayout
));

943 
w®ËtObj
.
	`pushKV
("ownsO³¿tÜRew¬dSüt", 
	`CheckW®ËtOwnsSüt
(
pw®Ët
, 
dmn
->
pdmnS‹
->
sütO³¿tÜPayout
));

944 
o
.
	`pushKV
("w®Ët", 
w®ËtObj
);

948 autØ
m‘aInfo
 = 
mm‘amª
.
	`G‘M‘aInfo
(
dmn
->
´oTxHash
);

949 
o
.
	`pushKV
("m‘aInfo", 
m‘aInfo
->
	`ToJsÚ
());

951  
o
;

952 
	}
}

954 
UniV®ue
 
	$´Ùx_li¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

956 ià(
»que¡
.
fH–p
) {

957 
	`´Ùx_li¡_h–p
(
»que¡
);

959 
CW®Ët
* 
pw®Ët
;

960 #ifdeà
ENABLE_WALLET


961 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

962 ià(
w®Ët
)

963 
pw®Ët
 = 
w®Ët
.
	`g‘
();

965 
pw®Ët
 = 
nuÎ±r
;

969 
¡d
::
¡ršg
 
ty³
 = "registered";

970 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

971 
ty³
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

974 
UniV®ue
 
	`»t
(UniV®ue::
VARR
);

976 
	`LOCK
(
cs_maš
);

978 ià(
ty³
 == "wallet") {

979 ià(!
pw®Ët
) {

980 
throw
 
¡d
::
	`ruÁime_”rÜ
("\"protx†ist wallet\"‚ot supported when wallet is disabled");

982 #ifdeà
ENABLE_WALLET


983 
	`LOCK2
(
cs_maš
, 
pw®Ët
->
cs_w®Ët
);

985 ià(
»que¡
.
·¿ms
.
	`size
() > 4) {

986 
	`´Ùx_li¡_h–p
(
»que¡
);

989 
boŞ
 
d‘aed
 = !
»que¡
.
·¿ms
[2].
	`isNuÎ
(è?„eque¡.·¿ms[2].
	`g‘_boŞ
(è: 
çl£
;

991 
height
 = !
»que¡
.
·¿ms
[3].
	`isNuÎ
(è?„eque¡.·¿ms[3].
	`g‘_št
(è: ::
	`ChašAùive
().
	`Height
();

992 ià(
height
 < 1 || heighˆ> ::
	`ChašAùive
().
	`Height
()) {

993 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid height specified");

996 
¡d
::
veùÜ
<
COutPošt
> 
vOuts
;

997 
pw®Ët
->
	`Li¡ProTxCošs
(
vOuts
);

998 
¡d
::
£t
<
COutPošt
> 
£tOuts
;

999 cÚ¡‡uto& 
out
 : 
vOuts
) {

1000 
£tOuts
.
	`em¶aû
(
out
);

1003 
CD‘”mši¡icMNLi¡
 
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡FÜBlock
(::
	`ChašAùive
()[
height
]);

1004 
mnLi¡
.
	`FÜEachMN
(
çl£
, [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

1005 ià(
£tOuts
.
	`couÁ
(
dmn
->
cŞÏ‹¿lOuošt
) ||

1006 
	`CheckW®ËtOwnsKey
(
pw®Ët
, 
dmn
->
pdmnS‹
->
keyIDOwÃr
) ||

1007 
	`CheckW®ËtOwnsKey
(
pw®Ët
, 
dmn
->
pdmnS‹
->
keyIDVÙšg
) ||

1008 
	`CheckW®ËtOwnsSüt
(
pw®Ët
, 
dmn
->
pdmnS‹
->
sütPayout
) ||

1009 
	`CheckW®ËtOwnsSüt
(
pw®Ët
, 
dmn
->
pdmnS‹
->
sütO³¿tÜPayout
)) {

1010 
»t
.
	`push_back
(
	`BudDMNLi¡EÁry
(
pw®Ët
, 
dmn
, 
d‘aed
));

1014 } ià(
ty³
 == "valid" ||ype == "registered") {

1015 ià(
»que¡
.
·¿ms
.
	`size
() > 4) {

1016 
	`´Ùx_li¡_h–p
(
»que¡
);

1019 
	`LOCK
(
cs_maš
);

1021 
boŞ
 
d‘aed
 = !
»que¡
.
·¿ms
[2].
	`isNuÎ
(è?„eque¡.·¿ms[2].
	`g‘_boŞ
(è: 
çl£
;

1023 
height
 = !
»que¡
.
·¿ms
[3].
	`isNuÎ
(è?„eque¡.·¿ms[3].
	`g‘_št
(è: ::
	`ChašAùive
().
	`Height
();

1024 ià(
height
 < 1 || heighˆ> ::
	`ChašAùive
().
	`Height
()) {

1025 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid height specified");

1028 
CD‘”mši¡icMNLi¡
 
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡FÜBlock
(::
	`ChašAùive
()[
height
]);

1029 
boŞ
 
ÚlyV®id
 = 
ty³
 == "valid";

1030 
mnLi¡
.
	`FÜEachMN
(
ÚlyV®id
, [&](cÚ¡ 
CD‘”mši¡icMNCPŒ
& 
dmn
) {

1031 
»t
.
	`push_back
(
	`BudDMNLi¡EÁry
(
pw®Ët
, 
dmn
, 
d‘aed
));

1034 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalidype specified");

1037  
»t
;

1038 
	}
}

1040 
	$´Ùx_šfo_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1042 
RPCH–pMª
{"protx info",

1045 + 
	`G‘H–pSŒšg
(1, "proTxHash"),

1048 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1049 
RPCExam¶es
{""},

1050 }.
	`Check
(
»que¡
);

1051 
	}
}

1053 
UniV®ue
 
	$´Ùx_šfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1055 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2) {

1056 
	`´Ùx_šfo_h–p
(
»que¡
);

1058 
CW®Ët
* 
pw®Ët
;

1059 #ifdeà
ENABLE_WALLET


1060 
¡d
::
sh¬ed_±r
<
CW®Ët
> cÚ¡ 
w®Ët
 = 
	`G‘W®ËtFÜJSONRPCReque¡
(
»que¡
);

1061 ià(
w®Ët
)

1062 
pw®Ët
 = 
w®Ët
.
	`g‘
();

1064 
pw®Ët
 = 
nuÎ±r
;

1067 
ušt256
 
´oTxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "proTxHash");

1068 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡AtChašT
();

1069 autØ
dmn
 = 
mnLi¡
.
	`G‘MN
(
´oTxHash
);

1070 ià(!
dmn
) {

1071 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("% nÙ found", 
´oTxHash
.
	`ToSŒšg
()));

1073  
	`BudDMNLi¡EÁry
(
pw®Ët
, 
dmn
, 
Œue
);

1074 
	}
}

1076 
	$´Ùx_diff_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1078 
RPCH–pMª
{"protx diff",

1085 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1086 
RPCExam¶es
{""},

1087 }.
	`Check
(
»que¡
);

1088 
	}
}

1090 
ušt256
 
	$P¬£Block
(cÚ¡ 
UniV®ue
& 
v
, 
¡d
::
¡ršg
 
¡rName
)

1092 
	`As£¹LockH–d
(
cs_maš
);

1094 
Œy
 {

1095  
	`P¬£HashV
(
v
, 
¡rName
);

1096 } 
	`ÿtch
 (...) {

1097 
h
 = 
v
.
	`g‘_št
();

1098 ià(
h
 < 1 || h > ::
	`ChašAùive
().
	`Height
())

1099 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`¡½rštf
("% mu¡ b¨block hash o¸chaš heighˆªd‚Ù %s", 
¡rName
, 
v
.
	`g‘V®SŒ
()));

1100  *::
	`ChašAùive
()[
h
]->
phashBlock
;

1102 
	}
}

1104 
UniV®ue
 
	$´Ùx_diff
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1106 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 3) {

1107 
	`´Ùx_diff_h–p
(
»que¡
);

1110 
	`LOCK
(
cs_maš
);

1111 
ušt256
 
ba£BlockHash
 = 
	`P¬£Block
(
»que¡
.
·¿ms
[1], "baseBlock");

1112 
ušt256
 
blockHash
 = 
	`P¬£Block
(
»que¡
.
·¿ms
[2], "block");

1114 
CSim¶if›dMNLi¡Diff
 
mnLi¡Diff
;

1115 
¡d
::
¡ršg
 
¡rE¼Ü
;

1116 ià(!
	`BudSim¶if›dMNLi¡Diff
(
ba£BlockHash
, 
blockHash
, 
mnLi¡Diff
, 
¡rE¼Ü
)) {

1117 
throw
 
¡d
::
	`ruÁime_”rÜ
(
¡rE¼Ü
);

1120 
UniV®ue
 
»t
;

1121 
mnLi¡Diff
.
	`ToJsÚ
(
»t
);

1122  
»t
;

1123 
	}
}

1125 
	$´Ùx_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1127 
RPCH–pMª
{"protx",

1131 #ifdeà
ENABLE_WALLET


1139 #ifdeà
ENABLE_WALLET


1146 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The commandoƒxecute"}

1148 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1149 
RPCExam¶es
{""},

1150 }.
	`Check
(
»que¡
);

1151 
	}
}

1153 
UniV®ue
 
	$´Ùx
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1155 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`em±y
()) {

1156 
	`´Ùx_h–p
(
»que¡
);

1159 
¡d
::
¡ršg
 
commªd
;

1160 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

1161 
commªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

1164 #ifdeà
ENABLE_WALLET


1165 ià(
commªd
 == "register" || command == "register_fund" || command == "register_prepare") {

1166  
	`´Ùx_»gi¡”
(
»que¡
);

1167 } ià(
commªd
 == "register_submit") {

1168  
	`´Ùx_»gi¡”_subm™
(
»que¡
);

1169 } ià(
commªd
 == "update_service") {

1170  
	`´Ùx_upd©e_£rviû
(
»que¡
);

1171 } ià(
commªd
 == "update_registrar") {

1172  
	`´Ùx_upd©e_»gi¡¿r
(
»que¡
);

1173 } ià(
commªd
 == "revoke") {

1174  
	`´Ùx_»voke
(
»que¡
);

1177 ià(
commªd
 == "list") {

1178  
	`´Ùx_li¡
(
»que¡
);

1179 } ià(
commªd
 == "info") {

1180  
	`´Ùx_šfo
(
»que¡
);

1181 } ià(
commªd
 == "diff") {

1182  
	`´Ùx_diff
(
»que¡
);

1184 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid…rotx command");

1186 
	}
}

1188 
	$bls_g’”©e_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1190 
RPCH–pMª
{"bls generate",

1194 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1195 
RPCExam¶es
{""},

1196 }.
	`Check
(
»que¡
);

1197 
	}
}

1199 
UniV®ue
 
	$bls_g’”©e
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1201 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 1) {

1202 
	`bls_g’”©e_h–p
(
»que¡
);

1205 
CBLSSeü‘Key
 
sk
;

1206 
sk
.
	`MakeNewKey
();

1208 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1209 
»t
.
	`pushKV
("£ü‘", 
sk
.
	`ToSŒšg
());

1210 
»t
.
	`pushKV
("public", 
sk
.
	`G‘PublicKey
().
	`ToSŒšg
());

1211  
»t
;

1212 
	}
}

1214 
	$bls_äom£ü‘_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1216 
RPCH–pMª
{"bls fromsecret",

1222 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1223 
RPCExam¶es
{""},

1224 }.
	`Check
(
»que¡
);

1225 
	}
}

1227 
UniV®ue
 
	$bls_äom£ü‘
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1229 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 2) {

1230 
	`bls_äom£ü‘_h–p
(
»que¡
);

1233 
CBLSSeü‘Key
 
sk
;

1234 ià(!
sk
.
	`S‘HexSŒ
(
»que¡
.
·¿ms
[1].
	`g‘_¡r
())) {

1235 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("Seü‘ key mu¡ b¨v®id hex sŒšg oàËngth %d", 
sk
.
S”Size
*2));

1238 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

1239 
»t
.
	`pushKV
("£ü‘", 
sk
.
	`ToSŒšg
());

1240 
»t
.
	`pushKV
("public", 
sk
.
	`G‘PublicKey
().
	`ToSŒšg
());

1241  
»t
;

1242 
	}
}

1244 
	$bls_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1246 
RPCH–pMª
{"bls",

1253 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The commandoƒxecute"}

1255 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

1256 
RPCExam¶es
{""},

1257 }.
	`Check
(
»que¡
);

1258 
	}
}

1260 
UniV®ue
 
	$_bls
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

1262 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`em±y
()) {

1263 
	`bls_h–p
(
»que¡
);

1266 
¡d
::
¡ršg
 
commªd
;

1267 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

1268 
commªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

1271 ià(
commªd
 == "generate") {

1272  
	`bls_g’”©e
(
»que¡
);

1273 } ià(
commªd
 == "fromsecret") {

1274  
	`bls_äom£ü‘
(
»que¡
);

1276 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid bls command");

1278 
	}
}

1280 cÚ¡ 
CRPCCommªd
 
	gcommªds
[] =

1283 { "evo", "bls", &
_bls
, {} },

1284 { "evo", "´Ùx", &
´Ùx
, {} },

1287 
	$Regi¡”EvoRPCCommªds
(
CRPCTabË
 &
bËRPC
)

1289 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++) {

1290 
bËRPC
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

1292 
	}
}

	@rpcquorums.cpp

5 
	~<chaš·¿ms.h
>

6 
	~<½c/£rv”.h
>

7 
	~<v®id©iÚ.h
>

9 
	~<ma¡”node/aùivema¡”node.h
>

11 
	~<Îmq/quÜums.h
>

12 
	~<Îmq/quÜums_block´oûssÜ.h
>

13 
	~<Îmq/quÜums_debug.h
>

14 
	~<Îmq/quÜums_dkg£ssiÚ.h
>

15 
	~<Îmq/quÜums_signšg.h
>

16 
	~<Îmq/quÜums_signšg_sh¬es.h
>

17 
	~<½c/ut.h
>

18 
	~<Ãt.h
>

19 
	~<½c/blockchaš.h
>

20 
	~<node/cÚ‹xt.h
>

21 
	$quÜum_li¡_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

23 
RPCH–pMª
{"quorum†ist",

30 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

31 
RPCExam¶es
{""},

32 }.
	`Check
(
»que¡
);

33 
	}
}

35 
UniV®ue
 
	$quÜum_li¡
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

37 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 1 &&„equest.params.size() != 2))

38 
	`quÜum_li¡_h–p
(
»que¡
);

40 
	`LOCK
(
cs_maš
);

42 
couÁ
 = -1;

43 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

44 
couÁ
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

45 ià(
couÁ
 < 0) {

46 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "count can't be‚egative");

50 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

52 auto& 
p
 : 
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
) {

53 
UniV®ue
 
	`v
(UniV®ue::
VARR
);

55 autØ
quÜums
 = 
Îmq
::
quÜumMªag”
->
	`SÿnQuÜums
(
p
.
fœ¡
, ::
	`ChašAùive
().
	`T
(), 
couÁ
 > -1 ? couÁ :….
£cÚd
.
signšgAùiveQuÜumCouÁ
);

56 auto& 
q
 : 
quÜums
) {

57 
v
.
	`push_back
(
q
->
qc
.
quÜumHash
.
	`ToSŒšg
());

60 
»t
.
	`pushKV
(
p
.
£cÚd
.
Çme
, 
v
);

64  
»t
;

65 
	}
}

67 
	$quÜum_šfo_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

69 
RPCH–pMª
{"quorum info",

77 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

78 
RPCExam¶es
{""},

79 }.
	`Check
(
»que¡
);

80 
	}
}

82 
UniV®ue
 
	$BudQuÜumInfo
(cÚ¡ 
Îmq
::
CQuÜumCPŒ
& 
quÜum
, 
boŞ
 
šşudeMemb”s
, boŞ 
šşudeSkSh¬e
)

84 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

86 
»t
.
	`pushKV
("height", 
quÜum
->
pšdexQuÜum
->
nHeight
);

87 
»t
.
	`pushKV
("ty³", 
quÜum
->
·¿ms
.
Çme
);

88 
»t
.
	`pushKV
("quÜumHash", 
quÜum
->
qc
.
quÜumHash
.
	`ToSŒšg
());

89 
»t
.
	`pushKV
("mšedBlock", 
quÜum
->
mšedBlockHash
.
	`ToSŒšg
());

91 ià(
šşudeMemb”s
) {

92 
UniV®ue
 
	`memb”sA¼
(UniV®ue::
VARR
);

93 
size_t
 
i
 = 0; i < 
quÜum
->
memb”s
.
	`size
(); i++) {

94 auto& 
dmn
 = 
quÜum
->
memb”s
[
i
];

95 
UniV®ue
 
	`mo
(UniV®ue::
VOBJ
);

96 
mo
.
	`pushKV
("´oTxHash", 
dmn
->
´oTxHash
.
	`ToSŒšg
());

97 
mo
.
	`pushKV
("pubKeyO³¿tÜ", 
dmn
->
pdmnS‹
->
pubKeyO³¿tÜ
.
	`G‘
().
	`ToSŒšg
());

98 
mo
.
	`pushKV
("v®id", 
quÜum
->
qc
.
v®idMemb”s
[
i
]);

99 ià(
quÜum
->
qc
.
v®idMemb”s
[
i
]) {

100 
CBLSPublicKey
 
pubKey
 = 
quÜum
->
	`G‘PubKeySh¬e
(
i
);

101 ià(
pubKey
.
	`IsV®id
()) {

102 
mo
.
	`pushKV
("pubKeySh¬e", 
pubKey
.
	`ToSŒšg
());

105 
memb”sA¼
.
	`push_back
(
mo
);

108 
»t
.
	`pushKV
("memb”s", 
memb”sA¼
);

110 
»t
.
	`pushKV
("quÜumPublicKey", 
quÜum
->
qc
.
quÜumPublicKey
.
	`ToSŒšg
());

111 
CBLSSeü‘Key
 
skSh¬e
 = 
quÜum
->
	`G‘SkSh¬e
();

112 ià(
šşudeSkSh¬e
 && 
skSh¬e
.
	`IsV®id
()) {

113 
»t
.
	`pushKV
("£ü‘KeySh¬e", 
skSh¬e
.
	`ToSŒšg
());

115  
»t
;

116 
	}
}

118 
UniV®ue
 
	$quÜum_šfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

120 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 3 &&„equest.params.size() != 4))

121 
	`quÜum_šfo_h–p
(
»que¡
);

123 
	`LOCK
(
cs_maš
);

125 
ušt8_t
 
ÎmqTy³
 = (ušt8_t)
»que¡
.
·¿ms
[1].
	`g‘_št
();

126 ià(!
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
.
	`couÁ
(
ÎmqTy³
)) {

127 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid LLMQype");

130 cÚ¡‡uto& 
ÎmqP¬ams
 = 
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
.
	`©
(
ÎmqTy³
);

132 
ušt256
 
quÜumHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "quorumHash");

133 
boŞ
 
šşudeSkSh¬e
 = 
çl£
;

134 ià(!
»que¡
.
·¿ms
[3].
	`isNuÎ
()) {

135 
šşudeSkSh¬e
 = 
»que¡
.
·¿ms
[3].
	`g‘_boŞ
();

138 autØ
quÜum
 = 
Îmq
::
quÜumMªag”
->
	`G‘QuÜum
(
ÎmqTy³
, 
quÜumHash
);

139 ià(!
quÜum
) {

140 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "quorum‚ot found");

143  
	`BudQuÜumInfo
(
quÜum
, 
Œue
, 
šşudeSkSh¬e
);

144 
	}
}

146 
	$quÜum_dkg¡©us_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

148 
RPCH–pMª
{"quorum dkgstatus",

156 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

157 
RPCExam¶es
{""},

158 }.
	`Check
(
»que¡
);

159 
	}
}

161 
UniV®ue
 
	$quÜum_dkg¡©us
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

163 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() < 1 ||„equest.params.size() > 2)) {

164 
	`quÜum_dkg¡©us_h–p
(
»que¡
);

167 
d‘aLev–
 = 0;

168 ià(!
»que¡
.
·¿ms
[1].
	`isNuÎ
()) {

169 
d‘aLev–
 = 
»que¡
.
·¿ms
[1].
	`g‘_št
();

170 ià(
d‘aLev–
 < 0 || detailLevel > 2) {

171 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid detail_level");

175 
Îmq
::
CDKGDebugStus
 
¡©us
;

176 
Îmq
::
quÜumDKGDebugMªag”
->
	`G‘LoÿlDebugStus
(
¡©us
);

178 autØ
»t
 = 
¡©us
.
	`ToJsÚ
(
d‘aLev–
);

180 
	`LOCK
(
cs_maš
);

181 
tHeight
 = ::
	`ChašAùive
().
	`Height
();

183 
UniV®ue
 
	`mšabËComm™m’ts
(UniV®ue::
VOBJ
);

184 
UniV®ue
 
	`quÜumCÚÃùiÚs
(UniV®ue::
VOBJ
);

185 
NodeCÚ‹xt
& 
node
 = 
	`Ensu»NodeCÚ‹xt
(
»que¡
.
cÚ‹xt
);

186 if(!
node
.
cÚnmª
)

187 
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_P2P_DISABLED
, "Error: Peer-to-peer functionality missing or disabled");

189 cÚ¡‡uto& 
p
 : 
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
) {

190 auto& 
·¿ms
 = 
p
.
£cÚd
;

192 ià(
fMa¡”nodeMode
) {

193 cÚ¡ 
CBlockIndex
* 
pšdexQuÜum
 = ::
	`ChašAùive
()[
tHeight
 - (tHeighˆ% 
·¿ms
.
dkgIÁ”v®
)];

194 autØ
®lCÚÃùiÚs
 = 
Îmq
::
CLLMQUts
::
	`G‘QuÜumCÚÃùiÚs
(
·¿ms
.
ty³
, 
pšdexQuÜum
, 
aùiveMa¡”nodeInfo
.
´oTxHash
, 
çl£
);

195 autØ
outboundCÚÃùiÚs
 = 
Îmq
::
CLLMQUts
::
	`G‘QuÜumCÚÃùiÚs
(
·¿ms
.
ty³
, 
pšdexQuÜum
, 
aùiveMa¡”nodeInfo
.
´oTxHash
, 
Œue
);

196 
¡d
::
m­
<
ušt256
, 
CAdd»ss
> 
foundCÚÃùiÚs
;

197 
node
.
cÚnmª
->
	`FÜEachNode
([&](
CNode
* 
²ode
) {

198 ià(!
²ode
->
v”if›dProRegTxHash
.
	`IsNuÎ
(è&& 
®lCÚÃùiÚs
.
	`couÁ
(pnode->verifiedProRegTxHash)) {

199 
foundCÚÃùiÚs
.
	`em¶aû
(
²ode
->
v”if›dProRegTxHash
,…node->
addr
);

202 
UniV®ue
 
	`¬r
(UniV®ue::
VARR
);

203 auto& 
ec
 : 
®lCÚÃùiÚs
) {

204 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

205 
obj
.
	`pushKV
("´oTxHash", 
ec
.
	`ToSŒšg
());

206 ià(
foundCÚÃùiÚs
.
	`couÁ
(
ec
)) {

207 
obj
.
	`pushKV
("cÚÃùed", 
Œue
);

208 
obj
.
	`pushKV
("add»ss", 
foundCÚÃùiÚs
[
ec
].
	`ToSŒšg
());

210 
obj
.
	`pushKV
("cÚÃùed", 
çl£
);

212 
obj
.
	`pushKV
("outbound", 
outboundCÚÃùiÚs
.
	`couÁ
(
ec
) != 0);

213 
¬r
.
	`push_back
(
obj
);

215 
quÜumCÚÃùiÚs
.
	`pushKV
(
·¿ms
.
Çme
, 
¬r
);

218 
Îmq
::
CFš®Comm™m’t
 
fqc
;

219 ià(
Îmq
::
quÜumBlockProûssÜ
->
	`G‘MšabËComm™m’t
(
·¿ms
.
ty³
, 
tHeight
, 
fqc
)) {

220 
UniV®ue
 
	`obj
(UniV®ue::
VOBJ
);

221 
fqc
.
	`ToJsÚ
(
obj
);

222 
mšabËComm™m’ts
.
	`pushKV
(
·¿ms
.
Çme
, 
obj
);

226 
»t
.
	`pushKV
("mšabËComm™m’ts", 
mšabËComm™m’ts
);

227 
»t
.
	`pushKV
("quÜumCÚÃùiÚs", 
quÜumCÚÃùiÚs
);

229  
»t
;

230 
	}
}

232 
	$quÜum_memb”of_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

234 
RPCH–pMª
{"quorum memberof",

242 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

243 
RPCExam¶es
{""},

244 }.
	`Check
(
»que¡
);

245 
	}
}

247 
UniV®ue
 
	$quÜum_memb”of
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

249 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() < 2 ||„equest.params.size() > 3)) {

250 
	`quÜum_memb”of_h–p
(
»que¡
);

253 
ušt256
 
´ÙxHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[1], "proTxHash");

254 
sÿnQuÜumsCouÁ
 = -1;

255 ià(!
»que¡
.
·¿ms
[2].
	`isNuÎ
()) {

256 
sÿnQuÜumsCouÁ
 = 
»que¡
.
·¿ms
[2].
	`g‘_št
();

257 ià(
sÿnQuÜumsCouÁ
 <= 0) {

258 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid scanQuorumsCount…arameter");

262 cÚ¡ 
CBlockIndex
* 
pšdexT
;

264 
	`LOCK
(
cs_maš
);

265 
pšdexT
 = ::
	`ChašAùive
().
	`T
();

268 autØ
mnLi¡
 = 
d‘”mši¡icMNMªag”
->
	`G‘Li¡FÜBlock
(
pšdexT
);

269 autØ
dmn
 = 
mnLi¡
.
	`G‘MN
(
´ÙxHash
);

270 ià(!
dmn
) {

271 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "masternode‚ot found");

274 
UniV®ue
 
	`»suÉ
(UniV®ue::
VARR
);

276 cÚ¡‡uto& 
p
 : 
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
) {

277 auto& 
·¿ms
 = 
p
.
£cÚd
;

278 
size_t
 
couÁ
 = 
·¿ms
.
signšgAùiveQuÜumCouÁ
;

279 ià(
sÿnQuÜumsCouÁ
 != -1) {

280 
couÁ
 = (
size_t
)
sÿnQuÜumsCouÁ
;

282 autØ
quÜums
 = 
Îmq
::
quÜumMªag”
->
	`SÿnQuÜums
(
·¿ms
.
ty³
, 
couÁ
);

283 auto& 
quÜum
 : 
quÜums
) {

284 ià(
quÜum
->
	`IsMemb”
(
dmn
->
´oTxHash
)) {

285 autØ
jsÚ
 = 
	`BudQuÜumInfo
(
quÜum
, 
çl£
, false);

286 
jsÚ
.
	`pushKV
("isV®idMemb”", 
quÜum
->
	`IsV®idMemb”
(
dmn
->
´oTxHash
));

287 
jsÚ
.
	`pushKV
("memb”Index", 
quÜum
->
	`G‘Memb”Index
(
dmn
->
´oTxHash
));

288 
»suÉ
.
	`push_back
(
jsÚ
);

293  
»suÉ
;

294 
	}
}

296 
	$quÜum_sign_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

298 
RPCH–pMª
{"quorum sign",

307 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

308 
RPCExam¶es
{""},

309 }.
	`Check
(
»que¡
);

310 
	}
}

312 
	$quÜum_ha¤ecsig_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

314 
RPCH–pMª
{"quorum hasrecsig",

322 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

323 
RPCExam¶es
{""},

324 }.
	`Check
(
»que¡
);

325 
	}
}

327 
	$quÜum_g‘»csig_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

329 
RPCH–pMª
{"quorum getrecsig",

337 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

338 
RPCExam¶es
{""},

339 }.
	`Check
(
»que¡
);

340 
	}
}

342 
	$quÜum_iscÚæiùšg_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

344 
RPCH–pMª
{"quorum isconflicting",

352 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

353 
RPCExam¶es
{""},

354 }.
	`Check
(
»que¡
);

355 
	}
}

357 
UniV®ue
 
	$quÜum_sigs_cmd
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

359 autØ
cmd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

360 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 4)) {

361 ià(
cmd
 == "sign") {

362 ià((
»que¡
.
·¿ms
.
	`size
() < 4) || (request.params.size() > 5)) {

363 
	`quÜum_sign_h–p
(
»que¡
);

365 } ià(
cmd
 == "hasrecsig") {

366 
	`quÜum_ha¤ecsig_h–p
(
»que¡
);

367 } ià(
cmd
 == "getrecsig") {

368 
	`quÜum_g‘»csig_h–p
(
»que¡
);

369 } ià(
cmd
 == "isconflicting") {

370 
	`quÜum_iscÚæiùšg_h–p
(
»que¡
);

373 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid cmd");

377 
ušt8_t
 
ÎmqTy³
 = (ušt8_t)
»que¡
.
·¿ms
[1].
	`g‘_št
();

378 ià(!
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
.
	`couÁ
(
ÎmqTy³
)) {

379 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid LLMQype");

382 
ušt256
 
id
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "id");

383 
ušt256
 
msgHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[3], "msgHash");

385 ià(
cmd
 == "sign") {

386 ià(!
»que¡
.
·¿ms
[4].
	`isNuÎ
()) {

387 
ušt256
 
quÜumHash
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[4], "quorumHash");

388 autØ
quÜum
 = 
Îmq
::
quÜumMªag”
->
	`G‘QuÜum
(
ÎmqTy³
, 
quÜumHash
);

389 ià(!
quÜum
) {

390 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "quorum‚ot found");

392 
Îmq
::
quÜumSigSh¬esMªag”
->
	`AsyncSign
(
quÜum
, 
id
, 
msgHash
);

393  
Œue
;

395  
Îmq
::
quÜumSignšgMªag”
->
	`AsyncSignIfMemb”
(
ÎmqTy³
, 
id
, 
msgHash
);

397 } ià(
cmd
 == "hasrecsig") {

398  
Îmq
::
quÜumSignšgMªag”
->
	`HasRecov”edSig
(
ÎmqTy³
, 
id
, 
msgHash
);

399 } ià(
cmd
 == "getrecsig") {

400 
Îmq
::
CRecov”edSig
 
»cSig
;

401 ià(!
Îmq
::
quÜumSignšgMªag”
->
	`G‘Recov”edSigFÜId
(
ÎmqTy³
, 
id
, 
»cSig
)) {

402 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "recovered signature‚ot found");

404 ià(
»cSig
.
msgHash
 != msgHash) {

405 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "recovered signature‚ot found");

407  
»cSig
.
	`ToJsÚ
();

408 } ià(
cmd
 == "isconflicting") {

409  
Îmq
::
quÜumSignšgMªag”
->
	`IsCÚæiùšg
(
ÎmqTy³
, 
id
, 
msgHash
);

412 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid cmd");

414 
	}
}

416 
	$quÜum_£ËùquÜum_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

418 
RPCH–pMª
{"quorum selectquorum",

425 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

426 
RPCExam¶es
{""},

427 }.
	`Check
(
»que¡
);

428 
	}
}

430 
UniV®ue
 
	$quÜum_£ËùquÜum
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

432 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`size
() != 3) {

433 
	`quÜum_£ËùquÜum_h–p
(
»que¡
);

436 
ušt8_t
 
ÎmqTy³
 = (ušt8_t)
»que¡
.
·¿ms
[1].
	`g‘_št
();

437 ià(!
	`P¬ams
().
	`G‘CÚ£nsus
().
Îmqs
.
	`couÁ
(
ÎmqTy³
)) {

438 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid LLMQype");

441 
ušt256
 
id
 = 
	`P¬£HashV
(
»que¡
.
·¿ms
[2], "id");

443 
tHeight
;

445 
	`LOCK
(
cs_maš
);

446 
tHeight
 = ::
	`ChašAùive
().
	`Height
();

449 
UniV®ue
 
	`»t
(UniV®ue::
VOBJ
);

451 autØ
quÜum
 = 
Îmq
::
quÜumSignšgMªag”
->
	`S–eùQuÜumFÜSignšg
(
ÎmqTy³
, 
tHeight
, 
id
);

452 ià(!
quÜum
) {

453 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, "no quorums‡ctive");

455 
»t
.
	`pushKV
("quÜumHash", 
quÜum
->
qc
.
quÜumHash
.
	`ToSŒšg
());

457 
UniV®ue
 
	`»cov”yMemb”s
(UniV®ue::
VARR
);

458 
i
 = 0; i < 
quÜum
->
·¿ms
.
»cov”yMemb”s
; i++) {

459 autØ
dmn
 = 
Îmq
::
quÜumSigSh¬esMªag”
->
	`S–eùMemb”FÜRecov”y
(
quÜum
, 
id
, 
i
);

460 
»cov”yMemb”s
.
	`push_back
(
dmn
->
´oTxHash
.
	`ToSŒšg
());

462 
»t
.
	`pushKV
("»cov”yMemb”s", 
»cov”yMemb”s
);

464  
»t
;

465 
	}
}

467 
	$quÜum_dkgsim”rÜ_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

469 
RPCH–pMª
{"quorum dkgsimerror",

477 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

478 
RPCExam¶es
{""},

479 }.
	`Check
(
»que¡
);

480 
	}
}

482 
UniV®ue
 
	$quÜum_dkgsim”rÜ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

484 autØ
cmd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

485 ià(
»que¡
.
fH–p
 || (»que¡.
·¿ms
.
	`size
() != 3)) {

486 
	`quÜum_dkgsim”rÜ_h–p
(
»que¡
);

489 
¡d
::
¡ršg
 
ty³
 = 
»que¡
.
·¿ms
[1].
	`g‘_¡r
();

490 
¿‹
 = 
»que¡
.
·¿ms
[2].
	`g‘_»®
();

492 ià(
¿‹
 < 0 ||„ate > 1) {

493 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "invalid„ate. Must be between 0‡nd 1");

496 
Îmq
::
	`S‘SimuÏ‹dDKGE¼ÜR©e
(
ty³
, 
¿‹
);

498  
	`UniV®ue
();

499 
	}
}

502 
	$quÜum_h–p
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

504 
RPCH–pMª
{"quorum",

519 {"commªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
::
NO
, "The commandoƒxecute"}

521 
RPCResuÉ
{RPCResuÉ::
Ty³
::
NONE
, "", ""},

522 
RPCExam¶es
{""},

523 }.
	`Check
(
»que¡
);

524 
	}
}

526 
UniV®ue
 
	$quÜum
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

528 ià(
»que¡
.
fH–p
 ||„eque¡.
·¿ms
.
	`em±y
()) {

529 
	`quÜum_h–p
(
»que¡
);

532 
¡d
::
¡ršg
 
commªd
;

533 ià(!
»que¡
.
·¿ms
[0].
	`isNuÎ
()) {

534 
commªd
 = 
»que¡
.
·¿ms
[0].
	`g‘_¡r
();

537 ià(
commªd
 == "list") {

538  
	`quÜum_li¡
(
»que¡
);

539 } ià(
commªd
 == "info") {

540  
	`quÜum_šfo
(
»que¡
);

541 } ià(
commªd
 == "dkgstatus") {

542  
	`quÜum_dkg¡©us
(
»que¡
);

543 } ià(
commªd
 == "memberof") {

544  
	`quÜum_memb”of
(
»que¡
);

545 } ià(
commªd
 == "sign" || command == "hasrecsig" || command == "getrecsig" || command == "isconflicting") {

546  
	`quÜum_sigs_cmd
(
»que¡
);

547 } ià(
commªd
 == "selectquorum") {

548  
	`quÜum_£ËùquÜum
(
»que¡
);

549 } ià(
commªd
 == "dkgsimerror") {

550  
	`quÜum_dkgsim”rÜ
(
»que¡
);

552 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Invalid quorum command");

554 
	}
}

556 cÚ¡ 
CRPCCommªd
 
	gcommªds
[] =

559 { "evo", "quÜum", &
quÜum
, {} },

562 
	$Regi¡”QuÜumsRPCCommªds
(
CRPCTabË
 &
bËRPC
)

564 
vcidx
 = 0; vcidx < 
	`ARRAYLEN
(
commªds
); vcidx++)

565 
bËRPC
.
	`­³ndCommªd
(
commªds
[
vcidx
].
Çme
, &commands[vcidx]);

566 
	}
}

	@server.cpp

6 
	~<½c/£rv”.h
>

8 
	~<½c/ut.h
>

9 
	~<shutdown.h
>

10 
	~<sync.h
>

11 
	~<ut/¡»ncodšgs.h
>

12 
	~<ut/sy¡em.h
>

14 
	~<boo¡/®gÜ™hm/¡ršg/şassifiÿtiÚ.hµ
>

15 
	~<boo¡/®gÜ™hm/¡ršg/¥l™.hµ
>

16 
	~<boo¡/sigÇls2/sigÇl.hµ
>

18 
	~<ÿs£¹
>

19 
	~<memÜy
>

20 
	~<mu‹x
>

21 
	~<unÜd”ed_m­
>

23 
RecursiveMu‹x
 
	gcs_½cW¬mup
;

24 
	g¡d
::
©omic
<
boŞ
> 
g_½c_ruÂšg
{
çl£
};

25 
boŞ
 
fRPCInW¬mup
 
GUARDED_BY
(
cs_½cW¬mup
èğ
Œue
;

26 
	g¡d
::
¡ršg
 
½cW¬mupStus
 
GUARDED_BY
(
cs_½cW¬mup
) = "RPC server started";

28 
RPCTim”IÁ”çû
* 
	gtim”IÁ”çû
 = 
nuÎ±r
;

30 
Mu‹x
 
	gg_d—dlše_tim”s_mu‹x
;

31 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::
unique_±r
<
RPCTim”Ba£
> > 
d—dlšeTim”s
 
GUARDED_BY
(
g_d—dlše_tim”s_mu‹x
);

32 
boŞ
 
Execu‹Commªd
(cÚ¡ 
CRPCCommªd
& 
commªd
, cÚ¡ 
JSONRPCReque¡
& 
»que¡
, 
UniV®ue
& 
»suÉ
, boŞ 
Ï¡_hªdËr
);

34 
	sRPCCommªdExecutiÚInfo


36 
	m¡d
::
¡ršg
 
m‘hod
;

37 
št64_t
 
	m¡¬t
;

40 
	sRPCS”v”Info


42 
Mu‹x
 
	mmu‹x
;

43 
	m¡d
::
li¡
<
RPCCommªdExecutiÚInfo
> 
aùive_commªds
 
GUARDED_BY
(
mu‹x
);

46 
RPCS”v”Info
 
	gg_½c_£rv”_šfo
;

48 
	sRPCCommªdExecutiÚ


50 
	m¡d
::
li¡
<
RPCCommªdExecutiÚInfo
>::
™”©Ü
 
™
;

51 
ex¶ic™
 
RPCCommªdExecutiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hod
)

53 
LOCK
(
g_½c_£rv”_šfo
.
mu‹x
);

54 
	m™
 = 
g_½c_£rv”_šfo
.
aùive_commªds
.
š£¹
(g_½c_£rv”_šfo.aùive_commªds.
’d
(), {
m‘hod
, 
G‘TimeMiüos
()});

56 ~
RPCCommªdExecutiÚ
()

58 
LOCK
(
g_½c_£rv”_šfo
.
mu‹x
);

59 
	mg_½c_£rv”_šfo
.
	maùive_commªds
.
”a£
(
™
);

63 
	sCRPCSigÇls


65 
	mboo¡
::
sigÇls2
::
sigÇl
<()> 
S¹ed
;

66 
	mboo¡
::
sigÇls2
::
sigÇl
<()> 
Stİ³d
;

67 } 
	gg_½cSigÇls
;

69 
	gRPCS”v”
::
OnS¹ed
(
¡d
::
funùiÚ
<()> 
¦Ù
)

71 
g_½cSigÇls
.
S¹ed
.
cÚÃù
(
¦Ù
);

74 
	gRPCS”v”
::
OnStİ³d
(
¡d
::
funùiÚ
<()> 
¦Ù
)

76 
g_½cSigÇls
.
Stİ³d
.
cÚÃù
(
¦Ù
);

79 
	g¡d
::
¡ršg
 
CRPCTabË
::
	$h–p
(cÚ¡ 
¡d
::
¡ršg
& 
¡rCommªd
, cÚ¡ std::¡ršg& 
¡rSubCommªd
, cÚ¡ 
JSONRPCReque¡
& 
h–´eq
) const

81 
¡d
::
¡ršg
 
¡rR‘
;

82 
¡d
::
¡ršg
 
ÿ‹gÜy
;

83 
¡d
::
£t
<
šŒ_t
> 
£tDÚe
;

84 
¡d
::
veùÜ
<¡d::
·œ
<¡d::
¡ršg
, cÚ¡ 
CRPCCommªd
*> > 
vCommªds
;

86 cÚ¡‡uto& 
’Œy
 : 
m­Commªds
)

87 
vCommªds
.
	`push_back
(
	`make_·œ
(
’Œy
.
£cÚd
.
	`äÚt
()->
ÿ‹gÜy
 +ƒÁry.
fœ¡
,ƒntry.second.front()));

88 
	`sÜt
(
vCommªds
.
	`begš
(), vCommªds.
	`’d
());

90 
JSONRPCReque¡
 
	`j»q
(
h–´eq
);

91 
j»q
.
fH–p
 = 
Œue
;

92 
j»q
.
·¿ms
 = 
	`UniV®ue
();

94 cÚ¡ 
¡d
::
·œ
<¡d::
¡ršg
, cÚ¡ 
CRPCCommªd
*>& 
commªd
 : 
vCommªds
)

96 cÚ¡ 
CRPCCommªd
 *
pcmd
 = 
commªd
.
£cÚd
;

97 
¡d
::
¡ršg
 
¡rM‘hod
 = 
pcmd
->
Çme
;

98 ià((
¡rCommªd
 !ğ"" || 
pcmd
->
ÿ‹gÜy
 =ğ"hidd’"è&& 
¡rM‘hod
 != strCommand)

100 
j»q
.
¡rM‘hod
 = strMethod;

101 
Œy


103 ià(!
¡rSubCommªd
.
	`em±y
()) {

104 
j»q
.
·¿ms
.
	`£tA¼ay
();

105 
j»q
.
·¿ms
.
	`push_back
(
¡rSubCommªd
);

108 
UniV®ue
 
unu£d_»suÉ
;

109 ià(
£tDÚe
.
	`š£¹
(
pcmd
->
unique_id
).
£cÚd
)

110 
pcmd
->
	`aùÜ
(
j»q
, 
unu£d_»suÉ
, 
Œue
 );

112 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
)

115 
¡d
::
¡ršg
 
¡rH–p
 = std::
	`¡ršg
(
e
.
	`wh©
());

116 ià(
¡rCommªd
 == "")

118 ià(
¡rH–p
.
	`fšd
('\n'è!ğ
¡d
::
¡ršg
::
Åos
)

119 
¡rH–p
 = sŒH–p.
	`sub¡r
(0, sŒH–p.
	`fšd
('\n'));

121 ià(
ÿ‹gÜy
 !ğ
pcmd
->category)

123 ià(!
ÿ‹gÜy
.
	`em±y
())

124 
¡rR‘
 += "\n";

125 
ÿ‹gÜy
 = 
pcmd
->category;

126 
¡rR‘
 +ğ"=ğ" + 
	`C­™®ize
(
ÿ‹gÜy
) + " ==\n";

129 
¡rR‘
 +ğ
¡rH–p
 + "\n";

132 ià(
¡rR‘
 == "")

133 
¡rR‘
 = 
	`¡½rštf
("h–p: unknowÀcommªd: %s\n", 
¡rCommªd
);

134 
¡rR‘
 = sŒR‘.
	`sub¡r
(0,¡rR‘.
	`size
()-1);

135  
¡rR‘
;

136 
	}
}

138 
UniV®ue
 
	$h–p
(cÚ¡ 
JSONRPCReque¡
& 
jsÚReque¡
)

140 ià(
jsÚReque¡
.
fH–p
 || jsÚReque¡.
·¿ms
.
	`size
() > 2)

141 
throw
 
¡d
::
	`ruÁime_”rÜ
(

142 
RPCH–pMª
{"help",

145 {"commªd", 
RPCArg
::
Ty³
::
STR
, "all commands", "The commando get help on"},

146 {"subCommªd", 
RPCArg
::
Ty³
::
STR
, RPCArg::
O±iÚ®
, "The subcommando get help on. Please‚othat‚ot‡ll subcommands supporthis‡the moment"}

148 
RPCResuÉ
{

149 
RPCResuÉ
::
Ty³
::
STR
, "", "The helpext"

151 
RPCExam¶es
{""},

152 }.
	`ToSŒšg
()

155 
¡d
::
¡ršg
 
¡rCommªd
, 
¡rSubCommªd
;

156 ià(
jsÚReque¡
.
·¿ms
.
	`size
() > 0)

157 
¡rCommªd
 = 
jsÚReque¡
.
·¿ms
[0].
	`g‘_¡r
();

158 ià(
jsÚReque¡
.
·¿ms
.
	`size
() > 1)

159 
¡rSubCommªd
 = 
jsÚReque¡
.
·¿ms
[1].
	`g‘_¡r
();

161  
bËRPC
.
	`h–p
(
¡rCommªd
, 
¡rSubCommªd
, 
jsÚReque¡
);

162 
	}
}

165 
UniV®ue
 
	$¡İ
(cÚ¡ 
JSONRPCReque¡
& 
jsÚReque¡
)

167 cÚ¡ 
¡d
::
¡ršg
 
RESULT
{
PACKAGE_NAME
 " stopping"};

172 ià(
jsÚReque¡
.
fH–p
 || jsÚReque¡.
·¿ms
.
	`size
() > 1)

173 
throw
 
¡d
::
	`ruÁime_”rÜ
(

174 
RPCH–pMª
{"stop",

175 "\nReque¡‡ g¿ûfuÈshutdowÀoà" 
PACKAGE_NAME
 ".",

177 
RPCResuÉ
{RPCResuÉ::
Ty³
::
STR
, "", "A sŒšg w™hhcÚ‹Á '" + 
RESULT
 + "'"},

178 
RPCExam¶es
{""},

179 }.
	`ToSŒšg
());

182 
	`S¹Shutdown
();

183 ià(
jsÚReque¡
.
·¿ms
[0].
	`isNum
()) {

184 
	`Unš‹¼u±ibËSË•
(
¡d
::
chrÚo
::
mli£cÚds
{
jsÚReque¡
.
·¿ms
[0].
	`g‘_št
()});

186  
RESULT
;

187 
	}
}

189 
UniV®ue
 
	$u±ime
(cÚ¡ 
JSONRPCReque¡
& 
jsÚReque¡
)

191 
RPCH–pMª
{"uptime",

194 
RPCResuÉ
{

195 
RPCResuÉ
::
Ty³
::
NUM
, "", "The‚umber of secondshathe server has been„unning"

197 
RPCExam¶es
{

198 
	`H–pExam¶eCli
("uptime", "")

199 + 
	`H–pExam¶eRpc
("uptime", "")

201 }.
	`Check
(
jsÚReque¡
);

203  
	`G‘Time
(è- 
	`G‘S¹upTime
();

204 
	}
}

206 
UniV®ue
 
	$g‘½cšfo
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
)

208 
RPCH–pMª
{"getrpcinfo",

211 
RPCResuÉ
{

212 
RPCResuÉ
::
Ty³
::
OBJ
, "", "",

214 {
RPCResuÉ
::
Ty³
::
ARR
, "active_commands", "All‡ctive commands",

216 {
RPCResuÉ
::
Ty³
::
OBJ
, "", "Information‡bout‡n‡ctive command",

218 {
RPCResuÉ
::
Ty³
::
STR
, "method", "The‚ame ofhe RPC command"},

219 {
RPCResuÉ
::
Ty³
::
NUM
, "duration", "The„unningime in microseconds"},

222 {
RPCResuÉ
::
Ty³
::
STR
, "logpath", "The complete file…athohe debug†og"},

225 
RPCExam¶es
{

226 
	`H–pExam¶eCli
("getrpcinfo", "")

227 + 
	`H–pExam¶eRpc
("getrpcinfo", "")},

228 }.
	`Check
(
»que¡
);

230 
	`LOCK
(
g_½c_£rv”_šfo
.
mu‹x
);

231 
UniV®ue
 
	`aùive_commªds
(UniV®ue::
VARR
);

232 cÚ¡ 
RPCCommªdExecutiÚInfo
& 
šfo
 : 
g_½c_£rv”_šfo
.
aùive_commªds
) {

233 
UniV®ue
 
	`’Œy
(UniV®ue::
VOBJ
);

234 
’Œy
.
	`pushKV
("m‘hod", 
šfo
.
m‘hod
);

235 
’Œy
.
	`pushKV
("du¿tiÚ", 
	`G‘TimeMiüos
(è- 
šfo
.
¡¬t
);

236 
aùive_commªds
.
	`push_back
(
’Œy
);

239 
UniV®ue
 
	`»suÉ
(UniV®ue::
VOBJ
);

240 
»suÉ
.
	`pushKV
("aùive_commªds", 
aùive_commªds
);

242 cÚ¡ 
¡d
::
¡ršg
 
·th
 = 
	`LogIn¡ªû
().
m_fe_·th
.
	`¡ršg
();

243 
UniV®ue
 
	`log_·th
(UniV®ue::
VSTR
, 
·th
);

244 
»suÉ
.
	`pushKV
("log·th", 
log_·th
);

246  
»suÉ
;

247 
	}
}

250 cÚ¡ 
CRPCCommªd
 
	gvRPCCommªds
[] =

254 { "cÚŒŞ", "g‘½cšfo", &
g‘½cšfo
, {} },

255 { "cÚŒŞ", "h–p", &
h–p
, {"command"} },

256 { "cÚŒŞ", "¡İ", &
¡İ
, {"wait"} },

257 { "cÚŒŞ", "u±ime", &
u±ime
, {} },

261 
	gCRPCTabË
::
	$CRPCTabË
()

263 
vcidx
;

264 
vcidx
 = 0; vcidx < ((
vRPCCommªds
) / (vRPCCommands[0])); vcidx++)

266 cÚ¡ 
CRPCCommªd
 *
pcmd
;

268 
pcmd
 = &
vRPCCommªds
[
vcidx
];

269 
m­Commªds
[
pcmd
->
Çme
].
	`push_back
(pcmd);

271 
	}
}

273 
boŞ
 
	gCRPCTabË
::
	$­³ndCommªd
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ 
CRPCCommªd
* 
pcmd
)

275 ià(
	`IsRPCRuÂšg
())

276  
çl£
;

278 
m­Commªds
[
Çme
].
	`push_back
(
pcmd
);

279  
Œue
;

280 
	}
}

282 
boŞ
 
	gCRPCTabË
::
	$»moveCommªd
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ 
CRPCCommªd
* 
pcmd
)

284 autØ
™
 = 
m­Commªds
.
	`fšd
(
Çme
);

285 ià(
™
 !ğ
m­Commªds
.
	`’d
()) {

286 autØ
Ãw_’d
 = 
¡d
::
	`»move
(
™
->
£cÚd
.
	`begš
(), it->£cÚd.
	`’d
(), 
pcmd
);

287 ià(
™
->
£cÚd
.
	`’d
(è!ğ
Ãw_’d
) {

288 
™
->
£cÚd
.
	`”a£
(
Ãw_’d
, it->£cÚd.
	`’d
());

289  
Œue
;

292  
çl£
;

293 
	}
}

295 
	$S¹RPC
()

297 
	`LogPršt
(
BCLog
::
RPC
, "Starting RPC\n");

298 
g_½c_ruÂšg
 = 
Œue
;

299 
g_½cSigÇls
.
	`S¹ed
();

300 
	}
}

302 
	$IÁ”ru±RPC
()

304 
¡d
::
Úû_æag
 
g_½c_š‹¼u±_æag
;

306 
¡d
::
	`ÿÎ_Úû
(
g_½c_š‹¼u±_æag
, []() {

307 
	`LogPršt
(
BCLog
::
RPC
, "Interrupting RPC\n");

309 
g_½c_ruÂšg
 = 
çl£
;

311 
	}
}

313 
	$StİRPC
()

315 
¡d
::
Úû_æag
 
g_½c_¡İ_æag
;

317 
	`as£¹
(!
g_½c_ruÂšg
);

318 
¡d
::
	`ÿÎ_Úû
(
g_½c_¡İ_æag
, []() {

319 
	`LogPršt
(
BCLog
::
RPC
, "Stopping RPC\n");

320 
	`WITH_LOCK
(
g_d—dlše_tim”s_mu‹x
, 
d—dlšeTim”s
.
	`ş—r
());

321 
	`D–‘eAuthCook›
();

322 
g_½cSigÇls
.
	`Stİ³d
();

324 
	}
}

326 
boŞ
 
	$IsRPCRuÂšg
()

328  
g_½c_ruÂšg
;

329 
	}
}

331 
	$RpcIÁ”ru±iÚPošt
()

333 ià(!
	`IsRPCRuÂšg
()è
throw
 
	`JSONRPCE¼Ü
(
RPC_CLIENT_NOT_CONNECTED
, "Shutting down");

334 
	}
}

336 
	$S‘RPCW¬mupStus
(cÚ¡ 
¡d
::
¡ršg
& 
ÃwStus
)

338 
	`LOCK
(
cs_½cW¬mup
);

339 
½cW¬mupStus
 = 
ÃwStus
;

340 
	}
}

342 
	$S‘RPCW¬mupFšished
()

344 
	`LOCK
(
cs_½cW¬mup
);

345 
	`as£¹
(
fRPCInW¬mup
);

346 
fRPCInW¬mup
 = 
çl£
;

347 
	}
}

349 
boŞ
 
	$RPCIsInW¬mup
(
¡d
::
¡ršg
 *
outStus
)

351 
	`LOCK
(
cs_½cW¬mup
);

352 ià(
outStus
)

353 *
outStus
 = 
½cW¬mupStus
;

354  
fRPCInW¬mup
;

355 
	}
}

357 
boŞ
 
	$IsD•»ÿ‹dRPCEÇbËd
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hod
)

359 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
’abËd_m‘hods
 = 
gArgs
.
	`G‘Args
("-deprecatedrpc");

361  
	`fšd
(
’abËd_m‘hods
.
	`begš
(),ƒÇbËd_m‘hods.
	`’d
(), 
m‘hod
) !=ƒnabled_methods.end();

362 
	}
}

364 
UniV®ue
 
	$JSONRPCExecOÃ
(
JSONRPCReque¡
 
j»q
, cÚ¡ 
UniV®ue
& 
»q
)

366 
UniV®ue
 
	`½c_»suÉ
(UniV®ue::
VOBJ
);

368 
Œy
 {

369 
j»q
.
	`·r£
(
»q
);

371 
UniV®ue
 
»suÉ
 = 
bËRPC
.
	`execu‹
(
j»q
);

372 
½c_»suÉ
 = 
	`JSONRPCR•lyObj
(
»suÉ
, 
NuÎUniV®ue
, 
j»q
.
id
);

374 
	`ÿtch
 (cÚ¡ 
UniV®ue
& 
objE¼Ü
)

376 
½c_»suÉ
 = 
	`JSONRPCR•lyObj
(
NuÎUniV®ue
, 
objE¼Ü
, 
j»q
.
id
);

378 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
)

380 
½c_»suÉ
 = 
	`JSONRPCR•lyObj
(
NuÎUniV®ue
,

381 
	`JSONRPCE¼Ü
(
RPC_PARSE_ERROR
, 
e
.
	`wh©
()), 
j»q
.
id
);

384  
½c_»suÉ
;

385 
	}
}

387 
	g¡d
::
¡ršg
 
	$JSONRPCExecB©ch
(cÚ¡ 
JSONRPCReque¡
& 
j»q
, cÚ¡ 
UniV®ue
& 
vReq
)

389 
UniV®ue
 
	`»t
(UniV®ue::
VARR
);

390 
»qIdx
 = 0;„eqIdx < 
vReq
.
	`size
();„eqIdx++)

391 
»t
.
	`push_back
(
	`JSONRPCExecOÃ
(
j»q
, 
vReq
[
»qIdx
]));

393  
»t
.
	`wr™e
() + "\n";

394 
	}
}

400 
šlše
 
JSONRPCReque¡
 
ŒªsfÜmNamedArgum’ts
(cÚ¡ JSONRPCReque¡& 
š
, cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
¬gNames
)

402 
JSONRPCReque¡
 
out
 = 
š
;

403 
	gout
.
	g·¿ms
 = 
UniV®ue
(UniV®ue::
VARR
);

406 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>& 
keys
 = 
š
.
·¿ms
.
g‘Keys
();

407 cÚ¡ 
	g¡d
::
veùÜ
<
UniV®ue
>& 
v®ues
 = 
š
.
·¿ms
.
g‘V®ues
();

408 
	g¡d
::
unÜd”ed_m­
<
¡d
::
¡ršg
, cÚ¡ 
	gUniV®ue
*> 
	g¬gsIn
;

409 
size_t
 
	gi
=0; i<
	gkeys
.
size
(); ++i) {

410 
	g¬gsIn
[
keys
[
i
]] = &
v®ues
[i];

413 
	ghŞe
 = 0;

414 cÚ¡ 
	g¡d
::
¡ršg
 &
¬gNameP©‹º
: 
¬gNames
) {

415 
¡d
::
veùÜ
<¡d::
¡ršg
> 
v¬gNames
;

416 
	gboo¡
::
®gÜ™hm
::
¥l™
(
v¬gNames
, 
¬gNameP©‹º
, 
boo¡
::®gÜ™hm::
is_ªy_of
("|"));

417 autØ
	gä
 = 
¬gsIn
.
’d
();

418 cÚ¡ 
	g¡d
::
¡ršg
 & 
¬gName
 : 
v¬gNames
) {

419 
ä
 = 
¬gsIn
.
fšd
(
¬gName
);

420 ià(
	gä
 !ğ
¬gsIn
.
’d
()) {

424 ià(
	gä
 !ğ
¬gsIn
.
’d
()) {

425 
i
 = 0; 
	gi
 < 
	ghŞe
; ++i) {

429 
	gout
.
	g·¿ms
.
push_back
(
UniV®ue
());

431 
	ghŞe
 = 0;

432 
	gout
.
	g·¿ms
.
push_back
(*
ä
->
£cÚd
);

433 
	g¬gsIn
.
”a£
(
ä
);

435 
	ghŞe
 += 1;

439 ià(!
	g¬gsIn
.
em±y
()) {

440 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "UnknowÀÇmed…¬am‘” " + 
¬gsIn
.
begš
()->
fœ¡
);

443  
	gout
;

446 
UniV®ue
 
	gCRPCTabË
::
	$execu‹
(cÚ¡ 
JSONRPCReque¡
 &
»que¡
) const

450 
	`LOCK
(
cs_½cW¬mup
);

451 ià(
fRPCInW¬mup
)

452 
throw
 
	`JSONRPCE¼Ü
(
RPC_IN_WARMUP
, 
½cW¬mupStus
);

456 autØ
™
 = 
m­Commªds
.
	`fšd
(
»que¡
.
¡rM‘hod
);

457 ià(
™
 !ğ
m­Commªds
.
	`’d
()) {

458 
UniV®ue
 
»suÉ
;

459 cÚ¡‡uto& 
commªd
 : 
™
->
£cÚd
) {

460 ià(
	`Execu‹Commªd
(*
commªd
, 
»que¡
, 
»suÉ
, &commªd =ğ&
™
->
£cÚd
.
	`back
())) {

461  
»suÉ
;

465 
throw
 
	`JSONRPCE¼Ü
(
RPC_METHOD_NOT_FOUND
, "Method‚ot found");

466 
	}
}

468 
boŞ
 
	$Execu‹Commªd
(cÚ¡ 
CRPCCommªd
& 
commªd
, cÚ¡ 
JSONRPCReque¡
& 
»que¡
, 
UniV®ue
& 
»suÉ
, 
boŞ
 
Ï¡_hªdËr
)

470 
Œy


472 
RPCCommªdExecutiÚ
 
	`executiÚ
(
»que¡
.
¡rM‘hod
);

474 ià(
»que¡
.
·¿ms
.
	`isObjeù
()) {

475  
commªd
.
	`aùÜ
(
	`ŒªsfÜmNamedArgum’ts
(
»que¡
, commªd.
¬gNames
), 
»suÉ
, 
Ï¡_hªdËr
);

477  
commªd
.
	`aùÜ
(
»que¡
, 
»suÉ
, 
Ï¡_hªdËr
);

480 
	`ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
)

482 
throw
 
	`JSONRPCE¼Ü
(
RPC_MISC_ERROR
, 
e
.
	`wh©
());

484 
	}
}

486 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
CRPCTabË
::
	$li¡Commªds
() const

488 
¡d
::
veùÜ
<¡d::
¡ršg
> 
commªdLi¡
;

489 cÚ¡‡uto& 
i
 : 
m­Commªds
è
commªdLi¡
.
	`em¶aû_back
(i.
fœ¡
);

490  
commªdLi¡
;

491 
	}
}

493 
	$RPCS‘Tim”IÁ”çûIfUn£t
(
RPCTim”IÁ”çû
 *
içû
)

495 ià(!
tim”IÁ”çû
)

496 
tim”IÁ”çû
 = 
içû
;

497 
	}
}

499 
	$RPCS‘Tim”IÁ”çû
(
RPCTim”IÁ”çû
 *
içû
)

501 
tim”IÁ”çû
 = 
içû
;

502 
	}
}

504 
	$RPCUn£tTim”IÁ”çû
(
RPCTim”IÁ”çû
 *
içû
)

506 ià(
tim”IÁ”çû
 =ğ
içû
)

507 
tim”IÁ”çû
 = 
nuÎ±r
;

508 
	}
}

510 
RPCRunL©”
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, std::
funùiÚ
<()> 
func
, 
št64_t
 
nSecÚds
)

512 ià(!
	gtim”IÁ”çû
)

513 
throw
 
JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Noimer handler„egistered for RPC");

514 
LOCK
(
g_d—dlše_tim”s_mu‹x
);

515 
	gd—dlšeTim”s
.
”a£
(
Çme
);

516 
LogPršt
(
BCLog
::
RPC
, "queuruÀoàtim” % š %˜£cÚd (usšg %s)\n", 
Çme
, 
nSecÚds
, 
tim”IÁ”çû
->
Name
());

517 
	gd—dlšeTim”s
.
em¶aû
(
Çme
, 
¡d
::
unique_±r
<
RPCTim”Ba£
>(
tim”IÁ”çû
->
NewTim”
(
func
, 
nSecÚds
*1000)));

520 
	$RPCS”Ÿliz©iÚFÏgs
()

522 
æag
 = 0;

523 ià(
gArgs
.
	`G‘Arg
("-½c£rŸlv”siÚ", 
DEFAULT_RPC_SERIALIZE_VERSION
) == 0)

524 
æag
 |ğ
SERIALIZE_TRANSACTION_NO_WITNESS
;

525  
æag
;

526 
	}
}

528 
CRPCTabË
 
	gbËRPC
;

	@server.h

6 #iâdeà
SYSCOIN_RPC_SERVER_H


7 
	#SYSCOIN_RPC_SERVER_H


	)

9 
	~<amouÁ.h
>

10 
	~<½c/»que¡.h
>

12 
	~<funùiÚ®
>

13 
	~<m­
>

14 
	~<¡dšt.h
>

15 
	~<¡ršg
>

17 
	~<univ®ue.h
>

19 cÚ¡ 
	gDEFAULT_RPC_SERIALIZE_VERSION
 = 1;

21 
şass
 
	gCRPCCommªd
;

23 
Çme¥aû
 
	gRPCS”v”


25 
OnS¹ed
(
¡d
::
funùiÚ
<()> 
¦Ù
);

26 
OnStİ³d
(
¡d
::
funùiÚ
<()> 
¦Ù
);

30 
boŞ
 
IsRPCRuÂšg
();

33 
RpcIÁ”ru±iÚPošt
();

39 
S‘RPCW¬mupStus
(cÚ¡ 
¡d
::
¡ršg
& 
ÃwStus
);

41 
S‘RPCW¬mupFšished
();

44 
boŞ
 
RPCIsInW¬mup
(
¡d
::
¡ršg
 *
outStus
);

50 şas 
	cRPCTim”Ba£


52 
	mpublic
:

53 
vœtu®
 ~
	$RPCTim”Ba£
() {}

54 
	}
};

59 şas 
	cRPCTim”IÁ”çû


61 
	mpublic
:

62 
vœtu®
 ~
	$RPCTim”IÁ”çû
() {}

64 
vœtu®
 cÚ¡ *
	`Name
() = 0;

71 
vœtu®
 
RPCTim”Ba£
* 
	`NewTim”
(
¡d
::
funùiÚ
<()>& 
func
, 
št64_t
 
mlis
) = 0;

72 
	}
};

75 
RPCS‘Tim”IÁ”çû
(
RPCTim”IÁ”çû
 *
içû
);

77 
RPCS‘Tim”IÁ”çûIfUn£t
(
RPCTim”IÁ”çû
 *
içû
);

79 
RPCUn£tTim”IÁ”çû
(
RPCTim”IÁ”çû
 *
içû
);

85 
RPCRunL©”
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, std::
funùiÚ
<()> 
func
, 
št64_t
 
nSecÚds
);

87 
	$UniV®ue
(*
	t½câ_ty³
)(cÚ¡ 
	tJSONRPCReque¡
& 
	tjsÚReque¡
);

89 şas 
	cCRPCCommªd


91 
public
:

95 
usšg
 
AùÜ
 = 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
, 
UniV®ue
& 
»suÉ
, 
boŞ
 
Ï¡_hªdËr
)>;

98 
	`CRPCCommªd
(
¡d
::
¡ršg
 
ÿ‹gÜy
, std::¡ršg 
Çme
, 
AùÜ
 
aùÜ
, std::
veùÜ
<¡d::¡ršg> 
¬gs
, 
šŒ_t
 
unique_id
)

99 : 
	`ÿ‹gÜy
(
¡d
::
	`move
(
ÿ‹gÜy
)), 
	`Çme
(¡d::move(
Çme
)), 
	`aùÜ
(¡d::move(
aùÜ
)), 
	`¬gNames
(¡d::move(
¬gs
)),

100 
	$unique_id
(
unique_id
)

105 
	`CRPCCommªd
(cÚ¡ * 
ÿ‹gÜy
, cÚ¡ * 
Çme
, 
½câ_ty³
 
â
, 
¡d
::
š™Ÿliz”_li¡
<cÚ¡ *> 
¬gs
)

106 : 
	`CRPCCommªd
(
ÿ‹gÜy
, 
Çme
,

107 [
â
](cÚ¡ 
JSONRPCReque¡
& 
»que¡
, 
UniV®ue
& 
»suÉ
, 
boŞ
è{„esuÉ = 
	`â
Ôeque¡);  
Œue
; 
	}
},

108 {
	g¬gs
.
begš
(),‡rgs.
’d
()}, 
	$šŒ_t
(
â
))

110 
	}
}

112 
	g¡d
::
¡ršg
 
ÿ‹gÜy
;

113 
	g¡d
::
¡ršg
 
Çme
;

114 
AùÜ
 
	gaùÜ
;

115 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gNames
;

116 
šŒ_t
 
	gunique_id
;

122 şas 
	cCRPCTabË


124 
	m´iv©e
:

125 
¡d
::
m­
<¡d::
¡ršg
, 
	m¡d
::
veùÜ
<cÚ¡ 
CRPCCommªd
*>> 
m­Commªds
;

126 
	mpublic
:

127 
CRPCTabË
();

128 
	m¡d
::
¡ršg
 
	$h–p
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ std::¡ršg& 
¡rSubCommªd
, cÚ¡ 
JSONRPCReque¡
& 
h–´eq
) const;

136 
UniV®ue
 
	$execu‹
(cÚ¡ 
JSONRPCReque¡
 &
»que¡
) const;

142 
¡d
::
veùÜ
<¡d::
¡ršg
> 
	$li¡Commªds
() const;

157 
boŞ
 
	`­³ndCommªd
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ 
CRPCCommªd
* 
pcmd
);

158 
boŞ
 
	`»moveCommªd
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ 
CRPCCommªd
* 
pcmd
);

161 
boŞ
 
	`IsD•»ÿ‹dRPCEÇbËd
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hod
);

163 
CRPCTabË
 
bËRPC
;

164 
	`S¹RPC
();

165 
	`IÁ”ru±RPC
();

166 
	`StİRPC
();

167 
¡d
::
¡ršg
 
	`JSONRPCExecB©ch
(cÚ¡ 
JSONRPCReque¡
& 
j»q
, cÚ¡ 
UniV®ue
& 
vReq
);

170 
	`RPCS”Ÿliz©iÚFÏgs
();

	@util.cpp

5 
	~<key_io.h
>

6 
	~<ouu‰y³.h
>

7 
	~<½c/ut.h
>

8 
	~<süt/desütÜ.h
>

9 
	~<süt/signšg´ovid”.h
>

10 
	~<tšyfÜm©.h
>

11 
	~<ut/¡»ncodšgs.h
>

12 
	~<ut/¡ršg.h
>

13 
	~<ut/Œª¦©iÚ.h
>

15 
	~<tu¶e
>

17 
	~<boo¡/®gÜ™hm/¡ršg/şassifiÿtiÚ.hµ
>

18 
	~<boo¡/®gÜ™hm/¡ršg/¥l™.hµ
>

20 
	~<m©h.h
>

21 cÚ¡ 
	g¡d
::
¡ršg
 
UNIX_EPOCH_TIME
 = "UNIXƒpochime";

23 cÚ¡ 
	g¡d
::
¡ršg
 
EXAMPLE_ADDRESS
[2] = {"sys1q09vm5lfy0j5reeulh4x5752q25uqqvz34hufdl", "sys1qtyf33aa2tl62xhrzhralpytka0krxvt0a4e8ee"};

25 
RPCTy³Check
(cÚ¡ 
UniV®ue
& 
·¿ms
,

26 cÚ¡ 
¡d
::
li¡
<
UniV®ueTy³
>& 
ty³sEx³ùed
,

27 
boŞ
 
fAÎowNuÎ
)

29 
	gi
 = 0;

30 cÚ¡ 
	gUniV®ueTy³
& 
	gt
 : 
ty³sEx³ùed
) {

31 ià(
·¿ms
.
size
(è<ğ
i
)

34 cÚ¡ 
	gUniV®ue
& 
	gv
 = 
·¿ms
[
i
];

35 ià(!(
	gfAÎowNuÎ
 && 
	gv
.
isNuÎ
())) {

36 
RPCTy³CheckArgum’t
(
v
, 
t
);

38 
	gi
++;

42 
	$RPCTy³CheckArgum’t
(cÚ¡ 
UniV®ue
& 
v®ue
, cÚ¡ 
UniV®ueTy³
& 
ty³Ex³ùed
)

44 ià(!
ty³Ex³ùed
.
ty³Any
 && 
v®ue
.
	`ty³
(è!ğty³Ex³ùed.
ty³
) {

45 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, 
	`¡½rštf
("Ex³ùedy³ %s, gÙ %s", 
	`uvTy³Name
(
ty³Ex³ùed
.
ty³
), uvTy³Name(
v®ue
.
	`ty³
())));

47 
	}
}

49 
RPCTy³CheckObj
(cÚ¡ 
UniV®ue
& 
o
,

50 cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, 
UniV®ueTy³
>& 
ty³sEx³ùed
,

51 
boŞ
 
fAÎowNuÎ
,

52 
boŞ
 
fSŒiù
)

54 cÚ¡‡uto& 
	gt
 : 
ty³sEx³ùed
) {

55 cÚ¡ 
UniV®ue
& 
v
 = 
fšd_v®ue
(
o
, 
t
.
fœ¡
);

56 ià(!
	gfAÎowNuÎ
 && 
	gv
.
isNuÎ
())

57 
throw
 
JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, 
¡½rštf
("Missšg %s", 
t
.
fœ¡
));

59 ià(!(
	gt
.
	g£cÚd
.
	gty³Any
 || 
	gv
.
ty³
(è=ğ
t
.
£cÚd
.ty³ || (
fAÎowNuÎ
 && 
v
.
isNuÎ
()))) {

60 
¡d
::
¡ršg
 
”r
 = 
¡½rštf
("Expectedype %s for %s, got %s",

61 
uvTy³Name
(
t
.
£cÚd
.
ty³
),.
fœ¡
, uvTy³Name(
v
.type()));

62 
throw
 
JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, 
”r
);

66 ià(
	gfSŒiù
)

68 cÚ¡ 
	g¡d
::
¡ršg
& 
k
 : 
o
.
g‘Keys
())

70 ià(
ty³sEx³ùed
.
couÁ
(
k
) == 0)

72 
¡d
::
¡ršg
 
”r
 = 
¡½rštf
("UÃx³ùed key %s", 
k
);

73 
throw
 
JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, 
”r
);

79 
CAmouÁ
 
	$AmouÁFromV®ue
(cÚ¡ 
UniV®ue
& 
v®ue
)

81 ià(!
v®ue
.
	`isNum
(è&& !v®ue.
	`isSŒ
())

82 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Amount is‚ot‡‚umber or string");

83 
CAmouÁ
 
amouÁ
;

84 ià(!
	`P¬£FixedPošt
(
v®ue
.
	`g‘V®SŒ
(), 8, &
amouÁ
))

85 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Invalid‡mount");

86 ià(!
	`MÚeyRªge
(
amouÁ
))

87 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Amount out of„ange");

88  
amouÁ
;

89 
	}
}

91 
ušt64_t
 
	$As£tAmouÁFromV®ue
(
UniV®ue
& 
v®ue
, 
´ecisiÚ
) {

92 if(
´ecisiÚ
 < 0 ||…recision > 8)

93 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Precision must be between 0‡nd 8");

94 ià(!
v®ue
.
	`isNum
(è&& !v®ue.
	`isSŒ
())

95 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Amount is‚ot‡‚umber or string");

96 ià(
v®ue
.
	`isSŒ
(è&& v®ue.
	`g‘_¡r
() == "-1") {

97 
v®ue
.
	`£tIÁ
((
ušt64_t
)(
MAX_ASSET
 / (()
	`pow
(10, 
´ecisiÚ
))));

99 
ušt64_t
 
amouÁ
;

100 ià(!
	`P¬£FixedPošt
(
v®ue
.
	`g‘V®SŒ
(), 
´ecisiÚ
, &
amouÁ
))

101 
throw
 
	`JSONRPCE¼Ü
(
RPC_TYPE_ERROR
, "Invalid‡mount");

102  
amouÁ
;

103 
	}
}

104 
ušt256
 
	$P¬£HashV
(cÚ¡ 
UniV®ue
& 
v
, 
¡d
::
¡ršg
 
¡rName
)

106 
¡d
::
¡ršg
 
	`¡rHex
(
v
.
	`g‘_¡r
());

107 ià(64 !ğ
¡rHex
.
	`Ëngth
())

108 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("% mu¡ boàËngth %d (nÙ %d, fÜ '%s')", 
¡rName
, 64, 
¡rHex
.
	`Ëngth
(), strHex));

109 ià(!
	`IsHex
(
¡rHex
))

110 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
¡rName
+" mu¡ bhexadecim® sŒšg (nÙ '"+
¡rHex
+"')");

111  
	`ušt256S
(
¡rHex
);

112 
	}
}

113 
ušt256
 
	$P¬£HashO
(cÚ¡ 
UniV®ue
& 
o
, 
¡d
::
¡ršg
 
¡rKey
)

115  
	`P¬£HashV
(
	`fšd_v®ue
(
o
, 
¡rKey
), strKey);

116 
	}
}

117 
	g¡d
::
veùÜ
<> 
	$P¬£HexV
(cÚ¡ 
UniV®ue
& 
v
, 
¡d
::
¡ršg
 
¡rName
)

119 
¡d
::
¡ršg
 
¡rHex
;

120 ià(
v
.
	`isSŒ
())

121 
¡rHex
 = 
v
.
	`g‘_¡r
();

122 ià(!
	`IsHex
(
¡rHex
))

123 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
¡rName
+" mu¡ bhexadecim® sŒšg (nÙ '"+
¡rHex
+"')");

124  
	`P¬£Hex
(
¡rHex
);

125 
	}
}

126 
	g¡d
::
veùÜ
<> 
	$P¬£HexO
(cÚ¡ 
UniV®ue
& 
o
, 
¡d
::
¡ršg
 
¡rKey
)

128  
	`P¬£HexV
(
	`fšd_v®ue
(
o
, 
¡rKey
), strKey);

129 
	}
}

131 
	g¡d
::
¡ršg
 
	$H–pExam¶eCli
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hodÇme
, cÚ¡ std::¡ršg& 
¬gs
)

133  "> syscoš-ş˜" + 
m‘hodÇme
 + " " + 
¬gs
 + "\n";

134 
	}
}

136 
	g¡d
::
¡ršg
 
	$H–pExam¶eRpc
(cÚ¡ 
¡d
::
¡ršg
& 
m‘hodÇme
, cÚ¡ std::¡ršg& 
¬gs
)

139 "\"m‘hod\": \"" + 
m‘hodÇme
 + "\", \"·¿ms\": [" + 
¬gs
 + "]}' -H 'content-type:ext/plain;' http://127.0.0.1:8370/\n";

140 
	}
}

143 
CPubKey
 
	$HexToPubKey
(cÚ¡ 
¡d
::
¡ršg
& 
hex_š
)

145 ià(!
	`IsHex
(
hex_š
)) {

146 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Inv®id…ubliøkey: " + 
hex_š
);

148 
CPubKey
 
	`vchPubKey
(
	`P¬£Hex
(
hex_š
));

149 ià(!
vchPubKey
.
	`IsFuÎyV®id
()) {

150 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Inv®id…ubliøkey: " + 
hex_š
);

152  
vchPubKey
;

153 
	}
}

156 
CPubKey
 
	$AddrToPubKey
(cÚ¡ 
FÏbËSignšgProvid”
& 
key¡Üe
, cÚ¡ 
¡d
::
¡ršg
& 
addr_š
)

158 
CTxDe¡š©iÚ
 
de¡
 = 
	`DecodeDe¡š©iÚ
(
addr_š
);

159 ià(!
	`IsV®idDe¡š©iÚ
(
de¡
)) {

160 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, "Inv®id‡dd»ss: " + 
addr_š
);

162 
CKeyID
 
key
 = 
	`G‘KeyFÜDe¡š©iÚ
(
key¡Üe
, 
de¡
);

163 ià(
key
.
	`IsNuÎ
()) {

164 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("% dÛ nÙ„eã¸tØ¨key", 
addr_š
));

166 
CPubKey
 
vchPubKey
;

167 ià(!
key¡Üe
.
	`G‘PubKey
(
key
, 
vchPubKey
)) {

168 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("nØfuÎ…ubliøkey fÜ‡dd»s %s", 
addr_š
));

170 ià(!
vchPubKey
.
	`IsFuÎyV®id
()) {

171 
throw
 
	`JSONRPCE¼Ü
(
RPC_INTERNAL_ERROR
, "Wallet contains‡n invalid…ublic key");

173  
vchPubKey
;

174 
	}
}

177 
CTxDe¡š©iÚ
 
AddAndG‘MuÉisigDe¡š©iÚ
(cÚ¡ 
»quœed
, cÚ¡ 
¡d
::
veùÜ
<
CPubKey
>& 
pubkeys
, 
OuutTy³
 
ty³
, 
FÏbËSignšgProvid”
& 
key¡Üe
, 
CSüt
& 
süt_out
)

180 ià(
	g»quœed
 < 1) {

181 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "a multisignature‡ddress must„equire‡t†east one keyo„edeem");

183 ià(()
	gpubkeys
.
size
(è< 
	g»quœed
) {

184 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
¡½rštf
("nÙƒnough key suµl›d (gÙ %u keys, buˆÃed‡ˆËa¡ %dØ»d“m)", 
pubkeys
.
size
(), 
»quœed
));

186 ià(
	gpubkeys
.
size
() > 16) {

187 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Number of keys involved inhe multisignature‡ddress creation > 16\nReducehe‚umber");

190 
	gsüt_out
 = 
G‘SütFÜMuÉisig
(
»quœed
, 
pubkeys
);

192 ià(
	gsüt_out
.
size
(è> 
	gMAX_SCRIPT_ELEMENT_SIZE
) {

193 
throw
 
JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, (
¡½rštf
("»d“mSüˆexûed sizlim™: %d > %d", 
süt_out
.
size
(), 
MAX_SCRIPT_ELEMENT_SIZE
)));

197 cÚ¡ 
	gCPubKey
& 
	gpk
 : 
pubkeys
) {

198 ià(!
pk
.
IsCom´es£d
()) {

199 
ty³
 = 
OuutTy³
::
LEGACY
;

205 
CTxDe¡š©iÚ
 
	gde¡
 = 
AddAndG‘De¡š©iÚFÜSüt
(
key¡Üe
, 
süt_out
, 
ty³
);

207  
	gde¡
;

210 
şass
 
	gDesüibeAdd»ssVis™Ü
 : 
public
 
boo¡
::
¡©ic_vis™Ü
<
UniV®ue
>

212 
public
:

213 
ex¶ic™
 
DesüibeAdd»ssVis™Ü
() {}

215 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
CNoDe¡š©iÚ
& 
de¡
) const

217  
UniV®ue
(UniV®ue::
VOBJ
);

220 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
	gPKHash
& 
	gkeyID
) const

222 
UniV®ue
 
obj
(UniV®ue::
VOBJ
);

223 
	gobj
.
pushKV
("issüt", 
çl£
);

224 
	gobj
.
pushKV
("isw™Ãss", 
çl£
);

225  
	gobj
;

228 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
	gSütHash
& 
	gsütID
) const

230 
UniV®ue
 
obj
(UniV®ue::
VOBJ
);

231 
	gobj
.
pushKV
("issüt", 
Œue
);

232 
	gobj
.
pushKV
("isw™Ãss", 
çl£
);

233  
	gobj
;

236 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
	gW™ÃssV0KeyHash
& 
	gid
) const

238 
UniV®ue
 
obj
(UniV®ue::
VOBJ
);

239 
	gobj
.
pushKV
("issüt", 
çl£
);

240 
	gobj
.
pushKV
("isw™Ãss", 
Œue
);

241 
	gobj
.
pushKV
("witness_version", 0);

242 
	gobj
.
pushKV
("w™Ãss_´og¿m", 
HexSŒ
(
id
.
begš
(), id.
’d
()));

243  
	gobj
;

246 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
	gW™ÃssV0SütHash
& 
	gid
) const

248 
UniV®ue
 
obj
(UniV®ue::
VOBJ
);

249 
	gobj
.
pushKV
("issüt", 
Œue
);

250 
	gobj
.
pushKV
("isw™Ãss", 
Œue
);

251 
	gobj
.
pushKV
("witness_version", 0);

252 
	gobj
.
pushKV
("w™Ãss_´og¿m", 
HexSŒ
(
id
.
begš
(), id.
’d
()));

253  
	gobj
;

256 
UniV®ue
 
İ”©Ü
()(cÚ¡ 
	gW™ÃssUnknown
& 
	gid
) const

258 
UniV®ue
 
obj
(UniV®ue::
VOBJ
);

259 
	gobj
.
pushKV
("isw™Ãss", 
Œue
);

260 
	gobj
.
pushKV
("w™Ãss_v”siÚ", ()
id
.
v”siÚ
);

261 
	gobj
.
pushKV
("w™Ãss_´og¿m", 
HexSŒ
(
id
.
´og¿m
, id.´og¿m + id.
Ëngth
));

262  
	gobj
;

266 
UniV®ue
 
	$DesüibeAdd»ss
(cÚ¡ 
CTxDe¡š©iÚ
& 
de¡
)

268  
boo¡
::
	`­¶y_vis™Ü
(
	`DesüibeAdd»ssVis™Ü
(), 
de¡
);

269 
	}
}

271 
	$P¬£CÚfœmT¬g‘
(cÚ¡ 
UniV®ue
& 
v®ue
, 
max_rg‘
)

273 
rg‘
 = 
v®ue
.
	`g‘_št
();

274 ià(
rg‘
 < 1 || (é¬g‘ > 
max_rg‘
) {

275 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, 
	`¡½rštf
("Inv®id cÚf_rg‘, mu¡ bb‘w“À%u - %u", 1, 
max_rg‘
));

277  ()
rg‘
;

278 
	}
}

280 
RPCE¼ÜCode
 
	$RPCE¼ÜFromT¿n§ùiÚE¼Ü
(
T¿n§ùiÚE¼Ü
 
‹¼
)

282 
‹¼
) {

283 
T¿n§ùiÚE¼Ü
::
MEMPOOL_REJECTED
:

284  
RPC_TRANSACTION_REJECTED
;

285 
T¿n§ùiÚE¼Ü
::
ALREADY_IN_CHAIN
:

286  
RPC_TRANSACTION_ALREADY_IN_CHAIN
;

287 
T¿n§ùiÚE¼Ü
::
P2P_DISABLED
:

288  
RPC_CLIENT_P2P_DISABLED
;

289 
T¿n§ùiÚE¼Ü
::
INVALID_PSBT
:

290 
T¿n§ùiÚE¼Ü
::
PSBT_MISMATCH
:

291  
RPC_INVALID_PARAMETER
;

292 
T¿n§ùiÚE¼Ü
::
SIGHASH_MISMATCH
:

293  
RPC_DESERIALIZATION_ERROR
;

296  
RPC_TRANSACTION_ERROR
;

297 
	}
}

299 
UniV®ue
 
	$JSONRPCT¿n§ùiÚE¼Ü
(
T¿n§ùiÚE¼Ü
 
‹¼
, cÚ¡ 
¡d
::
¡ršg
& 
”r_¡ršg
)

301 ià(
”r_¡ršg
.
	`Ëngth
() > 0) {

302  
	`JSONRPCE¼Ü
(
	`RPCE¼ÜFromT¿n§ùiÚE¼Ü
(
‹¼
), 
”r_¡ršg
);

304  
	`JSONRPCE¼Ü
(
	`RPCE¼ÜFromT¿n§ùiÚE¼Ü
(
‹¼
), 
	`T¿n§ùiÚE¼ÜSŒšg
Ñ”r).
Üigš®
);

306 
	}
}

312 
	sSeùiÚ
 {

313 
SeùiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
Ëá
, cÚ¡ std::¡ršg& 
right
)

314 : 
m_Ëá
{
Ëá
}, 
	mm_right
{
	mright
} {}

315 
	m¡d
::
¡ršg
 
m_Ëá
;

316 cÚ¡ 
	m¡d
::
¡ršg
 
m_right
;

323 
	sSeùiÚs
 {

324 
	m¡d
::
veùÜ
<
SeùiÚ
> 
m_£ùiÚs
;

325 
size_t
 
	mm_max_·d
{0};

327 
PushSeùiÚ
(cÚ¡ 
SeùiÚ
& 
s
)

329 
	mm_max_·d
 = 
¡d
::
max
(
m_max_·d
, 
s
.
m_Ëá
.
size
());

330 
	mm_£ùiÚs
.
push_back
(
s
);

336 
Push
(cÚ¡ 
RPCArg
& 
¬g
, cÚ¡ 
size_t
 
cu¼’t_šd’t
 = 5, cÚ¡ 
Ou‹rTy³
 
ou‹r_ty³
 = Ou‹rTy³::
NONE
)

338 cÚ¡‡utØ
šd’t
 = 
¡d
::
¡ršg
(
cu¼’t_šd’t
, ' ');

339 cÚ¡‡utØ
	mšd’t_Ãxt
 = 
¡d
::
¡ršg
(
cu¼’t_šd’t
 + 2, ' ');

340 cÚ¡ 
boŞ
 
	mpush_Çme
{
	mou‹r_ty³
 =ğ
Ou‹rTy³
::
OBJ
};

342 
	m¬g
.
	mm_ty³
) {

343 
	mRPCArg
::
Ty³
::
STR_HEX
:

344 
RPCArg
::
Ty³
::
STR
:

345 
RPCArg
::
Ty³
::
NUM
:

346 
RPCArg
::
Ty³
::
AMOUNT
:

347 
RPCArg
::
Ty³
::
RANGE
:

348 
RPCArg
::
Ty³
::
BOOL
: {

349 ià(
ou‹r_ty³
 =ğ
Ou‹rTy³
::
NONE
) ;

350 autØ
	mËá
 = 
šd’t
;

351 ià(
	m¬g
.
	mm_ty³_¡r
.
size
(è!ğ0 && 
push_Çme
) {

352 
Ëá
 +ğ"\"" + 
¬g
.
G‘Name
(è+ "\": " +‡rg.
m_ty³_¡r
.
©
(0);

354 
	mËá
 +ğ
push_Çme
 ? 
¬g
.
ToSŒšgObj
Ğ
çl£
è:‡rg.
ToSŒšg
( false);

356 
	mËá
 += ",";

357 
PushSeùiÚ
({
Ëá
, 
¬g
.
ToDesütiÚSŒšg
()});

360 
	mRPCArg
::
Ty³
::
OBJ
:

361 
RPCArg
::
Ty³
::
OBJ_USER_KEYS
: {

362 cÚ¡‡utØ
right
 = 
ou‹r_ty³
 =ğ
Ou‹rTy³
::
NONE
 ? "" : 
¬g
.
ToDesütiÚSŒšg
();

363 
PushSeùiÚ
({
šd’t
 + (
push_Çme
 ? "\"" + 
¬g
.
G‘Name
(è+ "\": " : ""è+ "{", 
right
});

364 cÚ¡‡uto& 
	m¬g_šÃr
 : 
¬g
.
m_šÃr
) {

365 
Push
(
¬g_šÃr
, 
cu¼’t_šd’t
 + 2, 
Ou‹rTy³
::
OBJ
);

367 ià(
	m¬g
.
	mm_ty³
 !ğ
RPCArg
::
Ty³
::
OBJ
) {

368 
PushSeùiÚ
({
šd’t_Ãxt
 + "...", ""});

370 
PushSeùiÚ
({
šd’t
 + "}" + (
ou‹r_ty³
 !ğ
Ou‹rTy³
::
NONE
 ? "," : ""), ""});

373 
	mRPCArg
::
Ty³
::
ARR
: {

374 autØ
Ëá
 = 
šd’t
;

375 
	mËá
 +ğ
push_Çme
 ? "\"" + 
¬g
.
G‘Name
() + "\": " : "";

376 
	mËá
 += "[";

377 cÚ¡‡utØ
	mright
 = 
ou‹r_ty³
 =ğ
Ou‹rTy³
::
NONE
 ? "" : 
¬g
.
ToDesütiÚSŒšg
();

378 
PushSeùiÚ
({
Ëá
, 
right
});

379 cÚ¡‡uto& 
	m¬g_šÃr
 : 
¬g
.
m_šÃr
) {

380 
Push
(
¬g_šÃr
, 
cu¼’t_šd’t
 + 2, 
Ou‹rTy³
::
ARR
);

382 
PushSeùiÚ
({
šd’t_Ãxt
 + "...", ""});

383 
PushSeùiÚ
({
šd’t
 + "]" + (
ou‹r_ty³
 !ğ
Ou‹rTy³
::
NONE
 ? "," : ""), ""});

394 
	m¡d
::
¡ršg
 
ToSŒšg
() const

396 
¡d
::
¡ršg
 
»t
;

397 cÚ¡ 
size_t
 
	m·d
 = 
m_max_·d
 + 4;

398 cÚ¡‡uto& 
	ms
 : 
m_£ùiÚs
) {

399 ià(
s
.
m_right
.
em±y
()) {

400 
»t
 +ğ
s
.
m_Ëá
;

401 
	m»t
 += "\n";

405 
	m¡d
::
¡ršg
 
Ëá
 = 
s
.
m_Ëá
;

406 
	mËá
.
»size
(
·d
, ' ');

407 
	m»t
 +ğ
Ëá
;

410 
	m¡d
::
¡ršg
 
right
;

411 
size_t
 
	mbegš
 = 0;

412 
size_t
 
	mÃw_lše_pos
 = 
s
.
m_right
.
fšd_fœ¡_of
('\n');

413 
	mŒue
) {

414 
	mright
 +ğ
s
.
m_right
.
sub¡r
(
begš
, 
Ãw_lše_pos
 - begin);

415 ià(
	mÃw_lše_pos
 =ğ
¡d
::
¡ršg
::
Åos
) {

418 
	mright
 +ğ"\n" + 
¡d
::
¡ršg
(
·d
, ' ');

419 
	mbegš
 = 
s
.
m_right
.
fšd_fœ¡_nÙ_of
(' ', 
Ãw_lše_pos
 + 1);

420 ià(
	mbegš
 =ğ
¡d
::
¡ršg
::
Åos
) {

423 
	mÃw_lše_pos
 = 
s
.
m_right
.
fšd_fœ¡_of
('\n', 
begš
 + 1);

425 
	m»t
 +ğ
right
;

426 
	m»t
 += "\n";

428  
	m»t
;

432 
	gRPCH–pMª
::
RPCH–pMª
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
desütiÚ
, std::
veùÜ
<
RPCArg
> 
¬gs
, 
RPCResuÉs
 
»suÉs
, 
RPCExam¶es
 
exam¶es
)

433 : 
m_Çme
{
¡d
::
move
(
Çme
)},

434 
	gm_desütiÚ
{
	g¡d
::
move
(
desütiÚ
)},

435 
	gm_¬gs
{
	g¡d
::
move
(
¬gs
)},

436 
	gm_»suÉs
{
	g¡d
::
move
(
»suÉs
)},

437 
	gm_exam¶es
{
	g¡d
::
move
(
exam¶es
)}

439 
¡d
::
£t
<¡d::
¡ršg
> 
Çmed_¬gs
;

440 cÚ¡‡uto& 
	g¬g
 : 
m_¬gs
) {

441 
¡d
::
veùÜ
<¡d::
¡ršg
> 
Çmes
;

442 
	gboo¡
::
¥l™
(
Çmes
, 
¬g
.
m_Çmes
, 
boo¡
::
is_ªy_of
("|"));

444 cÚ¡ 
	g¡d
::
¡ršg
& 
Çme
 : 
Çmes
) {

445 
CHECK_NONFATAL
(
Çmed_¬gs
.
š£¹
(
Çme
).
£cÚd
);

450 
	g¡d
::
¡ršg
 
RPCResuÉs
::
	$ToDesütiÚSŒšg
() const

452 
¡d
::
¡ršg
 
»suÉ
;

453 cÚ¡‡uto& 
r
 : 
m_»suÉs
) {

454 ià(
r
.
m_cÚd
.
	`em±y
()) {

455 
»suÉ
 += "\nResult:\n";

457 
»suÉ
 +ğ"\nResuÉ (" + 
r
.
m_cÚd
 + "):\n";

459 
SeùiÚs
 
£ùiÚs
;

460 
r
.
	`ToSeùiÚs
(
£ùiÚs
);

461 
»suÉ
 +ğ
£ùiÚs
.
	`ToSŒšg
();

463  
»suÉ
;

464 
	}
}

466 
	g¡d
::
¡ršg
 
RPCExam¶es
::
	$ToDesütiÚSŒšg
() const

468  
m_exam¶es
.
	`em±y
() ? m_examples : "\nExamples:\n" + m_examples;

469 
	}
}

471 
boŞ
 
	gRPCH–pMª
::
	$IsV®idNumArgs
(
size_t
 
num_¬gs
) const

473 
size_t
 
num_»quœed_¬gs
 = 0;

474 
size_t
 
n
 = 
m_¬gs
.
	`size
();‚ > 0; --n) {

475 ià(!
m_¬gs
.
	`©
(
n
 - 1).
	`IsO±iÚ®
()) {

476 
num_»quœed_¬gs
 = 
n
;

480  
num_»quœed_¬gs
 <ğ
num_¬gs
 &&‚um_¬g <ğ
m_¬gs
.
	`size
();

481 
	}
}

482 
	g¡d
::
¡ršg
 
RPCH–pMª
::
	$ToSŒšg
() const

484 
¡d
::
¡ršg
 
»t
;

487 
»t
 +ğ
m_Çme
;

488 
boŞ
 
was_İtiÚ®
{
çl£
};

489 cÚ¡‡uto& 
¬g
 : 
m_¬gs
) {

490 cÚ¡ 
boŞ
 
İtiÚ®
 = 
¬g
.
	`IsO±iÚ®
();

491 
»t
 += " ";

492 ià(
İtiÚ®
) {

493 ià(!
was_İtiÚ®
è
»t
 += "( ";

494 
was_İtiÚ®
 = 
Œue
;

496 ià(
was_İtiÚ®
è
»t
 += ") ";

497 
was_İtiÚ®
 = 
çl£
;

499 
»t
 +ğ
¬g
.
	`ToSŒšg
Ğ
Œue
);

501 ià(
was_İtiÚ®
è
»t
 += " )";

502 
»t
 += "\n";

505 
»t
 +ğ
m_desütiÚ
;

508 
SeùiÚs
 
£ùiÚs
;

509 
size_t
 
i
{0}; i < 
m_¬gs
.
	`size
(); ++i) {

510 cÚ¡‡uto& 
¬g
 = 
m_¬gs
.
	`©
(
i
);

512 ià(
i
 =ğ0è
»t
 += "\nArguments:\n";

515 
£ùiÚs
.
m_£ùiÚs
.
	`em¶aû_back
(::
	`ToSŒšg
(
i
 + 1è+ ". " + 
¬g
.
	`G‘Fœ¡Name
(),‡rg.
	`ToDesütiÚSŒšg
());

516 
£ùiÚs
.
m_max_·d
 = 
¡d
::
	`max
(£ùiÚs.m_max_·d, seùiÚs.
m_£ùiÚs
.
	`back
().
m_Ëá
.
	`size
());

519 
£ùiÚs
.
	`Push
(
¬g
);

521 
»t
 +ğ
£ùiÚs
.
	`ToSŒšg
();

524 
»t
 +ğ
m_»suÉs
.
	`ToDesütiÚSŒšg
();

527 
»t
 +ğ
m_exam¶es
.
	`ToDesütiÚSŒšg
();

529  
»t
;

530 
	}
}

532 
	g¡d
::
¡ršg
 
RPCArg
::
	$G‘Fœ¡Name
() const

534  
m_Çmes
.
	`sub¡r
(0, m_Çmes.
	`fšd
("|"));

535 
	}
}

537 
	g¡d
::
¡ršg
 
RPCArg
::
	$G‘Name
() const

539 
	`CHECK_NONFATAL
(
¡d
::
¡ršg
::
Åos
 =ğ
m_Çmes
.
	`fšd
("|"));

540  
m_Çmes
;

541 
	}
}

543 
boŞ
 
	gRPCArg
::
	$IsO±iÚ®
() const

545 ià(
m_çÎback
.
	`which
() == 1) {

546  
Œue
;

548  
RPCArg
::
O±iÚ®
::
NO
 !ğ
boo¡
::
g‘
<RPCArg::O±iÚ®>(
m_çÎback
);

550 
	}
}

552 
	g¡d
::
¡ršg
 
RPCArg
::
	$ToDesütiÚSŒšg
() const

554 
¡d
::
¡ršg
 
»t
;

555 
»t
 += "(";

556 ià(
m_ty³_¡r
.
	`size
() != 0) {

557 
»t
 +ğ
m_ty³_¡r
.
	`©
(1);

559 
m_ty³
) {

560 
Ty³
::
STR_HEX
:

561 
Ty³
::
STR
: {

562 
»t
 += "string";

565 
Ty³
::
NUM
: {

566 
»t
 += "numeric";

569 
Ty³
::
AMOUNT
: {

570 
»t
 += "numeric or string";

573 
Ty³
::
RANGE
: {

574 
»t
 += "numeric or‡rray";

577 
Ty³
::
BOOL
: {

578 
»t
 += "boolean";

581 
Ty³
::
OBJ
:

582 
Ty³
::
OBJ_USER_KEYS
: {

583 
»t
 += "json object";

586 
Ty³
::
ARR
: {

587 
»t
 += "json‡rray";

594 ià(
m_çÎback
.
	`which
() == 1) {

595 
»t
 +ğ", o±iÚ®, deçuÉ=" + 
boo¡
::
g‘
<
¡d
::
¡ršg
>(
m_çÎback
);

597 
boo¡
::
g‘
<
RPCArg
::
O±iÚ®
>(
m_çÎback
)) {

598 
RPCArg
::
O±iÚ®
::
OMITTED
: {

602 
RPCArg
::
O±iÚ®
::
OMITTED_NAMED_ARG
: {

603 
»t
 += ", optional";

606 
RPCArg
::
O±iÚ®
::
NO
: {

607 
»t
 += ",„equired";

614 
»t
 += ")";

615 
»t
 +ğ
m_desütiÚ
.
	`em±y
() ? "" : " " + m_description;

616  
»t
;

617 
	}
}

619 
	gRPCResuÉ
::
	$ToSeùiÚs
(
SeùiÚs
& 
£ùiÚs
, cÚ¡ 
Ou‹rTy³
 
ou‹r_ty³
, cÚ¡ 
cu¼’t_šd’t
) const

622 cÚ¡ 
¡d
::
¡ršg
 
	`šd’t
(
cu¼’t_šd’t
, ' ');

623 cÚ¡ 
¡d
::
¡ršg
 
	`šd’t_Ãxt
(
cu¼’t_šd’t
 + 2, ' ');

626 cÚ¡ 
¡d
::
¡ršg
 
maybe_£·¿tÜ
{
ou‹r_ty³
 !ğ
Ou‹rTy³
::
NONE
 ? "," : ""};

629 cÚ¡ 
¡d
::
¡ršg
 
maybe_key
{

630 
ou‹r_ty³
 =ğ
Ou‹rTy³
::
OBJ
 ?

631 "\"" + 
this
->
m_key_Çme
 + "\" : " :

635 cÚ¡‡utØ
DesütiÚ
 = [&](cÚ¡ 
¡d
::
¡ršg
& 
ty³
) {

636  "(" + 
ty³
 + (
this
->
m_İtiÚ®
 ? ", optional" : "") + ")" +

637 (
this
->
m_desütiÚ
.
	`em±y
() ? "" : " " +his->m_description);

640 
m_ty³
) {

641 
Ty³
::
ELISION
: {

643 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + "..." + 
maybe_£·¿tÜ
, 
m_desütiÚ
});

646 
Ty³
::
NONE
: {

647 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + "nuÎ" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("json‚ull")});

650 
Ty³
::
STR
: {

651 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "\"¡r\"" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("string")});

654 
Ty³
::
STR_AMOUNT
: {

655 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "n" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("numeric")});

658 
Ty³
::
STR_HEX
: {

659 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "\"hex\"" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("string")});

662 
Ty³
::
NUM
: {

663 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "n" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("numeric")});

666 
Ty³
::
NUM_TIME
: {

667 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "xxx" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("numeric")});

670 
Ty³
::
BOOL
: {

671 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "Œue|çl£" + 
maybe_£·¿tÜ
, 
	`DesütiÚ
("boolean")});

674 
Ty³
::
ARR_FIXED
:

675 
Ty³
::
ARR
: {

676 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "[", 
	`DesütiÚ
("json‡rray")});

677 cÚ¡‡uto& 
i
 : 
m_šÃr
) {

678 
i
.
	`ToSeùiÚs
(
£ùiÚs
, 
Ou‹rTy³
::
ARR
, 
cu¼’t_šd’t
 + 2);

680 
	`CHECK_NONFATAL
(!
m_šÃr
.
	`em±y
());

681 ià(
m_ty³
 =ğ
Ty³
::
ARR
 && 
m_šÃr
.
	`back
().m_ty³ !ğTy³::
ELISION
) {

682 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t_Ãxt
 + "...", ""});

685 
£ùiÚs
.
m_£ùiÚs
.
	`back
().
m_Ëá
.
	`pİ_back
();

687 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + "]" + 
maybe_£·¿tÜ
, ""});

690 
Ty³
::
OBJ_DYN
:

691 
Ty³
::
OBJ
: {

692 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + 
maybe_key
 + "{", 
	`DesütiÚ
("json object")});

693 cÚ¡‡uto& 
i
 : 
m_šÃr
) {

694 
i
.
	`ToSeùiÚs
(
£ùiÚs
, 
Ou‹rTy³
::
OBJ
, 
cu¼’t_šd’t
 + 2);

696 
	`CHECK_NONFATAL
(!
m_šÃr
.
	`em±y
());

697 ià(
m_ty³
 =ğ
Ty³
::
OBJ_DYN
 && 
m_šÃr
.
	`back
().m_ty³ !ğTy³::
ELISION
) {

699 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t_Ãxt
 + "...", ""});

702 
£ùiÚs
.
m_£ùiÚs
.
	`back
().
m_Ëá
.
	`pİ_back
();

704 
£ùiÚs
.
	`PushSeùiÚ
({
šd’t
 + "}" + 
maybe_£·¿tÜ
, ""});

711 
	`CHECK_NONFATAL
(
çl£
);

712 
	}
}

714 
	g¡d
::
¡ršg
 
RPCArg
::
	$ToSŒšgObj
(cÚ¡ 
boŞ
 
Ú–še
) const

716 
¡d
::
¡ršg
 
»s
;

717 
»s
 += "\"";

718 
»s
 +ğ
	`G‘Fœ¡Name
();

719 ià(
Ú–še
) {

720 
»s
 += "\":";

722 
»s
 += "\": ";

724 
m_ty³
) {

725 
Ty³
::
STR
:

726  
»s
 + "\"str\"";

727 
Ty³
::
STR_HEX
:

728  
»s
 + "\"hex\"";

729 
Ty³
::
NUM
:

730  
»s
 + "n";

731 
Ty³
::
RANGE
:

732  
»s
 + "n or [n,n]";

733 
Ty³
::
AMOUNT
:

734  
»s
 + "amount";

735 
Ty³
::
BOOL
:

736  
»s
 + "bool";

737 
Ty³
::
ARR
:

738 
»s
 += "[";

739 cÚ¡‡uto& 
i
 : 
m_šÃr
) {

740 
»s
 +ğ
i
.
	`ToSŒšg
(
Ú–še
) + ",";

742  
»s
 + "...]";

743 
Ty³
::
OBJ
:

744 
Ty³
::
OBJ_USER_KEYS
:

746 
	`CHECK_NONFATAL
(
çl£
);

750 
	`CHECK_NONFATAL
(
çl£
);

751 
	}
}

753 
	g¡d
::
¡ršg
 
RPCArg
::
	$ToSŒšg
(cÚ¡ 
boŞ
 
Ú–še
) const

755 ià(
Ú–še
 && !
m_Ú–še_desütiÚ
.
	`em±y
())  m_oneline_description;

757 
m_ty³
) {

758 
Ty³
::
STR_HEX
:

759 
Ty³
::
STR
: {

760  "\"" + 
	`G‘Fœ¡Name
() + "\"";

762 
Ty³
::
NUM
:

763 
Ty³
::
RANGE
:

764 
Ty³
::
AMOUNT
:

765 
Ty³
::
BOOL
: {

766  
	`G‘Fœ¡Name
();

768 
Ty³
::
OBJ
:

769 
Ty³
::
OBJ_USER_KEYS
: {

770 cÚ¡ 
¡d
::
¡ršg
 
»s
 = 
	`Još
(
m_šÃr
, ",", [&](cÚ¡ 
RPCArg
& 
i
è{  i.
	`ToSŒšgObj
(
Ú–še
); });

771 ià(
m_ty³
 =ğ
Ty³
::
OBJ
) {

772  "{" + 
»s
 + "}";

774  "{" + 
»s
 + ",...}";

777 
Ty³
::
ARR
: {

778 
¡d
::
¡ršg
 
»s
;

779 cÚ¡‡uto& 
i
 : 
m_šÃr
) {

780 
»s
 +ğ
i
.
	`ToSŒšg
(
Ú–še
) + ",";

782  "[" + 
»s
 + "...]";

787 
	`CHECK_NONFATAL
(
çl£
);

788 
	}
}

790 
	g¡d
::
·œ
<
št64_t
, 
	gšt64_t
> 
	$P¬£Rªge
(cÚ¡ 
UniV®ue
& 
v®ue
)

792 ià(
v®ue
.
	`isNum
()) {

793  {0, 
v®ue
.
	`g‘_št64
()};

795 ià(
v®ue
.
	`isA¼ay
(è&& v®ue.
	`size
(è=ğ2 && v®ue[0].
	`isNum
() && value[1].isNum()) {

796 
št64_t
 
low
 = 
v®ue
[0].
	`g‘_št64
();

797 
št64_t
 
high
 = 
v®ue
[1].
	`g‘_št64
();

798 ià(
low
 > 
high
è
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range specified‡s [begin,end] must‚ot have begin‡fterƒnd");

799  {
low
, 
high
};

801 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range must be specified‡sƒnd or‡s [begin,end]");

802 
	}
}

804 
	g¡d
::
·œ
<
št64_t
, 
	gšt64_t
> 
	$P¬£DesütÜRªge
(cÚ¡ 
UniV®ue
& 
v®ue
)

806 
št64_t
 
low
, 
high
;

807 
¡d
::
	`t›
(
low
, 
high
èğ
	`P¬£Rªge
(
v®ue
);

808 ià(
low
 < 0) {

809 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range should be greater orƒqualhan 0");

811 ià((
high
 >> 31) != 0) {

812 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "End of„ange isoo high");

814 ià(
high
 >ğ
low
 + 1000000) {

815 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Range isoo†arge");

817  {
low
, 
high
};

818 
	}
}

820 
	g¡d
::
veùÜ
<
CSüt
> 
	$Ev®DesütÜSŒšgOrObjeù
(cÚ¡ 
UniV®ue
& 
sÿnobjeù
, 
FÏtSignšgProvid”
& 
´ovid”
)

822 
¡d
::
¡ršg
 
desc_¡r
;

823 
¡d
::
·œ
<
št64_t
, iÁ64_t> 
¿nge
 = {0, 1000};

824 ià(
sÿnobjeù
.
	`isSŒ
()) {

825 
desc_¡r
 = 
sÿnobjeù
.
	`g‘_¡r
();

826 } ià(
sÿnobjeù
.
	`isObjeù
()) {

827 
UniV®ue
 
desc_uni
 = 
	`fšd_v®ue
(
sÿnobjeù
, "desc");

828 ià(
desc_uni
.
	`isNuÎ
()è
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Descriptor‚eedso be…rovided in scan object");

829 
desc_¡r
 = 
desc_uni
.
	`g‘_¡r
();

830 
UniV®ue
 
¿nge_uni
 = 
	`fšd_v®ue
(
sÿnobjeù
, "range");

831 ià(!
¿nge_uni
.
	`isNuÎ
()) {

832 
¿nge
 = 
	`P¬£DesütÜRªge
(
¿nge_uni
);

835 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_PARAMETER
, "Scan object‚eedso beƒither‡ string or‡n object");

838 
¡d
::
¡ršg
 
”rÜ
;

839 autØ
desc
 = 
	`P¬£
(
desc_¡r
, 
´ovid”
, 
”rÜ
);

840 ià(!
desc
) {

841 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
”rÜ
);

843 ià(!
desc
->
	`IsRªge
()) {

844 
¿nge
.
fœ¡
 = 0;

845 
¿nge
.
£cÚd
 = 0;

847 
¡d
::
veùÜ
<
CSüt
> 
»t
;

848 
i
 = 
¿nge
.
fœ¡
; i <ğ¿nge.
£cÚd
; ++i) {

849 
¡d
::
veùÜ
<
CSüt
> 
süts
;

850 ià(!
desc
->
	`Ex·nd
(
i
, 
´ovid”
, 
süts
,…rovider)) {

851 
throw
 
	`JSONRPCE¼Ü
(
RPC_INVALID_ADDRESS_OR_KEY
, 
	`¡½rštf
("CªnÙ d”ivsüˆw™houˆ´iv©keys: '%s'", 
desc_¡r
));

853 
¡d
::
	`move
(
süts
.
	`begš
(), süts.
	`’d
(), std::
	`back_š£¹”
(
»t
));

855  
»t
;

856 
	}
}

858 
UniV®ue
 
	$G‘S”viûsNames
(
S”viûFÏgs
 
£rviûs
)

860 
UniV®ue
 
	`£rviûsNames
(UniV®ue::
VARR
);

862 cÚ¡‡uto& 
æag
 : 
	`£rviûFÏgsToSŒ
(
£rviûs
)) {

863 
£rviûsNames
.
	`push_back
(
æag
);

866  
£rviûsNames
;

867 
	}
}

	@util.h

5 #iâdeà
SYSCOIN_RPC_UTIL_H


6 
	#SYSCOIN_RPC_UTIL_H


	)

8 
	~<node/Œª§ùiÚ.h
>

9 
	~<ouu‰y³.h
>

10 
	~<´ÙocŞ.h
>

11 
	~<pubkey.h
>

12 
	~<½c/´ÙocŞ.h
>

13 
	~<½c/»que¡.h
>

14 
	~<süt/süt.h
>

15 
	~<süt/sign.h
>

16 
	~<süt/¡ªd¬d.h
>

17 
	~<univ®ue.h
>

18 
	~<ut/check.h
>

20 
	~<¡ršg
>

21 
	~<veùÜ
>

23 
	~<boo¡/v¬ŸÁ.hµ
>

29 cÚ¡ 
¡d
::
¡ršg
 
UNIX_EPOCH_TIME
;

35 cÚ¡ 
¡d
::
¡ršg
 
EXAMPLE_ADDRESS
[2];

37 
şass
 
	gFÏbËSignšgProvid”
;

38 
şass
 
	gCPubKey
;

39 
şass
 
	gCSüt
;

40 
	gSeùiÚs
;

44 
	sUniV®ueTy³
 {

45 
UniV®ueTy³
(
UniV®ue
::
VTy³
 
_ty³
è: 
ty³Any
(
çl£
), 
ty³
(_type) {}

46 
UniV®ueTy³
(è: 
ty³Any
(
Œue
) {}

47 
boŞ
 
ty³Any
;

48 
	mUniV®ue
::
VTy³
 
ty³
;

55 
RPCTy³Check
(cÚ¡ 
UniV®ue
& 
·¿ms
,

56 cÚ¡ 
¡d
::
li¡
<
UniV®ueTy³
>& 
ty³sEx³ùed
, 
boŞ
 
fAÎowNuÎ
=
çl£
);

61 
RPCTy³CheckArgum’t
(cÚ¡ 
UniV®ue
& 
v®ue
, cÚ¡ 
UniV®ueTy³
& 
ty³Ex³ùed
);

66 
RPCTy³CheckObj
(cÚ¡ 
UniV®ue
& 
o
,

67 cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, 
UniV®ueTy³
>& 
ty³sEx³ùed
,

68 
boŞ
 
fAÎowNuÎ
 = 
çl£
,

69 
boŞ
 
fSŒiù
 = 
çl£
);

75 
ušt256
 
P¬£HashV
(cÚ¡ 
UniV®ue
& 
v
, 
¡d
::
¡ršg
 
¡rName
);

76 
ušt256
 
P¬£HashO
(cÚ¡ 
UniV®ue
& 
o
, 
¡d
::
¡ršg
 
¡rKey
);

77 
¡d
::
veùÜ
<> 
P¬£HexV
(cÚ¡ 
UniV®ue
& 
v
, std::
¡ršg
 
¡rName
);

78 
¡d
::
veùÜ
<> 
P¬£HexO
(cÚ¡ 
UniV®ue
& 
o
, std::
¡ršg
 
¡rKey
);

80 
CAmouÁ
 
AmouÁFromV®ue
(cÚ¡ 
UniV®ue
& 
v®ue
);

82 
ušt64_t
 
As£tAmouÁFromV®ue
(
UniV®ue
& 
v®ue
, 
´ecisiÚ
);

83 
¡d
::
¡ršg
 
H–pExam¶eCli
(cÚ¡ std::¡ršg& 
m‘hodÇme
, cÚ¡ std::¡ršg& 
¬gs
);

84 
¡d
::
¡ršg
 
H–pExam¶eRpc
(cÚ¡ std::¡ršg& 
m‘hodÇme
, cÚ¡ std::¡ršg& 
¬gs
);

86 
CPubKey
 
HexToPubKey
(cÚ¡ 
¡d
::
¡ršg
& 
hex_š
);

87 
CPubKey
 
AddrToPubKey
(cÚ¡ 
FÏbËSignšgProvid”
& 
key¡Üe
, cÚ¡ 
¡d
::
¡ršg
& 
addr_š
);

88 
CTxDe¡š©iÚ
 
AddAndG‘MuÉisigDe¡š©iÚ
(cÚ¡ 
»quœed
, cÚ¡ 
¡d
::
veùÜ
<
CPubKey
>& 
pubkeys
, 
OuutTy³
 
ty³
, 
FÏbËSignšgProvid”
& 
key¡Üe
, 
CSüt
& 
süt_out
);

90 
UniV®ue
 
DesüibeAdd»ss
(cÚ¡ 
CTxDe¡š©iÚ
& 
de¡
);

93 
P¬£CÚfœmT¬g‘
(cÚ¡ 
UniV®ue
& 
v®ue
, 
max_rg‘
);

95 
RPCE¼ÜCode
 
RPCE¼ÜFromT¿n§ùiÚE¼Ü
(
T¿n§ùiÚE¼Ü
 
‹¼
);

96 
UniV®ue
 
JSONRPCT¿n§ùiÚE¼Ü
(
T¿n§ùiÚE¼Ü
 
‹¼
, cÚ¡ 
¡d
::
¡ršg
& 
”r_¡ršg
 = "");

99 
	g¡d
::
·œ
<
št64_t
, 
	gšt64_t
> 
P¬£DesütÜRªge
(cÚ¡ 
UniV®ue
& 
v®ue
);

102 
	g¡d
::
veùÜ
<
CSüt
> 
Ev®DesütÜSŒšgOrObjeù
(cÚ¡ 
UniV®ue
& 
sÿnobjeù
, 
FÏtSignšgProvid”
& 
´ovid”
);

105 
UniV®ue
 
G‘S”viûsNames
(
S”viûFÏgs
 
£rviûs
);

111 şas 
	cOu‹rTy³
 {

112 
	mARR
,

113 
	mOBJ
,

114 
	mNONE
,

117 
	sRPCArg
 {

118 şas 
	cTy³
 {

119 
	mOBJ
,

120 
	mARR
,

121 
	mSTR
,

122 
	mNUM
,

123 
	mBOOL
,

124 
	mOBJ_USER_KEYS
,

125 
	mAMOUNT
,

126 
	mSTR_HEX
,

127 
	mRANGE
,

130 şas 
	cO±iÚ®
 {

132 
	gNO
,

137 
	gOMITTED_NAMED_ARG
,

144 
	gOMITTED
,

146 
usšg
 
	gF®lback
 = 
boo¡
::
v¬ŸÁ
<
O±iÚ®
, 
	g¡d
::
¡ršg
>;

147 cÚ¡ 
	g¡d
::
¡ršg
 
m_Çmes
;

148 cÚ¡ 
Ty³
 
	gm_ty³
;

149 cÚ¡ 
	g¡d
::
veùÜ
<
RPCArg
> 
m_šÃr
;

150 cÚ¡ 
F®lback
 
	gm_çÎback
;

151 cÚ¡ 
	g¡d
::
¡ršg
 
m_desütiÚ
;

152 cÚ¡ 
	g¡d
::
¡ršg
 
m_Ú–še_desütiÚ
;

153 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
m_ty³_¡r
;

155 
RPCArg
(

156 cÚ¡ 
¡d
::
¡ršg
 
Çme
,

157 cÚ¡ 
Ty³
 
ty³
,

158 cÚ¡ 
F®lback
 
çÎback
,

159 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

160 cÚ¡ 
¡d
::
¡ršg
 
Ú–še_desütiÚ
 = "",

161 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
ty³_¡r
 = {})

162 : 
m_Çmes
{
¡d
::
move
(
Çme
)},

163 
	gm_ty³
{
	g¡d
::
move
(
ty³
)},

164 
	gm_çÎback
{
	g¡d
::
move
(
çÎback
)},

165 
	gm_desütiÚ
{
	g¡d
::
move
(
desütiÚ
)},

166 
	gm_Ú–še_desütiÚ
{
	g¡d
::
move
(
Ú–še_desütiÚ
)},

167 
	gm_ty³_¡r
{
	g¡d
::
move
(
ty³_¡r
)}

169 
CHECK_NONFATAL
(
ty³
 !ğ
Ty³
::
ARR
 &&y³ !ğTy³::
OBJ
);

172 
RPCArg
(

173 cÚ¡ 
¡d
::
¡ršg
 
Çme
,

174 cÚ¡ 
Ty³
 
ty³
,

175 cÚ¡ 
F®lback
 
çÎback
,

176 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

177 cÚ¡ 
¡d
::
veùÜ
<
RPCArg
> 
šÃr
,

178 cÚ¡ 
¡d
::
¡ršg
 
Ú–še_desütiÚ
 = "",

179 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
ty³_¡r
 = {})

180 : 
m_Çmes
{
¡d
::
move
(
Çme
)},

181 
	gm_ty³
{
	g¡d
::
move
(
ty³
)},

182 
	gm_šÃr
{
	g¡d
::
move
(
šÃr
)},

183 
	gm_çÎback
{
	g¡d
::
move
(
çÎback
)},

184 
	gm_desütiÚ
{
	g¡d
::
move
(
desütiÚ
)},

185 
	gm_Ú–še_desütiÚ
{
	g¡d
::
move
(
Ú–še_desütiÚ
)},

186 
	gm_ty³_¡r
{
	g¡d
::
move
(
ty³_¡r
)}

188 
CHECK_NONFATAL
(
ty³
 =ğ
Ty³
::
ARR
 ||y³ =ğTy³::
OBJ
);

191 
boŞ
 
	$IsO±iÚ®
() const;

194 
¡d
::
¡ršg
 
	$G‘Fœ¡Name
() const;

197 
¡d
::
¡ršg
 
	$G‘Name
() const;

203 
¡d
::
¡ršg
 
	$ToSŒšg
(
boŞ
 
Ú–še
) const;

208 
¡d
::
¡ršg
 
	$ToSŒšgObj
(
boŞ
 
Ú–še
) const;

213 
¡d
::
¡ršg
 
	$ToDesütiÚSŒšg
() const;

214 
	}
};

216 
	sRPCResuÉ
 {

217 şas 
	cTy³
 {

218 
	mOBJ
,

219 
	mARR
,

220 
	mSTR
,

221 
	mNUM
,

222 
	mBOOL
,

223 
	mNONE
,

224 
	mSTR_AMOUNT
,

225 
	mSTR_HEX
,

226 
	mOBJ_DYN
,

227 
	mARR_FIXED
,

228 
	mNUM_TIME
,

229 
	mELISION
,

232 cÚ¡ 
Ty³
 
	gm_ty³
;

233 cÚ¡ 
	g¡d
::
¡ršg
 
m_key_Çme
;

234 cÚ¡ 
	g¡d
::
veùÜ
<
RPCResuÉ
> 
m_šÃr
;

235 cÚ¡ 
boŞ
 
	gm_İtiÚ®
;

236 cÚ¡ 
	g¡d
::
¡ršg
 
m_desütiÚ
;

237 cÚ¡ 
	g¡d
::
¡ršg
 
m_cÚd
;

239 
RPCResuÉ
(

240 cÚ¡ 
¡d
::
¡ršg
 
cÚd
,

241 cÚ¡ 
Ty³
 
ty³
,

242 cÚ¡ 
¡d
::
¡ršg
 
m_key_Çme
,

243 cÚ¡ 
boŞ
 
İtiÚ®
,

244 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

245 cÚ¡ 
¡d
::
veùÜ
<
RPCResuÉ
> 
šÃr
 = {})

246 : 
m_ty³
{
¡d
::
move
(
ty³
)},

247 
	gm_key_Çme
{
	g¡d
::
move
(
m_key_Çme
)},

248 
	gm_šÃr
{
	g¡d
::
move
(
šÃr
)},

249 
	gm_İtiÚ®
{
	gİtiÚ®
},

250 
	gm_desütiÚ
{
	g¡d
::
move
(
desütiÚ
)},

251 
	gm_cÚd
{
	g¡d
::
move
(
cÚd
)}

253 
CHECK_NONFATAL
(!
m_cÚd
.
em±y
());

254 cÚ¡ 
boŞ
 
	gšÃr_Ãeded
{
	gty³
 =ğ
Ty³
::
ARR
 || 
ty³
 =ğTy³::
ARR_FIXED
 ||y³ =ğTy³::
OBJ
 ||y³ =ğTy³::
OBJ_DYN
};

255 
CHECK_NONFATAL
(
šÃr_Ãeded
 !ğ
šÃr
.
em±y
());

258 
RPCResuÉ
(

259 cÚ¡ 
¡d
::
¡ršg
 
cÚd
,

260 cÚ¡ 
Ty³
 
ty³
,

261 cÚ¡ 
¡d
::
¡ršg
 
m_key_Çme
,

262 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

263 cÚ¡ 
¡d
::
veùÜ
<
RPCResuÉ
> 
šÃr
 = {})

264 : 
RPCResuÉ
{
cÚd
, 
ty³
, 
m_key_Çme
, 
çl£
, 
desütiÚ
, 
šÃr
} {}

266 
RPCResuÉ
(

267 cÚ¡ 
Ty³
 
ty³
,

268 cÚ¡ 
¡d
::
¡ršg
 
m_key_Çme
,

269 cÚ¡ 
boŞ
 
İtiÚ®
,

270 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

271 cÚ¡ 
¡d
::
veùÜ
<
RPCResuÉ
> 
šÃr
 = {})

272 : 
m_ty³
{
¡d
::
move
(
ty³
)},

273 
	gm_key_Çme
{
	g¡d
::
move
(
m_key_Çme
)},

274 
	gm_šÃr
{
	g¡d
::
move
(
šÃr
)},

275 
	gm_İtiÚ®
{
	gİtiÚ®
},

276 
	gm_desütiÚ
{
	g¡d
::
move
(
desütiÚ
)},

277 
	gm_cÚd
{}

279 cÚ¡ 
boŞ
 
	gšÃr_Ãeded
{
	gty³
 =ğ
Ty³
::
ARR
 || 
ty³
 =ğTy³::
ARR_FIXED
 ||y³ =ğTy³::
OBJ
 ||y³ =ğTy³::
OBJ_DYN
};

280 
CHECK_NONFATAL
(
šÃr_Ãeded
 !ğ
šÃr
.
em±y
());

283 
RPCResuÉ
(

284 cÚ¡ 
Ty³
 
ty³
,

285 cÚ¡ 
¡d
::
¡ršg
 
m_key_Çme
,

286 cÚ¡ 
¡d
::
¡ršg
 
desütiÚ
,

287 cÚ¡ 
¡d
::
veùÜ
<
RPCResuÉ
> 
šÃr
 = {})

288 : 
RPCResuÉ
{
ty³
, 
m_key_Çme
, 
çl£
, 
desütiÚ
, 
šÃr
} {}

291 
	$ToSeùiÚs
(
SeùiÚs
& 
£ùiÚs
, 
Ou‹rTy³
 
ou‹r_ty³
 = Ou‹rTy³::
NONE
, cÚ¡ 
cu¼’t_šd’t
 = 0) const;

293 
¡d
::
¡ršg
 
	$ToSŒšgObj
() const;

295 
¡d
::
¡ršg
 
	$ToDesütiÚSŒšg
() const;

296 
	}
};

298 
	sRPCResuÉs
 {

299 cÚ¡ 
	m¡d
::
veùÜ
<
RPCResuÉ
> 
m_»suÉs
;

301 
RPCResuÉs
(
RPCResuÉ
 
»suÉ
)

302 : 
m_»suÉs
{{
»suÉ
}}

306 
RPCResuÉs
(
¡d
::
š™Ÿliz”_li¡
<
RPCResuÉ
> 
»suÉs
)

307 : 
m_»suÉs
{
»suÉs
}

314 
¡d
::
¡ršg
 
ToDesütiÚSŒšg
() const;

317 
	sRPCExam¶es
 {

318 cÚ¡ 
	m¡d
::
¡ršg
 
m_exam¶es
;

319 
ex¶ic™
 
RPCExam¶es
(

320 
¡d
::
¡ršg
 
exam¶es
)

321 : 
m_exam¶es
(
¡d
::
move
(
exam¶es
))

324 
¡d
::
¡ršg
 
ToDesütiÚSŒšg
() const;

327 şas 
	cRPCH–pMª


329 
	mpublic
:

330 
RPCH–pMª
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
desütiÚ
, std::
veùÜ
<
RPCArg
> 
¬gs
, 
RPCResuÉs
 
»suÉs
, 
RPCExam¶es
 
exam¶es
);

332 
	m¡d
::
¡ršg
 
	$ToSŒšg
() const;

334 
boŞ
 
	$IsV®idNumArgs
(
size_t
 
num_¬gs
) const;

339 
šlše
 
	$Check
(cÚ¡ 
JSONRPCReque¡
& 
»que¡
) const {

340 ià(
»que¡
.
fH–p
 || !
	`IsV®idNumArgs
Ôeque¡.
·¿ms
.
	`size
())) {

341 
throw
 
¡d
::
	`ruÁime_”rÜ
(
	`ToSŒšg
());

345 
´iv©e
:

346 cÚ¡ 
¡d
::
¡ršg
 
m_Çme
;

347 cÚ¡ 
¡d
::
¡ršg
 
m_desütiÚ
;

348 cÚ¡ 
¡d
::
veùÜ
<
RPCArg
> 
m_¬gs
;

349 cÚ¡ 
RPCResuÉs
 
m_»suÉs
;

350 cÚ¡ 
RPCExam¶es
 
m_exam¶es
;

351 
	}
};

352 cÚ¡ 
	g¡d
::
¡ršg
 
HELP_REQUIRING_PASSPHRASE
{"\nRequires wallet…assphraseo be set with walletpassphrase call if wallet isƒncrypted.\n"};

	@
1
.
0
24
309
auxpow_miner.cpp
auxpow_miner.h
blockchain.cpp
blockchain.h
client.cpp
client.h
governance.cpp
masternode.cpp
mining.cpp
misc.cpp
net.cpp
protocol.h
rawtransaction.cpp
rawtransaction_util.cpp
rawtransaction_util.h
register.h
request.cpp
request.h
rpcevo.cpp
rpcquorums.cpp
server.cpp
server.h
util.cpp
util.h
