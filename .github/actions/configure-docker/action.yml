name: 'Configure Docker'
description: 'Set up Docker build driver and configure build cache args'
inputs:
  cache-provider:
    description: 'gha or cirrus cache provider'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Check inputs
      shell: python
      env:
        CACHE_PROVIDER: ${{ inputs.cache-provider }}
      run: |
        import os
        # We expect only gha or cirrus as inputs to cache-provider
        if os.environ["CACHE_PROVIDER"] not in ("gha", "cirrus"):
          print(f"::warning title=Unknown input to configure docker action::Provided value was {os.environ['CACHE_PROVIDER']}")

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        # Use host network to allow access to cirrus gha cache running on the host
        driver-opts: |
          network=host

    # This is required to allow buildkit to access the actions cache
    - name: Expose actions cache variables
      uses: actions/github-script@v6
      with:
        script: |
          Object.keys(process.env).forEach(function (key) {
            if (key.startsWith('ACTIONS_')) {
              core.info(`Exporting ${key}`);
              core.exportVariable(key, process.env[key]);
            }
          });

    - name: Construct docker build cache args
      shell: bash
      env:
        CACHE_PROVIDER: ${{ inputs.cache-provider }}
        EVENT_NAME: ${{ github.event_name }}
        REF_NAME: ${{ github.ref_name }}
        DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      run: |
        # Configure docker build cache backend
        #
        # On forks the gha cache will work but will use Github's cache backend.
        # Docker will check for variables $ACTIONS_CACHE_URL, $ACTIONS_RESULTS_URL and $ACTIONS_RUNTIME_TOKEN
        # which are set automatically when running on GitHub infra: https://docs.docker.com/build/cache/backends/gha/#synopsis

        # Use cirrus cache host
        if [[ $CACHE_PROVIDER == 'cirrus' ]]; then
          url_args="url=${CIRRUS_CACHE_HOST},url_v2=${CIRRUS_CACHE_HOST}"
        else
          url_args=""
        fi

        # Always optimistically --cacheâ€‘from in case a cache blob exists
        args=(--cache-from "type=gha${url_args:+,${url_args}},scope=${CONTAINER_NAME}")

        # Only add --cache-to when using the Cirrus cache provider and pushing to the default branch.
        if [[ $CACHE_PROVIDER == 'cirrus' && $EVENT_NAME == "push" && $REF_NAME == $DEFAULT_BRANCH ]]; then
          args+=(--cache-to "type=gha${url_args:+,${url_args}},mode=max,ignore-error=true,scope=${CONTAINER_NAME}")
        fi

        # Always `--load` into docker images (needed when using the `docker-container` build driver).
        args+=(--load)

        echo "DOCKER_BUILD_CACHE_ARG=${args[*]}" >> $GITHUB_ENV